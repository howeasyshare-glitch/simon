
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>å…¬é–‹ç©¿æ­ Explore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;margin:0;background:#fafafa}
    header{padding:12px 16px;border-bottom:1px solid #ddd;background:#fff}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .card img{width:100%;display:block}
    .card-body{padding:10px}
    .counts{font-size:13px;color:#555;margin-bottom:6px}
    .actions{display:flex;gap:6px}
    .actions button{flex:1;font-size:13px;padding:6px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
    .actions button:hover{background:#eee}
  </style>
</head>
<body>

<header>
  <strong>å…¬é–‹ç©¿æ­ Explore</strong>
</header>

<main>
  <div id="grid" class="grid"></div>
</main>

<script>
function getAnonId(){
  let id = localStorage.getItem("anon_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("anon_id", id);
  }
  return id;
}
const anonId = getAnonId();

async function api(action, body){
  const res = await fetch("/explore/list?action=" + encodeURIComponent(action), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body || {})
  });

  const text = await res.text();
  if(!res.ok){
    throw new Error(text || ("API failed: " + res.status));
  }
  if(!text.trim()) return { ok: true }; // handle 204/empty
  try { return JSON.parse(text); } catch { return { ok: true, raw: text }; }
}

async function load(){
  const r = await fetch("/explore/list?limit=30&sort=like");
  const json = await r.json();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  (json.items || []).forEach(item => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <img src="${item.image_url}" alt="">
      <div class="card-body">
        <div class="counts">
          â¤ï¸ <span class="like">${item.like_count}</span>
          Â· ğŸ” <span class="share">${item.share_count}</span>
          Â· âœ¨ <span class="apply">${item.apply_count}</span>
        </div>
        <div class="actions">
          <button class="btn-like">Like</button>
          <button class="btn-share">åˆ†äº«</button>
          <button class="btn-apply">å¥—ç”¨</button>
        </div>
      </div>
    `;

    const $like = el.querySelector(".like");
    const $share = el.querySelector(".share");
    const $apply = el.querySelector(".apply");

    el.querySelector(".btn-like").onclick = async () => {
      $like.textContent = String(parseInt($like.textContent,10) + 1);
      try{
        const out = await api("like", { outfit_id: item.id, anon_id: anonId, toggle: true });
        const c = out && out.counts;
        if(c && typeof c.like_count === "number") $like.textContent = String(c.like_count);
      }catch(e){
        $like.textContent = String(Math.max(parseInt($like.textContent,10) - 1, 0));
        alert("Like å¤±æ•—ï¼š" + (e && e.message ? e.message : ""));
      }
    };

    el.querySelector(".btn-share").onclick = async () => {
      $share.textContent = String(parseInt($share.textContent,10) + 1);
      try{ await navigator.clipboard.writeText(location.origin + item.share_url); }catch(_){}
      try{
        const out = await api("share", { outfit_id: item.id });
        const c = out && out.counts;
        if(c && typeof c.share_count === "number") $share.textContent = String(c.share_count);
        alert("å·²è¤‡è£½åˆ†äº«é€£çµ");
      }catch(e){
        $share.textContent = String(Math.max(parseInt($share.textContent,10) - 1, 0));
        alert("Share å¤±æ•—ï¼š" + (e && e.message ? e.message : ""));
      }
    };

    el.querySelector(".btn-apply").onclick = async () => {
      $apply.textContent = String(parseInt($apply.textContent,10) + 1);
      try{
        const out = await api("apply", { outfit_id: item.id });
        const c = out && out.counts;
        if(c && typeof c.apply_count === "number") $apply.textContent = String(c.apply_count);
        location.href = "/?apply=" + encodeURIComponent(item.share_slug || "");
      }catch(e){
        $apply.textContent = String(Math.max(parseInt($apply.textContent,10) - 1, 0));
        alert("Apply å¤±æ•—ï¼š" + (e && e.message ? e.message : ""));
      }
    };

    grid.appendChild(el);
  });
}
load();
</script>

</body>
</html>
