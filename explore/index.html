<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>å…¬é–‹ç©¿æ­ Explore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;margin:0;background:#fafafa}
    header{padding:12px 16px;border-bottom:1px solid #ddd;background:#fff}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .card img{width:100%;display:block}
    .card-body{padding:10px}
    .counts{font-size:13px;color:#555;margin-bottom:6px}
    .actions{display:flex;gap:6px}
    .actions button{flex:1;font-size:13px;padding:6px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
    .actions button:hover{background:#eee}
  </style>
</head>
<body>

<header>
  <strong>å…¬é–‹ç©¿æ­ Explore</strong>
</header>

<main>
  <div id="grid" class="grid"></div>
</main>

<script>
/* ---------- utils ---------- */
function getAnonId(){
  let id = localStorage.getItem("anon_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("anon_id", id);
  }
  return id;
}
const anonId = getAnonId();

async function api(action, body){
  const res = await fetch("/explore/list?action=" + action, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body || {})
  });
  if(!res.ok) throw new Error("API failed");
  return res.json();
}

/* ---------- render ---------- */
async function load(){
  const res = await fetch("/explore/list?limit=30&sort=like");
  const json = await res.json();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  json.items.forEach(item => {
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <img src="${item.image_url}" alt="">
      <div class="card-body">
        <div class="counts">
          â¤ï¸ <span class="like">${item.like_count}</span>
          Â· ğŸ” <span class="share">${item.share_count}</span>
          Â· âœ¨ <span class="apply">${item.apply_count}</span>
        </div>
        <div class="actions">
          <button class="btn-like">Like</button>
          <button class="btn-share">åˆ†äº«</button>
          <button class="btn-apply">å¥—ç”¨</button>
        </div>
      </div>
    `;

    // Like
    el.querySelector(".btn-like").onclick = async () => {
      el.querySelector(".like").textContent =
        parseInt(el.querySelector(".like").textContent,10) + 1;
      try{
        await api("like", { outfit_id: item.id, anon_id: anonId, toggle: true });
      }catch(e){ alert("Like å¤±æ•—"); }
    };

    // Share
    el.querySelector(".btn-share").onclick = async () => {
      el.querySelector(".share").textContent =
        parseInt(el.querySelector(".share").textContent,10) + 1;
      await navigator.clipboard.writeText(location.origin + item.share_url);
      try{
        await api("share", { outfit_id: item.id });
        alert("å·²è¤‡è£½åˆ†äº«é€£çµ");
      }catch(e){ alert("Share å¤±æ•—"); }
    };

    // Apply
    el.querySelector(".btn-apply").onclick = async () => {
      el.querySelector(".apply").textContent =
        parseInt(el.querySelector(".apply").textContent,10) + 1;
      try{
        await api("apply", { outfit_id: item.id });
        location.href = "/?apply=" + item.share_slug;
      }catch(e){ alert("Apply å¤±æ•—"); }
    };

    grid.appendChild(el);
  });
}

load();
</script>

</body>
</html>
