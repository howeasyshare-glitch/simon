<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ç©¿æ­åˆ†äº«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;margin:0;background:#fafafa}
    main{max-width:960px;margin:0 auto;padding:16px}
    img{max-width:100%;border-radius:16px;background:#eee}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.like.liked{background:#ffe9ef;border-color:#ff9db7}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .counts{font-size:14px;color:#555;margin-top:6px}
    .meta{margin-top:10px;color:#333;font-size:14px;line-height:1.5}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transition:.2s;max-width:90vw}
    .toast.show{opacity:1}
    .err{margin-top:12px;padding:10px 12px;border:1px solid #f2b8b5;background:#fff0f0;border-radius:10px;color:#7a1c1c;display:none}
    .err a{color:#7a1c1c}
  </style>
</head>
<body>

<main>
  <h1 id="title">ç©¿æ­åˆ†äº«</h1>

  <img id="image" src="" alt="outfit" />

  <div class="counts">
    â¤ï¸ <span id="likeCount">0</span>
    Â· ğŸ” <span id="shareCount">0</span>
    Â· âœ¨ <span id="applyCount">0</span>
  </div>

  <div class="row">
    <button id="btnLike" class="btn like" disabled>Like</button>
    <button id="btnShare" class="btn" disabled>åˆ†äº«</button>
    <button id="btnApply" class="btn primary" disabled>ç”¨åŒæ¬¾æ¢ä»¶ç”Ÿæˆ</button>
  </div>

  <div id="meta" class="meta"></div>

  <div id="err" class="err"></div>
</main>

<div id="toast" class="toast"></div>

<script>
/* ========= config ========= */
const SUPABASE_PROJECT_REF = "auiwcsolpvufxxyhnvaf";
const SUPABASE_URL = `https://${SUPABASE_PROJECT_REF}.supabase.co`;

/* ========= helpers ========= */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}
function showError(html){
  const el=document.getElementById("err");
  el.style.display="block";
  el.innerHTML=html;
}
function getAnonId(){
  let id=localStorage.getItem("anon_id");
  if(!id){
    id=crypto.randomUUID();
    localStorage.setItem("anon_id",id);
  }
  return id;
}
const anonId=getAnonId();

function likeKey(outfitId){return `liked:${anonId}:${outfitId}`;}
function getLiked(outfitId){return localStorage.getItem(likeKey(outfitId))==="1";}
function setLiked(outfitId,v){localStorage.setItem(likeKey(outfitId),v?"1":"0");}

function getShareSlug(){
  // 1) query string
  const q = new URLSearchParams(location.search).get("slug");
  if(q) return q;

  // 2) path: /share/<slug>
  const parts = location.pathname.split("/").filter(Boolean);
  const i = parts.indexOf("share");
  if(i >= 0 && parts[i+1]) return parts[i+1];

  return "";
}

async function apiEvent(action, body){
  const r=await fetch("/explore/list?action="+encodeURIComponent(action),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body||{})
  });
  const text=await r.text();
  if(!r.ok) throw new Error(text || ("HTTP "+r.status));
  if(!text.trim()) return {ok:true};
  try{return JSON.parse(text);}catch{return {ok:true, raw:text};}
}

function normalizeOutfit(resp){
  // ä½  API å›å‚³å¯èƒ½æ˜¯ï¼š{outfit:{...}} æˆ– {data:{...}} æˆ– {item:{...}} æˆ–ç›´æ¥ {...}
  return resp?.outfit || resp?.data || resp?.item || resp?.row || (resp?.ok && resp) || resp || null;
}

function buildImageUrl(o){
  if(!o) return "";
  if(o.image_url) return o.image_url;
  if(o.image_path) return `${SUPABASE_URL}/storage/v1/object/public/outfits/${o.image_path}`;
  return "";
}

function setButtonsEnabled(enabled){
  document.getElementById("btnLike").disabled = !enabled;
  document.getElementById("btnShare").disabled = !enabled;
  document.getElementById("btnApply").disabled = !enabled;
}

/* ========= main ========= */
const slug = getShareSlug();
if(!slug){
  showError(`ç¼ºå°‘åˆ†äº«ä»£ç¢¼ï¼ˆslugï¼‰ã€‚ä½ ç›®å‰ç¶²å€æ˜¯ï¼š<code>${location.href}</code>`);
  throw new Error("Missing slug");
}

(async function init(){
  try{
    setButtonsEnabled(false);

    // cache buster é¿å…å¿«å–é€ æˆã€Œæ˜æ˜æœ‰è³‡æ–™å»æ²’æ›´æ–°ã€
    const url = "/api/share/" + encodeURIComponent(slug) + "?ts=" + Date.now();
    const r = await fetch(url);
    const j = await r.json();

    const outfit = normalizeOutfit(j);
    if(!outfit || !outfit.id){
      showError(`åˆ†äº«è³‡æ–™è®€å–æˆåŠŸï¼Œä½†æ ¼å¼ä¸ç¬¦åˆé æœŸã€‚ä½ å¯ä»¥å…ˆæ‰“é–‹ API çœ‹å…§å®¹ï¼š<a href="/api/share/${encodeURIComponent(slug)}" target="_blank">/api/share/${slug}</a>`);
      console.log("share api response:", j);
      return;
    }

    window._outfit = outfit;

    // image
    const imgUrl = buildImageUrl(outfit);
    if(!imgUrl){
      showError(`æ‰¾ä¸åˆ°åœ–ç‰‡ç¶²å€ï¼ˆimage_url / image_path éƒ½æ²’æœ‰ï¼‰ã€‚APIï¼š<a href="/api/share/${encodeURIComponent(slug)}" target="_blank">/api/share/${slug}</a>`);
    }else{
      const img = document.getElementById("image");
      img.src = imgUrl;
      img.onerror = () => {
        showError(`åœ–ç‰‡è¼‰å…¥å¤±æ•—ã€‚è«‹æª¢æŸ¥ Storage public æ¬Šé™æˆ–æª”æ¡ˆæ˜¯å¦å­˜åœ¨ã€‚<br>åœ–ç‰‡ç¶²å€ï¼š<a href="${imgUrl}" target="_blank">${imgUrl}</a>`);
      };
    }

    // counts
    document.getElementById("likeCount").textContent  = outfit.like_count  ?? 0;
    document.getElementById("shareCount").textContent = outfit.share_count ?? 0;
    document.getElementById("applyCount").textContent = outfit.apply_count ?? 0;

    // meta
    const meta = [];
    if(outfit.style) meta.push(`é¢¨æ ¼ï¼š${outfit.style}`);
    if(outfit.summary) meta.push(`æè¿°ï¼š${outfit.summary}`);
    document.getElementById("meta").textContent = meta.join(" Â· ");

    // like button initial
    const btnLike = document.getElementById("btnLike");
    const liked = getLiked(outfit.id);
    btnLike.classList.toggle("liked", liked);
    btnLike.textContent = liked ? "å·² Like" : "Like";

    setButtonsEnabled(true);
  }catch(e){
    showError(`åˆ†äº«è³‡æ–™è®€å–å¤±æ•—ï¼š${String(e?.message || e)}<br>ä½ å¯ä»¥å…ˆæ‰“é–‹ API çœ‹å…§å®¹ï¼š<a href="/api/share/${encodeURIComponent(slug)}" target="_blank">/api/share/${slug}</a>`);
    console.error(e);
  }
})();

/* ========= actions ========= */
document.getElementById("btnLike").onclick = async () => {
  const o = window._outfit;
  if(!o) return;

  const btn = document.getElementById("btnLike");
  btn.disabled = true;

  const was = getLiked(o.id);
  const next = !was;

  // optimistic
  setLiked(o.id, next);
  btn.classList.toggle("liked", next);
  btn.textContent = next ? "å·² Like" : "Like";

  const likeEl = document.getElementById("likeCount");
  likeEl.textContent = String(Math.max(parseInt(likeEl.textContent,10) + (next?1:-1), 0));

  try{
    const out = await apiEvent("like", { outfit_id: o.id, anon_id: anonId, toggle: true });
    if(out?.counts && typeof out.counts.like_count === "number"){
      likeEl.textContent = String(out.counts.like_count);
    }
    if(typeof out?.liked === "boolean"){
      setLiked(o.id, out.liked);
      btn.classList.toggle("liked", out.liked);
      btn.textContent = out.liked ? "å·² Like" : "Like";
    }
  }catch(e){
    // revert
    setLiked(o.id, was);
    btn.classList.toggle("liked", was);
    btn.textContent = was ? "å·² Like" : "Like";
    likeEl.textContent = String(Math.max(parseInt(likeEl.textContent,10) + (was?1:-1), 0));
    toast("Like å¤±æ•—");
  }finally{
    btn.disabled = false;
  }
};

document.getElementById("btnShare").onclick = async () => {
  const o = window._outfit;
  if(!o) return;

  const btn = document.getElementById("btnShare");
  btn.disabled = true;
  setTimeout(()=>btn.disabled=false, 1200);

  const shareEl = document.getElementById("shareCount");
  shareEl.textContent = String(parseInt(shareEl.textContent,10) + 1);

  try{
    // iOS/Safari å¯èƒ½ç„¡ clipboardï¼Œå¤±æ•—å°±ç•¥éä¸æ“‹æµç¨‹
    try{ await navigator.clipboard.writeText(location.origin + "/share/" + slug); }catch(_){}
    await apiEvent("share", { outfit_id: o.id });
    toast("å·²è¤‡è£½åˆ†äº«é€£çµ");
  }catch(e){
    shareEl.textContent = String(Math.max(parseInt(shareEl.textContent,10) - 1, 0));
    toast("åˆ†äº«å¤±æ•—");
  }
};

document.getElementById("btnApply").onclick = async () => {
  const o = window._outfit;
  if(!o) return;

  const btn = document.getElementById("btnApply");
  btn.disabled = true;
  setTimeout(()=>btn.disabled=false, 1200);

  const applyEl = document.getElementById("applyCount");
  applyEl.textContent = String(parseInt(applyEl.textContent,10) + 1);

  try{
    await apiEvent("apply", { outfit_id: o.id });
  }catch(e){
    // è¨˜æ•¸å¤±æ•—ä¸æ“‹ä½¿ç”¨è€…å›é¦–é 
  }
  location.href = "/?apply=" + encodeURIComponent(slug);
};
</script>

</body>
</html>
