<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>ç©¿æ­åˆ†äº«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;margin:0;background:#fafafa}
    main{max-width:960px;margin:0 auto;padding:16px}
    img{max-width:100%;border-radius:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn.like.liked{background:#ffe9ef;border-color:#ff9db7}
    .counts{font-size:14px;color:#555;margin-top:6px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;transition:.2s}
    .toast.show{opacity:1}
  </style>
</head>
<body>

<main>
  <h1 id="title">ç©¿æ­åˆ†äº«</h1>
  <img id="image" src="" alt="">
  <div class="counts">
    â¤ï¸ <span id="likeCount">0</span>
    Â· ğŸ” <span id="shareCount">0</span>
    Â· âœ¨ <span id="applyCount">0</span>
  </div>

  <div class="row">
    <button id="btnLike" class="btn like">Like</button>
    <button id="btnShare" class="btn">åˆ†äº«</button>
    <button id="btnApply" class="btn primary">ç”¨åŒæ¬¾æ¢ä»¶ç”Ÿæˆ</button>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
/* ---------- utils ---------- */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1200);
}

function getAnonId(){
  let id=localStorage.getItem("anon_id");
  if(!id){
    id=crypto.randomUUID();
    localStorage.setItem("anon_id",id);
  }
  return id;
}
const anonId=getAnonId();

function likeKey(id){return `liked:${anonId}:${id}`}
function getLiked(id){return localStorage.getItem(likeKey(id))==="1"}
function setLiked(id,v){localStorage.setItem(likeKey(id),v?"1":"0")}

async function api(action,body){
  const r=await fetch("/explore/list?action="+encodeURIComponent(action),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body||{})
  });
  const text=await r.text();
  if(!r.ok) throw new Error(text||r.status);
  if(!text.trim()) return {ok:true};
  try{return JSON.parse(text)}catch{return {ok:true}}
}

/* ---------- load share ---------- */
const slug=new URLSearchParams(location.search).get("slug");
if(!slug){document.body.innerHTML="ç¼ºå°‘åˆ†äº«ä»£ç¢¼";throw ""}

fetch("/api/share/"+slug)
  .then(r=>r.json())
  .then(d=>{
    const o=d.outfit;
    window._outfit=o;

    document.getElementById("image").src=o.image_url;
    document.getElementById("likeCount").textContent=o.like_count||0;
    document.getElementById("shareCount").textContent=o.share_count||0;
    document.getElementById("applyCount").textContent=o.apply_count||0;

    if(getLiked(o.id)){
      document.getElementById("btnLike").classList.add("liked");
      document.getElementById("btnLike").textContent="å·² Like";
    }
  });

/* ---------- actions ---------- */
const btnLike=document.getElementById("btnLike");
btnLike.onclick=async()=>{
  const o=window._outfit;
  const was=getLiked(o.id);
  const next=!was;

  setLiked(o.id,next);
  btnLike.classList.toggle("liked",next);
  btnLike.textContent=next?"å·² Like":"Like";
  document.getElementById("likeCount").textContent=
    Math.max(parseInt(document.getElementById("likeCount").textContent,10)+(next?1:-1),0);

  try{
    const out=await api("like",{outfit_id:o.id,anon_id:anonId,toggle:true});
    if(out.counts && typeof out.counts.like_count==="number"){
      document.getElementById("likeCount").textContent=out.counts.like_count;
    }
  }catch(e){
    setLiked(o.id,was);
    btnLike.classList.toggle("liked",was);
    btnLike.textContent=was?"å·² Like":"Like";
    toast("Like å¤±æ•—");
  }
};

document.getElementById("btnShare").onclick=async()=>{
  const o=window._outfit;
  document.getElementById("shareCount").textContent=
    parseInt(document.getElementById("shareCount").textContent,10)+1;
  try{
    await navigator.clipboard.writeText(location.href);
    await api("share",{outfit_id:o.id});
    toast("å·²è¤‡è£½åˆ†äº«é€£çµ");
  }catch(e){toast("åˆ†äº«å¤±æ•—")}
};

document.getElementById("btnApply").onclick=async()=>{
  const o=window._outfit;
  document.getElementById("applyCount").textContent=
    parseInt(document.getElementById("applyCount").textContent,10)+1;
  try{
    await api("apply",{outfit_id:o.id});
    location.href="/?apply="+encodeURIComponent(slug);
  }catch(e){toast("å¥—ç”¨å¤±æ•—")}
};
</script>

</body>
</html>
