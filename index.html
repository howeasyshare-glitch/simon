<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI ç©¿æ­å»ºè­°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --primary: #222;
      --accent: #ff6b6b;
      --muted: #777;
      --border-radius-lg: 18px;
      --border-radius-sm: 10px;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffecec 0, #f5f5f7 45%, #f5f5f7 100%);
      color: var(--primary);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
    }

    .logo {
      font-weight: 700;
      font-size: 22px;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-pill {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      box-shadow: 0 6px 15px rgba(255,107,107,0.5);
    }

    .subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 20px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      gap: 10px;
    }

    .card-title {
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f3f8;
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 14px;
      margin-bottom: 16px;
    }

    @media (max-width: 600px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label {
      font-weight: 500;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    select,
    input[type="number"] {
      padding: 8px 10px;
      border-radius: var(--border-radius-sm);
      border: 1px solid #e0e0ea;
      background: #fafafa;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: #ff8a8a;
      box-shadow: 0 0 0 2px rgba(255,138,138,0.35);
      background: #ffffff;
    }

    .range-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      flex: 1;
    }

    .temp-display {
      min-width: 46px;
      text-align: right;
      font-size: 13px;
      color: var(--muted);
    }

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(255,107,107,0.5);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(255,107,107,0.6);
      opacity: 0.95;
    }

    .primary-btn[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .secondary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color: #555;
      font-size: 12px;
      cursor: pointer;
    }

    .secondary-btn[disabled] {
      opacity: 0.5;
      cursor: default;
    }

    .btn-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .status-text {
      font-size: 11px;
      color: var(--muted);
    }

    .status-text.loading::before {
      content: "â³ ";
    }
    .status-text.done::before {
      content: "âœ¨ ";
    }
    .status-text.error::before {
      content: "âš ï¸ ";
    }

    /* Result side */

    .result-layout {
      display: grid;
      grid-template-rows: auto auto;
      gap: 14px;
      height: 100%;
    }

    .image-wrapper {
      border-radius: var(--border-radius-lg);
      background: linear-gradient(125deg, #fff7f7, #f9fbff);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 420px;
      position: relative;
    }

    .image-inner {
      flex: 1;
      border-radius: 16px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid #f0f0f5;
      aspect-ratio: 3 / 4; /* ç›´å¼æ¯”ä¾‹ */
      position: relative;
    }

    #outfit-image {
      max-width: 100%;
      max-height: 100%;
      display: block;
      object-fit: contain;
    }

    .image-placeholder {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      padding: 12px;
    }

    .desc {
      font-size: 13px;
      color: var(--muted);
    }

    .product-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .product-item {
      display: grid;
      grid-template-columns: 64px minmax(0, 1fr);
      gap: 10px;
      background: #fafafa;
      border-radius: 13px;
      padding: 8px;
      align-items: center;
    }

    .product-thumb {
      width: 64px;
      height: 64px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #eee;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--muted);
    }

    .product-thumb img {
      max-width: 100%;
      max-height: 100%;
      object-fit: cover;
    }

    .product-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .product-name {
      font-size: 13px;
      font-weight: 500;
    }

    .product-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .product-price {
      font-size: 12px;
      font-weight: 600;
    }

    .product-link {
      font-size: 11px;
      color: #ff7b7b;
      text-decoration: none;
    }

    .product-link:hover {
      text-decoration: underline;
    }

    footer {
      margin-top: 22px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    /* åœ–ç‰‡ overlayï¼šé›¶ä»¶æ¨™ç±¤å€ */
   /* åœ–ç‰‡ overlayï¼šæ¨™ç±¤è²¼åœ¨é‚Šç·£ï¼Œæœ‰å°ç®­é ­æŒ‡å‘æœè£å€åŸŸ */
.outfit-overlay {
  position: absolute;
  inset: 0;
  pointer-events: none; /* è®“é»æ“Šäº‹ä»¶åªè½åœ¨å…§éƒ¨æŒ‰éˆ• */
}

.overlay-list {
  position: relative;
  width: 100%;
  height: 100%;
}

/* æ¯ä¸€å€‹ slot çš„æ¨™ç±¤æ¨£å¼ */
/* æ¯ä¸€å€‹ slot çš„æ¨™ç±¤æ¨£å¼ï¼šç¸®å°ä¸€é»ã€åŠé€æ˜ */
.overlay-item {
  position: absolute;
  max-width: 44%;
  background: rgba(0,0,0,0.6);
  color: #fff;
  border-radius: 999px;
  padding: 3px 7px;
  font-size: 10px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  pointer-events: auto;
  transform: scale(0.7);      /* â† ç¸®å°åˆ°å¤§ç´„ 70% */
  transform-origin: center;
}

/* å·¦å´æ¨™ç±¤çš„å°ç®­é ­ */
.overlay-item.left::before {
  content: "";
  position: absolute;
  right: -5px;
  top: 50%;
  transform: translateY(-50%);
  border-width: 5px 0 5px 5px;
  border-style: solid;
  border-color: transparent transparent transparent rgba(0,0,0,0.6);
}

/* å³å´æ¨™ç±¤çš„å°ç®­é ­ */
.overlay-item.right::before {
  content: "";
  position: absolute;
  left: -5px;
  top: 50%;
  transform: translateY(-50%);
  border-width: 5px 5px 5px 0;
  border-style: solid;
  border-color: transparent rgba(0,0,0,0.6) transparent transparent;
}

.overlay-slot-label { font-size: 10px; font-weight: 600; }
.overlay-name       { font-size: 10px; }

.overlay-actions { display:flex; gap:3px; }

.overlay-link {
  font-size: 9px;
  color: #ffd27f;
  text-decoration: none;
}

.overlay-btn {
  border: none;
  border-radius: 999px;
  padding: 1px 6px;
  font-size: 9px;
  background: #fff;
  color: #555;
  cursor: pointer;
}



    /* æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
    @media (max-width: 900px) {
      .page {
        padding: 16px 12px 28px;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .image-wrapper {
        height: auto;
        min-height: 360px;
      }

      .btn-row {
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }

      .primary-btn {
        width: 100%;
        justify-content: center;
      }

      .outfit-overlay {
        max-width: 80%;
      }
    }

    @media (max-width: 480px) {
      .card {
        padding: 14px;
      }

      .card-title {
        font-size: 15px;
      }

      .product-item {
        grid-template-columns: 56px 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <div class="logo">
          <span class="logo-pill"></span>
          <span>Outfit Studio</span>
        </div>
        <div class="subtitle">è¼¸å…¥æ¢ä»¶ â†’ ç”¢ç”Ÿ AI ç©¿æ­ç¤ºæ„åœ– + é¡ä¼¼å•†å“æ¸…å–®ï¼ˆå¯é‡å°å–®å“å±€éƒ¨èª¿æ•´ï¼‰</div>
      </div>
    </header>

    <main class="layout">
      <!-- å·¦å´ï¼šæ¢ä»¶è¼¸å…¥ -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">ç©¿æ­æ¢ä»¶</div>
          <div class="pill">Step 1 Â· è¨­å®šæ¢ä»¶</div>
        </div>

        <form id="outfit-form" onsubmit="event.preventDefault(); generateOutfit();">
          <div class="form-grid">
            <div class="form-field">
              <label for="gender">æ€§åˆ¥</label>
              <select id="gender" required>
                <option value="female">å¥³æ€§</option>
                <option value="male">ç”·æ€§</option>
                <option value="neutral">ä¸­æ€§ / ä¸æ‹˜</option>
              </select>
              <div class="hint">æœƒå½±éŸ¿ç‰ˆå‹èˆ‡å‰ªè£æ„Ÿè¦º</div>
            </div>

            <div class="form-field">
              <label for="age">å¹´é½¡</label>
              <input
                type="number"
                id="age"
                min="10"
                max="80"
                value="25"
                required
              />
              <div class="hint">å¯ç²—åˆ†é¢¨æ ¼æˆç†Ÿåº¦</div>
            </div>

            <div class="form-field">
              <label for="height">èº«é«˜ï¼ˆcmï¼‰</label>
              <input
                type="number"
                id="height"
                min="140"
                max="210"
                value="165"
                required
              />
              <div class="hint">ç”¨ä¾†æ¨ä¼°èº«å½¢æ¯”ä¾‹ï¼ˆé«˜æŒ‘ / å¨ƒå¨ƒæ„Ÿç­‰ï¼‰</div>
            </div>

            <div class="form-field">
              <label for="weight">é«”é‡ï¼ˆkgï¼‰</label>
              <input
                type="number"
                id="weight"
                min="35"
                max="150"
                value="55"
                required
              />
              <div class="hint">ç”¨ä¾†æ¨ä¼°èº«å½¢ï¼ˆåç˜¦ / ä¸€èˆ¬ / å¾®è‚‰ï¼‰</div>
            </div>

            <div class="form-field">
              <label for="style">é¢¨æ ¼</label>
              <select id="style" required>
                <option value="casual">ä¼‘é–’æ—¥å¸¸</option>
                <option value="minimal">æ¥µç°¡é€šå‹¤</option>
                <option value="street">è¡—é ­é¢¨</option>
                <option value="sporty">é‹å‹•é¢¨</option>
                <option value="smart">Smart Casual</option>
              </select>
            </div>

            <div class="form-field">
              <label for="temp-range">æº«åº¦</label>
              <div class="range-wrapper">
                <input
                  type="range"
                  id="temp-range"
                  min="5"
                  max="35"
                  value="22"
                  oninput="updateTempDisplay(this.value)"
                />
                <div class="temp-display">
                  <span id="temp-text">22</span>Â°C
                </div>
              </div>
              <div class="hint">å½±éŸ¿æ˜¯å¦å»ºè­°å¤–å¥—ã€åšåº¦ç­‰</div>
            </div>

            <div class="form-field" style="grid-column: 1 / -1;">
              <label>é¡å¤–æ­é…ï¼ˆå¯è¤‡é¸ï¼‰</label>
              <div class="hint">åŸºæœ¬æœƒæœ‰ã€Œä¸Šèº«ï¼‹ä¸‹èº«ï¼‹é‹å­ã€ï¼Œé€™è£¡å¯ä»¥åŠ å¸½å­ã€åŒ…åŒ…ã€å¤–å¥—ç­‰</div>
              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; font-size:12px;">
                <label><input type="checkbox" id="extra-hat" /> å¸½å­</label>
                <label><input type="checkbox" id="extra-bag" /> åŒ…åŒ…</label>
                <label><input type="checkbox" id="extra-outer" /> å¤–å¥—</label>
                <label><input type="checkbox" id="extra-accessory" /> å…¶ä»–å°é…ä»¶</label>
              </div>
            </div>
          </div>

          <div class="btn-row">
            <span id="status" class="status-text">æº–å‚™å¥½æ™‚ï¼ŒæŒ‰ä¸‹ã€Œç”¢ç”Ÿç©¿æ­ç¤ºæ„åœ–ã€ã€‚</span>
            <button type="button" id="update-image-btn" class="secondary-btn" onclick="updateImageFromCurrentOutfit()" disabled>
              ğŸ” æ›´æ–°ç¤ºæ„åœ–
            </button>
            <button type="submit" id="generate-btn" class="primary-btn">
              <span>âœ¨ ç”¢ç”Ÿç©¿æ­ç¤ºæ„åœ–</span>
            </button>
          </div>
        </form>
      </section>

      <!-- å³å´ï¼šçµæœå±•ç¤º -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“</div>
          <div class="pill">Step 2 Â· çµæœé è¦½</div>
        </div>

        <div class="result-layout">
          <!-- åœ–ç‰‡å€ -->
          <div class="image-wrapper">
            <div class="image-inner">
              <img
                id="outfit-image"
                src=""
                alt="Outfit preview"
                style="display:none;"
              />
              <div id="image-placeholder" class="image-placeholder">
                ç›®å‰é‚„æ²’æœ‰ç¤ºæ„åœ–ï¼Œè«‹å…ˆåœ¨å·¦é‚Šè¼¸å…¥æ¢ä»¶ä¸¦ç”¢ç”Ÿä¸€æ¬¡ç©¿æ­ã€‚<br />
                åœ–ç‰‡å°‡ä»¥ã€ŒUNIQLO Lookbookã€é¢¨æ ¼å‘ˆç¾ï¼Œä½œç‚ºæ•´é«”æ­é…åƒè€ƒã€‚
              </div>

              <!-- Overlayï¼šé¡¯ç¤ºå„éƒ¨ä½æ¨™ç±¤ï¼†æ›ä¸€ä»¶ -->
              <div id="outfit-overlay" class="outfit-overlay" style="display:none;">
  <div id="overlay-list" class="overlay-list">
    <!-- JS æœƒå¡æ¨™ç±¤ -->
  </div>
</div>

            </div>
            <div class="desc" id="outfit-desc">
              é€™è£¡æœƒé¡¯ç¤ºä»¥æ–‡å­—æè¿°çš„ç©¿æ­èªªæ˜ï¼Œä¾‹å¦‚ï¼š
              ã€Œ22Â°C çš„æ™´å¤©ï¼Œå»ºè­°ä½ ç©¿è‘—ç™½è‰²å¯¬ç‰ˆä¸Šè¡£æ­é…æ·ºè‰²ç›´ç­’è¤²èˆ‡å¸†å¸ƒé‹ï¼Œæ•´é«”æ˜¯åå‘ UNIQLO é¢¨æ ¼çš„æ¥µç°¡ä¼‘é–’æ„Ÿã€‚ã€
            </div>
          </div>

          <!-- å•†å“æ¸…å–®å€ -->
          <div>
            <div class="desc" style="margin-bottom:6px;">é¡ä¼¼å•†å“ï¼ˆç¤ºæ„ï¼‰ï¼š</div>
            <div id="product-list" class="product-list">
              <!-- JS æœƒæŠŠå•†å“å¡ç‰‡æ’å…¥åˆ°é€™è£¡ -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      v0.3 Â· Demo â€” AI åœ–ç‰‡ç”Ÿæˆ + é›¶ä»¶åŒ–ç©¿æ­ï¼ˆå¯å±€éƒ¨æ›æ¬¾ & æ›´æ–°ç¤ºæ„åœ–ï¼‰ + æ¯æ—¥æ¬¡æ•¸é™åˆ¶
    </footer>
  </div>

  <!-- TensorFlow.js + Pose Detectionï¼ˆMoveNetï¼‰-->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script>
    // ===== Pose Detectionï¼ˆMoveNetï¼‰ç›¸é—œ =====
let poseDetector = null;
let dynamicSlotPositions = null; // ç”±å§¿å‹¢åµæ¸¬å‹•æ…‹æ±ºå®šæ¨™ç±¤ä½ç½®

async function initPoseDetector() {
  if (poseDetector) return poseDetector;
  if (typeof poseDetection === "undefined") {
    console.warn("poseDetection library not loaded");
    return null;
  }

  try {
    if (typeof tf !== "undefined" && tf.setBackend) {
      await tf.setBackend("webgl");
      await tf.ready();
    }
  } catch (e) {
    console.warn("tf webgl backend failed, fallback to default", e);
  }

  poseDetector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    {
      modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
    }
  );

  return poseDetector;
}
    // ===== 1. æ¯æ—¥ API å‘¼å«æ¬¡æ•¸é™åˆ¶ =====
    const DAILY_LIMIT = 20;
    const USAGE_KEY = "outfit_daily_usage_v1";

    function getTodayStr() {
      return new Date().toISOString().slice(0, 10);
    }

    function getUsage() {
      if (!window.localStorage) {
        return { date: getTodayStr(), count: 0 };
      }
      try {
        const raw = localStorage.getItem(USAGE_KEY);
        if (!raw) return { date: getTodayStr(), count: 0 };
        const parsed = JSON.parse(raw);
        if (parsed.date !== getTodayStr()) {
          return { date: getTodayStr(), count: 0 };
        }
        return parsed;
      } catch (e) {
        console.warn("usage parse error", e);
        return { date: getTodayStr(), count: 0 };
      }
    }

    function setUsage(usage) {
      if (!window.localStorage) return;
      try {
        localStorage.setItem(USAGE_KEY, JSON.stringify(usage));
      } catch (e) {
        console.warn("usage save error", e);
      }
    }

    function incrementUsage() {
      const u = getUsage();
      const next = { date: getTodayStr(), count: u.count + 1 };
      setUsage(next);
      return next;
    }

    // ===== 2. æ›´æ–°æº«åº¦é¡¯ç¤º =====
    function updateTempDisplay(v) {
      document.getElementById("temp-text").textContent = v;
    }

    // ===== 3. å•†å“è³‡æ–™ï¼šUNIQLO æœå°‹é€£çµç¤ºæ„ =====
    const products = [
      // ä¸Šè¡£
      {
        id: "f-top-casual-01",
        name: "å¥³è£ å¯¬ç‰ˆåœ“é ˜ T æ¤ï¼ˆç™½ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "top",
        gender: "female",
        styles: ["casual", "minimal"],
        tempMin: 18,
        tempMax: 30,
        price: 390,
        currency: "TWD",
        searchKeyword: "å¥³è£ å¯¬ç‰ˆ åœ“é ˜ Tæ¤ ç™½"
      },
      {
        id: "u-top-minimal-01",
        name: "ç”·å¥³çš†å¯ æ¥µç°¡è½è‚© T æ¤ï¼ˆç°ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "top",
        gender: "unisex",
        styles: ["minimal", "smart"],
        tempMin: 16,
        tempMax: 28,
        price: 490,
        currency: "TWD",
        searchKeyword: "è½è‚© Tæ¤ ç° æ¥µç°¡"
      },
      {
        id: "m-top-casual-01",
        name: "ç”·è£ U åœ“é ˜å¯¬ç‰ˆ T æ¤ï¼ˆé»‘ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "top",
        gender: "male",
        styles: ["casual", "street"],
        tempMin: 20,
        tempMax: 32,
        price: 390,
        currency: "TWD",
        searchKeyword: "ç”·è£ U åœ“é ˜ å¯¬ç‰ˆ Tæ¤ é»‘"
      },
      // ä¸‹èº«
      {
        id: "f-bottom-casual-01",
        name: "å¥³è£ ç›´ç­’ç‰›ä»”è¤²ï¼ˆæ·ºè—ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "bottom",
        gender: "female",
        styles: ["casual", "minimal"],
        tempMin: 15,
        tempMax: 28,
        price: 990,
        currency: "TWD",
        searchKeyword: "å¥³è£ ç›´ç­’ ç‰›ä»”è¤² æ·ºè—"
      },
      {
        id: "m-bottom-casual-01",
        name: "ç”·è£ éŒå½¢é•·è¤²ï¼ˆå¡å…¶ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "bottom",
        gender: "male",
        styles: ["casual", "smart"],
        tempMin: 15,
        tempMax: 26,
        price: 1290,
        currency: "TWD",
        searchKeyword: "ç”·è£ éŒå½¢ é•·è¤² å¡å…¶"
      },
      // é‹å­
      {
        id: "shoes-white-sneaker-01",
        name: "ç™½è‰²ä¼‘é–’é‹å‹•é‹",
        brand: "UNIQLO é¢¨æ ¼",
        type: "shoes",
        gender: "unisex",
        styles: ["casual", "minimal", "sporty"],
        tempMin: 5,
        tempMax: 35,
        price: 1290,
        currency: "TWD",
        searchKeyword: "ç™½è‰² çƒé‹ ä¼‘é–’é‹"
      },
      // å¤–å¥—
      {
        id: "unisex-outer-01",
        name: "è¶…è¼•ç¾½çµ¨å¤–å¥—ï¼ˆæ·±è—ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "outer",
        gender: "unisex",
        styles: ["casual", "minimal", "smart"],
        tempMin: 8,
        tempMax: 18,
        price: 1990,
        currency: "TWD",
        searchKeyword: "è¶…è¼• ç¾½çµ¨ å¤–å¥— æ·±è—"
      },
      // å¸½å­
      {
        id: "hat-cap-01",
        name: "æ£‰è³ªé´¨èˆŒå¸½ï¼ˆé»‘ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "hat",
        gender: "unisex",
        styles: ["casual", "street", "sporty"],
        tempMin: 5,
        tempMax: 35,
        price: 390,
        currency: "TWD",
        searchKeyword: "æ£‰è³ª é´¨èˆŒå¸½ é»‘"
      },
      // åŒ…åŒ…
      {
        id: "bag-shoulder-01",
        name: "æ–œèƒŒå°å´èƒŒåŒ…",
        brand: "UNIQLO é¢¨æ ¼",
        type: "bag",
        gender: "unisex",
        styles: ["casual", "street", "minimal"],
        tempMin: 5,
        tempMax: 35,
        price: 590,
        currency: "TWD",
        searchKeyword: "æ–œèƒŒ å°åŒ…"
      },
      // å…¶ä»–é…ä»¶
      {
        id: "accessory-socks-01",
        name: "ç´ è‰²ä¸­ç­’è¥ªï¼ˆç™½ï¼‰",
        brand: "UNIQLO é¢¨æ ¼",
        type: "accessory",
        gender: "unisex",
        styles: ["casual", "sporty", "minimal"],
        tempMin: 5,
        tempMax: 35,
        price: 150,
        currency: "TWD",
        searchKeyword: "ç´ è‰² ä¸­ç­’ è¥ª ç™½"
      }
    ];

    // ===== 4. å…¨å±€ç‹€æ…‹ï¼šç›®å‰é€™ä¸€å¥—ç©¿æ­æ‹†æˆ slots =====
    let currentOutfitSlots = []; // [{ slot: 'top', product: {...} }, ...]

    // ===== 5. å•†å“æŒ‘é¸ï¼šåŸºæœ¬ä¸‰ä»¶ï¼‹é¡å¤–å‹¾é¸ =====
    function pickProducts(gender, style, temp, extras) {
      const pool = products.filter(p => {
        const genderMatch = p.gender === "unisex" || p.gender === gender;
        const styleMatch = p.styles.includes(style);
        return genderMatch && styleMatch;
      });

      const pickOne = (typeFilter, extraFilter = () => true) => {
        const candidates = pool.filter(
          p => p.type === typeFilter && extraFilter(p)
        );
        if (candidates.length === 0) return null;
        return candidates[Math.floor(Math.random() * candidates.length)];
      };

      const result = [];

      // åŸºæœ¬ï¼šä¸Šèº«
      const top = pickOne("top", p => temp >= p.tempMin && temp <= p.tempMax);
      if (top) result.push(top);

      // åŸºæœ¬ï¼šä¸‹èº«
      const bottom = pickOne("bottom", p => temp >= p.tempMin && temp <= p.tempMax);
      if (bottom) result.push(bottom);

      // åŸºæœ¬ï¼šé‹å­
      const shoes = pickOne("shoes", p => temp >= p.tempMin && temp <= p.tempMax);
      if (shoes) result.push(shoes);

      // é¡å¤–ï¼šå¤–å¥—
      if (extras.outer) {
        const outer = pickOne("outer", p => temp >= p.tempMin && temp <= p.tempMax);
        if (outer) result.push(outer);
      }

      // é¡å¤–ï¼šå¸½å­
      if (extras.hat) {
        const hat = pickOne("hat");
        if (hat) result.push(hat);
      }

      // é¡å¤–ï¼šåŒ…åŒ…
      if (extras.bag) {
        const bag = pickOne("bag");
        if (bag) result.push(bag);
      }

      // é¡å¤–ï¼šå…¶ä»–é…ä»¶
      if (extras.accessory) {
        const acc = pickOne("accessory");
        if (acc) result.push(acc);
      }

      return result;
    }

    function buildOutfitSlots(productsArr) {
      return productsArr.map(p => ({ slot: p.type, product: p }));
    }

    function buildUniqloLink(p) {
      const base = "https://www.uniqlo.com/tw/zh_TW/search?q=";
      const keyword = p.searchKeyword || p.name;
      return base + encodeURIComponent(keyword);
    }

    // ===== 6. å•†å“åˆ—è¡¨ï¼ˆå³å´ï¼‰ =====
    function renderProducts(list) {
      const container = document.getElementById("product-list");
      container.innerHTML = "";

      const typeLabel = {
        top: "ä¸Šèº«",
        bottom: "ä¸‹èº«",
        shoes: "é‹å­",
        hat: "å¸½å­",
        bag: "åŒ…åŒ…",
        outer: "å¤–å¥—",
        accessory: "é…ä»¶"
      };

      list.forEach(p => {
        const el = document.createElement("div");
        el.className = "product-item";

        const thumbHTML = `<span>ç¤ºæ„åœ–</span>`;
        const link = buildUniqloLink(p);

        el.innerHTML = `
          <div class="product-thumb">
            ${thumbHTML}
          </div>
          <div class="product-main">
            <div class="product-name">${p.name}</div>
            <div class="product-meta">
              <span>${p.brand}</span>
              <span>Â· ${typeLabel[p.type] || ""}</span>
            </div>
            <div class="product-price">
              $${p.price.toLocaleString()} ${p.currency}
            </div>
            <a class="product-link" href="${link}" target="_blank" rel="noopener noreferrer">
              å‰å¾€æŸ¥çœ‹é¡ä¼¼å•†å“
            </a>
          </div>
        `;

        container.appendChild(el);
      });
    }

    // åˆå§‹ï¼šç”¨é è¨­æ¢ä»¶å…ˆæŒ‘å¹¾ä»¶å•†å“ï¼ˆæ²’æœ‰ç”¢åœ–ï¼‰
    (function initDefaultProducts() {
      const extras = { hat: false, bag: false, outer: false, accessory: false };
      const selected = pickProducts("female", "casual", 22, extras);
      currentOutfitSlots = buildOutfitSlots(selected);
      renderProducts(selected);
      renderOutfitOverlay(currentOutfitSlots);
    })();

    // ===== 7. Overlayï¼šåœ–ä¸Šçš„éƒ¨ä½æ¨™ç±¤ & æ›ä¸€ä»¶ =====
    function renderOutfitOverlay(slots) {
  const overlay = document.getElementById("outfit-overlay");
  const listEl = document.getElementById("overlay-list");
  if (!overlay || !listEl) return;

  if (!slots || slots.length === 0) {
    overlay.style.display = "none";
    return;
  }

  const labelMap = {
    top: "ä¸Šèº«",
    bottom: "ä¸‹èº«",
    shoes: "é‹å­",
    hat: "å¸½å­",
    bag: "åŒ…åŒ…",
    outer: "å¤–å¥—",
    accessory: "é…ä»¶"
  };

  // å‚™ç”¨ï¼šå¦‚æœæ²’æœ‰åµæ¸¬åˆ°å§¿å‹¢ï¼Œå°±ç”¨é è¨­ç™¾åˆ†æ¯”
  const defaultSlotPosition = {
    hat:      { top: 8,  side: "left"  },
    top:      { top: 28, side: "right" },
    outer:    { top: 40, side: "left"  },
    bag:      { top: 50, side: "right" },
    accessory:{ top: 60, side: "right" },
    bottom:   { top: 70, side: "left"  },
    shoes:    { top: 86, side: "right" }
  };

  listEl.innerHTML = "";

  slots.forEach(({ slot, product }) => {
    const override = dynamicSlotPositions && dynamicSlotPositions[slot];
    const basePos = defaultSlotPosition[slot] || { top: 50, side: "right" };
    const pos = override || basePos;

    const el = document.createElement("div");
    el.className = "overlay-item " + pos.side;

    el.style.top = pos.top + "%";
    el.style[pos.side] = "4px";

    const link = buildUniqloLink(product);

    el.innerHTML = `
      <span class="overlay-slot-label">${labelMap[slot] || "å–®å“"}</span>
      <span class="overlay-name">${product.name}</span>
      <div class="overlay-actions">
        <a class="overlay-link" href="${link}" target="_blank">æŸ¥çœ‹</a>
        <button type="button" class="overlay-btn" onclick="replaceSingleItem('${slot}')">
          æ›ä¸€ä»¶
        </button>
      </div>
    `;

    listEl.appendChild(el);
  });

  overlay.style.display = "block";

  const updateBtn = document.getElementById("update-image-btn");
  if (updateBtn) updateBtn.disabled = false;
}



    // ===== 8. ç”¨ slots + èº«é«˜é«”é‡ çµ„åˆ prompt =====
   function buildOutfitPromptFromSlots(slots, gender, style, temp, height, weight) {
  const genderTextMapEn = {
    female: "a woman",
    male: "a man",
    neutral: "a person"
  };
  const styleTextMapEn = {
    casual: "casual everyday style",
    minimal: "minimalist office casual style",
    street: "streetwear style",
    sporty: "sporty athleisure style",
    smart: "smart casual style"
  };

  const genderEn = genderTextMapEn[gender] || "a person";
  const styleEn = styleTextMapEn[style] || "casual style";

  let bodyTypeDesc = "average height and average build";
  if (height && weight) {
    const h = height / 100;
    const bmi = weight / (h * h);
    if (height <= 155) {
      bodyTypeDesc = "petite height";
    } else if (height >= 175) {
      bodyTypeDesc = "taller height";
    }

    if (bmi < 19) {
      bodyTypeDesc += ", slim body type";
    } else if (bmi > 25) {
      bodyTypeDesc += ", slightly fuller body type";
    } else {
      bodyTypeDesc += ", medium body type";
    }
  }

  const itemsText = slots.map(s => s.product.name).join(", ");

  return `
${genderEn}, height around ${height} cm, weight around ${weight} kg, ${bodyTypeDesc}.
Generate a full-body view.

Clothing items:
${itemsText}

Style: UNIQLO lookbook style, realistic but clean and simple.
Neutral light background, soft natural light.
No visible logos or brand names.
Clearly show the proportions of the body (height and body type) and how the outfit fits.
      `.trim();
}


    // ===== 9. å‘¼å«å¾Œç«¯ï¼šå¯¦éš›ç”¢åœ– =====
    async function callGenerateImage(outfitPrompt, gender, age, style, temp) {
      const btn = document.getElementById("generate-btn");
      const updateBtn = document.getElementById("update-image-btn");
      const status = document.getElementById("status");
      const img = document.getElementById("outfit-image");
      const placeholder = document.getElementById("image-placeholder");

      btn.disabled = true;
      if (updateBtn) updateBtn.disabled = true;
      status.className = "status-text loading";

      const usage = getUsage();
      if (usage.count >= DAILY_LIMIT) {
        status.textContent = `ä»Šå¤©è©¦ç”¨æ¬¡æ•¸å·²é” ${DAILY_LIMIT} æ¬¡ï¼Œä¸Šé™å·²æ»¿ï¼Œæ˜å¤©å†è©¦ âœ¨`;
        btn.disabled = false;
        if (updateBtn) updateBtn.disabled = false;
        return;
      }

      try {
        const response = await fetch("/api/generate-image", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gender, age, style, temp, outfitPrompt })
        });

        if (!response.ok) {
          const txt = await response.text();
          console.error("API error:", txt);
          throw new Error("API å›æ‡‰å¤±æ•—ï¼š" + response.status);
        }

        const data = await response.json();
        if (!data.image) {
          throw new Error("API æ²’æœ‰å›å‚³åœ–ç‰‡è³‡æ–™");
        }

        const newUsage = incrementUsage();

        img.src = "data:image/png;base64," + data.image;
        img.style.display = "block";
        if (placeholder) placeholder.style.display = "none";

        status.textContent = `AI ç©¿æ­ç¤ºæ„åœ–å·²ç”Ÿæˆï¼ï¼ˆä»Šå¤©å·²ç”¨ ${newUsage.count}/${DAILY_LIMIT} æ¬¡ï¼‰`;
        status.className = "status-text done";

        if (updateBtn) updateBtn.disabled = false;
      } catch (err) {
        console.error(err);
        status.textContent = "ç”¢ç”Ÿåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
        status.className = "status-text error";
        if (updateBtn) updateBtn.disabled = false;
      } finally {
        btn.disabled = false;
      }
    }

    // ===== 10. ä¸»æŒ‰éˆ•ï¼šç”¢ç”Ÿä¸€æ•´å¥—ç©¿æ­ + åœ–ç‰‡ =====
    async function generateOutfit() {
      const btn = document.getElementById("generate-btn");
      const status = document.getElementById("status");

      const gender = document.getElementById("gender").value;
      const age = parseInt(document.getElementById("age").value, 10);
      const height = parseInt(document.getElementById("height").value, 10);
      const weight = parseInt(document.getElementById("weight").value, 10);
      const style = document.getElementById("style").value;
      const temp = parseInt(document.getElementById("temp-range").value, 10);

      const extras = {
        hat: document.getElementById("extra-hat").checked,
        bag: document.getElementById("extra-bag").checked,
        outer: document.getElementById("extra-outer").checked,
        accessory: document.getElementById("extra-accessory").checked
      };

      const usage = getUsage();
      if (usage.count >= DAILY_LIMIT) {
        status.textContent = `ä»Šå¤©è©¦ç”¨æ¬¡æ•¸å·²é” ${DAILY_LIMIT} æ¬¡ï¼Œä¸Šé™å·²æ»¿ï¼Œæ˜å¤©å†è©¦ âœ¨`;
        status.className = "status-text error";
        return;
      }

      btn.disabled = true;
      status.textContent = `æ­£åœ¨ç”¢ç”Ÿ AI ç©¿æ­ç¤ºæ„åœ–...ï¼ˆä»Šå¤©å·²ç”¨ ${usage.count}/${DAILY_LIMIT} æ¬¡ï¼‰`;
      status.className = "status-text loading";

      // å…ˆé¸ä¸€å¥—å•†å“
      const selectedProducts = pickProducts(gender, style, temp, extras);
      currentOutfitSlots = buildOutfitSlots(selectedProducts);
      renderProducts(selectedProducts);
      renderOutfitOverlay(currentOutfitSlots);

      // æ–‡å­—èªªæ˜
      const styleTextMap = {
        casual: "ä¼‘é–’æ—¥å¸¸",
        minimal: "æ¥µç°¡é€šå‹¤",
        street: "è¡—é ­é¢¨",
        sporty: "é‹å‹•é¢¨",
        smart: "Smart Casual"
      };
      const genderTextMap = {
        female: "å¥³æ€§",
        male: "ç”·æ€§",
        neutral: "ä¸­æ€§é¢¨æ ¼"
      };
      const styleText = styleTextMap[style] || "æ—¥å¸¸ç©¿æ­";
      const genderText = genderTextMap[gender] || "ä¸æ‹˜";
      const outfitItemsText = selectedProducts.map(p => p.name).join("ã€");

      const desc = `
${temp}Â°C å·¦å³çš„å¤©æ°£ï¼Œé©åˆ${genderText}ã€ç´„ ${age} æ­²ã€èº«é«˜ç´„ ${height} cmã€é«”é‡ç´„ ${weight} kgï¼Œåå‘ã€Œ${styleText}ã€çš„æ­é…ã€‚
é€™å¥—ç¤ºæ„å¯æƒ³åƒæˆï¼šã€Œ${outfitItemsText}ã€é€™é¡çµ„åˆï¼Œç”± AI ä»¥ UNIQLO Lookbook é¢¨æ ¼å‘ˆç¾ã€‚
      `.trim();
      document.getElementById("outfit-desc").textContent = desc;

      // çµ„ prompt & call å¾Œç«¯
      const outfitPrompt = buildOutfitPromptFromSlots(
        currentOutfitSlots,
        gender,
        style,
        temp,
        height,
        weight
      );

      await callGenerateImage(outfitPrompt, gender, age, style, temp);
    }

    // ===== 11. å±€éƒ¨æ›ä¸€ä»¶ï¼šåªæ›æŸ slotï¼Œä¸é¦¬ä¸Šé‡ç•«åœ– =====
    function replaceSingleItem(slot) {
      const status = document.getElementById("status");
      const gender = document.getElementById("gender").value;
      const style = document.getElementById("style").value;
      const temp = parseInt(document.getElementById("temp-range").value, 10);

      const pool = products.filter(p => {
        const genderMatch = p.gender === "unisex" || p.gender === gender;
        const styleMatch = p.styles.includes(style);
        return genderMatch && styleMatch && p.type === slot;
      });

      if (pool.length === 0 || !currentOutfitSlots.length) return;

      const current = currentOutfitSlots.find(s => s.slot === slot)?.product;
      let candidate = pool[Math.floor(Math.random() * pool.length)];

      let guard = 0;
      while (current && candidate.id === current.id && guard < 5) {
        candidate = pool[Math.floor(Math.random() * pool.length)];
        guard++;
      }

      currentOutfitSlots = currentOutfitSlots.map(s =>
        s.slot === slot ? { slot, product: candidate } : s
      );

      const updatedProducts = currentOutfitSlots.map(s => s.product);
      renderOutfitOverlay(currentOutfitSlots);
      renderProducts(updatedProducts);

      status.textContent = "å·²æ›´æ–°éƒ¨åˆ†å–®å“ï¼Œå¦‚éœ€åŒæ­¥åœ–ç‰‡ï¼Œè«‹æŒ‰ä¸‹ã€Œæ›´æ–°ç¤ºæ„åœ–ã€ã€‚";
      status.className = "status-text";
      const updateBtn = document.getElementById("update-image-btn");
      if (updateBtn) updateBtn.disabled = false;
    }

    // ===== 12. æ›´æ–°ç¤ºæ„åœ–ï¼šä½¿ç”¨ç›®å‰ slots é‡ç•«ä¸€æ¬¡ =====
    async function updateImageFromCurrentOutfit() {
      const status = document.getElementById("status");
      const gender = document.getElementById("gender").value;
      const age = parseInt(document.getElementById("age").value, 10);
      const height = parseInt(document.getElementById("height").value, 10);
      const weight = parseInt(document.getElementById("weight").value, 10);
      const style = document.getElementById("style").value;
      const temp = parseInt(document.getElementById("temp-range").value, 10);

      if (!currentOutfitSlots || currentOutfitSlots.length === 0) {
        status.textContent = "å°šæœªç”¢ç”Ÿä»»ä½•ç©¿æ­ï¼Œè«‹å…ˆæŒ‰ã€Œç”¢ç”Ÿç©¿æ­ç¤ºæ„åœ–ã€ã€‚";
        status.className = "status-text error";
        return;
      }

      const usage = getUsage();
      if (usage.count >= DAILY_LIMIT) {
        status.textContent = `ä»Šå¤©è©¦ç”¨æ¬¡æ•¸å·²é” ${DAILY_LIMIT} æ¬¡ï¼Œä¸Šé™å·²æ»¿ï¼Œæ˜å¤©å†è©¦ âœ¨`;
        status.className = "status-text error";
        return;
      }

      const outfitPrompt = buildOutfitPromptFromSlots(
        currentOutfitSlots,
        gender,
        style,
        temp,
        height,
        weight
      );

      status.textContent = `æ­£åœ¨ä¾ç…§ç›®å‰å–®å“é‡æ–°æ›´æ–°ç¤ºæ„åœ–...ï¼ˆä»Šå¤©å·²ç”¨ ${usage.count}/${DAILY_LIMIT} æ¬¡ï¼‰`;
      status.className = "status-text loading";

      await callGenerateImage(outfitPrompt, gender, age, style, temp);
    }

    // æŠŠ replaceSingleItem / updateImageFromCurrentOutfit æ›åˆ° windowï¼Œè®“ HTML onclick ç”¨å¾—åˆ°
    window.replaceSingleItem = replaceSingleItem;
    window.updateImageFromCurrentOutfit = updateImageFromCurrentOutfit;

    async function updateOverlayPositionsFromPose() {
  const img = document.getElementById("outfit-image");
  if (!img || !img.complete || img.naturalWidth === 0) return;
  if (!currentOutfitSlots || !currentOutfitSlots.length) return;

  try {
    const detector = await initPoseDetector();
    if (!detector) return;

    const poses = await detector.estimatePoses(img);
    if (!poses || !poses.length) {
      console.warn("No pose detected");
      return;
    }

    const keypoints = {};
    poses[0].keypoints.forEach(k => {
      if (k.name) keypoints[k.name] = k;
    });

    const imgH = img.naturalHeight || img.clientHeight || 1;
    const toPercent = y =>
      Math.max(0, Math.min(100, (y / imgH) * 100));

    const pos = {};

    // é ­éƒ¨ï¼ˆå¸½å­ï¼‰
    if (keypoints.nose) {
      const y = keypoints.nose.y - imgH * 0.18;
      pos.hat = { top: toPercent(y), side: "left" };
    }

    // è‚©è†€é™„è¿‘ï¼ˆä¸Šèº« / å¤–å¥—ï¼‰
    if (keypoints.left_shoulder && keypoints.right_shoulder) {
      const yShoulder =
        (keypoints.left_shoulder.y + keypoints.right_shoulder.y) / 2;
      pos.top = { top: toPercent(yShoulder), side: "right" };
      pos.outer = { top: toPercent(yShoulder + imgH * 0.05), side: "left" };
    }

    // è‡€éƒ¨é™„è¿‘ï¼ˆä¸‹èº« / åŒ…åŒ…ï¼‰
    if (keypoints.left_hip && keypoints.right_hip) {
      const yHip = (keypoints.left_hip.y + keypoints.right_hip.y) / 2;
      pos.bottom = { top: toPercent(yHip + imgH * 0.08), side: "left" };
      pos.bag = { top: toPercent(yHip), side: "right" };
    }

    // è…³è¸é™„è¿‘ï¼ˆé‹å­ / å…¶ä»–é…ä»¶ï¼‰
    if (keypoints.left_ankle && keypoints.right_ankle) {
      const yAnkle =
        (keypoints.left_ankle.y + keypoints.right_ankle.y) / 2;
      pos.shoes = { top: toPercent(yAnkle + imgH * 0.04), side: "right" };
      pos.accessory = {
        top: toPercent(yAnkle - imgH * 0.08),
        side: "right"
      };
    }

    dynamicSlotPositions = pos;
    // ç”¨æ–°çš„ä½ç½®é‡ç•« overlay
    renderOutfitOverlay(currentOutfitSlots);
  } catch (err) {
    console.warn("Pose detection failed:", err);
  }
}
// åœ–ç‰‡è¼‰å…¥å®Œæˆæ™‚ï¼Œè‡ªå‹•ä¾æ“šå§¿å‹¢é‡æ–°å®šä½æ¨™ç±¤
window.addEventListener("load", () => {
  const img = document.getElementById("outfit-image");
  if (!img) return;
  img.addEventListener("load", () => {
    updateOverlayPositionsFromPose();
  });
});

  </script>
</body>
</html>
