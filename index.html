

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>findoutfit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>

    :root{
      --bg:#FBF7F1;         /* warm cream */
      --card:#FFFFFF;
      --text:#221F1A;       /* cocoa ink */
      --muted:#6B625B;
      --line:#E6D9CC;
      --brand:#2C241F;      /* espresso primary */
      --accent:#C96A5A;     /* terracotta accent */
      --ok:#16a34a;
      --warn:#ef4444;
      --shadow:0 12px 30px rgba(44,36,31,.10);
      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #FFF3E8 0, var(--bg) 45%, var(--bg) 100%);
    }
    a{ color:inherit }
    .skel { position: relative; overflow: hidden; background: #f3f4f6; border-radius: 14px; border: 1px solid #eef0f3; }
    .skel::after{ content:""; position:absolute; inset:0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%); transform:translateX(-120%); animation: skelmove 1.15s infinite; }
    @keyframes skelmove { 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }
    .form-disabled { pointer-events:none; opacity:.6; }
    .img-skel-wrap{ width:100%; height:100%; padding:14px; display:flex; flex-direction:column; gap:12px; justify-content:flex-start; }
    .img-skel-line{ height:14px; border-radius:999px }
    .img-skel-block{ height:100%; min-height:220px; border-radius:18px; flex: 1 1 auto; }
    .products-skel{ display:flex; flex-direction:column; gap:10px; }
    .products-skel .row{ display:grid; grid-template-columns:60px 1fr; gap:10px; }
    .products-skel .thumb{ width:60px; height:60px; border-radius:12px }
    .products-skel .t1{ height:14px; border-radius:999px; width:75% }
    .products-skel .t2{ height:12px; border-radius:999px; width:45%; margin-top:8px }
    .page{max-width:1280px;margin:0 auto;padding:16px 14px 40px}

    /* Header re-layout (1236) */
    header{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding:12px 10px 14px; }
    .brand{ display:flex; gap:10px; align-items:center; min-width:0; }
    .brand-dot{ width:28px;height:28px;border-radius:999px; background: linear-gradient(135deg, var(--brand), var(--brand)); box-shadow:0 10px 20px rgba(0,0,0,.2); flex:0 0 auto; }
    .brand-text{min-width:0}
    .title{font-size:20px;font-weight:900;letter-spacing:.02em; line-height:1.15}
    .subtitle{color:var(--muted);font-size:12px;margin-top:6px; line-height:1.35; max-width: 520px}
    .top-right{ display:flex; align-items:center; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .auth-chip{ display:flex; flex-direction:column; align-items:flex-end; gap:2px; padding:8px 10px; border-radius:14px; border:1px solid #eef0f3; background:rgba(255,255,255,.75); backdrop-filter: blur(8px); box-shadow: 0 10px 22px rgba(0,0,0,.06); max-width:min(56vw, 320px); }
    .auth-chip .line1{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; text-align:right; }
    .auth-chip .line2{ font-size:12px; color:var(--muted); }
    .auth-chip b{color:var(--text)}
    .btn{ border:none;cursor:pointer;border-radius:999px; padding:10px 14px;font-weight:900;background:var(--brand);color:#fff; box-shadow:0 10px 20px rgba(0,0,0,.18); transition:transform .1s ease, opacity .1s ease;white-space:nowrap; }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:900}

    .layout{ display:grid; grid-template-columns: minmax(320px, 0.9fr) minmax(0, 1.6fr); gap:16px; align-items:start; }
    @media (max-width: 980px){
    .layout{grid-template-columns:1fr}
}

.card{ background:var(--card); border-radius:var(--r-lg); box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.04); padding:16px; }
    .pill{ display:inline-flex;align-items:center;gap:6px; padding:6px 10px;border-radius:999px; font-size:12px;color:var(--muted); background:#f3f4f6;border:1px solid #eef0f3; }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}

    .section-block{ padding:12px; border:1px solid var(--line); border-radius:16px; background:linear-gradient(135deg,#fff,#fafafa); margin-bottom:8px; }
    .section-head{ display:flex;align-items:center;justify-content:space-between; gap:10px;margin-bottom:10px; }
    .section-head .stitle{ font-weight:900; font-size:14px; color:var(--brand); display:flex; align-items:center; gap:8px; }
    .tag{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #eef0f3; background:#fff; color:var(--muted); white-space:nowrap; }

    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px 12px; align-items:flex-start; }
    @media (max-width: 560px){ .form-grid{grid-template-columns:1fr} }
    label{ display:block;font-size:12px;font-weight:900; margin:0 0 6px 0;color:var(--brand); }
    input, select{ width:100%;padding:8px 10px;border-radius:12px; border:1px solid var(--line);background:#fafafa;outline:none;font-size:14px; }
    input:focus, select:focus{ background:#fff;border-color:var(--accent); box-shadow:0 0 0 3px rgba(201,106,90,.18); }

    .slider-group{ padding:8px;border-radius:14px;border:1px solid var(--line);background:#fafafa; }
    .slider-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px}
    .slider-head .label{font-size:12px;font-weight:900;color:var(--brand)}
    .value-chip{ display:inline-flex;align-items:baseline;gap:6px; padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eef0f3; font-size:12px;color:var(--muted);white-space:nowrap; }
    .value-chip b{color:var(--brand);font-weight:900}
    input[type="range"]{ width:100%; padding:0; border:none; background:transparent; accent-color:var(--brand); height:26px; }
    .range-sub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}
/* âœ… Segmented (Gender) */
.visually-hidden{
  position:absolute !important;
  width:1px;height:1px;
  padding:0;margin:-1px;
  overflow:hidden;clip:rect(0,0,0,0);
  white-space:nowrap;border:0;
}
.segmented{
  display:flex;
  gap:8px;
  padding:6px;
  border-radius:14px;
  border:1px solid var(--line);
  background:#fafafa;
}
.seg-btn{
  flex:1;
  border:none;
  cursor:pointer;
  border-radius:12px;
  padding:9px 10px;
  font-weight:900;
  background:#fff;
  color:var(--brand);
  transition:transform .1s ease, opacity .1s ease, box-shadow .12s ease;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
}
.seg-btn:active{transform:translateY(1px);opacity:.94}
.seg-btn.selected,.seg-btn.on{
  background:var(--brand);
  color:#fff;
  box-shadow:0 10px 20px rgba(44,36,31,.12);
}


/* Age group segmented: slightly more compact */
#agegroup-seg .seg-btn{padding:8px 10px}
#agegroup-seg .seg-sub{font-size:11px}
.seg-btn.on{
  background:var(--brand) !important;
  color:#fff !important;
  border-color:var(--brand) !important;
}
.seg-btn.on *{
  color:#fff !important;
}


/* âœ… Range thumb bigger (drag easier) */
input[type="range"]{ -webkit-appearance:none; appearance:none; }
input[type="range"]::-webkit-slider-runnable-track{
  height:6px;border-radius:999px;background:#e5e7eb;
}
input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance:none; appearance:none;
  width:22px;height:22px;border-radius:999px;
  background:var(--brand);border:3px solid #fff;
  margin-top:-8px;
  box-shadow:0 4px 10px rgba(0,0,0,.18);
}
input[type="range"]::-moz-range-track{
  height:6px;border-radius:999px;background:#e5e7eb;
}
input[type="range"]::-moz-range-thumb{
  width:22px;height:22px;border-radius:999px;
  background:var(--brand);border:3px solid #fff;
  box-shadow:0 4px 10px rgba(0,0,0,.18);
}


    .style-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    @media (max-width:560px){ .style-grid{grid-template-columns:1fr 1fr} }
    .style-card{ border:1px solid var(--line); background:#fff; border-radius:16px; padding:12px 12px; cursor:pointer; user-select:none; transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease; display:flex; flex-direction:column; gap:6px; min-height:76px; }
    .style-card:active{transform:translateY(1px)}
    .style-card .name{font-weight:900;font-size:14px;color:var(--brand)}
    .style-card .desc{font-size:12px;color:var(--muted);line-height:1.4}
    .style-card.selected{ border-color:var(--brand); box-shadow:0 10px 20px rgba(44,36,31,.12); }
    .style-card .chip{ align-self:flex-start; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #eef0f3; background:#f9fafb; color:var(--brand); font-weight:900; }

    .toggle-list{ margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden; }
    .toggle-item{ display:flex;justify-content:space-between;align-items:center; padding:12px 12px;border-top:1px solid var(--line); }
    .toggle-item:first-child{border-top:none}
    .toggle-item .left{display:flex;flex-direction:column;gap:0px}
    .toggle-item .name{font-weight:900;font-size:14px}
    .toggle-item .desc{font-size:12px;color:var(--muted)}
    .switch{ width:44px;height:24px;border-radius:999px;background:#e5e7eb; position:relative;cursor:pointer;flex:0 0 auto; }
    .switch::after{ content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px; background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.18);transition:transform .15s ease; }
    .switch.on{background:var(--brand)}
    .switch.on::after{transform:translateX(20px)}

    .primary-wide{ width:100%; margin-top:12px; padding:14px 14px; border-radius:14px; font-size:15px; font-weight:900; background:var(--brand); color:#fff; border:none; cursor:pointer; }
    .primary-wide:disabled{opacity:.55;cursor:default}

    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .hint.error{color:var(--warn);font-weight:900}

    .right-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .right-head h3{margin:0;font-size:18px;font-weight:900}
    .debug-toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none;cursor:pointer}

    .preview-wrap{ border:1px solid var(--line); border-radius:18px; background:linear-gradient(125deg,#FFF3EC,#f9fbff); padding:12px; }
    .preview-inner{ width:100%; max-width:450px; aspect-ratio: 9 / 16; height:auto; margin:0 auto; border-radius:16px; background:#fff; border:1px solid #f0f0f5; display:flex;align-items:center;justify-content:center; overflow:hidden;position:relative; }
    img#outfit-image{ width:100%; height:100%; object-fit:contain; display:none; cursor: zoom-in; }
    .placeholder{text-align:center;color:var(--muted);font-size:14px;padding:20px}

    .preview-tools{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5; }
    .tool-btn{ display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(229,231,235,.95); background:rgba(255,255,255,.92); padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:900; font-size:12px; color:var(--brand); backdrop-filter: blur(6px); }
    .tool-btn:disabled{opacity:.55; cursor:default}
    .tool-btn .icon{font-size:14px}
    .tool-btn.fav.on{ border-color:#fecaca; background:rgba(255,245,245,.92); color:#ef4444; }

    .section-title{margin:14px 0 8px;display:flex;gap:8px;align-items:center}
    .section-title .pill{font-weight:900}

    .products{ border:1px solid var(--line); border-radius:18px; padding:12px;background:#fff; min-height:160px; }

    .slot-group{ border:1px solid #f1f2f4; background:#fafafa; border-radius:16px; padding:10px; margin-bottom:10px; }
    .slot-group:last-child{margin-bottom:0}
    .slot-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .slot-title{ font-weight:900; color:var(--brand); font-size:14px; display:flex; align-items:center; gap:8px; }
    .slot-count{ font-size:12px; color:var(--muted); border:1px solid #eef0f3; background:#fff; padding:4px 8px; border-radius:999px; white-space:nowrap; }

    .product-item{ display:grid;grid-template-columns:60px 1fr;gap:10px;padding:10px;border-radius:14px; background:#fff;border:1px solid #f1f2f4;margin-bottom:10px; }
    .product-item:last-child{margin-bottom:0}
    .thumb{ width:60px;height:60px;border-radius:12px;background:#fff;border:1px solid #eee; display:flex;align-items:center;justify-content:center;overflow:hidden;color:var(--muted);font-size:12px; }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pname{font-weight:900;font-size:14px;margin:0 0 4px}
    .pmeta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .plink{font-size:12px;color:var(--accent);text-decoration:none;font-weight:900}
    .plink:hover{text-decoration:underline}

    .statusbar{margin-top:10px;font-size:12px;color:var(--muted)}
    .statusbar .ok{color:var(--ok);font-weight:900}
    .statusbar .bad{color:var(--warn);font-weight:900}
    .progress{ margin-top:8px; height:8px; border-radius:999px; background:#eef0f3; overflow:hidden; border:1px solid #e9ecf1; }
    .progress > div{ height:100%; width:0%; background:var(--brand); transition:width .25s ease; }

    .dots{ display:inline-flex; gap:3px; vertical-align:middle; margin-left:6px; }
    .ldot{ width:5px;height:5px;border-radius:999px;background:var(--muted); opacity:.3; animation:blink 1s infinite; }
    .ldot:nth-child(2){animation-delay:.15s}
    .ldot:nth-child(3){animation-delay:.3s}
    @keyframes blink{ 0%,100%{opacity:.25;transform:translateY(0)} 50%{opacity:.9;transform:translateY(-1px)} }

    .shimmer{ position:relative; overflow:hidden; border-radius:16px; }
    .shimmer::after{ content:""; position:absolute;inset:0; background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%); transform:translateX(-120%); animation:shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }

    .debug{ margin-top:12px;display:none; border:1px dashed #d1d5db;background:#fff;border-radius:14px; padding:10px;font-size:12px;color:var(--brand); max-height:280px;overflow:visible;white-space:pre-wrap; }
    .debug.on{display:block}

    .outfit-summary { margin-top: 14px; background: #fafafa; border: 1px solid #e5e7eb; }
    .summary-head { display: flex; align-items: center; gap: 8px; font-weight: 900; font-size: 14px; margin-bottom: 6px; }
    .summary-icon { font-size: 18px; }
    .summary-title { color: var(--brand); }
    .summary-text { font-size: 14px; line-height: 1.6; color: #374151; }

    .action-row{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .mini-btn{ border:1px solid var(--line); background:#fff; color:var(--brand); padding:9px 12px; border-radius:999px; cursor:pointer; font-weight:900; font-size:13px; }
    .mini-btn:disabled{opacity:.55; cursor:default}
    .mini-btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .mini-btn.danger{ background:#fff; color:#ef4444; border-color:#fecaca; }
    .mini-hint{ font-size:12px; color:var(--muted); }

    .collection-wrap{ margin-top:12px; border:1px solid var(--line); border-radius:18px; overflow:hidden; background:#fff; }
    .tabs{ display:flex; gap:0; border-bottom:1px solid var(--line); background:#fafafa; }
    .tab{ flex:1; padding:10px 12px; font-weight:900; font-size:13px; cursor:pointer; border:none; background:transparent; color:#6b7280; }
    .tab.active{ color:var(--brand); background:#fff; }
    .tabpanes{ padding:10px; }
    .pane{ display:none; }
    .pane.active{ display:block; }

    .mini-list{ display:flex; flex-direction:column; gap:10px; }
    .mini-card{ display:grid; grid-template-columns:68px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid #eef0f3; border-radius:14px; background:#fafafa; }
    .mini-thumb{ width:68px; aspect-ratio: 9/16; border-radius:12px; overflow:hidden; border:1px solid #eee; background:#fff; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:12px; }
    .mini-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini-info .t{ font-weight:900; font-size:13px; margin:0 0 4px; color:var(--brand); }
    .mini-info .m{ font-size:12px; color:#6b7280; line-height:1.35; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
    .mini-actions{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
    .chip-btn{ border:1px solid #e5e7eb; background:#fff; padding:7px 10px; border-radius:999px; cursor:pointer; font-weight:900; font-size:12px; color:var(--brand); white-space:nowrap; }
    .chip-btn.danger{ color:#ef4444; border-color:#fecaca; }
    .mini-empty{ padding:14px; color:#6b7280; font-size:12px; background:#fff; border:1px dashed #e5e7eb; border-radius:14px; }

    @media (min-width: 1024px) {
      .layout { overflow: visible; }
      .left-panel { position: sticky; top: 18px; align-self: flex-start; max-height: calc(100vh - 24px); overflow-y: auto; padding-right: 6px; }
      .left-panel.card { padding: 14px; }
      .left-panel .row { margin-bottom: 8px; }
      .left-panel .form-grid { gap: 8px 10px; }
      .left-panel label { margin-bottom: 4px; font-size: 12px; }
      .left-panel input, .left-panel select { padding: 8px 10px; }
      .left-panel .toggle-list { margin-top: 8px; }
      .left-panel .toggle-item { padding: 10px 10px; }
      .left-panel .sticky-generate { position: sticky; bottom: 0; padding-top: 10px; background: linear-gradient(to top, #fff 60%, rgba(255,255,255,0)); z-index: 5; }
      .preview-inner { max-height: 70vh; }
    }

    @media (max-width: 640px){
      .page{ padding:14px 12px calc(104px + var(--safe-b)); }
      header{ grid-template-columns: 1fr; gap:10px; padding:10px 6px 10px; align-items:flex-start; }
      .brand-dot{ width:24px; height:24px; }
      .title{ font-size:18px; }
      .subtitle{ display:none; }
      .top-right{ width:100%; justify-content:space-between; gap:10px; }
      .auth-chip{ flex:1 1 auto; align-items:flex-start; max-width:none; }
      .auth-chip .line1{ text-align:left; }
      .btn{ padding:9px 12px; font-size:13px; }
      .card{ padding:14px; border-radius:16px; }
      .toggle-item{ padding:12px 10px; }
      .style-card{ min-height:72px; padding:12px; }
      .products{ padding:10px; }
      .product-item{ padding:10px; }
      .mobile-actionbar{ display:block;
  position: fixed; left: 12px; right: 12px; bottom: calc(14px + var(--safe-b)); z-index: 9999; pointer-events:none; }
      .mobile-actionbar .primary-wide{ width:100%; height:54px; font-size:16px; border-radius:16px; box-shadow:0 18px 38px rgba(0,0,0,.18); pointer-events:auto; }
      .left-panel .sticky-generate{ display:none; }
      .anchor { scroll-margin-top: 12px; }
.mobile-actionbar{display:none;}

    }

    .anchor { scroll-margin-top: 12px; }

    .modal{ position:fixed; inset:0; z-index: 10000; background: rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding: 14px; }
    .modal.on{ display:flex; }
    .modal-card{ width: min(520px, 100%); aspect-ratio: 9/16; background:var(--brand); border-radius: 18px; overflow:hidden; position:relative; box-shadow: 0 30px 70px rgba(0,0,0,.35); }
    .modal-card img{ width:100%; height:100%; object-fit:contain; display:block; background:#0b1020; }
    .modal-top{ position:absolute; top:10px; left:10px; right:10px; display:flex; justify-content:space-between; gap:10px; pointer-events:none; }
    .modal-top .m-btn{ pointer-events:auto; border:none; cursor:pointer; background: rgba(255,255,255,.12); color:#fff; padding:9px 12px; border-radius: 999px; font-weight:900; font-size:12px; backdrop-filter: blur(8px); }
    .modal-top .m-btn:active{ transform: translateY(1px); opacity:.95; }

    .status-sub{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.4; }
    .result-meta{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid #eef0f3; background:linear-gradient(135deg,#fff,#fafafa); border-radius:16px; margin:10px 0 14px; }
    .rm-left{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; color:var(--muted); line-height:1.3; }
    .rm-left b{ color:var(--brand); }
    .rm-dot{ opacity:.5; }
    .rm-actions{ display:flex; gap:8px; flex:0 0 auto; }
    .cta-row{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(90px + var(--safe-b)); z-index:1200; background:rgba(44,36,31,.92); color:#fff; padding:10px 12px; border-radius:999px; font-size:13px; font-weight:900; box-shadow:0 18px 38px rgba(0,0,0,.22); max-width:min(92vw,520px); text-align:center; opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; }
    .toast.on{ opacity:1; transform:translateX(-50%) translateY(-2px); }
    .newbie-tip{ margin:10px 0 6px; padding:10px 12px; border-radius:14px; border:1px solid #eef0f3; background:#fff; color:var(--muted); font-size:12px; line-height:1.5; }
    .newbie-tip b{ color:var(--brand); }
  
    /* === UI fixes (2026-01) === */
    /* Gender segmented: match style-card logic (bold, clean, consistent) */
    .segmented{
      display:flex;
      gap:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:8px;
    }
    .seg-btn{
      flex:1;
      border:1px solid transparent;
      background:#fafafa;
      border-radius:14px;
      padding:9px 10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease, background .08s ease;
    }
    .seg-btn:active{ transform:translateY(1px); }
    .seg-btn .seg-main{ font-weight:900; font-size:14px; color:var(--brand); }
    .seg-btn .seg-sub{ font-weight:800; font-size:11px; color:var(--muted); letter-spacing:.02em; }
.seg-btn.on .seg-main{ color:#fff; }
.seg-btn.on .seg-sub{ color: rgba(255,255,255,.82); }

    .seg-btn.on{
      background:#fff;
      border-color:var(--brand);
      box-shadow:0 10px 20px rgba(44,36,31,.12);
    }

    /* Compact sliders (reduce height) */
    .slider-group{
      padding:8px;
      border-radius:14px;
    }
    .slider-head{ margin-bottom:6px; }
    .value-chip{ padding:5px 8px; font-size:12px; }
    .range-sub{ margin-top:2px; font-size:10px; }

    /* Bigger thumb + better track (override earlier range styles) */
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      height:28px;
      background:transparent;
      border:none;
      padding:0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:6px;
      border-radius:999px;
      background:#d1d5db;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:28px;height:28px;
      border-radius:999px;
      background:var(--brand);
      border:4px solid #fff;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
      margin-top:-11px;
    }
    input[type="range"]::-moz-range-track{
      height:6px;border-radius:999px;background:#d1d5db;
    }
    input[type="range"]::-moz-range-thumb{
      width:28px;height:28px;border-radius:999px;
      background:var(--brand);border:4px solid #fff;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
    }

    /* Hide admin-only helper text under accessories */
    .toggle-item .desc{ display:none !important; }

 
/* âœ… Force desktop/mobile behavior via JS class (prevents wrong breakpoint) */
body.is-desktop .layout{ grid-template-columns: minmax(320px, 0.9fr) minmax(0, 1.6fr); }
body.is-desktop #mobile-actionbar{ display:none !important; }
body.is-mobile .layout{ grid-template-columns: 1fr; }
body.is-mobile #mobile-actionbar{ display:block !important; }
 

  .ghost-btn{border:1px solid rgba(0,0,0,.12); background:transparent; border-radius:12px; padding:10px 12px; font-weight:600;}
  .ghost-btn:disabled{opacity:.5;}
</style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-dot" aria-hidden="true"></div>
        <div class="brand-text">
          <div class="title" id="copy-brand-title">findoutfit</div>
          <div class="subtitle" id="copy-brand-subtitle">è¼¸å…¥æ¢ä»¶â†’ outfitç”Ÿæˆ â†’ å•†å“æ¨è–¦</div>
        </div>
      </div>

      <div class="top-right">
        <div class="auth-chip" aria-label="ç™»å…¥èˆ‡é»æ•¸">
          <div class="line1" id="login-status">æœªç™»å…¥</div>
          <div class="line2">é»æ•¸ï¼š<b><span id="credits">â€”</span></b> <span id="auth-hint" style="margin-left:6px;"></span></div>
        </div>
        <button id="login-btn" class="btn">Google ç™»å…¥</button>
        <button id="logout-btn" class="btn secondary" style="display:none;">ç™»å‡º</button>
      </div>
    </header>

    <main class="layout">
      <section class="card left-panel" id="left-panel">
        <div class="row">
          <h3 style="margin:0"><span id="copy-left-title">ç©¿æ­æ¢ä»¶</span></h3>
          <span class="pill">æ‰£ 1 é» / æ¬¡</span>
        </div>

        <div class="section-block">
  <div class="section-head">
    <div class="stitle">â‘  åŸºæœ¬è³‡æ–™ </div>
  </div>

  <div class="form-grid">
    <div class="seg-group">
      <label>æ€§åˆ¥</label>
      <div class="segmented" id="gender-seg" role="radiogroup" aria-label="æ€§åˆ¥">
        <button type="button" class="seg-btn" data-value="female" role="radio" aria-checked="true">å¥³</button>
        <button type="button" class="seg-btn" data-value="male" role="radio" aria-checked="false">ç”·</button>
        <button type="button" class="seg-btn" data-value="neutral" role="radio" aria-checked="false">ä¸­æ€§</button>
      </div>
      <input type="hidden" id="gender" value="female" />
    </div>

    <div class="seg-group">
      <label>é¡åˆ¥</label>
      <div class="segmented agegroup-seg" id="agegroup-seg" role="radiogroup" aria-label="é¡åˆ¥">
        <button type="button" class="seg-btn" data-value="adult" role="radio" aria-checked="true">
          <div class="seg-title">æˆäºº</div>
          <div class="seg-sub">13â€“70</div>
        </button>
        <button type="button" class="seg-btn" data-value="kids" role="radio" aria-checked="false">
          <div class="seg-title">ç«¥è£</div>
          <div class="seg-sub">4â€“12</div>
        </button>
      </div>
      <input type="hidden" id="ageGroup" value="adult" />
    </div>

    <div class="slider-group" style="grid-column:1/-1">
      <div class="slider-head">
        <div class="label">å¹´é½¡</div>
        <div class="value-chip"><b id="age-val">25</b> æ­²</div>
      </div>
      <input id="age" type="range" min="13" max="70" step="1" value="25" aria-label="å¹´é½¡" />
      <div class="range-sub"><span id="age-min">13</span><span id="age-max">70</span></div>
    </div>
<div class="slider-group">
      <div class="slider-head">
        <div class="label">èº«é«˜</div>
        <div class="value-chip"><b id="height-val">165</b> cm</div>
      </div>
      <input id="height" type="range" min="140" max="200" step="1" value="165" aria-label="èº«é«˜" />
      <div class="range-sub"><span id="height-min">140</span><span id="height-max">200</span></div>
    </div>

    <div class="slider-group">
      <div class="slider-head">
        <div class="label">é«”é‡</div>
        <div class="value-chip"><b id="weight-val">55</b> kg</div>
      </div>
      <input id="weight" type="range" min="35" max="120" step="1" value="55" aria-label="é«”é‡" />
      <div class="range-sub"><span id="weight-min">35</span><span id="weight-max">120</span></div>
    </div>

    <div class="slider-group" style="grid-column:1/-1">
      <div class="slider-head">
        <div class="label">æº«åº¦</div>
        <div class="value-chip"><b id="temp-val">22</b> Â°C</div>
      </div>
      <input id="temp" type="range" min="0" max="35" step="1" value="22" aria-label="æº«åº¦" />
      <div class="range-sub"><span>0</span><span>35</span></div>

      <div class="cta-row">
        <button class="mini-btn" id="cta-products" style="display:none;" type="button">çœ‹å•†å“ â†“</button>
        <div class="mini-hint" id="cta-hint" style="display:none;"></div>
      </div>
    </div>
  </div>
</div><div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘¡ é¢¨æ ¼</div>
          </div>

          <!-- é¢¨æ ¼é¡å‹ï¼ˆäº’æ–¥ï¼‰ -->
          <div class="segmented" id="style-source-seg" role="tablist" aria-label="é¢¨æ ¼">
            <button type="button" class="seg-btn on" data-source="scene" role="tab" aria-selected="true">
              <div class="seg-main">ç©¿æ­æƒ…å¢ƒ</div>
              <div class="seg-sub">ä¼‘é–’ / ä¸Šç­ / ç´„æœƒ...</div>
            </button>
            <button type="button" class="seg-btn" data-source="celebrity" role="tab" aria-selected="false">
              <div class="seg-main">åäººéˆæ„Ÿ</div>
              <div class="seg-sub">GD / Jennie / Lisa...</div>
            </button>
          </div>

          <!-- ç¬¬äºŒå±¤é¸é …ï¼ˆä¾ä¸Šæ–¹åˆ‡æ›ï¼‰ -->
          <!-- âœ… ç¬¬äºŒå±¤ä¸æ²å‹•ï¼šç§»é™¤ max-heightï¼Œè®“å®¹å™¨éš¨å…§å®¹è‡ªç„¶é•·é«˜ï¼Œé¿å…å¡ç‰‡æº¢å‡ºå£“åˆ°ä¸‹æ–¹æŒ‰éˆ• -->
          <div class="style-grid" id="style-source-options" style="margin-top:10px;"></div>

          <!-- éš¨æ©Ÿä¸€ä¸‹ï¼ˆç¨ç«‹ä¸»è¡Œç‚ºï¼‰ -->
          <div style="margin-top:10px; display:flex; gap:10px;">
            <button class="primary-wide" id="style-random-btn" type="button" style="flex:1;">éš¨æ©Ÿä¸€ä¸‹</button>
</div>

          <!-- å·²é¸é è¦½ï¼ˆUI-onlyï¼‰ -->
          <div id="style-preview" class="muted" style="margin-top:8px; font-size:12px; opacity:.85;"></div>


          <!-- UI ç‹€æ…‹ï¼ˆæœªä¾†å¯æ˜ å°„åˆ° payloadï¼‰ -->
          <input type="hidden" id="uiStyleSource" value="scene" />
          <input type="hidden" id="uiStyleValue" value="" />

          <!-- ä¿ç•™æ—¢æœ‰é¢¨æ ¼/è®Šé«”æ¬„ä½ï¼ˆéš±è—ï¼‰ï¼Œé¿å…ç ´å£æ—¢æœ‰æµç¨‹ -->
          <div style="display:none;">
            <div class="style-grid" id="style-grid">
            <div class="style-card selected" data-style="casual">
<div class="name">ä¼‘é–’ <span class="en">Casual</span></div>
              <div class="desc">èˆ’æœã€æ—¥å¸¸ã€å¥½æ­é…</div>
            </div>
            <div class="style-card" data-style="minimal">
<div class="name">æ¥µç°¡ <span class="en">Minimal</span></div>
              <div class="desc">ä¹¾æ·¨ä¿è½ã€ä½å½©åº¦</div>
            </div>
            <div class="style-card" data-style="street">
<div class="name">è¡—é ­ <span class="en">Street</span></div>
              <div class="desc">å±¤æ¬¡ã€æ¯”ä¾‹ã€å€‹æ€§</div>
            </div>
            <div class="style-card" data-style="sporty">
<div class="name">é‹å‹• <span class="en">Sporty</span></div>
              <div class="desc">æ©Ÿèƒ½ã€è¼•é¬†ã€å¥½æ´»å‹•</div>
            </div>
            <div class="style-card" data-style="smart" style="grid-column:1/-1">
<div class="name">Smart Casual <span class="en">Smart</span></div>
              <div class="desc">æ­£å¼ä¸€é»ä½†ä¸æ‹˜è¬¹</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>é¢¨æ ¼è®Šé«”ï¼ˆå“ç‰Œ / åäººï¼‰</label>
            <select id="styleVariant">
              <option value="">ï¼ˆä¸ä½¿ç”¨è®Šé«”ï¼‰</option>
              <optgroup label="å“ç‰Œ">
                <option value="brand-uniqlo">UNIQLOï¼ˆæ—¥ç³»åŸºæœ¬ï¼‰</option>
                <option value="brand-muji">MUJIï¼ˆç”Ÿæ´»æ¥µç°¡ï¼‰</option>
                <option value="brand-cos">COSï¼ˆçµæ§‹æ¥µç°¡ï¼‰</option>
                <option value="brand-nike-tech">Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰</option>
                <option value="brand-ader-error">Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰</option>
              </optgroup>
              <optgroup label="åäººï¼ˆé¢¨æ ¼éˆæ„Ÿï¼Œä¸æ¨¡ä»¿è‡‰ï¼‰">
                <option value="celeb-iu-casual">IUï¼ˆéŸ“ç³»æ¸…æ–°ï¼‰</option>
                <option value="celeb-jennie-minimal">Jennieï¼ˆæ¥µç°¡è¾£ï¼‰</option>
                <option value="celeb-gd-street">G-Dragonï¼ˆè¡—é ­å±¤æ¬¡ï¼‰</option>
                <option value="celeb-lisa-sporty">Lisaï¼ˆèˆè€…é‹å‹•ï¼‰</option>
              </optgroup>
            </select>
          </div>

          <input type="hidden" id="style" value="casual" />
          </div>
        </div>
<div class="section-block" style="margin-bottom:0">
          <div class="section-head">
            <div class="stitle">â‘¢ é…ä»¶ </div>
          </div>

          <div class="toggle-list" style="margin-top:0">
            <div class="toggle-item">
              <div class="left">
                <div class="name">åŒ…åŒ…</div>
                
              </div>
              <div class="switch" id="sw-bag" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¸½å­</div>
                
              </div>
              <div class="switch" id="sw-hat" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¤–å¥—</div>
                
              </div>
              <div class="switch" id="sw-coat" role="switch" aria-checked="false"></div>
            </div>
          </div>
        </div>

        <div class="newbie-tip" id="newbie-tip" style="display:none;">é¦–æ¬¡ä½¿ç”¨ï¼šæŒ‰ä¸‹ <b>ã€Œç”¢ç”Ÿç©¿æ­åœ–ã€</b> å¾Œæœƒè‡ªå‹•è·³åˆ°å³å´çµæœï¼ˆç¤ºæ„åœ– â†’ å•†å“ï¼‰ã€‚</div>

        <div class="sticky-generate">
          <button id="go-btn" class="primary-wide">ç”¢ç”Ÿç©¿æ­åœ–</button>
        </div>

        <div class="hint" id="form-hint"></div>
        <div class="hint error" id="error-hint" style="display:none;"></div>
      </section>

      <section class="card">
        <div class="right-head">
          <h3 id="copy-right-title">AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“</h3>
          <div class="debug-toggle" id="debug-toggle">
            <div class="switch" id="sw-debug" aria-checked="false"></div>
            <div>Debug</div>
          </div>
        </div>

        <div class="result-meta" id="result-meta" style="display:none;">
          <div class="rm-left">
            <span id="result-time">â€”</span><span class="rm-dot">â€¢</span>
            <span id="result-summaryline">â€”</span>
          </div>
          <div class="rm-actions">
            <button class="mini-btn" id="copy-spec-btn" disabled>ä¸€éµè¤‡è£½ Outfit Spec</button>
            <button class="mini-btn" id="share-btn" disabled>åˆ†äº«</button>
          </div>
        </div>
        <div class="preview-wrap anchor" id="anchor-preview">
          <div class="preview-inner" id="preview-box">
            <div class="preview-tools">
              <button class="tool-btn" id="btn-fullscreen" title="å…¨è¢å¹•é è¦½" type="button">
                <span class="icon">â›¶</span> å…¨è¢å¹•
              </button>
              <button class="tool-btn fav" id="btn-fav" title="æ”¶è—/å–æ¶ˆæ”¶è—" type="button" disabled>
                <span class="icon" id="fav-icon">â™¡</span>
                <span id="fav-text">æ”¶è—</span>
              </button>
            </div>

            <div id="img-skeleton" style="display:none;width:100%;height:100%;">
              <div class="img-skel-wrap">
                <div class="skel img-skel-line" style="width:68%"></div>
                <div class="skel img-skel-line" style="width:52%"></div>
                <div class="skel img-skel-block"></div>
              </div>
            </div>

            <img id="outfit-image" alt="Outfit preview" />
            <div class="placeholder" id="img-placeholder">å°šæœªç”¢ç”Ÿç¤ºæ„åœ–</div>
          </div>

          <div class="anchor" id="anchor-status"></div>

          <div class="statusbar" id="statusbar">
            ç‹€æ…‹ï¼š<span id="status-text">ç­‰å¾…æ“ä½œ</span>
            <div class="status-sub" id="status-sub">æŒ‰ä¸‹å·¦å´æŒ‰éˆ•é–‹å§‹ã€‚</div>
            <span id="status-dots" style="display:none">
              <span class="dots"><span class="ldot"></span><span class="ldot"></span><span class="ldot"></span></span>
            </span>
            <div class="progress"><div id="progress-bar"></div></div>

            <div class="action-row" id="retry-row" style="display:none;">
              <button class="mini-btn primary" id="retry-btn" type="button">é‡è©¦ç›®å‰æ­¥é©Ÿ</button>
              <button class="mini-btn danger" id="restart-btn" type="button">å¾é ­é‡è·‘</button>
              <div class="mini-hint" id="retry-hint"></div>
            </div>
          </div>
        </div>

        <div class="outfit-summary card" id="outfit-summary" style="display:none;">
          <div class="summary-head">
            <span class="summary-icon">ğŸ‘”</span>
            <span class="summary-title">AI ç©¿æ­å»ºè­°</span>
          </div>
          <div class="summary-text" id="summary-text"></div>
        </div>

        <div class="section-title" style="margin-top:12px;">
          <span class="pill">æ”¶è— / æœ€è¿‘ 10 å¥—</span>
        </div>
        <div class="collection-wrap" id="collection-wrap">
          <div class="tabs">
            <button class="tab active" id="tab-recents" type="button">æœ€è¿‘ 10 å¥—</button>
            <button class="tab" id="tab-favs" type="button">å·²æ”¶è—</button>
          </div>
          <div class="tabpanes">
            <div class="pane active" id="pane-recents">
              <div class="mini-list" id="recents-list"></div>
            </div>
            <div class="pane" id="pane-favs">
              <div class="mini-list" id="favs-list"></div>
            </div>
          </div>
        </div>

        <div class="section-title anchor" id="anchor-products">
          <span class="pill">æ¨è–¦å•†å“</span>
        </div>
        <div class="products" id="products">
          <div class="placeholder" style="padding:16px;">å°šæœªç”¢ç”Ÿå•†å“</div>
        </div>

        <pre class="debug" id="debug-box"></pre>
      </section>
    </main>
  </div>

  <div class="mobile-actionbar" id="mobile-actionbar">
    <button id="go-btn-mobile" class="primary-wide" type="button">ç”¢ç”Ÿç©¿æ­åœ–</button>
  </div>

  <div class="modal" id="img-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="å…¨è¢å¹•é è¦½">
      <div class="modal-top">
        <button class="m-btn" id="modal-close" type="button">é—œé–‰ âœ•</button>
        <button class="m-btn" id="modal-save" type="button">ä¸‹è¼‰åœ–ç‰‡ â¬‡ï¸</button>
      </div>
      <img id="modal-img" alt="Outfit fullscreen preview" />
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>


// --- JS runtime guard: show error banner if script fails ---
(function(){
  function showErr(msg){
    try{
      var el=document.getElementById('js-error-banner');
      if(!el){
        el=document.createElement('div');
        el.id='js-error-banner';
        el.style.cssText='position:fixed;left:12px;right:12px;bottom:calc(80px + env(safe-area-inset-bottom,0px));z-index:20000;background:rgba(239,68,68,.95);color:#fff;padding:10px 12px;border-radius:14px;font:600 13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;box-shadow:0 18px 38px rgba(0,0,0,.22);';
        document.body.appendChild(el);
      }
      el.textContent='JS éŒ¯èª¤ï¼š' + msg + 'ï¼ˆè«‹æ‰“é–‹ Console çœ‹ç´°ç¯€ï¼‰';
    }catch(e){}
  }
  window.addEventListener('error', function(e){ showErr(e.message || 'æœªçŸ¥éŒ¯èª¤'); });
  window.addEventListener('unhandledrejection', function(e){ showErr((e.reason && (e.reason.message||String(e.reason))) || 'Promise éŒ¯èª¤'); });
})();

function isMobile(){ return window.matchMedia && window.matchMedia("(max-width: 640px)").matches; }

function applyDeviceClass() {
  const m = isMobile();
  document.body.classList.toggle("is-mobile", m);
  document.body.classList.toggle("is-desktop", !m);
}


    function scrollToElWithOffset(id, offsetPx = 0, behavior="smooth"){
      const el = document.getElementById(id);
      if (!el) return;
      const y = el.getBoundingClientRect().top + window.scrollY - (offsetPx || 0);
      window.scrollTo({ top: Math.max(0, y), behavior });
    }

    function haptic(ms = 12){
      try{ if (navigator.vibrate) navigator.vibrate(ms); }catch{}
    }

    let toastTimer=null;
    function showToast(text, ms=2000){
      const t=document.getElementById("toast");
      if(!t) return;
      t.textContent=text||"";
      t.style.display="block";
      void t.offsetWidth;
      t.classList.add("on");
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>{ t.classList.remove("on"); setTimeout(()=>{ t.style.display="none"; },220); }, ms);
    }

    function formatNowTS(){
      const d=new Date();
      const pad=(n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function payloadSummaryLine(p) {
  if (!p) return "â€”";

  const g = p.gender === "female" ? "å¥³" : p.gender === "male" ? "ç”·" : "ä¸­æ€§";
  const group = p.ageGroup === "kids" ? "ç«¥è£" : "æˆäºº";

  // Base style (keep for debugging/consistency)
  const style = (p.style || "").toUpperCase();

  // UI layer: show the user's chosen 2nd-level value (æ—…è¡Œ / GD ...)
  const uiValue = (p.uiStyleValue || p.ui_style_value || "").trim(); // backward-compatible

  const extras = [
    p.withBag ? "åŒ…" : "",
    p.withHat ? "å¸½" : "",
    (p.withCoat || (Number(p.temp) <= 20)) ? "å¤–å¥—" : ""
  ].filter(Boolean).join("ã€");

  const stylePart = uiValue ? `${style} Â· ${uiValue}` : style;

  return `${group} Â· ${g} Â· ${p.age}æ­² Â· ${p.height}cm/${p.weight}kg Â· ${p.temp}Â°C Â· ${stylePart}${extras ? " Â· " + extras : ""}`;
}


    function setResultMeta(payload){
      const bar=document.getElementById("result-meta");
      const timeEl=document.getElementById("result-time");
      const sumEl=document.getElementById("result-summaryline");
      if(!bar||!timeEl||!sumEl) return;
      bar.style.display="flex";
      timeEl.innerHTML=`<b>${formatNowTS()}</b>`;
      sumEl.textContent=payloadSummaryLine(payload);
    }

    function safeJson(obj){ try{ return JSON.stringify(obj,null,2);}catch{ return ""; } }
    function copyText(text){
      const s=String(text||"");
      if(!s) return false;
      if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(s).catch(()=>{}); return true; }
      const ta=document.createElement("textarea");
      ta.value=s; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select();
      try{ document.execCommand("copy"); }catch{}
      document.body.removeChild(ta);
      return true;
    }

    function b64urlEncode(str){
      const b64=btoa(unescape(encodeURIComponent(str)));
      return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");
    }
    function b64urlDecode(str){
      const s=String(str||"").replace(/-/g,"+").replace(/_/g,"/");
      const pad=s.length%4? "=".repeat(4-(s.length%4)):"";
      return decodeURIComponent(escape(atob(s+pad)));
    }

    function makeShareHash({payload,spec}){
      const data={v:1,payload:payload||null,spec:spec?{summary:spec.summary||"",items:spec.items||[]}:null};
      return "#share="+b64urlEncode(JSON.stringify(data));
    }
    function parseShareFromLocation(){
      const h=location.hash||"";
      const m=h.match(/#share=([^&]+)/);
      if(!m) return null;
      try{ const obj=JSON.parse(b64urlDecode(m[1])); if(!obj||!obj.payload) return null; return obj; }catch{ return null; }
    }

    function applyPayloadToForm(payload) {
  if (!payload) return;

  // Age group first (affects slider min/max)
  const ag = payload.ageGroup || (Number(payload.age) < 13 ? "kids" : "adult");
  const agEl = document.getElementById("ageGroup");
  if (agEl) agEl.value = ag;
  try { if (window.__setAgeGroup) window.__setAgeGroup(ag); } catch {}

  // Gender (segmented control)
  const gEl = document.getElementById("gender");
  if (gEl && payload.gender) gEl.value = String(payload.gender);
  try { if (window.__setGenderSeg && payload.gender) window.__setGenderSeg(payload.gender); } catch {}

  const setRange = (id, valId, v) => {
    const el = document.getElementById(id);
    const lab = document.getElementById(valId);
    if (!el || v === undefined || v === null) return;
    el.value = String(v);
    if (lab) lab.textContent = String(v);
    try { el.dispatchEvent(new Event("input", { bubbles: true })); } catch {}
  };

  setRange("age", "age-val", payload.age);
  setRange("height", "height-val", payload.height);
  setRange("weight", "weight-val", payload.weight);
  setRange("temp", "temp-val", payload.temp);

  // Style cards
  const styleHidden = document.getElementById("style");
  if (styleHidden && payload.style) styleHidden.value = payload.style;
  const cards = Array.from(document.querySelectorAll("#style-grid .style-card"));
  cards.forEach(c => c.classList.toggle("selected", c.dataset.style === payload.style));

  // Style variant
  const sv = document.getElementById("styleVariant");
  if (sv) sv.value = payload.styleVariant || "";

  // Switches
  const setSwitch = (id, on) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle("on", !!on);
    el.setAttribute("aria-checked", !!on ? "true" : "false");
  };
  setSwitch("sw-bag", !!payload.withBag);
  setSwitch("sw-hat", !!payload.withHat);
  setSwitch("sw-coat", !!payload.withCoat);

  // Ensure ageGroup application clamps values if needed
  try { if (window.__setAgeGroup) window.__setAgeGroup(ag); } catch {}
}

    function userFriendlyError(e, step, hasImage){
      const raw=String(e?.message||e||"");
      if(raw.includes("æœªç™»å…¥")||raw.includes("no session")||raw.includes("Missing bearer token")||raw.includes("Invalid token")){
        return { title:"ç™»å…¥ç‹€æ…‹å·²å¤±æ•ˆ", desc:"è«‹å…ˆç™»å…¥å¾Œå†è©¦ä¸€æ¬¡ã€‚", next:"æŒ‰å³ä¸Šã€ŒGoogle ç™»å…¥ã€â†’ å†é»ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€ã€‚" };
      }
      if(raw.includes("/api/search-products")||raw.includes("search-products")){
        return { title:"å•†å“æœå°‹æš«æ™‚ä¸ç©©", desc: hasImage? "ç¤ºæ„åœ–å·²ä¿ç•™ï¼Œä½ å¯ä»¥ç¨å¾Œå†è©¦æœå°‹å•†å“ã€‚":"è«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚", next: hasImage? "æŒ‰ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€å³å¯é‡æ–°æ‰¾å•†å“ã€‚":"æŒ‰ã€Œå¾é ­é‡è·‘ã€å†è©¦ã€‚" };
      }
      if(raw.includes("/api/generate-image")||raw.includes("generate-image")){
        return { title:"ç¤ºæ„åœ–ç”Ÿæˆæš«æ™‚å¤±æ•—", desc:"é€šå¸¸æ˜¯æ¨¡å‹æˆ–ç¶²è·¯æ³¢å‹•ï¼Œç¨å¾Œå¯å†è©¦ã€‚", next:"æŒ‰ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€å³å¯ã€‚" };
      }
      if(raw.includes("/api/generate-outfit-spec")||raw.includes("generate-outfit-spec")){
        return { title:"åˆ†ææ¢ä»¶æš«æ™‚å¤±æ•—", desc:"è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–å…ˆæª¢æŸ¥ç™»å…¥èˆ‡é»æ•¸ã€‚", next:"æŒ‰ã€Œå¾é ­é‡è·‘ã€å†è©¦ä¸€æ¬¡ã€‚" };
      }
      return { title:"æš«æ™‚å¤±æ•—", desc:"å¯èƒ½æ˜¯ç¶²è·¯æˆ–æœå‹™æ³¢å‹•ï¼Œç¨å¾Œå†è©¦å³å¯ã€‚", next:"æŒ‰ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€æˆ–ç¨å¾Œå†è©¦ã€‚" };
    }

    function setFormDisabled(disabled){
      const form=document.getElementById("left-panel");
      if(!form) return;
      form.classList.toggle("form-disabled", disabled);
    }

    const GENERATE_STEPS={
      idle:{ btn:"ç”¢ç”Ÿç©¿æ­åœ–", text:"æº–å‚™å°±ç·’", sub:"æŒ‰ä¸‹å¾Œæœƒè‡ªå‹•è·³åˆ°ç¤ºæ„åœ–èˆ‡å•†å“å€ã€‚", eta:"" },
      spec:{ btn:"åˆ†æèº«å½¢â€¦", text:"åˆ†æèº«å½¢èˆ‡éœ€æ±‚", sub:"ç‚ºäº†æŒ‘å‡ºæ›´åˆèº«ã€ç¬¦åˆé¢¨æ ¼çš„ç‰ˆå‹èˆ‡é…è‰²ã€‚", eta:"é€šå¸¸ 10â€“20 ç§’" },
      image:{ btn:"çµ„åˆç©¿æ­â€¦", text:"çµ„è¡£æœèˆ‡æ¯”ä¾‹", sub:"æŠŠå–®å“çµ„æˆå®Œæ•´ç©¿æ­ï¼Œä¸¦ç”Ÿæˆç¤ºæ„åœ–ã€‚", eta:"é€šå¸¸ 10â€“20 ç§’" },
      products:{ btn:"æ‰¾å•†å“â€¦", text:"æ‰¾å¯è²·å•†å“", sub:"ç”¨ç©¿æ­å–®å“å»æœå°‹ç›¸ä¼¼å•†å“ï¼Œæ–¹ä¾¿ç›´æ¥è³¼è²·ã€‚", eta:"é€šå¸¸ 5â€“15 ç§’" },
      done:{ btn:"å†ç”Ÿæˆä¸€å¥—", text:"å®Œæˆ âœ…", sub:"ä½ å¯ä»¥æ”¶è—ã€åˆ†äº«ï¼Œæˆ–å†è©¦ä¸€å¥—ä¸åŒé¢¨æ ¼ã€‚", eta:"" },
      failed:{ btn:"å†è©¦ä¸€æ¬¡", text:"æš«æ™‚å¤±æ•—", sub:"åˆ¥æ“”å¿ƒï¼Œçµæœå·²ç›¡é‡ä¿ç•™ï¼Œä½ å¯ä»¥é‡è©¦ã€‚", eta:"" }
    };

    function setGenerateStep(step){
      const cfg=GENERATE_STEPS[step]||GENERATE_STEPS.idle;
      const btn1=document.getElementById("go-btn");
      const btn2=document.getElementById("go-btn-mobile");
      if(btn1) btn1.textContent=cfg.btn;
      if(btn2) btn2.textContent=cfg.btn;

      const statusTextEl=document.getElementById("status-text");
      if(statusTextEl) statusTextEl.textContent=cfg.text;

      const statusSubEl=document.getElementById("status-sub");
      if(statusSubEl){
        const extra=cfg.eta? `ï¼ˆ${cfg.eta}ï¼‰`:"";
        statusSubEl.textContent=(cfg.sub||"") + (cfg.sub? " ":"") + extra;
      }
    }

    const SUPABASE_PROJECT_REF="auiwcsolpvufxxyhnvaf";
    const SUPABASE_URL=`https://${SUPABASE_PROJECT_REF}.supabase.co`;
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1aXdjc29scHZ1Znh4eWhudmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MzUwMDEsImV4cCI6MjA4MDUxMTAwMX0.KeD8JXdHs5Iu7-wf0F0GpUPp-_y5X5ha6mwBcR5eYDA";
    const REDIRECT_TO=location.origin+"/body-test.html";

    function bindRange(rangeId, valueId){
      const r=document.getElementById(rangeId);
      const v=document.getElementById(valueId);
      const paint=()=>{ v.textContent=String(r.value); };
      r.addEventListener("input", paint);
      paint();
    }

    
function bindGenderSeg(){
  const seg = document.getElementById("gender-seg");
  const hidden = document.getElementById("gender");
  if (!seg || !hidden) return;
  const btns = Array.from(seg.querySelectorAll(".seg-btn"));
  const select = (val, opts={emit:true}) => {
    if (!val) return;
    hidden.value = val;
    btns.forEach(b => {
      const on = b.dataset.value === val;
      b.classList.toggle("on", on);
      b.setAttribute("aria-checked", on ? "true" : "false");
    });
    // update style/variant labels per audience
    try { if (typeof updateStyleUIForAudience === "function") updateStyleUIForAudience(); } catch {}
    if(opts.emit){
      try{ hidden.dispatchEvent(new Event("input",{bubbles:true})); }catch{}
      try{ hidden.dispatchEvent(new Event("change",{bubbles:true})); }catch{}
    }
  };
  btns.forEach(b => b.addEventListener("click", () => select(b.dataset.value,{emit:true})));
  hidden.addEventListener("change", () => select(hidden.value,{emit:false}));
  // expose for applyPayloadToForm / share restore
  window.__setGenderSeg = (val)=>select(val,{emit:true});
  select(hidden.value || "female",{emit:false});
}

function bindStyleCards() {
      const grid = document.getElementById("style-grid");
      const hidden = document.getElementById("style");
      const cards = Array.from(grid.querySelectorAll(".style-card"));
      const select = (style, opts = {}) => {
        hidden.value = style;
        cards.forEach((c) => c.classList.toggle("selected", c.dataset.style === style));
        if (!opts.silent) haptic(6);
      };
      cards.forEach((c) => {
        c.addEventListener("click", () => select(c.dataset.style));
      });
      window.__setStyleCard = (val) => select(val, { silent: true });
      select(hidden.value || "casual", { silent: true });
      return select;
    }

    const AUTH_KEY="os_supabase_access_token_v1";
    function saveAccessToken(t){ localStorage.setItem(AUTH_KEY,t); }
    function getAccessToken(){ return localStorage.getItem(AUTH_KEY); }
    function clearAccessToken(){ localStorage.removeItem(AUTH_KEY); }

    const osSupabase=supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, flowType:"pkce" }
    });

    async function apiMe(){
      const token=getAccessToken();
      if(!token) return { ok:false, error:"no token" };
      const r=await fetch("/api/me", { headers:{ Authorization:"Bearer "+token } });
      const j=await r.json().catch(()=>({}));
      if(!r.ok) return { ok:false, error:j?.error||"me failed", detail:j?.detail };
      return j;
    }

    function renderOutfitSummary(summary){
      const box=document.getElementById("outfit-summary");
      const text=document.getElementById("summary-text");
      if(!summary){ box.style.display="none"; return; }
      text.textContent=summary;
      box.style.display="block";
    }

    function setAuthUI({loggedIn,email,credits,hint}){
      const st=document.getElementById("login-status");
      const cr=document.getElementById("credits");
      const hintEl=document.getElementById("auth-hint");
      const loginBtn=document.getElementById("login-btn");
      const logoutBtn=document.getElementById("logout-btn");
      if(loggedIn){
        st.textContent=email? `å·²ç™»å…¥ï¼š${email}`:"å·²ç™»å…¥";
        cr.textContent=String(credits ?? 0);
        hintEl.textContent=hint||"";
        loginBtn.style.display="none";
        logoutBtn.style.display="inline-flex";
      } else {
        st.textContent=hint||"æœªç™»å…¥";
        cr.textContent="â€”";
        hintEl.textContent="";
        loginBtn.style.display="inline-flex";
        logoutBtn.style.display="none";
      }
    }

    async function refreshAuthUI(){
      const token=getAccessToken();
      if(!token){ setAuthUI({loggedIn:false, hint:"æœªç™»å…¥"}); return; }
      const me=await apiMe();
      if(!me.ok){ setAuthUI({loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰"}); return; }
      setAuthUI({loggedIn:true, email:me.user?.email, credits:me.credits_left, hint:""});
    }

    async function ensureTokenFromSession(){
      const {data, error}=await osSupabase.auth.getSession();
      if(error) return { ok:false, error:error.message };
      const session=data?.session;
      if(!session?.access_token){ clearAccessToken(); return { ok:false, error:"no session" }; }
      saveAccessToken(session.access_token);
      if(location.hash||location.search) history.replaceState(null,"",location.pathname);
      return { ok:true, session };
    }

    async function loginGoogle(){
      if(!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("PASTE_")){
        alert("è«‹å…ˆåœ¨ body-test.html å¡«å…¥ SUPABASE_ANON_KEYï¼ˆSupabase â†’ Settings â†’ API â†’ anon public keyï¼‰");
        return;
      }
      const {error}=await osSupabase.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: REDIRECT_TO } });
      if(error){ console.error(error); setAuthUI({loggedIn:false, hint:"ç™»å…¥å•Ÿå‹•å¤±æ•—ï¼š"+error.message}); }
    }

    async function logout(){
      try{ await osSupabase.auth.signOut(); }catch{}
      clearAccessToken();
      try{
        const keys=Object.keys(localStorage);
        for(const k of keys){ if(k.startsWith("sb-")||k.includes("supabase")||k.includes("auth")) localStorage.removeItem(k); }
        const skeys=Object.keys(sessionStorage);
        for(const k of skeys){ if(k.startsWith("sb-")||k.includes("supabase")||k.includes("auth")) sessionStorage.removeItem(k); }
      }catch{}
      setAuthUI({loggedIn:false, hint:"å·²ç™»å‡º"});
      window.location.href="/body-test.html";
    }

    function bindSwitch(id, initial=false){
      const el=document.getElementById(id);
      let on=initial;
      const paint=()=>{ el.classList.toggle("on",on); el.setAttribute("aria-checked", on?"true":"false"); };
      paint();
      el.addEventListener("click", ()=>{ on=!on; paint(); });
      return ()=>on;
    }

    const getBag=bindSwitch("sw-bag", false);
    const getHat=bindSwitch("sw-hat", false);
    const getCoat=bindSwitch("sw-coat", false);
    const getDebug=bindSwitch("sw-debug", false);

    document.getElementById("debug-toggle").addEventListener("click", (e)=>{
      if(e.target.id!=="sw-debug") document.getElementById("sw-debug").click();
      document.getElementById("debug-box").classList.toggle("on", getDebug());
    });

    const statusTextEl=document.getElementById("status-text");
    const statusDotsEl=document.getElementById("status-dots");
    const progressBarEl=document.getElementById("progress-bar");
    const previewBox=document.getElementById("preview-box");

    function setStatus(_ignored, ok=null, loading=false){
      statusTextEl.className = ok===true ? "ok" : ok===false ? "bad" : "";
      statusDotsEl.style.display = loading ? "inline" : "none";
    }
    function setProgress(pct){ const v=Math.max(0,Math.min(100,Number(pct||0))); progressBarEl.style.width=v+"%"; }
    function setLoadingUI(on){
      const products=document.getElementById("products");
      if(on){ previewBox.classList.add("shimmer"); products.classList.add("shimmer"); }
      else{ previewBox.classList.remove("shimmer"); products.classList.remove("shimmer"); }
    }

    function showError(msg){ const el=document.getElementById("error-hint"); el.style.display="block"; el.textContent=msg; }
    function clearError(){ const el=document.getElementById("error-hint"); el.style.display="none"; el.textContent=""; }

    function setImageBase64(base64, mime="image/png"){
      const img=document.getElementById("outfit-image");
      const ph=document.getElementById("img-placeholder");
      img.src=`data:${mime};base64,${base64}`;
      img.style.display="block";
      ph.style.display="none";
    }
    function clearImage(){
      const img=document.getElementById("outfit-image");
      const ph=document.getElementById("img-placeholder");
      img.src="";
      img.style.display="none";
      ph.style.display="block";
    }
    function showImageSkeleton(on){
      const sk=document.getElementById("img-skeleton");
      const img=document.getElementById("outfit-image");
      const ph=document.getElementById("img-placeholder");
      if(!sk) return;
      if(on){ sk.style.display="block"; img.style.display="none"; ph.style.display="none"; }
      else { sk.style.display="none"; }
    }

    function renderProductsSkeleton(rows=4){
      const root=document.getElementById("products");
      root.innerHTML = `<div class="products-skel">` + Array.from({length:rows}).map(()=>`
          <div class="row">
            <div class="skel thumb"></div>
            <div><div class="skel t1"></div><div class="skel t2"></div></div>
          </div>`).join("") + `</div>`;
    }

    function escapeHtml(str){
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setDebug(obj){
      const box=document.getElementById("debug-box");
      box.textContent = typeof obj==="string" ? obj : JSON.stringify(obj,null,2);
      box.classList.toggle("on", getDebug());
    }

    const SLOT_ORDER=["top","bottom","shoes","outer","bag","hat"];
    const SLOT_LABEL_ZH={ top:"ä¸Šè¡£", bottom:"ä¸‹èº«", shoes:"é‹å­", outer:"å¤–å¥—", bag:"åŒ…åŒ…", hat:"å¸½å­" };

    function groupProductsBySlot(list){
      const groups={}; for(const s of SLOT_ORDER) groups[s]=[];
      (list||[]).forEach(p=>{ const slot=(p.slot||"").toLowerCase(); (groups[slot] ||= []).push(p); });
      return groups;
    }

    function renderProductsGrouped(list){
      const root=document.getElementById("products");
      root.innerHTML="";
      if(!Array.isArray(list) || list.length===0){
        root.innerHTML=`<div class="placeholder" style="padding:16px;">æ²’æœ‰æ‰¾åˆ°å•†å“ï¼ˆæˆ– API å°šæœªå›å‚³ï¼‰</div>`;
        return;
      }
      const groups=groupProductsBySlot(list);
      for(const slot of SLOT_ORDER){
        const items=groups[slot]||[];
        if(items.length===0) continue;
        const wrap=document.createElement("div");
        wrap.className="slot-group";
        wrap.innerHTML=`<div class="slot-head"><div class="slot-title">ğŸ§© ${escapeHtml(SLOT_LABEL_ZH[slot]||slot)}</div><div class="slot-count">${items.length} å€‹</div></div>`;
        items.forEach(p=>{
          const div=document.createElement("div");
          div.className="product-item";
          const thumb=p.thumbnail? `<img src="${p.thumbnail}" alt="">`:"ç¤ºæ„";
          const price=p.price||p.extracted_price||"";
          const link=p.product_link||p.link||p.url||"#";
          div.innerHTML=`<div class="thumb">${thumb}</div><div><div class="pname">${escapeHtml(p.title||p.name||"å•†å“")}</div><div class="pmeta">${price? `<span>åƒ¹æ ¼ï¼š${escapeHtml(String(price))}</span>`:""}${p.source? `<span>ä¾†æºï¼š${escapeHtml(String(p.source))}</span>`:""}</div><a class="plink" href="${link}" target="_blank" rel="noopener noreferrer">å‰å¾€æŸ¥çœ‹</a></div>`;
          wrap.appendChild(div);
        });
        root.appendChild(wrap);
      }
    }

    async function postJson(url, body, withAuth=true){
  const headers={ "Content-Type":"application/json" };
  if(withAuth){
    const token=getAccessToken();
    if(!token) throw new Error("æœªç™»å…¥ï¼ˆæ²’æœ‰ Bearer tokenï¼‰");
    headers["Authorization"]="Bearer "+token;
  }

  // âœ… only patch search-products (safe)
  if (typeof url === "string" && url.includes("/api/search-products")) {
    const b = body && typeof body === "object" ? { ...body } : {};

    if (!b.ageGroup) b.ageGroup = document.getElementById("ageGroup")?.value || "adult";

    // å¦‚æœå‘¼å«ç«¯æ²’å¸¶ styleTagï¼Œå°±ç”¨ UI çš„é¸æ“‡è£œä¸Š
    if (!b.styleTag) b.styleTag = getSelectedStyleTagForApi();

    body = b;
  }

  const r=await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
  const text=await r.text();
  let j=null;
  try{ j=JSON.parse(text); }catch{ j={ raw:text }; }
  if(!r.ok){
    const msg=j?.error ? `${j.error}${j.detail? " / "+(typeof j.detail==="string"? j.detail: JSON.stringify(j.detail)):""}` : `HTTP ${r.status} / ${text.slice(0,500)}`;
    throw new Error(`${url} å¤±æ•—ï¼š${msg}`);
  }
  return j;
}




    const flowState={ lastStep:"idle", payload:null, me:null, spec:null, imgResp:null, products:null, currentOutfitId:null };

    function updateResultActions(){
      const copyBtn=document.getElementById("copy-spec-btn");
      const shareBtn=document.getElementById("share-btn");
      const ctaBtn=document.getElementById("cta-products");
      if(copyBtn) copyBtn.disabled=!flowState.spec;
      if(shareBtn) shareBtn.disabled=!(flowState.payload && (flowState.spec || flowState.payload));
      if(ctaBtn) ctaBtn.style.display=(Array.isArray(flowState.products) && flowState.products.length) ? "inline-flex":"none";
      const ctaHint=document.getElementById("cta-hint");
      if(ctaHint) ctaHint.style.display=(ctaBtn && ctaBtn.style.display!=="none") ? "block":"none";
    }

    function showRetryUI(show, step="", hint=""){
      const row=document.getElementById("retry-row");
      const ht=document.getElementById("retry-hint");
      if(!row||!ht) return;
      if(!show){ row.style.display="none"; ht.textContent=""; return; }
      row.style.display="flex";
      ht.textContent=hint ? hint : (step? `å¯é‡è©¦ï¼š${step}`:"");
    }

    async function runStepSpec(payload, me){
      setGenerateStep("spec"); setStatus("", null, true); setProgress(20);
      const spec=await postJson("/api/generate-outfit-spec", payload, true);
      flowState.spec=spec; flowState.lastStep="spec"; updateResultActions(); haptic(12);
      setDebug({ step:"spec", spec });
      renderOutfitSummary(spec.summary);
      if(typeof spec.credits_left!=="undefined"){ setAuthUI({ loggedIn:true, email: me.user?.email, credits: spec.credits_left }); }
      else { await refreshAuthUI();
      try{ await refreshCollectionsUI(); }catch(e){ console.warn(e); }
      syncFavButtonUI(); }
      return spec;
    }

    async function runStepImage(payload, spec){
      setGenerateStep("image"); setStatus("", null, true); setProgress(55);
      const kidHint = payload.ageGroup === "kids"
    ? `child, age ${payload.age}, youthful face, child body proportions`
    : "";
  const specForImage = payload.ageGroup === "kids"
    ? { ...spec, audience: "kids", person_hint: kidHint, age: payload.age }
    : spec;
  const imgResp = await postJson("/api/generate-image", {
    ...payload,
    ageGroup: payload.ageGroup,
    personHint: kidHint,
    outfitSpec: specForImage,
    aspectRatio: "9:16",
    imageSize: "1K"
  }, true);
      if(!imgResp.image) throw new Error("Image API æ²’å›å‚³ image");
      flowState.imgResp=imgResp; flowState.lastStep="image"; haptic(12);
      setDebug({ step:"image", imgResp, spec });
      setImageBase64(imgResp.image, imgResp.mime||"image/png");
      showImageSkeleton(false);
      return imgResp;
    }

    
    // --- Global keyword prefix helpers (stability shim) ---
    // Some parts of the page expect these helpers to exist at the top scope.
    // Define them defensively here to avoid breaking product recommendation.
    window.getProductKeywordPrefix = window.getProductKeywordPrefix || function(payload) {
      const ak = payload?.audienceKey || (typeof getAudienceKey === "function" ? getAudienceKey(payload) : "adult-neutral");
      const g = payload?.gender || "neutral";
      if (String(ak).startsWith("kids")) {
        if (g === "female") return "å¥³ç«¥";
        if (g === "male") return "ç”·ç«¥";
        return "ç«¥è£";
      }
      if (String(ak).startsWith("adult")) {
        if (g === "female") return "å¥³è£";
        if (g === "male") return "ç”·è£";
        return "";
      }
      return "";
    };

    window.getProductKeywordPrefixEn = window.getProductKeywordPrefixEn || function(payload) {
      const ak = payload?.audienceKey || (typeof getAudienceKey === "function" ? getAudienceKey(payload) : "adult-neutral");
      const g = payload?.gender || "neutral";
      if (String(ak).startsWith("kids")) {
        if (g === "female") return "girls";
        if (g === "male") return "boys";
        return "kids";
      }
      if (String(ak).startsWith("adult")) {
        if (g === "female") return "women";
        if (g === "male") return "men";
        return "";
      }
      return "";
    };

async function runStepProducts(payload, spec){
      setGenerateStep("products"); setStatus("", null, true); setProgress(80);
      const itemsForSearch = (spec.items || []).map(it => {
    const prefixZh = getProductKeywordPrefix(payload);
    const prefixEn = getProductKeywordPrefixEn(payload);

    if (!prefixZh && !prefixEn) return it;

    const zh0 = String(it.display_name_zh || it.generic_name || it.display_name_en || "").trim();
    const zh = prefixZh && zh0
      ? (zh0.startsWith(prefixZh) ? zh0 : (prefixZh + zh0))
      : (prefixZh ? (prefixZh + (zh0 || "")) : zh0);

    const en0 = String(it.generic_name || it.display_name_en || "").trim();
    const en = prefixEn && en0
      ? (en0.toLowerCase().startsWith(prefixEn.toLowerCase()) ? en0 : (prefixEn + " " + en0))
      : en0;

    return {
      ...it,
      display_name_zh: zh || it.display_name_zh,
      generic_name: en || it.generic_name,
      audienceKey: payload.audienceKey,
      ageGroup: payload.ageGroup,
      age: payload.age,
      query_hint: prefixZh ? `${prefixZh} clothing` : undefined
    };
  });

  const prodResp = await postJson("/api/search-products", {
    items: itemsForSearch,
    locale: "tw",
    gender: payload.gender,
    ageGroup: payload.ageGroup,
    age: payload.age,
    audience: payload.ageGroup === "kids" ? "kids" : "adult"
  }, true);
      const list=prodResp.products || prodResp.items || prodResp.shopping_results || [];
      flowState.products=list; flowState.lastStep="products"; updateResultActions(); haptic(14);
      setDebug({ step:"products", prodResp, spec });
      renderProductsGrouped(list);
      return list;
    }

    async function retryCurrentStep(){
      showRetryUI(false); clearError();
      const ensured=await ensureTokenFromSession();
      if(!ensured.ok) throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");
      const me=await apiMe();
      if(!me.ok) throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");
      const payload=flowState.payload;
      if(!payload) throw new Error("æ²’æœ‰å¯é‡è©¦çš„ payloadï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
      if(flowState.lastStep==="spec"){
        if(!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        showImageSkeleton(true);
        await runStepImage(payload, flowState.spec);
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        finalizeDoneNoThrow();
        scrollToElWithOffset("anchor-products", 12, "smooth");
        return;
      }
      if(flowState.lastStep==="image"){
        if(!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        finalizeDoneNoThrow();
        scrollToElWithOffset("anchor-products", 12, "smooth");
        return;
      }
      await generateAll(true);
    }

    // Auto scroll fix (1238): scroll to anchor-status (status text area)
    function autoScrollOnStart(){ scrollToElWithOffset("anchor-status", isMobile()? 16:12, "smooth"); haptic(10); }
    function autoScrollOnDone(){ scrollToElWithOffset("anchor-products", 12, "smooth"); showToast("å¾€ä¸‹çœ‹å•†å“ â†“", 2000); haptic(18); }

    const modal=document.getElementById("img-modal");
    const modalImg=document.getElementById("modal-img");
    const modalClose=document.getElementById("modal-close");
    const modalSave=document.getElementById("modal-save");
    function openModalWithCurrentImage(){
      const img=document.getElementById("outfit-image");
      if(!img || !img.src) return;
      modalImg.src=img.src;
      modal.classList.add("on");
      modal.setAttribute("aria-hidden","false");
      document.body.style.overflow="hidden";
    }
    function closeModal(){
      modal.classList.remove("on");
      modal.setAttribute("aria-hidden","true");
      document.body.style.overflow="";
    }
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modal.classList.contains("on")) closeModal(); });

    modalSave.addEventListener("click", ()=>{
      try{
        const src=modalImg.src;
        if(!src) return;
        const a=document.createElement("a");
        a.href=src; a.download="outfit.png";
        document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ console.error(e); }
    });

    document.getElementById("btn-fullscreen").addEventListener("click", openModalWithCurrentImage);
    document.getElementById("outfit-image").addEventListener("click", openModalWithCurrentImage);
    /***********************
     * æ”¶è— / æœ€è¿‘ 10 å¥—ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼‰
     * - metadata: localStorage
     * - image dataUrl: IndexedDBï¼ˆé¿å… localStorage çˆ†æ‰ï¼‰
     ***********************/
    const LS_RECENTS="os_recents_v2";
    const LS_FAVS="os_favs_v2";

    function safeJsonParse(str,fallback){ try{ return JSON.parse(str); }catch{ return fallback; } }
    function readList(key){ const raw=localStorage.getItem(key); const arr=safeJsonParse(raw,[]); return Array.isArray(arr)?arr:[]; }
    function writeList(key,arr){ try{ localStorage.setItem(key,JSON.stringify(arr)); return true; }catch(e){ console.warn("localStorage write failed",e); return false; } }

    // IndexedDB (store images by id)
    const IDB_NAME="os_outfits_db_v1";
    const IDB_STORE="images";

    function openDb(){
      return new Promise((resolve,reject)=>{
        const req=indexedDB.open(IDB_NAME,1);
        req.onupgradeneeded=()=>{
          const db=req.result;
          if(!db.objectStoreNames.contains(IDB_STORE)){
            db.createObjectStore(IDB_STORE,{ keyPath:"id" });
          }
        };
        req.onsuccess=()=>resolve(req.result);
        req.onerror=()=>reject(req.error);
      });
    }

    async function idbPutImage(id,dataUrl){
      try{
        const db=await openDb();
        await new Promise((resolve,reject)=>{
          const tx=db.transaction(IDB_STORE,"readwrite");
          tx.objectStore(IDB_STORE).put({ id, dataUrl });
          tx.oncomplete=()=>resolve(true);
          tx.onerror=()=>reject(tx.error);
        });
        db.close();
        return true;
      }catch(e){ console.warn("idbPutImage failed",e); return false; }
    }

    async function idbGetImage(id){
      try{
        const db=await openDb();
        const dataUrl=await new Promise((resolve,reject)=>{
          const tx=db.transaction(IDB_STORE,"readonly");
          const req=tx.objectStore(IDB_STORE).get(id);
          req.onsuccess=()=>resolve(req.result?.dataUrl||null);
          req.onerror=()=>reject(req.error);
        });
        db.close();
        return dataUrl;
      }catch(e){ console.warn("idbGetImage failed",e); return null; }
    }

    async function idbDelImage(id){
      try{
        const db=await openDb();
        await new Promise((resolve,reject)=>{
          const tx=db.transaction(IDB_STORE,"readwrite");
          tx.objectStore(IDB_STORE).delete(id);
          tx.oncomplete=()=>resolve(true);
          tx.onerror=()=>reject(tx.error);
        });
        db.close();
        return true;
      }catch(e){ console.warn("idbDelImage failed",e); return false; }
    }

    // stable id (hash)
    function stableStringify(obj){
      const seen=new WeakSet();
      const sorter=(k,v)=>{
        if(v && typeof v==="object"){
          if(seen.has(v)) return;
          seen.add(v);
          if(Array.isArray(v)) return v;
          const out={};
          Object.keys(v).sort().forEach(key=>out[key]=v[key]);
          return out;
        }
        return v;
      };
      return JSON.stringify(obj,sorter);
    }

    async function sha256Hex(str){
      if(!crypto?.subtle) throw new Error("crypto.subtle unavailable");
      const enc=new TextEncoder().encode(str);
      const buf=await crypto.subtle.digest("SHA-256",enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    async function computeOutfitId(payload,spec){
      const core={
        payload:{
          gender:payload.gender, age: payload.age,
      ageGroup: payload.ageGroup || "adult", height:payload.height, weight:payload.weight,
          style:payload.style, styleVariant:payload.styleVariant||"", temp:payload.temp,
          withBag:!!payload.withBag, withHat:!!payload.withHat, withCoat:!!payload.withCoat
        },
        items:(spec?.items||[]).map(i=>({
          slot:i.slot, generic_name:i.generic_name, display_name_zh:i.display_name_zh,
          color:i.color, style:i.style, gender:i.gender, warmth:i.warmth
        })),
        summary:spec?.summary||""
      };
      return await sha256Hex(stableStringify(core));
    }

    function fmtTime(ts){
      try{
        const d=new Date(ts);
        const m=String(d.getMonth()+1).padStart(2,"0");
        const day=String(d.getDate()).padStart(2,"0");
        const hh=String(d.getHours()).padStart(2,"0");
        const mm=String(d.getMinutes()).padStart(2,"0");
        return `${m}/${day} ${hh}:${mm}`;
      }catch{ return ""; }
    }

    // Tabs
    const tabRecents=document.getElementById("tab-recents");
    const tabFavs=document.getElementById("tab-favs");
    const paneRecents=document.getElementById("pane-recents");
    const paneFavs=document.getElementById("pane-favs");
    function setTab(which){
      const rec=(which==="recents");
      tabRecents?.classList.toggle("active",rec);
      tabFavs?.classList.toggle("active",!rec);
      paneRecents?.classList.toggle("active",rec);
      paneFavs?.classList.toggle("active",!rec);
    }
    tabRecents?.addEventListener("click",()=>setTab("recents"));
    tabFavs?.addEventListener("click",()=>setTab("favs"));

    async function renderMiniList(targetId,listKey){
      const root=document.getElementById(targetId);
      if(!root) return;
      const list=readList(listKey);
      root.innerHTML="";
      if(!list.length){
        root.innerHTML='<div class="mini-empty">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚</div>';
        return;
      }
      for(const item of list){
        const row=document.createElement("div");
        row.className="mini-card";

        const thumb=document.createElement("div");
        thumb.className="mini-thumb";
        thumb.textContent="è¼‰å…¥ä¸­â€¦";

        const info=document.createElement("div");
        info.className="mini-info";
        const title=(item.summary||"ä¸€å¥—ç©¿æ­").trim()||"ä¸€å¥—ç©¿æ­";
        const p=item.payload||{};
        const meta=`${fmtTime(item.ts)} Â· ${(p.gender||"")} Â· ${(p.style||"")} Â· ${(p.temp ?? "")}Â°C`;
        info.innerHTML=`<div class="t">${escapeHtml(title)}</div><div class="m">${escapeHtml(meta)}</div>`;

        const actions=document.createElement("div");
        actions.className="mini-actions";

        const btnLoad=document.createElement("button");
        btnLoad.className="chip-btn";
        btnLoad.type="button";
        btnLoad.textContent="å¥—ç”¨";
        btnLoad.addEventListener("click",async()=>{ await applySavedOutfit(item.id); });

        const btnDel=document.createElement("button");
        btnDel.className="chip-btn danger";
        btnDel.type="button";
        btnDel.textContent="åˆªé™¤";
        btnDel.addEventListener("click",async()=>{ await removeSavedOutfit(listKey,item.id); });

        actions.appendChild(btnLoad);
        actions.appendChild(btnDel);

        row.appendChild(thumb);
        row.appendChild(info);
        row.appendChild(actions);
        root.appendChild(row);

        const dataUrl=await idbGetImage(item.imageId||item.id);
        if(dataUrl) thumb.innerHTML=`<img src="${dataUrl}" alt="">`;
        else thumb.textContent="ç„¡åœ–";

        thumb.addEventListener("click",async()=>{
          const d=await idbGetImage(item.imageId||item.id);
          if(!d) return;
          try{
            modalImg.src=d;
            modal.classList.add("on");
            modal.setAttribute("aria-hidden","false");
            document.body.style.overflow="hidden";
          }catch{}
        });
      }
    }

    async function refreshCollectionsUI(){
      await renderMiniList("recents-list",LS_RECENTS);
      await renderMiniList("favs-list",LS_FAVS);
    }

    async function upsertRecent(outfit){
      try{
        const list=readList(LS_RECENTS);
        const filtered=list.filter(x=>x.id!==outfit.id);
        filtered.unshift(outfit);
        writeList(LS_RECENTS, filtered.slice(0,10));
      }catch(e){ console.warn("upsertRecent failed",e); }
    }

    function isFav(id){
      const list=readList(LS_FAVS);
      return list.some(x=>x.id===id);
    }

    async function setFav(outfit,on){
      try{
        const list=readList(LS_FAVS);
        const exists=list.some(x=>x.id===outfit.id);
        let next=list;
        if(on){
          if(!exists) next=[outfit, ...list].slice(0,200);
        }else{
          next=list.filter(x=>x.id!==outfit.id);
        }
        writeList(LS_FAVS,next);
      }catch(e){ console.warn("setFav failed",e); }
    }

    async function removeSavedOutfit(listKey,id){
      try{
        const list=readList(listKey);
        const item=list.find(x=>x.id===id);
        const next=list.filter(x=>x.id!==id);
        writeList(listKey,next);
        const imageId=item?.imageId||id;
        await idbDelImage(imageId);
      }catch(e){ console.warn("removeSavedOutfit failed",e); }
      await refreshCollectionsUI();
      syncFavButtonUI();
    }

    async function applySavedOutfit(id){
      const all=[...readList(LS_RECENTS), ...readList(LS_FAVS)];
      const item=all.find(x=>x.id===id);
      if(!item) return;

      try{
        applyPayloadToForm(item.payload||{});

        flowState.payload=item.payload||null;
        flowState.spec=item.spec||null;
        flowState.products=Array.isArray(item.products)?item.products:[];
        updateResultActions();

        renderOutfitSummary(item.summary||flowState.spec?.summary||"");
        if(flowState.products?.length) renderProductsGrouped(flowState.products);

        const dataUrl=await idbGetImage(item.imageId||item.id);
        if(dataUrl){
          const img=document.getElementById("outfit-image");
          const ph=document.getElementById("img-placeholder");
          img.src=dataUrl;
          img.style.display="block";
          ph.style.display="none";
          showImageSkeleton(false);
        }

        flowState.currentOutfitId=item.id;
        syncFavButtonUI();

        scrollToEl("anchor-preview","smooth","start");
      }catch(e){ console.warn("applySavedOutfit failed",e); }
    }

    const favBtn=document.getElementById("btn-fav");
    const favIcon=document.getElementById("fav-icon");
    const favText=document.getElementById("fav-text");

    function syncFavButtonUI(){
      const id=flowState.currentOutfitId;
      const hasImage=!!(document.getElementById("outfit-image")?.src);
      const enabled=!!id && hasImage;
      if(!favBtn) return;

      favBtn.disabled=!enabled;

      if(!enabled){
        favBtn.classList.remove("on");
        if(favIcon) favIcon.textContent="â™¡";
        if(favText) favText.textContent="æ”¶è—";
        return;
      }

      const on=isFav(id);
      favBtn.classList.toggle("on",on);
      if(favIcon) favIcon.textContent=on ? "â™¥" : "â™¡";
      if(favText) favText.textContent=on ? "å·²æ”¶è—" : "æ”¶è—";
    }

    async function buildCurrentOutfitSnapshotNoThrow(){
      try{
        const id=flowState.currentOutfitId;
        if(!id) return null;
        const img=document.getElementById("outfit-image");
        const dataUrl=img?.src||"";
        if(dataUrl.startsWith("data:")) await idbPutImage(id,dataUrl);

        return {
          id,
          ts: Date.now(),
          payload: flowState.payload,
          summary: flowState.spec?.summary || "",
          spec: flowState.spec,
          products: Array.isArray(flowState.products) ? flowState.products : [],
          imageId: id
        };
      }catch(e){ console.warn("buildCurrentOutfitSnapshot failed",e); return null; }
    }

    favBtn?.addEventListener("click",async()=>{
      const id=flowState.currentOutfitId;
      if(!id) return;
      const outfit=await buildCurrentOutfitSnapshotNoThrow();
      if(!outfit) return;
      const on=!isFav(id);
      await setFav(outfit,on);
      syncFavButtonUI();
      await refreshCollectionsUI();
    });


    function resetPerRunUI(){
      showRetryUI(false);
      clearError();
      clearImage();
      showImageSkeleton(true);
      renderProductsSkeleton(4);
      renderOutfitSummary(null);
      flowState.currentOutfitId=null;
      flowState.imgResp=null;
      flowState.spec=null;
      flowState.products=null;
        syncFavButtonUI();
    }

    function finalizeDoneNoThrow(){
      setGenerateStep("done");
      setProgress(100);
      setStatus("", true, false);
      showRetryUI(false);
    }

    async function generateAll(forceRestart=false){
      showRetryUI(false); clearError();
      setLoadingUI(true); setFormDisabled(true);
      try{
        setGenerateStep("spec"); setProgress(0); setStatus("", null, true);
        autoScrollOnStart();
        resetPerRunUI();

        const ensured=await ensureTokenFromSession();
        if(!ensured.ok){ setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥ï¼ˆè«‹æŒ‰ Google ç™»å…¥ï¼‰" }); throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨"); }

        const me=await apiMe();
        if(!me.ok){ setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" }); throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰"); }
        flowState.me=me;

        const basePayload={
          gender: document.getElementById("gender").value,
          age: Number(document.getElementById("age").value),
      ageGroup: (document.getElementById("ageGroup")?.value || "adult"),
          height: Number(document.getElementById("height").value),
          weight: Number(document.getElementById("weight").value),
          style: document.getElementById("style").value,
          styleVariant: document.getElementById("styleVariant").value || "",
          temp: Number(document.getElementById("temp").value),
          withBag: !!getBag(),
          withHat: !!getHat(),
          withCoat: !!getCoat()
        };
        const payload=enrichPayload(basePayload);
        flowState.payload=payload;
        setResultMeta(payload);
        updateResultActions();

        if(forceRestart){ flowState.spec=null; flowState.imgResp=null; flowState.products=null;
        syncFavButtonUI(); flowState.lastStep="idle"; }

        const spec=await runStepSpec(payload, me);
        try{ flowState.currentOutfitId = await computeOutfitId(payload, spec); }catch(e){ flowState.currentOutfitId = String(Date.now()); }
        syncFavButtonUI();
        const imgResp=await runStepImage(payload, spec);
        syncFavButtonUI();
        scrollToElWithOffset("anchor-preview", 12, "smooth");
        const products=await runStepProducts(payload, spec);
        syncFavButtonUI();

        finalizeDoneNoThrow();
        autoScrollOnDone();
        (async()=>{ try{ const outfit=await buildCurrentOutfitSnapshotNoThrow(); if(!outfit) return; await upsertRecent(outfit); await refreshCollectionsUI(); syncFavButtonUI(); }catch(e){ console.warn("persist recent failed (non-fatal)",e); }})();
      }catch(e){
        console.error(e);
        setGenerateStep("failed");
        setStatus("", false, false);
        setProgress(0);
        const raw=String(e?.message||e||"");
        setDebug({ error: raw, step: flowState.lastStep, state: flowState });
        const friendly=userFriendlyError(e, flowState.lastStep, !!flowState.imgResp);
        showError(`${friendly.title}ï¼š${friendly.desc}ï¼ˆä¸‹ä¸€æ­¥ï¼š${friendly.next}ï¼‰`);
        showRetryUI(true, flowState.lastStep, friendly.next);
      } finally {
        setLoadingUI(false);
        setFormDisabled(false);
      }
    }

/***********************
 * Age group (æˆäºº / ç«¥è£) + dynamic ranges
 * - ç«¥è£ï¼šå¹´é½¡ 4â€“12ï¼Œä¸¦åŒæ­¥èª¿æ•´èº«é«˜/é«”é‡ slider å€é–“
 ***********************/
const AGE_GROUP_RULES = {
  adult: {
    age:    { min: 13, max: 70, dft: 25 },
    height: { min: 140, max: 200, dft: 165 },
    weight: { min: 35,  max: 120, dft: 55 }
  },
  kids: {
    age:    { min: 4,  max: 12, dft: 7 },
    height: { min: 90, max: 170, dft: 120 },
    weight: { min: 12, max: 80, dft: 25 }
  }
};

function clampNum(n, min, max){
  const x = Number(n);
  if (!Number.isFinite(x)) return min;
  return Math.max(min, Math.min(max, x));
}

// Update slider min/max + chips + range-sub numbers, keeping user value if still valid.
// If user value falls outside, set to group default.
function setRangeAttributes(rangeId, valId, minId, maxId, min, max, dft){
  const r = document.getElementById(rangeId);
  if (!r) return;
  r.min = String(min);
  r.max = String(max);
  r.step = "1";

  const cur = Number(r.value);
  let next = cur;
  if (!Number.isFinite(next) || next < min || next > max) next = (dft !== undefined && dft !== null) ? dft : min;
  next = clampNum(next, min, max);
  r.value = String(next);

  const v = document.getElementById(valId);
  if (v) v.textContent = String(next);

  const mn = document.getElementById(minId);
  const mx = document.getElementById(maxId);
  if (mn) mn.textContent = String(min);
  if (mx) mx.textContent = String(max);

  // re-paint value chips bound by input listeners
  try { r.dispatchEvent(new Event("input", { bubbles: true })); } catch {}
}

function applyAgeGroup(group, { silent=false } = {}){
  const g = AGE_GROUP_RULES[group] ? group : "adult";
  const cfg = AGE_GROUP_RULES[g];

  // Update hidden value
  const hidden = document.getElementById("ageGroup");
  if (hidden) hidden.value = g;

  // Sliders
  setRangeAttributes("age", "age-val", "age-min", "age-max", cfg.age.min, cfg.age.max, cfg.age.dft);
  setRangeAttributes("height", "height-val", "height-min", "height-max", cfg.height.min, cfg.height.max, cfg.height.dft);
  setRangeAttributes("weight", "weight-val", "weight-min", "weight-max", cfg.weight.min, cfg.weight.max, cfg.weight.dft);

  if (!silent) haptic(10);
}

function bindAgeGroupSeg(){
  const seg = document.getElementById("agegroup-seg");
  const hidden = document.getElementById("ageGroup");
  if (!seg || !hidden) return;

  const btns = Array.from(seg.querySelectorAll(".seg-btn"));
  const select = (val, opts={emit:true}) => {
    const v = (val === "kids" || val === "adult") ? val : "adult";
    hidden.value = v;
    btns.forEach(b => {
      const on = b.dataset.value === v;
      b.classList.toggle("on", on);
      b.setAttribute("aria-checked", on ? "true" : "false");
    });
    applyAgeGroup(v, opts);
    // update style/variant labels per audience
    try { if (typeof updateStyleUIForAudience === "function") updateStyleUIForAudience(); } catch {}
    if(opts.emit){
      try{ hidden.dispatchEvent(new Event("input",{bubbles:true})); }catch{}
      try{ hidden.dispatchEvent(new Event("change",{bubbles:true})); }catch{}
    }
  };

  btns.forEach(b => b.addEventListener("click", () => select(b.dataset.value,{emit:true})));
  // allow share/restore to set this before sliders
  window.__setAgeGroup = (val) => select(val, { silent: true, emit: true });

  // init: if current age < 13, default to kids, otherwise adult
  const curAge = Number(document.getElementById("age")?.value ?? 25);
  const initial = hidden.value || (Number.isFinite(curAge) && curAge < 13 ? "kids" : "adult");
  select(initial, { silent: true, emit: false });
}


    /***********************
     * Audience / presets / metadata (non-breaking)
     * Q1:B è¿½åŠ æ–°æ¬„ä½ï¼ˆstyleId / paletteId / celebId / audienceKeyï¼‰
     * - ä¸å½±éŸ¿æ—¢æœ‰ï¼šstyle / styleVariant
     * Q2:A å•†å“æœå°‹ï¼šä¾ audienceKey å‰ç½® keywordï¼ˆç”·è£/å¥³è£/ç”·ç«¥/å¥³ç«¥/ç«¥è£ï¼‰
     ***********************/
    let uiPaletteId = null; // set by éš¨æ©Ÿæ¨è–¦ï¼ˆä¹‹å¾Œå¯æ“´å±•æˆå¯è¦–åŒ–é¸å–®ï¼‰

    function getAgeGroupValue() {
      return document.getElementById("ageGroup")?.value || "adult";
    }

    function getAudienceKey(p) {
      const ag = p?.ageGroup || getAgeGroupValue();
      const g = p?.gender || (document.getElementById("gender")?.value || "neutral");
      return `${ag}-${g}`; // e.g. adult-female, kids-neutral
    }

    const DEFAULT_PALETTE_BY_AUDIENCE = {
      "adult-female": "cream-warm",
      "adult-male": "mono-dark",
      "adult-neutral": "mono-dark",
      "kids-female": "bright",
      "kids-male": "bright",
      "kids-neutral": "bright",
    };

    function deriveCelebId(styleVariant) {
      const v = String(styleVariant || "");
      return v.startsWith("celeb-") ? v : "";
    }
// ---- styleTag helpers (UI -> API) ----
function normalizeStyleChoiceToSlug(source, valueRaw){
  const v = String(valueRaw || "").trim();
  if(!v) return "";

  // Scene (æƒ…å¢ƒ) mapping
  if(source === "scene"){
    const map = {
      "ä¼‘é–’": "casual",
      "ä¸Šç­ / é€šå‹¤": "commute",
      "ç´„æœƒ": "date",
      "é‹å‹•": "sport",
      "æ—…è¡Œ": "travel",
      "æ­£å¼å ´åˆ": "formal",

      "æ—¥å¸¸ / ä¸Šå­¸": "school",
      "æˆ¶å¤–ç©æ¨‚": "outdoor",
      "é‹å‹• / é«”è‚²èª²": "sport_class",
      "èšæœƒ / ç”Ÿæ—¥": "party_birthday",
    };
    return map[v] || v
      .toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/[^\w\u4e00-\u9fff]/g, "_")
      .replace(/_+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  // Celebrity mapping
  if(source === "celebrity"){
    const map = {
      "GD": "gd",
      "BTS": "bts",
      "V": "v",
      "Jungkook": "jungkook",
      "Jimin": "jimin",
      "RM": "rm",
      "Lisa": "lisa",
      "IU": "iu",
      "Jennie": "jennie",
      "RosÃ©": "rose",
      "Jisoo": "jisoo",
      "Karina": "karina",
    };
    return map[v] || v
      .toLowerCase()
      .replace(/\s+/g, "_")
      .replace(/[^\w]/g, "_")
      .replace(/_+/g, "_")
      .replace(/^_+|_+$/g, "");
  }

  return "";
}

function getSelectedStyleTagForApi(){
  const source = (document.getElementById("uiStyleSource")?.value || "").trim();
  const value  = (document.getElementById("uiStyleValue")?.value  || "").trim();
  if(!source || !value) return null;

  const src = source === "celebrity" ? "celeb" : "scene"; // API æƒ³è¦ celeb_/scene_
  const slug = normalizeStyleChoiceToSlug(source, value);
  if(!slug) return null;

  return `${src}_${slug}`;
}

    function enrichPayload(base) {
  const audienceKey = getAudienceKey(base);
  const paletteId = uiPaletteId || DEFAULT_PALETTE_BY_AUDIENCE[audienceKey] || "cream-warm";
  const celebId = deriveCelebId(base.styleVariant);
  const styleId = base.style;

  const uiStyleSource = document.getElementById("uiStyleSource")?.value || "";
  const uiStyleValue  = document.getElementById("uiStyleValue")?.value || "";

  const styleTag = getSelectedStyleTagForApi(); // âœ… é€™è£¡æœƒè®Šæˆ scene_travel / celeb_gd ...

  return { ...base, audienceKey, styleId, paletteId, celebId, uiStyleSource, uiStyleValue, styleTag };
}


    function getProductKeywordPrefix(payload) {
      const ak = payload?.audienceKey || getAudienceKey(payload);
      const g = payload?.gender || "neutral";
      if (ak.startsWith("kids")) {
        if (g === "female") return "å¥³ç«¥";
        if (g === "male") return "ç”·ç«¥";
        return "ç«¥è£";
      }
      if (ak.startsWith("adult")) {
        if (g === "female") return "å¥³è£";
        if (g === "male") return "ç”·è£";
        return ""; // ä¸­æ€§ï¼šä¸å‰ç½®ï¼Œé¿å…ç¸®å°çµæœ
      }
      return "";

    function getProductKeywordPrefixEn(payload) {
      const ak = payload?.audienceKey || getAudienceKey(payload);
      const g = payload?.gender || "neutral";
      if (ak.startsWith("kids")) {
        if (g === "female") return "girls";
        if (g === "male") return "boys";
        return "kids";
      }
      if (ak.startsWith("adult")) {
        if (g === "female") return "women";
        if (g === "male") return "men";
        return "";
      }
      return "";
    }

    }

    // éš¨æ©Ÿæ¨è–¦ï¼ˆä¸­æ–‡åï¼Œä¾ï¼šç”·/å¥³/ä¸­æ€§ + æˆäºº/ç«¥è£ï¼‰
    const RANDOM_PRESETS = {
      "adult-female": [
        { label: "éŸ“ç³»æ—¥å¸¸", style: "casual", styleVariant: "celeb-iu-casual", paletteId: "cream-warm" },
        { label: "å¥¶æ²¹æ¥µç°¡", style: "minimal", styleVariant: "brand-muji", paletteId: "cream-warm" },
        { label: "å¾®æ­£å¼", style: "smart", styleVariant: "brand-cos", paletteId: "cream-warm" },
      ],
      "adult-male": [
        { label: "ä¹¾æ·¨æ—¥å¸¸", style: "minimal", styleVariant: "brand-uniqlo", paletteId: "mono-dark" },
        { label: "æ©Ÿèƒ½é‹å‹•", style: "sporty", styleVariant: "brand-nike-tech", paletteId: "mono-dark" },
        { label: "è¡—é ­å±¤æ¬¡", style: "street", styleVariant: "celeb-gd-street", paletteId: "mono-dark" },
      ],
      "adult-neutral": [
        { label: "ä¸­æ€§æ¥µç°¡", style: "minimal", styleVariant: "brand-cos", paletteId: "mono-dark" },
        { label: "ä¸­æ€§è¡—é ­", style: "street", styleVariant: "brand-ader-error", paletteId: "mono-dark" },
        { label: "ä¸­æ€§æ—¥å¸¸", style: "casual", styleVariant: "", paletteId: "mono-dark" },
      ],
      "kids-female": [
        { label: "æ ¡åœ’æ—¥å¸¸", style: "casual", styleVariant: "", paletteId: "bright" },
        { label: "æ´»åŠ›é‹å‹•", style: "sporty", styleVariant: "", paletteId: "bright" },
        { label: "å¯æ„›ç°¡ç´„", style: "minimal", styleVariant: "brand-uniqlo", paletteId: "bright" },
      ],
      "kids-male": [
        { label: "æ ¡åœ’æ—¥å¸¸", style: "casual", styleVariant: "", paletteId: "bright" },
        { label: "é‹å‹•æ©Ÿèƒ½", style: "sporty", styleVariant: "brand-nike-tech", paletteId: "bright" },
        { label: "é…·æ„Ÿè¡—é ­", style: "street", styleVariant: "", paletteId: "bright" },
      ],
      "kids-neutral": [
        { label: "æ ¡åœ’æ—¥å¸¸", style: "casual", styleVariant: "", paletteId: "bright" },
        { label: "æ´»åŠ›é‹å‹•", style: "sporty", styleVariant: "", paletteId: "bright" },
        { label: "æ¸…çˆ½ç°¡ç´„", style: "minimal", styleVariant: "", paletteId: "bright" },
      ],
    };

    
    /***********************
     * Style UI per audience (gender + age group)
     * - Q1:B: ä¸åŒæ—ç¾¤ â†’ ä¸åŒã€Œé¡¯ç¤ºåç¨±/æè¿°/è®Šé«”é¸é …ã€
     *   ï¼ˆä¿ç•™åŸæœ¬ style / styleVariant çš„ valueï¼Œé¿å…å¾Œç«¯ç›¸å®¹æ€§å•é¡Œï¼‰
     ***********************/
    const STYLE_UI_BY_AUDIENCE = {
      "adult-female": {
        styles: [
          { style: "casual", chip: "Daily", name: "éŸ“ç³»æ—¥å¸¸", desc: "æŸ”å’Œã€å¥½æ­ã€å¸¶é»ç”œæ„Ÿ" },
          { style: "minimal", chip: "Minimal", name: "å¥¶æ²¹æ¥µç°¡", desc: "ä¹¾æ·¨æ¯”ä¾‹ã€ä½é£½å’Œ" },
          { style: "street",  chip: "Street",  name: "éŸ“ç³»è¡—é ­", desc: "å±¤æ¬¡ã€å¯¬é¬†ã€å€‹æ€§" },
          { style: "sporty",  chip: "Sporty",  name: "è¼•é‹å‹•æ©Ÿèƒ½", desc: "è¼•ä¾¿ã€å¥½æ´»å‹•" },
          { style: "smart",   chip: "Smart",   name: "è¼•ç†Ÿé€šå‹¤", desc: "æ­£å¼ä¸€é»ä½†ä¸æ‹˜è¬¹", wide: true },
        ],
        variants: {
          brands: [
            { v: "brand-uniqlo",      t: "UNIQLOï¼ˆåŸºæœ¬ç™¾æ­ï¼‰" },
            { v: "brand-muji",        t: "MUJIï¼ˆç”Ÿæ´»æ¥µç°¡ï¼‰" },
            { v: "brand-cos",         t: "COSï¼ˆçµæ§‹æ¥µç°¡ï¼‰" },
            { v: "brand-nike-tech",   t: "Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰" },
            { v: "brand-ader-error",  t: "Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰" },
          ],
          celebs: [
            { v: "celeb-iu-casual",       t: "IUï¼ˆæ¸…æ–°æ—¥å¸¸ï¼‰" },
            { v: "celeb-jennie-minimal",  t: "Jennieï¼ˆæ¥µç°¡è¾£ï¼‰" },
            { v: "celeb-gd-street",       t: "G-Dragonï¼ˆå±¤æ¬¡è¡—é ­ï¼‰" },
            { v: "celeb-lisa-sporty",     t: "Lisaï¼ˆèˆè€…é‹å‹•ï¼‰" },
          ],
        },
      },
      "adult-male": {
        styles: [
          { style: "casual", chip: "Clean",  name: "ä¹¾æ·¨æ—¥å¸¸", desc: "ä¿è½ã€è€çœ‹ã€å¥½ä¸Šæ‰‹" },
          { style: "minimal", chip: "Mono",  name: "é»‘ç™½ç°æ¥µç°¡", desc: "ç·šæ¢ä¹¾æ·¨ã€ä½å½©åº¦" },
          { style: "street",  chip: "Layer", name: "è¡—é ­å±¤æ¬¡", desc: "å¯¬é¬†æ¯”ä¾‹ã€æ©Ÿèƒ½æ„Ÿ" },
          { style: "sporty",  chip: "Tech",  name: "æ©Ÿèƒ½é‹å‹•", desc: "è¼•é‡ã€è€ç”¨ã€å¥½æ´»å‹•" },
          { style: "smart",   chip: "Smart", name: "é€šå‹¤ä¿è½", desc: "æˆç†Ÿä½†ä¸è€æ°£", wide: true },
        ],
        variants: {
          brands: [
            { v: "brand-uniqlo",      t: "UNIQLOï¼ˆä¹¾æ·¨é€šå‹¤ï¼‰" },
            { v: "brand-muji",        t: "MUJIï¼ˆç°¡ç´„èˆ’é©ï¼‰" },
            { v: "brand-cos",         t: "COSï¼ˆä¿è½å‰ªè£ï¼‰" },
            { v: "brand-nike-tech",   t: "Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰" },
            { v: "brand-ader-error",  t: "Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰" },
          ],
          celebs: [
            { v: "celeb-gd-street",       t: "G-Dragonï¼ˆå±¤æ¬¡è¡—é ­ï¼‰" },
            { v: "celeb-lisa-sporty",     t: "Lisaï¼ˆèˆè€…é‹å‹•ï¼‰" },
            { v: "celeb-iu-casual",       t: "IUï¼ˆæ¸…æ–°é…è‰²ï¼‰" },
            { v: "celeb-jennie-minimal",  t: "Jennieï¼ˆæ¥µç°¡è¾£ï¼‰" },
          ],
        },
      },
      "adult-neutral": {
        styles: [
          { style: "casual", chip: "Daily",  name: "ä¸­æ€§æ—¥å¸¸", desc: "èˆ’æœã€å¥½æ­ã€ç•™ç™½æ„Ÿ" },
          { style: "minimal", chip: "Mono",  name: "æ¥µç°¡ä¸­æ€§", desc: "é»‘ç™½ç°ã€ç·šæ¢ä¹¾æ·¨" },
          { style: "street",  chip: "Street", name: "ä¸­æ€§è¡—é ­", desc: "å¯¬é¬†æ¯”ä¾‹ã€å±¤æ¬¡" },
          { style: "sporty",  chip: "Sporty", name: "ä¸­æ€§é‹å‹•", desc: "æ©Ÿèƒ½ã€è¼•é¬†ã€å¥½æ´»å‹•" },
          { style: "smart",   chip: "Smart",  name: "ä¸­æ€§ä¿è½", desc: "æ­£å¼æ„Ÿï¼‹ä¼‘é–’å¹³è¡¡", wide: true },
        ],
        variants: {
          brands: [
            { v: "brand-uniqlo",      t: "UNIQLOï¼ˆä¸­æ€§åŸºæœ¬ï¼‰" },
            { v: "brand-muji",        t: "MUJIï¼ˆä¸­æ€§æ¥µç°¡ï¼‰" },
            { v: "brand-cos",         t: "COSï¼ˆä¸­æ€§çµæ§‹ï¼‰" },
            { v: "brand-nike-tech",   t: "Nike Techï¼ˆä¸­æ€§æ©Ÿèƒ½ï¼‰" },
            { v: "brand-ader-error",  t: "Ader Errorï¼ˆä¸­æ€§è¡—é ­ï¼‰" },
          ],
          celebs: [
            { v: "celeb-jennie-minimal",  t: "Jennieï¼ˆæ¥µç°¡è¾£ï¼‰" },
            { v: "celeb-gd-street",       t: "G-Dragonï¼ˆå±¤æ¬¡è¡—é ­ï¼‰" },
            { v: "celeb-iu-casual",       t: "IUï¼ˆæ¸…æ–°æ—¥å¸¸ï¼‰" },
            { v: "celeb-lisa-sporty",     t: "Lisaï¼ˆèˆè€…é‹å‹•ï¼‰" },
          ],
        },
      },
      "kids-female": {
        styles: [
          { style: "casual", chip: "School", name: "æ ¡åœ’æ—¥å¸¸", desc: "å¯æ„›ä¹¾æ·¨ã€è€çœ‹å¥½æ­" },
          { style: "minimal", chip: "Soft",  name: "æŸ”å’Œç°¡ç´„", desc: "ä½é£½å’Œã€èˆ’æœè¦ªè†š" },
          { style: "street",  chip: "Cute",  name: "ç«¥è¶£æ½®æµ", desc: "äº®é»å–®å“ã€ä¿çš®å±¤æ¬¡" },
          { style: "sporty",  chip: "Active", name: "æ´»åŠ›é‹å‹•", desc: "å¥½æ´»å‹•ã€è€é«’è€ç£¨" },
          { style: "smart",   chip: "Neat",  name: "å°å°æ­£å¼", desc: "èšæœƒ/ç”Ÿæ—¥ä¹Ÿåˆé©", wide: true },
        ],
        variants: {
          brands: [
            { v: "brand-uniqlo",      t: "UNIQLO Kidsï¼ˆåŸºæœ¬ç™¾æ­ï¼‰" },
            { v: "brand-muji",        t: "MUJIï¼ˆç«¥è£ç°¡ç´„ï¼‰" },
            { v: "brand-nike-tech",   t: "Nikeï¼ˆç«¥è£é‹å‹•ï¼‰" },
          ],
          celebs: [],
        },
      },
      "kids-male": {
        styles: [
          { style: "casual", chip: "School", name: "æ ¡åœ’æ—¥å¸¸", desc: "ä¹¾æ·¨ä¿è½ã€è€çœ‹" },
          { style: "minimal", chip: "Soft",  name: "ç°¡ç´„èˆ’æœ", desc: "å¥½ç©¿å¥½æ´—ã€è¦ªè†š" },
          { style: "street",  chip: "Cool",  name: "ç«¥è£è¡—é ­", desc: "å¯¬é¬†æ¯”ä¾‹ã€æ½®æµæ„Ÿ" },
          { style: "sporty",  chip: "Active", name: "æ´»åŠ›é‹å‹•", desc: "æ©Ÿèƒ½ã€å¥½æ´»å‹•" },
          { style: "smart",   chip: "Neat",  name: "å°å°ç´³å£«", desc: "èšæœƒ/ç¯€æ—¥æ›´åˆé©", wide: true },
        ],
        variants: {
          brands: [
            { v: "brand-uniqlo",      t: "UNIQLO Kidsï¼ˆåŸºæœ¬ç™¾æ­ï¼‰" },
            { v: "brand-muji",        t: "MUJIï¼ˆç«¥è£ç°¡ç´„ï¼‰" },
            { v: "brand-nike-tech",   t: "Nikeï¼ˆç«¥è£é‹å‹•ï¼‰" },
          ],
          celebs: [],
        },
      },
      "kids-neutral": {
        styles: [
          { style: "casual", chip: "School", name: "ä¸­æ€§æ ¡åœ’", desc: "ä¹¾æ·¨å¥½æ­ã€è€çœ‹" },
          { style: "minimal", chip: "Soft",  name: "ä¸­æ€§ç°¡ç´„", desc: "ä½é£½å’Œã€èˆ’æœ" },
          { style: "street",  chip: "Play",  name: "ç«¥è¶£å±¤æ¬¡", desc: "ä¿çš®ã€äº®é»å–®å“" },
          { style: "sporty",  chip: "Active", name: "ä¸­æ€§é‹å‹•", desc: "å¥½æ´»å‹•ã€è€ç”¨" },
          { style: "smart",   chip: "Neat",  name: "æ•´é½Šå¯æ„›", desc: "æ‹ç…§ä¹Ÿå¥½çœ‹", wide: true },
        ],
        variants: {
          brands: [
            { v: "brand-uniqlo",      t: "UNIQLO Kidsï¼ˆä¸­æ€§åŸºæœ¬ï¼‰" },
            { v: "brand-muji",        t: "MUJIï¼ˆä¸­æ€§ç°¡ç´„ï¼‰" },
            { v: "brand-nike-tech",   t: "Nikeï¼ˆä¸­æ€§é‹å‹•ï¼‰" },
          ],
          celebs: [],
        },
      },
    };

    function getAudienceKey() {
      const g = document.getElementById("gender")?.value || "neutral";
      const ag = (typeof getAgeGroupValue === "function") ? (getAgeGroupValue() || "adult") : "adult";
      return `${ag}-${g}`;
    }

    function getStyleUIForAudience() {
      const key = getAudienceKey();
      return STYLE_UI_BY_AUDIENCE[key] || STYLE_UI_BY_AUDIENCE["adult-neutral"];
    }

    function rebuildStyleCardsForAudience() {
      const grid = document.getElementById("style-grid");
      const hidden = document.getElementById("style");
      if (!grid || !hidden) return;

      const ui = getStyleUIForAudience();
      const current = hidden.value || "casual";

      grid.innerHTML = (ui.styles || []).map(s => {
        const wide = s.wide ? ' style="grid-column:1/-1"' : "";
        const selected = (s.style === current) ? " selected" : "";
        return `
          <div class="style-card${selected}" data-style="${s.style}"${wide}>
            <div class="chip">${s.chip || s.style}</div>
            <div class="name">${s.name || s.style}</div>
            <div class="desc">${s.desc || ""}</div>
          </div>
        `.trim();
      }).join("");

      // Re-bind click handlers (and keep compatibility with existing code)
      try { bindStyleCards(); } catch {}

      // Ensure selected style exists; otherwise fallback to first card
      const exists = (ui.styles || []).some(s => s.style === current);
      if (!exists && ui.styles && ui.styles.length) {
        hidden.value = ui.styles[0].style;
        try { if (window.__setStyleCard) window.__setStyleCard(hidden.value); } catch {}
      } else {
        try { if (window.__setStyleCard) window.__setStyleCard(current); } catch {}
      }
    }

    function rebuildStyleVariantOptionsForAudience() {
      const sel = document.getElementById("styleVariant");
      if (!sel) return;

      const ui = getStyleUIForAudience();
      const prev = sel.value || "";

      const option = (v, t) => `<option value="${v}">${t}</option>`;
      const group = (label, arr) => {
        if (!arr || !arr.length) return "";
        return `<optgroup label="${label}">${arr.map(x => option(x.v, x.t)).join("")}</optgroup>`;
      };

      sel.innerHTML =
        option("", "ï¼ˆä¸ä½¿ç”¨è®Šé«”ï¼‰") +
        group("å“ç‰Œ", ui.variants?.brands || []) +
        group("åäººï¼ˆé¢¨æ ¼éˆæ„Ÿï¼Œä¸æ¨¡ä»¿è‡‰ï¼‰", ui.variants?.celebs || []);

      // restore previous if still exists
      const hasPrev = Array.from(sel.options).some(o => o.value === prev);
      sel.value = hasPrev ? prev : "";
    }

    function updateStyleUIForAudience() {
      rebuildStyleCardsForAudience();
      rebuildStyleVariantOptionsForAudience();
    }


function safeSetSelectValue(id, value) {
      const el = document.getElementById(id);
      if (!el) return false;
      const v = String(value || "");
      const has = Array.from(el.options || []).some((o) => o.value === v);
      el.value = has ? v : "";
      el.dispatchEvent(new Event("change"));
      return true;
    }

    function applyRandomPreset() {
      const gender = document.getElementById("gender")?.value || "neutral";
      const ageGroup = getAgeGroupValue();
      const key = `${ageGroup}-${gender}`;
      const pool = RANDOM_PRESETS[key] || RANDOM_PRESETS[`adult-${gender}`] || RANDOM_PRESETS["adult-neutral"];
      if (!pool || !pool.length) return;

      const p = pool[Math.floor(Math.random() * pool.length)];
      if (window.__setStyleCard) window.__setStyleCard(p.style);
      else {
        const hidden = document.getElementById("style");
        if (hidden) hidden.value = p.style;
      }
      safeSetSelectValue("styleVariant", p.styleVariant || "");
      uiPaletteId = p.paletteId || null;

      showToast(`å·²å¹«ä½ é¸ï¼š${p.label}`, 1600);
      haptic(10);
    }



/***********************
 * é¢¨æ ¼ï¼ˆç©¿æ­æƒ…å¢ƒ / åäººéˆæ„Ÿï¼‰UIï¼ˆç©©å®šç‰ˆï¼šä¸æ”¹æ—¢æœ‰ payload çµæ§‹ï¼‰
 * - UI é¡¯ç¤ºï¼šæƒ…å¢ƒ 6 å€‹ï¼›åäººä¾æ€§åˆ¥é¡¯ç¤ºï¼ˆç”· / å¥³ / ä¸­æ€§ï¼‰
 * - é»é¸å¾Œï¼šæ˜ å°„åˆ°æ—¢æœ‰ #style / #styleVariantï¼ˆä¸ç ´å£å¾Œç«¯ç›¸å®¹æ€§ï¼‰
 * - éš¨æ©Ÿä¸€ä¸‹ï¼šéš¨æ©Ÿä¾†æº + è©²ä¾†æºåº•ä¸‹é …ç›®
 ***********************/
const STYLE_SOURCES = {
  scene: {
    label: "ç©¿æ­æƒ…å¢ƒ",
    optionsByAgeGroup: {
      adult: ["ä¼‘é–’", "ä¸Šç­ / é€šå‹¤", "ç´„æœƒ", "é‹å‹•", "æ—…è¡Œ", "æ­£å¼å ´åˆ"],
      kids:  ["æ—¥å¸¸ / ä¸Šå­¸", "æˆ¶å¤–ç©æ¨‚", "é‹å‹• / é«”è‚²èª²", "èšæœƒ / ç”Ÿæ—¥", "æ—…è¡Œ", "æ­£å¼å ´åˆ"]
    },
    mapToPayload: (val) => {
      // scene â†’ existing 5 styles (casual/minimal/street/sporty/smart)
      const m = {
        "ä¼‘é–’": { style: "casual", styleVariant: "" },
        "ä¸Šç­ / é€šå‹¤": { style: "smart", styleVariant: "" },
        "ç´„æœƒ": { style: "minimal", styleVariant: "" },
        "é‹å‹•": { style: "sporty", styleVariant: "" },
        "æ—…è¡Œ": { style: "casual", styleVariant: "" },
        "æ­£å¼å ´åˆ": { style: "smart", styleVariant: "" }
        ,
        "V": { style: "street", styleVariant: "" },
        "Jungkook": { style: "sporty", styleVariant: "" },
        "Jimin": { style: "minimal", styleVariant: "" },
        "RM": { style: "smart", styleVariant: "" },
        "RosÃ©": { style: "minimal", styleVariant: "" },
        "Jisoo": { style: "smart", styleVariant: "" },
        "Karina": { style: "street", styleVariant: "" }
      };
      return m[val] || { style: "casual", styleVariant: "" };
    }
  },
  celebrity: {
    label: "åäººéˆæ„Ÿ",
    // options are derived by gender at runtime
    optionsByGender: {
      male: ["GD", "BTS", "V", "Jungkook", "Jimin", "RM"],
      female: ["Lisa", "IU", "Jennie", "RosÃ©", "Jisoo", "Karina"],
      neutralPool: ["GD", "BTS", "V", "Jungkook", "Jimin", "RM", "Lisa", "IU", "Jennie", "RosÃ©", "Jisoo", "Karina"]
    },
    mapToPayload: (val) => {
      const m = {
        "GD": { style: "street", styleVariant: "celeb-gd-street" },
        "BTS": { style: "street", styleVariant: "celeb-bts-street" },
        "Lisa": { style: "sporty", styleVariant: "celeb-lisa-sporty" },
        "IU": { style: "casual", styleVariant: "celeb-iu-casual" },
        "Jennie": { style: "minimal", styleVariant: "celeb-jennie-minimal" }
      };
      return m[val] || { style: "casual", styleVariant: "" };
    }
  }
};

function __shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

// --- Gender reader (robust): supports select#gender, radios name="gender", and common Chinese labels ---
function __normalizeGender(v){
  if(v==null) return "neutral";
  const s = String(v).trim().toLowerCase();
  if(["male","m","man","boy","ç”·","ç”·æ€§"].includes(s)) return "male";
  if(["female","f","woman","girl","å¥³","å¥³æ€§"].includes(s)) return "female";
  if(["neutral","x","other","none","ä¸æŒ‡å®š","ä¸­æ€§","çš†å¯"].includes(s)) return "neutral";
  // fallback: accept already-normalized
  if(s === "male" || s === "female") return s;
  return "neutral";
}

function getCurrentGender(){
  // 1) select / hidden input #gender
  try{
    const el = document.getElementById("gender");
    if(el && ("value" in el) && String(el.value||"").trim()!=="") return __normalizeGender(el.value);
  }catch{}

  // 2) radios name="gender"
  try{
    const checked = document.querySelector('input[name="gender"]:checked');
    if(checked && String(checked.value||"").trim()!=="") return __normalizeGender(checked.value);
  }catch{}

  // 3) any element with data-field="gender"
  try{
    const el = document.querySelector('[data-field="gender"]');
    if(el && ("value" in el) && String(el.value||"").trim()!=="") return __normalizeGender(el.value);
  }catch{}

  return "neutral";
}


function getSceneOptions(){
  // ageGroup is managed by existing UI (adult / kids)
  let ag = "adult";
  try {
    const el = document.getElementById("ageGroup");
    if (el && el.value) ag = String(el.value);
  } catch {}
  const by = STYLE_SOURCES.scene.optionsByAgeGroup || {};
  return (ag === "kids" ? (by.kids || []) : (by.adult || []));
}

function getCelebOptionsByGender(gender){
  if(gender==="male") return STYLE_SOURCES.celebrity.optionsByGender.male.slice();
  if(gender==="female") return STYLE_SOURCES.celebrity.optionsByGender.female.slice();
  // neutral: show 4 random
  const pool = STYLE_SOURCES.celebrity.optionsByGender.neutralPool.slice();
  return __shuffle(pool).slice(0, Math.min(4, pool.length));
}

function ensureBtsVariantOption(){
  // keep existing variant UX working even if BTS isn't pre-defined
  const sel = document.getElementById("styleVariant");
  if(!sel) return;
  const exists = Array.from(sel.options).some(o => o.value === "celeb-bts-street");
  if(exists) return;

  // Find celeb optgroup; if none, append at end
  let celebGroup = Array.from(sel.querySelectorAll("optgroup")).find(g => (g.label||"").includes("åäºº"));
  const opt = document.createElement("option");
  opt.value = "celeb-bts-street";
  opt.textContent = "BTSï¼ˆåœ˜é«”è¡—é ­ï¼‰";

  if(celebGroup) celebGroup.appendChild(opt);
  else sel.appendChild(opt);
}

function bindStyleSourceUI(){
  const seg = document.getElementById("style-source-seg");
  const optionsRoot = document.getElementById("style-source-options");
  const btnRandom = document.getElementById("style-random-btn");
  const btnUndo = document.getElementById("style-undo-btn");
  const previewEl = document.getElementById("style-preview");
  const hSource = document.getElementById("uiStyleSource");
  const hValue = document.getElementById("uiStyleValue");
  if(!seg || !optionsRoot || !btnRandom || !hSource || !hValue) return;
  let lastPick = null;

  function showToast(msg){
    const t = document.getElementById("mini-toast");
    if(!t) return;
    t.textContent = msg;
    t.style.opacity = "1";
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>{ t.style.opacity = "0"; }, 1400);
  }


  let curSource = hSource.value || "scene";
  let curValue = hValue.value || "";

  function setSeg(source){
    curSource = (source==="celebrity") ? "celebrity" : "scene";
    hSource.value = curSource;

    const btns = Array.from(seg.querySelectorAll(".seg-btn"));
    btns.forEach(b=>{
      const on = b.dataset.source === curSource;
      b.classList.toggle("on", on);
      b.setAttribute("aria-selected", on ? "true" : "false");
    });

    render();
  }

  function applySelection(source, value, {silent=false}={}){
    curSource = source;
    curValue = value;
    hSource.value = source;
    hValue.value = value;

    // Visual selected state
    Array.from(optionsRoot.querySelectorAll(".style-card")).forEach(c=>{
      c.classList.toggle("selected", c.dataset.value === value);
    });

    // Map to existing payload fields (safe)
    const mapper = STYLE_SOURCES[source]?.mapToPayload;
    if(typeof mapper === "function"){
      const out = mapper(value) || {};
      if(out.style){
        try{ if(window.__setStyleCard) window.__setStyleCard(out.style); }catch{}; try{ const st=document.getElementById("style"); if(st){ st.dispatchEvent(new Event("change",{bubbles:true})); st.dispatchEvent(new Event("input",{bubbles:true})); }}catch{}
      }
      if(typeof safeSetSelectValue === "function"){
        safeSetSelectValue("styleVariant", out.styleVariant || "");
      }else{
        // fallback
        const sv = document.getElementById("styleVariant");
        if(sv){ sv.value = out.styleVariant || ""; try{ sv.dispatchEvent(new Event("change",{bubbles:true})); }catch{} }
      }
    }

    // Update preview (UI-only)
    if(previewEl){
      const label = (curSource === "scene") ? "ç©¿æ­æƒ…å¢ƒ" : "åäººéˆæ„Ÿ";
      previewEl.textContent = curValue ? `å·²é¸ï¼š${label} / ${curValue}` : `å·²é¸ï¼š${label} / ï¼ˆæœªé¸ï¼‰`;
    }

    // Undo availability
    if(btnUndo){
      btnUndo.disabled = !(lastPick && lastPick.value);
    }

    if(!silent) haptic(8);
  }

  function render(){
    const gender = getCurrentGender();
    let list = [];

    if(curSource === "scene"){
      list = getSceneOptions().slice();
    }else{
      list = getCelebOptionsByGender(gender);
      ensureBtsVariantOption();
    }

      // If previously selected value is not in new list (e.g., gender changed), clear it
    if(curValue && !list.includes(curValue)){
      applySelection(curSource, "", {silent:true});
    }

optionsRoot.innerHTML = list.map(v=>{
      const sel = (v === curValue) ? " selected" : "";
      return `
        <div class="style-card${sel}" data-value="${escapeHtml(v)}" role="button" tabindex="0">
          <div class="name">${escapeHtml(v)}</div>
          <div class="desc"></div>
        </div>
      `.trim();
    }).join("");

    Array.from(optionsRoot.querySelectorAll(".style-card")).forEach(card=>{
      const v = card.dataset.value;
      const activate = ()=>applySelection(curSource, v);
      card.addEventListener("click", activate);
      card.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" || e.key===" "){ e.preventDefault(); activate(); }
      });
    });

    // If current selection is no longer in list, clear it
    if(curValue && !list.includes(curValue)){
      curValue = "";
      hValue.value = "";
    }
  }

  function randomPick(){
    const source = Math.random() < 0.5 ? "scene" : "celebrity";
    setSeg(source);

    const gender = getCurrentGender();
    const list = (source==="scene") ? getSceneOptions() : getCelebOptionsByGender(gender);
    const pick = list[Math.floor(Math.random()*list.length)];
    applySelection(source, pick);
    showToast("å·²å¹«ä½ éš¨æ©Ÿé¸ä¸€å€‹é¢¨æ ¼", 1200);
  }

  // events
  seg.addEventListener("click", (e)=>{
    const btn = e.target.closest(".seg-btn");
    if(!btn) return;
    setSeg(btn.dataset.source);
  });

  btnRandom.addEventListener("click", randomPick);

  // when gender changes, celebrity options should follow
  function bindGenderWatch(){
    const els = [];
    try{ const el = document.getElementById("gender"); if(el) els.push(el); }catch{}
    try{ document.querySelectorAll('input[name="gender"]').forEach(el=>els.push(el)); }catch{}
    try{ const el = document.querySelector('[data-field="gender"]'); if(el) els.push(el); }catch{}
    Array.from(new Set(els)).forEach(el=>{
      el.addEventListener("change", ()=>{
        // If currently on celebrity tab, update immediately
        if(curSource === "celebrity") render();
      });
    });
  }
  bindGenderWatch();

  // when ageGroup changes (adult/kids), re-render options if needed
  const ageGroupEl = document.getElementById("ageGroup");
  if(ageGroupEl){
    ageGroupEl.addEventListener("change", ()=>{
      showToast(String(ageGroupEl.value)==="kids" ? "ç«¥è£æ¨¡å¼ï¼šæƒ…å¢ƒå·²åˆ‡æ›" : "æˆäººæ¨¡å¼ï¼šæƒ…å¢ƒå·²åˆ‡æ›");
      // scene list differs between adult/kids; keep current tab stable
      if(curSource === "scene") render();
      // (future-proof) if celeb list should differ by age, rerender too
      if(curSource === "celebrity") render();
    });
  }

  // init
  setSeg(curSource);
}


  // ===== Public copy (from admin settings) =====
  const DEFAULT_PUBLIC_COPY = {
    brand_title: "findoutfit",
    brand_subtitle: "è¼¸å…¥æ¢ä»¶â†’ outfitç”Ÿæˆ â†’ å•†å“æ¨è–¦",
    left_title: "ç©¿æ­æ¢ä»¶",
    right_title: "AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“"
  };

  async function fetchPublicCopy(){
    try{
      const r = await fetch("/api/public-copy?ts=" + Date.now(), { cache: "no-store" });
      const t = await r.text();
      let j = {};
      try{ j = t ? JSON.parse(t) : {}; } catch { j = { raw: t }; }
      if(!r.ok) return { ok:false, error: j?.error || ("HTTP " + r.status), detail: j };
      const copy = j.copy || j.value || j.public_copy || j.data || null;
      if(!copy || typeof copy !== "object") return { ok:false, error:"no copy object", detail: j };
      return { ok:true, copy };
    }catch(e){
      return { ok:false, error: String(e?.message || e) };
    }
  }

  function applyPublicCopy(copy){
    const c = { ...DEFAULT_PUBLIC_COPY, ...(copy||{}) };
    const setText = (id, v)=>{
      const node = document.getElementById(id);
      if(!node) return;
      const s = (v == null) ? "" : String(v);
      if(s.trim()) node.textContent = s;
    };
    setText("copy-brand-title", c.findoutfit_title);
    setText("copy-brand-subtitle", c.brand);
    setText("copy-left-title", c.left_title);
    setText("copy-right-title", c.right_title);
  }


(async function init(){
      fetchPublicCopy().then(r=>{ if(r.ok) applyPublicCopy(r.copy); });
      bindRange("age","age-val");
      bindRange("height","height-val");
      bindRange("weight","weight-val");
      bindRange("temp","temp-val");
      bindStyleCards();
    // initial style/variant labels per audience
    try { updateStyleUIForAudience(); } catch {}
bindGenderSeg();
      const genderSel=document.getElementById("gender");
      if(genderSel) genderSel.addEventListener("change", () => { uiPaletteId=null; });
bindAgeGroupSeg();
      try{ bindStyleSourceUI(); }catch(e){ console.warn(e); }
      const ageGroupSel=document.getElementById("ageGroup");
      if(ageGroupSel) ageGroupSel.addEventListener("change", () => { uiPaletteId=null; });
document.getElementById("login-btn").addEventListener("click", loginGoogle);
      document.getElementById("logout-btn").addEventListener("click", logout);

      applyDeviceClass();
      window.addEventListener("resize", applyDeviceClass);

      /* mobile actionbar handled by applyDeviceClass() */
      const ctaBtn=document.getElementById("cta-products");
      if(ctaBtn) ctaBtn.addEventListener("click", ()=>{ scrollToElWithOffset("anchor-products",12,"smooth"); haptic(8); });

      const copyBtn=document.getElementById("copy-spec-btn");
      if(copyBtn) copyBtn.addEventListener("click", ()=>{ if(!flowState.spec) return; copyText(safeJson(flowState.spec)); showToast("å·²è¤‡è£½ Outfit Spec",1600); haptic(10); });

      const shareBtn=document.getElementById("share-btn");
      if(shareBtn) shareBtn.addEventListener("click", ()=>{ const hash=makeShareHash({ payload: flowState.payload, spec: flowState.spec }); const url=location.origin+location.pathname+hash; copyText(url); showToast("åˆ†äº«é€£çµå·²è¤‡è£½",1800); haptic(12); });

      document.getElementById("retry-btn").addEventListener("click", async ()=>{
        const btn=document.getElementById("retry-btn");
        btn.disabled=true;
        try{ setLoadingUI(true); await retryCurrentStep(); }
        catch(e){ console.error(e); showError(String(e?.message||e)); }
        finally{ setLoadingUI(false); btn.disabled=false; }
      });

      document.getElementById("restart-btn").addEventListener("click", async ()=>{
        const btn=document.getElementById("restart-btn");
        btn.disabled=true;
        try{ setLoadingUI(true); await generateAll(true); }
        catch(e){ console.error(e); showError(String(e?.message||e)); }
        finally{ setLoadingUI(false); btn.disabled=false; }
      });

      async function onGenerateClick(){ showRetryUI(false); try{ await generateAll(false); }catch{} }

      const goBtnDesktop=document.getElementById("go-btn");
      const goBtnMobile=document.getElementById("go-btn-mobile");
      if(goBtnDesktop) goBtnDesktop.addEventListener("click", async ()=>{
        goBtnDesktop.disabled=true; if(goBtnMobile) goBtnMobile.disabled=true;
        try{ await onGenerateClick(); } finally { goBtnDesktop.disabled=false; if(goBtnMobile) goBtnMobile.disabled=false; }
      });
      if(goBtnMobile) goBtnMobile.addEventListener("click", async ()=>{
        goBtnMobile.disabled=true; if(goBtnDesktop) goBtnDesktop.disabled=true;
        try{ await onGenerateClick(); } finally { goBtnMobile.disabled=false; if(goBtnDesktop) goBtnDesktop.disabled=false; }
      });

      document.getElementById("debug-box").classList.toggle("on", getDebug());

      await ensureTokenFromSession();
      await refreshAuthUI();
      try{ await refreshCollectionsUI(); }catch(e){ console.warn(e); }
      syncFavButtonUI();

      osSupabase.auth.onAuthStateChange(async (_event, session)=>{ if(session?.access_token) saveAccessToken(session.access_token); else clearAccessToken(); await refreshAuthUI();
      try{ await refreshCollectionsUI(); }catch(e){ console.warn(e); }
      syncFavButtonUI(); });

      const shared=parseShareFromLocation();
      if(shared && shared.payload){
        applyPayloadToForm(shared.payload);
        flowState.payload=shared.payload;
        setResultMeta(shared.payload);
        if(shared.spec){
          flowState.spec={ ...shared.spec, items: shared.spec.items||[], summary: shared.spec.summary||"" };
          renderOutfitSummary(flowState.spec.summary);
        }
        updateResultActions();
        showToast("å·²è¼‰å…¥åˆ†äº«æ¢ä»¶", 1600);
      }

      setGenerateStep("idle");
      setProgress(0);
      setStatus("", null, false);
      setLoadingUI(false);
    })();
</script>

  <div class="toast" id="toast" style="display:none;">å¾€ä¸‹çœ‹å•†å“ â†“</div>

  <!-- mini toast (UI-only) -->
  <div id="mini-toast" style="
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:18px; z-index:9999;
    background:rgba(0,0,0,.72); color:#fff;
    padding:10px 12px; border-radius:14px;
    font-size:13px; line-height:1; letter-spacing:.2px;
    opacity:0; pointer-events:none; transition:opacity .18s ease;
    max-width:min(92vw,520px); text-align:center;
  "></div>
</body>
</html>
