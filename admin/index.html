<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin - Display Rules</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;background:#f6f7fb;margin:0;padding:18px;color:#111}
    .card{max-width:820px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 14px 34px rgba(0,0,0,.06)}
    h1{margin:0 0 10px;font-size:18px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-weight:700;font-size:12px;margin:10px 0 6px}
    input{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{border:none;border-radius:999px;padding:10px 14px;font-weight:800;cursor:pointer}
    .primary{background:#111;color:#fff}
    .ghost{background:#fff;border:1px solid #e5e7eb}
    .muted{color:#6b7280;font-size:12px;margin-top:10px;white-space:pre-wrap}
    .line{height:1px;background:#eef2f7;margin:14px 0}
    .toggle{display:flex;align-items:center;gap:8px;margin-top:6px}
  </style>
</head>
<body>
  <div class="card">
    <h1>管理後台：每個種類顯示數量</h1>
    <div class="muted" id="status">讀取中…（需使用同一個登入 token）</div>

    <div class="line"></div>

    <h1 style="font-size:14px;margin-top:0;">每個 Slot 顯示數量（Google + Custom 合計）</h1>
    <div class="row">
      <div><label>上衣 top</label><input id="top" type="number" min="0" max="12" value="4"/></div>
      <div><label>下身 bottom</label><input id="bottom" type="number" min="0" max="12" value="4"/></div>
      <div><label>鞋 shoes</label><input id="shoes" type="number" min="0" max="12" value="4"/></div>
      <div><label>外套 outer</label><input id="outer" type="number" min="0" max="12" value="4"/></div>
      <div><label>包 bag</label><input id="bag" type="number" min="0" max="12" value="2"/></div>
      <div><label>帽 hat</label><input id="hat" type="number" min="0" max="12" value="2"/></div>
    </div>

    <div class="line"></div>

    <div class="row">
      <div>
        <label>每個 slot 最多顯示幾個 Custom</label>
        <input id="customMax" type="number" min="0" max="6" value="2"/>
        <div class="muted">其餘會用 Google Shopping 補滿。</div>
      </div>
      <div>
        <label>Fallback（補不滿再用較寬 query 搜一次）</label>
        <div class="toggle">
          <input id="fallback" type="checkbox" checked />
          <span class="muted">建議開啟，避免某些 slot 掉到 2～3。</span>
        </div>
      </div>
    </div>

    <div class="btns">
      <button class="ghost" id="btnReload">重新讀取</button>
      <button class="primary" id="btnSave">儲存</button>
    </div>

    <div class="muted" id="debug"></div>
  </div>

<script>
  const AUTH_KEY="os_supabase_access_token_v1";
  function getToken(){ return localStorage.getItem(AUTH_KEY); }

  function el(id){ return document.getElementById(id); }
  function setStatus(t){ el("status").textContent = t; }
  function setDebug(t){ el("debug").textContent = t || ""; }

  function readForm(){
    return {
      perSlot: {
        top: Number(el("top").value||0),
        bottom: Number(el("bottom").value||0),
        shoes: Number(el("shoes").value||0),
        outer: Number(el("outer").value||0),
        bag: Number(el("bag").value||0),
        hat: Number(el("hat").value||0),
      },
      customMax: Number(el("customMax").value||0),
      fallback: !!el("fallback").checked
    };
  }

  function applyRules(r){
    const per = (r && r.perSlot) || {};
    if (per.top!=null) el("top").value = per.top;
    if (per.bottom!=null) el("bottom").value = per.bottom;
    if (per.shoes!=null) el("shoes").value = per.shoes;
    if (per.outer!=null) el("outer").value = per.outer;
    if (per.bag!=null) el("bag").value = per.bag;
    if (per.hat!=null) el("hat").value = per.hat;
    if (r && r.customMax!=null) el("customMax").value = r.customMax;
    if (r && typeof r.fallback==="boolean") el("fallback").checked = r.fallback;
  }

  async function apiGet(){
    const token = getToken();
    if(!token){
      setStatus("找不到 token：請先到 /body-test.html 登入後，再回來 /admin");
      return;
    }
    setStatus("讀取中…");
    setDebug("");

    const r = await fetch("/api/admin-get-rules", {
      headers: { "Authorization": "Bearer " + token }
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok){
      setStatus("讀取失敗：" + (j.error || r.status));
      setDebug(JSON.stringify(j, null, 2));
      return;
    }
    applyRules(j.rules || null);
    setStatus("已載入（updated_at: " + (j.updated_at || "—") + "）");
  }

  async function apiSave(){
    const token = getToken();
    if(!token){
      setStatus("找不到 token：請先到 /body-test.html 登入後，再回來 /admin");
      return;
    }
    setStatus("儲存中…");
    setDebug("");

    const payload = { rules: readForm() };

    const r = await fetch("/api/admin-save-rules", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization":"Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const j = await r.json().catch(()=>({}));
    if(!r.ok){
      setStatus("儲存失敗：" + (j.error || r.status));
      setDebug(JSON.stringify(j, null, 2));
      return;
    }
    setStatus("已儲存 ✅（updated_at: " + (j.saved?.updated_at || "—") + "）");
    setDebug(JSON.stringify(j.saved?.rules || {}, null, 2));
  }

  el("btnReload").addEventListener("click", apiGet);
  el("btnSave").addEventListener("click", apiSave);

  apiGet();
</script>
</body>
</html>
