<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin – Custom Products</title>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
  background:#f6f7fb;margin:0;padding:18px;color:#111
}
.card{
  max-width:1200px;margin:0 auto;background:#fff;
  border:1px solid #e5e7eb;border-radius:16px;
  padding:16px;box-shadow:0 14px 34px rgba(0,0,0,.06)
}
h1{margin:0 0 10px;font-size:18px}
.tabs{display:flex;gap:8px;margin:10px 0 16px}
.tab{
  border:1px solid #e5e7eb;background:#fff;
  border-radius:999px;padding:8px 14px;
  font-weight:800;cursor:pointer
}
.tab.active{background:#111;color:#fff;border-color:#111}
.muted{color:#6b7280;font-size:12px;margin-top:6px}
.line{height:1px;background:#eef2f7;margin:14px 0}
label{display:block;font-weight:800;font-size:12px;margin:10px 0 6px}
input,textarea,select{
  width:100%;padding:10px 12px;
  border:1px solid #e5e7eb;border-radius:10px;
  font-size:14px;box-sizing:border-box
}
textarea{min-height:100px}
button{
  border:none;border-radius:999px;
  padding:10px 14px;font-weight:900;cursor:pointer
}
.primary{background:#111;color:#fff}
.ghost{background:#fff;border:1px solid #e5e7eb}
.danger{background:#b91c1c;color:#fff}

.split{
  display:grid;
  grid-template-columns:1.3fr .9fr;
  gap:16px
}
@media(max-width:960px){ .split{grid-template-columns:1fr} }

.tableWrap{max-height:65vh;overflow:auto}
table{
  width:100%;border-collapse:separate;border-spacing:0;
  border:1px solid #e5e7eb;border-radius:14px
}
th,td{
  font-size:12px;padding:10px;
  border-bottom:1px solid #eef2f7;
  vertical-align:top
}
th{background:#fafafa}
tr:last-child td{border-bottom:none}
.img{
  width:56px;height:56px;object-fit:cover;
  border-radius:10px;border:1px solid #e5e7eb
}
.pill{
  display:inline-block;padding:3px 8px;
  border:1px solid #e5e7eb;border-radius:999px;
  font-size:12px;margin-right:4px
}

.formPanel{
  position:sticky;top:16px;
  max-height:calc(100vh - 60px);
  overflow:auto;padding-right:6px
}
</style>
</head>

<body>
<div class="card">
  <h1>管理後台</h1>
  <div class="muted" id="status">初始化中…</div>

  <div class="tabs">
    <button class="tab active" id="tabCustom">Custom Products</button>
    <button class="tab" id="tabRules">Display Rules（尚未啟用）</button>
  </div>

  <!-- ================= Custom Products ================= -->
  <section id="panelCustom">
    <div class="split">

      <!-- 左：列表 -->
      <div>
        <h1 style="font-size:14px">商品列表</h1>

        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px">
          <div>
            <label>搜尋（title）</label>
            <input id="q" placeholder="例如：外套 / hoodie"/>
          </div>
          <div>
            <label>狀態</label>
            <select id="is_active">
              <option value="">全部</option>
              <option value="true">上架</option>
              <option value="false">下架</option>
            </select>
          </div>
          <div>
            <label>tag</label>
            <input id="tag" placeholder="item_top / adult"/>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="ghost" id="btnSearch">搜尋</button>
          <button class="ghost" id="btnNew">新增商品</button>
        </div>

        <div class="line"></div>

        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:70px">圖</th>
                <th>商品</th>
                <th style="width:80px">priority</th>
                <th style="width:70px">狀態</th>
                <th style="width:140px">操作</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="ghost" id="btnPrev">上一頁</button>
          <button class="ghost" id="btnNext">下一頁</button>
        </div>
      </div>

      <!-- 右：表單 -->
      <div class="formPanel">
        <h1 style="font-size:14px">編輯 / 新增</h1>

        <input type="hidden" id="edit_id"/>

        <label>title *</label>
        <input id="f_title"/>

        <label>image_url *</label>
        <input id="f_image_url"/>

        <label>product_url *</label>
        <input id="f_product_url"/>

        <label>tags（逗號分隔）</label>
        <input id="f_tags" placeholder="item_top, adult, female"/>

        <label>priority_boost</label>
        <input id="f_priority_boost" type="number" value="0"/>

        <label>badge_text（可空）</label>
        <input id="f_badge_text" placeholder="本站推薦"/>

        <label>tracking_params（JSON，可空）</label>
        <textarea id="f_tracking_params" placeholder='{"utm_source":"reco"}'></textarea>

        <div style="margin-top:8px">
          <label><input type="checkbox" id="f_is_active" checked/> 上架</label>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="primary" id="btnSave">儲存</button>
          <button class="ghost" id="btnClear">清空</button>
          <button class="danger" id="btnDeactivate">下架</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ================= Rules ================= -->
  <section id="panelRules" style="display:none">
    <div class="muted">
      Display Rules 尚未接後端。<br/>
      下一步會把「每個 slot 顯示幾個」接到 search-products。
    </div>
  </section>
</div>

<script>
const AUTH_KEY="os_supabase_access_token_v1";
const el=id=>document.getElementById(id);
const status=t=>el("status").textContent=t;
const token=()=>localStorage.getItem(AUTH_KEY);

async function api(url, opts={}){
  const t=token();
  if(!t) throw new Error("請先登入");
  const res=await fetch(url,{
    ...opts,
    headers:{...(opts.headers||{}),"Authorization":"Bearer "+t}
  });
  const j=await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(j.error||("HTTP "+res.status));
  return j;
}

let PAGE={limit:20,offset:0,count:0};

async function listReload(){
  status("載入中…");
  const p=new URLSearchParams({
    action:"custom_products.list",
    limit:PAGE.limit,
    offset:PAGE.offset,
    q:el("q").value||"",
    tag:el("tag").value||"",
    is_active:el("is_active").value||""
  });
  const j=await api("/api/admin?"+p);
  PAGE.count=j.count||0;
  el("list").innerHTML="";
  j.items.forEach(it=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><img class="img" src="${it.image_url}"/></td>
      <td>
        <b>${it.title}</b><br/>
        ${(it.tags||[]).map(t=>`<span class="pill">${t}</span>`).join("")}
      </td>
      <td>${it.priority_boost||0}</td>
      <td>${it.is_active?"上架":"下架"}</td>
      <td>
        <button class="ghost" onclick='edit(${JSON.stringify(it)})'>編輯</button>
      </td>`;
    el("list").appendChild(tr);
  });
  status(`共 ${PAGE.count} 筆`);
}

function edit(it){
  el("edit_id").value=it.id;
  el("f_title").value=it.title;
  el("f_image_url").value=it.image_url;
  el("f_product_url").value=it.product_url;
  el("f_tags").value=(it.tags||[]).join(", ");
  el("f_priority_boost").value=it.priority_boost||0;
  el("f_badge_text").value=it.badge_text||"";
  el("f_tracking_params").value=JSON.stringify(it.tracking_params||{},null,2);
  el("f_is_active").checked=!!it.is_active;
}

async function save(){
  const id=el("edit_id").value;
  const payload={
    title:el("f_title").value,
    image_url:el("f_image_url").value,
    product_url:el("f_product_url").value,
    tags:el("f_tags").value.split(",").map(x=>x.trim()).filter(Boolean),
    priority_boost:+el("f_priority_boost").value||0,
    badge_text:el("f_badge_text").value||null,
    tracking_params:JSON.parse(el("f_tracking_params").value||"{}"),
    is_active:el("f_is_active").checked
  };
  await api("/api/admin?action="+(id?"custom_products.update":"custom_products.create"),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(id?{id,patch:payload}:{item:payload})
  });
  await listReload();
}

el("btnSearch").onclick=()=>{PAGE.offset=0;listReload()};
el("btnSave").onclick=save;
el("btnNew").onclick=()=>{el("edit_id").value="";el("f_title").value=""};
el("btnPrev").onclick=()=>{PAGE.offset=Math.max(0,PAGE.offset-PAGE.limit);listReload()};
el("btnNext").onclick=()=>{if(PAGE.offset+PAGE.limit<PAGE.count){PAGE.offset+=PAGE.limit;listReload()}};

listReload();
</script>
</body>
</html>
