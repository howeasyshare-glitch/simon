<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>å…¬é–‹ç©¿æ­ Explore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;margin:0;background:#fafafa}
    header{padding:12px 16px;border-bottom:1px solid #ddd;background:#fff}
    main{padding:16px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:#fff;border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .card img{width:100%;display:block}
    .card-body{padding:10px}
    .counts{font-size:13px;color:#555;margin-bottom:6px}
    .actions{display:flex;gap:6px}
    .actions button{flex:1;font-size:13px;padding:6px;border-radius:6px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
    .actions button:hover{background:#eee}
    .actions button[disabled]{opacity:.55;cursor:not-allowed}
    .btn-like.liked{background:#ffe9ef;border-color:#ff9db7}
  </style>
</head>
<body>

<header>
  <strong>å…¬é–‹ç©¿æ­ Explore</strong>
</header>

<main>
  <div id="grid" class="grid"></div>
</main>

<script>
function getAnonId(){
  let id = localStorage.getItem("anon_id");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("anon_id", id);
  }
  return id;
}
const anonId = getAnonId();

function likeKey(outfitId){ return `liked:${anonId}:${outfitId}`; }
function getLiked(outfitId){ return localStorage.getItem(likeKey(outfitId)) === "1"; }
function setLiked(outfitId, v){ localStorage.setItem(likeKey(outfitId), v ? "1" : "0"); }

async function api(action, body){
  const res = await fetch("/explore/list?action=" + encodeURIComponent(action), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body || {})
  });

  const text = await res.text();
  if(!res.ok){
    throw new Error(text || ("API failed: " + res.status));
  }
  if(!text.trim()) return { ok: true };
  try { return JSON.parse(text); } catch { return { ok: true, raw: text }; }
}

async function load(){
  // âœ… åŠ  tsï¼šé¿å… CDN å¿«å–é€ æˆã€Œåˆ·æ–°å¾Œåƒæ²’ä¿ç•™ã€
  const url = "/explore/list?limit=30&sort=like&ts=" + Date.now();
  const r = await fetch(url);
  const json = await r.json();

  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  (json.items || []).forEach(item => {
    const el = document.createElement("div");
    el.className = "card";

    const liked = getLiked(item.id);

    el.innerHTML = `
      <img src="${item.image_url}" alt="">
      <div class="card-body">
        <div class="counts">
          â¤ï¸ <span class="like">${item.like_count}</span>
          Â· ğŸ” <span class="share">${item.share_count}</span>
          Â· âœ¨ <span class="apply">${item.apply_count}</span>
        </div>
        <div class="actions">
          <button class="btn-like ${liked ? "liked" : ""}">${liked ? "å·² Like" : "Like"}</button>
          <button class="btn-share">åˆ†äº«</button>
          <button class="btn-apply">å¥—ç”¨</button>
        </div>
      </div>
    `;

    const $like = el.querySelector(".like");
    const $share = el.querySelector(".share");
    const $apply = el.querySelector(".apply");
    const $btnLike = el.querySelector(".btn-like");
    const $btnShare = el.querySelector(".btn-share");
    const $btnApply = el.querySelector(".btn-apply");

    // ---- Like: toggle å»é‡ï¼ˆåŒä¸€ anon_id åªæœƒ like/unlikeï¼Œä¸æœƒä¸€ç›´+1ï¼‰----
    $btnLike.onclick = async () => {
      $btnLike.disabled = true;

      const wasLiked = getLiked(item.id);

      // optimisticï¼šå…ˆåœ¨ UI åˆ‡æ›
      const nextLiked = !wasLiked;
      setLiked(item.id, nextLiked);
      $btnLike.classList.toggle("liked", nextLiked);
      $btnLike.textContent = nextLiked ? "å·² Like" : "Like";
      $like.textContent = String(Math.max(parseInt($like.textContent,10) + (nextLiked ? 1 : -1), 0));

      try{
        const out = await api("like", { outfit_id: item.id, anon_id: anonId, toggle: true });
        // å¾Œç«¯è‹¥å›å‚³ countsï¼Œå°±ä»¥å¾Œç«¯ç‚ºæº–
        if(out && out.counts && typeof out.counts.like_count === "number"){
          $like.textContent = String(out.counts.like_count);
        }
        // å¾Œç«¯è‹¥å›å‚³ likedï¼ˆtoggle pathï¼‰ï¼Œä»¥å¾Œç«¯ç‹€æ…‹ç‚ºæº–
        if(typeof out.liked === "boolean"){
          setLiked(item.id, out.liked);
          $btnLike.classList.toggle("liked", out.liked);
          $btnLike.textContent = out.liked ? "å·² Like" : "Like";
        }
      }catch(e){
        // revert
        setLiked(item.id, wasLiked);
        $btnLike.classList.toggle("liked", wasLiked);
        $btnLike.textContent = wasLiked ? "å·² Like" : "Like";
        $like.textContent = String(Math.max(parseInt($like.textContent,10) + (wasLiked ? 1 : -1), 0));
        alert("Like å¤±æ•—ï¼š" + (e && e.message ? e.message : ""));
      }finally{
        $btnLike.disabled = false;
      }
    };

    // ---- Share: è¨˜æ¬¡æ•¸OKï¼Œä½†åŠ é˜²é€£é»ï¼ˆ1.2sï¼‰----
    $btnShare.onclick = async () => {
      $btnShare.disabled = true;
      setTimeout(()=>{ $btnShare.disabled = false; }, 1200);

      // optimistic
      $share.textContent = String(parseInt($share.textContent,10) + 1);

      try{ await navigator.clipboard.writeText(location.origin + item.share_url); }catch(_){}

      try{
        const out = await api("share", { outfit_id: item.id });
        if(out && out.counts && typeof out.counts.share_count === "number"){
          $share.textContent = String(out.counts.share_count);
        }
        // ä¸è¦æ¯æ¬¡éƒ½ alertï¼Œå¾ˆåµï¼›éœ€è¦çš„è©±ä½ å†èªª
      }catch(e){
        $share.textContent = String(Math.max(parseInt($share.textContent,10) - 1, 0));
        alert("Share å¤±æ•—ï¼š" + (e && e.message ? e.message : ""));
      }
    };

    // ---- Apply: è¨˜æ¬¡æ•¸OK + é˜²é€£é»ï¼ŒæˆåŠŸå¾Œè·³å›é¦–é  ----
    $btnApply.onclick = async () => {
      $btnApply.disabled = true;
      setTimeout(()=>{ $btnApply.disabled = false; }, 1200);

      $apply.textContent = String(parseInt($apply.textContent,10) + 1);

      try{
        const out = await api("apply", { outfit_id: item.id });
        if(out && out.counts && typeof out.counts.apply_count === "number"){
          $apply.textContent = String(out.counts.apply_count);
        }
        location.href = "/?apply=" + encodeURIComponent(item.share_slug || "");
      }catch(e){
        $apply.textContent = String(Math.max(parseInt($apply.textContent,10) - 1, 0));
        alert("Apply å¤±æ•—ï¼š" + (e && e.message ? e.message : ""));
      }
    };

    grid.appendChild(el);
  });
}

load();
</script>

</body>
</html>
