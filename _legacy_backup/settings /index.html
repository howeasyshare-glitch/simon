
<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>設定｜首頁文案與選單</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;background:#f6f7fb;margin:0;padding:18px;color:#111}
    .card{max-width:1060px;margin:0 auto;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 14px 34px rgba(0,0,0,.06)}
    h1{margin:0 0 10px;font-size:18px}
    h2{margin:0 0 8px;font-size:14px}
    .muted{color:#6b7280;font-size:12px;white-space:pre-wrap}
    .line{height:1px;background:#eef2f7;margin:14px 0}
    label{display:block;font-weight:800;font-size:12px;margin:10px 0 6px}
    input, textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;font-size:14px;box-sizing:border-box}
    textarea{min-height:96px}
    button{border:none;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .primary{background:#111;color:#fff}
    .ghost{background:#fff;border:1px solid #e5e7eb}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 920px){ .row{grid-template-columns:1fr} }
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .box{border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#fafafa}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:2px 6px}
    .help{font-size:12px;color:#6b7280;margin-top:6px;line-height:1.5}
  </style>
</head>
<body>
  <div class="card">
    <h1>設定：首頁文案與選單</h1>
    <div class="muted" id="status">初始化中…</div>

    <div class="line"></div>

    <div class="box">
      <h2>一、首頁四個主要文字（對齊首頁 id）</h2>
      <div class="row">
        <div>
          <label>findoutfit（品牌標題）</label>
          <input id="c_brand" placeholder="例如：findoutfit" />
          <div class="help">對應首頁：<span class="kbd">copy-brand-title</span></div>
        </div>
        <div>
          <label>輸入條件→ outfit生成 → 商品推薦（副標）</label>
          <input id="c_tagline" placeholder="例如：輸入條件→ outfit生成 → 商品推薦" />
          <div class="help">對應首頁：<span class="kbd">copy-brand-subtitle</span></div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>穿搭條件（左側標題）</label>
          <input id="c_left_title" placeholder="例如：穿搭條件" />
          <div class="help">對應首頁：<span class="kbd">copy-left-title</span></div>
        </div>
        <div>
          <label>AI 穿搭示意圖 & 類似商品（右側標題）</label>
          <input id="c_right_title" placeholder="例如：AI 穿搭示意圖 & 類似商品" />
          <div class="help">對應首頁：<span class="kbd">copy-right-title</span></div>
        </div>
      </div>
    </div>

    <div class="line"></div>

    <div class="box">
      <h2>二、情境 / 風格（依類別）</h2>
      <div class="row">
        <div>
          <label>成人穿搭情境（每行一個）</label>
          <textarea id="c_scene_adult" placeholder="休閒\n上班/通勤\n約會\n運動\n旅行\n正式場合"></textarea>
        </div>
        <div>
          <label>兒童穿搭情境（每行一個）</label>
          <textarea id="c_scene_kids" placeholder="日常/上學\n戶外玩樂\n運動/體育課\n聚會/生日\n旅行\n正式場合"></textarea>
        </div>
      </div>
      <div class="help">會影響首頁「穿搭情境」選單。資料會存到 <span class="kbd">home_copy.style_by_category</span>。</div>
    </div>

    <div class="line"></div>

    <div class="box">
      <h2>三、名人靈感（依性別）</h2>
      <div class="row">
        <div>
          <label>男名人靈感（每行一個）</label>
          <textarea id="c_celeb_male" placeholder="GD\nBTS\nV\nJungkook\nJimin\nRM"></textarea>
        </div>
        <div>
          <label>女名人靈感（每行一個）</label>
          <textarea id="c_celeb_female" placeholder="Lisa\nIU\nJennie\nRosé\nJisoo\nKarina"></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>中性名人靈感（可留空；每行一個）</label>
          <textarea id="c_celeb_neutral" placeholder="Jennie\nLisa\nJungkook\nRM"></textarea>
          <div class="help">留空時：首頁會「從男/女各隨機挑 2 個」組成中性選單。</div>
        </div>
        <div>
          <label>分享頁 CTA 按鈕文字（可選）</label>
          <input id="c_share_cta" placeholder="例如：製作屬於自己的穿搭" />
        </div>
      </div>
      <div class="help">資料會存到 <span class="kbd">home_copy.celebs_by_gender</span>。</div>
    </div>

    <div class="line"></div>

    <div class="box">
      <h2>四、更多文案（JSON，可留空）</h2>
      <textarea id="c_extra" placeholder='{"landing_title":"今天想穿什麼？"}'></textarea>
      <div class="help">可留空。未來新增文案 key 時，不用改 UI 也能存。</div>
    </div>

    <div class="actions">
      <button class="ghost" id="btnLoad">讀取</button>
      <button class="primary" id="btnSave">儲存</button>
    </div>

    <div class="line"></div>

    <div class="box">
      <h2>前台會讀取這份設定（公開 API：<span class="kbd">/api/public-copy</span>）</h2>
      <div class="muted" id="debug"></div>
    </div>
  </div>

<script>
  const AUTH_KEY = "os_supabase_access_token_v1";
  const el = (id)=>document.getElementById(id);
  const setStatus = (t)=> el("status").textContent = t;

  function token(){ return localStorage.getItem(AUTH_KEY); }

  function parseLines(s){
    return String(s||"")
      .split(/\r?\n/)
      .map(x=>x.trim())
      .filter(Boolean);
  }
  function joinLines(arr){
    return (Array.isArray(arr) ? arr : []).map(String).map(x=>x.trim()).filter(Boolean).join("\n");
  }
  function jsonParseSafe(s){
    const t = String(s||"").trim();
    if(!t) return {};
    try { return JSON.parse(t); } catch { return {}; }
  }

  async function api(path, opts={}){
    const t = token();
    if(!t) throw new Error("找不到 token：請先登入後再開 /settings");

    const headers = Object.assign({}, opts.headers||{}, { "Authorization":"Bearer " + t });
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const text = await res.text();
    let json = {};
    try{ json = text ? JSON.parse(text) : {}; }catch{ json = { raw:text }; }

    if(!res.ok){
      const msg = json?.error ? json.error : ("HTTP " + res.status);
      const e = new Error(msg);
      e.payload = json;
      throw e;
    }
    return json;
  }

  function readForm(){
    return {
      brand: el("c_brand").value || "",
      tagline: el("c_tagline").value || "",
      left_title: el("c_left_title").value || "",
      right_title: el("c_right_title").value || "",
      share_cta: el("c_share_cta").value || "",
      style_by_category: {
        adult: parseLines(el("c_scene_adult").value),
        kids: parseLines(el("c_scene_kids").value),
      },
      celebs_by_gender: {
        male: parseLines(el("c_celeb_male").value),
        female: parseLines(el("c_celeb_female").value),
        neutral: parseLines(el("c_celeb_neutral").value),
      },
      extra: jsonParseSafe(el("c_extra").value),
    };
  }

  function applyForm(copy){
    const c = (copy && typeof copy === "object") ? copy : {};
    el("c_brand").value = c.brand || "";
    el("c_tagline").value = c.tagline || "";
    el("c_left_title").value = c.left_title || "";
    el("c_right_title").value = c.right_title || "";
    el("c_share_cta").value = c.share_cta || "";

    const scene = (c.style_by_category && typeof c.style_by_category === "object") ? c.style_by_category : {};
    el("c_scene_adult").value = joinLines(scene.adult || []);
    el("c_scene_kids").value = joinLines(scene.kids || []);

    const celebs = (c.celebs_by_gender && typeof c.celebs_by_gender === "object") ? c.celebs_by_gender : {};
    el("c_celeb_male").value = joinLines(celebs.male || []);
    el("c_celeb_female").value = joinLines(celebs.female || []);
    el("c_celeb_neutral").value = joinLines(celebs.neutral || []);

    el("c_extra").value = JSON.stringify(c.extra || {}, null, 2);
  }

  function setBusy(b, label){
    el("btnLoad").disabled = b;
    el("btnSave").disabled = b;
    if(label) setStatus(label);
  }

  async function load(){
    try{
      setBusy(true, "讀取中…");
      el("debug").textContent = "";
      const j = await api("/api/admin?action=get_copy");
      applyForm(j.copy || null);
      setBusy(false, "已讀取 ✅（updated_at: " + (j.updated_at || "—") + "）");
      el("debug").textContent = JSON.stringify({ ok:true, updated_at: j.updated_at || null }, null, 2);
    }catch(e){
      setBusy(false, "讀取失敗：" + e.message);
      el("debug").textContent = JSON.stringify(e.payload || {}, null, 2);
    }
  }

  async function save(){
    try{
      setBusy(true, "儲存中…");
      el("debug").textContent = "";
      const payload = readForm();
      const j = await api("/api/admin?action=save_copy", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ copy: payload })
      });
      applyForm(j.saved?.copy || payload);
      setBusy(false, "已儲存 ✅（updated_at: " + (j.saved?.updated_at || "—") + "）");
      el("debug").textContent = JSON.stringify({ ok:true, updated_at: j.saved?.updated_at || null }, null, 2);
    }catch(e){
      setBusy(false, "儲存失敗：" + e.message);
      el("debug").textContent = JSON.stringify(e.payload || {}, null, 2);
    }
  }

  el("btnLoad").addEventListener("click", load);
  el("btnSave").addEventListener("click", save);

  (async()=>{ await load(); })();
</script>
</body>
</html>
