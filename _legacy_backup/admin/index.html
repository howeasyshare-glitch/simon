<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111;
      --muted:#6b7280;
      --line:#eef2f7;
      --border:#e5e7eb;
      --shadow:0 14px 34px rgba(0,0,0,.06);
      --radius:16px;
      --radius2:12px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;background:var(--bg);margin:0;padding:18px;color:var(--text)}
    .card{max-width:1180px;margin:0 auto;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    h1{margin:0 0 10px;font-size:18px}
    .muted{color:var(--muted);font-size:12px;white-space:pre-wrap}
    .line{height:1px;background:var(--line);margin:14px 0}
    .tabs{display:flex;gap:8px;margin:10px 0 16px;flex-wrap:wrap}
    .tab{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}

    label{display:block;font-weight:800;font-size:12px;margin:10px 0 6px}
    input, textarea, select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius2);font-size:14px;min-width:0}
    textarea{min-height:92px;resize:vertical}

    button{border:none;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;white-space:nowrap}
    button:disabled{opacity:.5;cursor:not-allowed}
    .primary{background:#111;color:#fff}
    .ghost{background:#fff;border:1px solid var(--border)}
    .danger{background:#b91c1c;color:#fff}

    .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;align-items:start}
    .row3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;align-items:start}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}

    /* Layout */
    .split{display:grid;grid-template-columns: minmax(520px,1.2fr) minmax(360px,.8fr);gap:14px;align-items:start}
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }
    @media (max-width: 1100px){ .row3{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width: 720px){ .row3{grid-template-columns:1fr} }

    /* Left list card */
    .panel{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .panelHead{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHead h2{margin:0;font-size:14px}
    .panelHead .hint{font-size:12px;color:var(--muted)}

    /* Table -> list rows (better alignment) */
    .listWrap{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .listHeader, .listRow{
      display:grid;
      grid-template-columns: 68px minmax(220px, 1fr) 90px 92px 168px;
      gap:10px;
      align-items:center;
      padding:10px 12px;
    }
    .listHeader{
      background:#fafafa;
      font-size:12px;
      font-weight:900;
      border-bottom:1px solid var(--line);
    }
    .listRow{
      border-bottom:1px solid var(--line);
      font-size:12px;
      align-items:start;
    }
    .listRow:last-child{border-bottom:none}
    @media (max-width: 980px){
      .listHeader{display:none}
      .listRow{
        grid-template-columns: 64px 1fr;
        grid-auto-rows:auto;
      }
      .cellMeta, .cellRight{grid-column:1 / -1}
    }

    .img{width:56px;height:56px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:#f3f4f6}
    .title{font-weight:900;font-size:13px;line-height:1.25}
    .sub{color:var(--muted);font-size:12px;margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff}
    .pillBtn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:#fff;cursor:pointer;font-weight:900}
    .pillBtn.active{border-color:#111}
    .pillBtn.on{background:#111;color:#fff;border-color:#111}
    .pillBtn.off{background:#fff;color:#111;border-color:var(--border)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}

    .cellActions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .cellActions button{padding:8px 10px}
    .cellMeta{color:var(--muted)}
    .cellRight{display:flex;gap:10px;align-items:center;justify-content:flex-end}

    /* Right form: sticky, scroll */
    .formPanel{
      position: sticky;
      top: 14px;
      max-height: calc(100vh - 40px);
      overflow: auto;
      padding: 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .formPanel h2{margin:0;font-size:14px}
    .formTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:6px;
    }
    .formBadge{
      font-size:12px;
      padding:4px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fafafa;
      color:#111;
      font-weight:900;
    }
    .help{
      margin-top:8px;
      padding:10px 12px;
      border:1px dashed var(--border);
      border-radius:12px;
      background:#fcfcfd;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .inlineCheck{display:flex;align-items:center;gap:8px;margin-top:10px}
    .inlineCheck input{width:auto}
    .dangerZone{margin-top:10px;padding-top:10px;border-top:1px solid var(--line)}

    /* Import */
    .importBox{
      margin-top:12px;
      padding:12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
    }
    .importBox h3{margin:0 0 8px;font-size:13px}
    .importGrid{display:grid;grid-template-columns:1fr;gap:10px}
    .small{font-size:12px;color:var(--muted)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#f3f4f6;border:1px solid var(--border);padding:1px 6px;border-radius:6px}
  </style>
</head>

<body>
  <div class="card">
    <h1>管理後台</h1>
    <div class="muted" id="status">初始化中…</div>

    <div class="tabs">
      <button class="tab active" id="tabRules" type="button">Display Rules</button>
      <button class="tab" id="tabCustom" type="button">Custom Products</button>
    </div>

    <!-- ===== Rules ===== -->
    <section id="panelRules">
      <h1 style="font-size:14px;margin-top:0;">每個 Slot 顯示數量（Google + Custom 合計）</h1>

      <div class="row">
        <div><label>上衣 top</label><input id="top" type="number" min="0" max="12" value="4"/></div>
        <div><label>下身 bottom</label><input id="bottom" type="number" min="0" max="12" value="4"/></div>
        <div><label>鞋 shoes</label><input id="shoes" type="number" min="0" max="12" value="4"/></div>
        <div><label>外套 outer</label><input id="outer" type="number" min="0" max="12" value="4"/></div>
        <div><label>包 bag</label><input id="bag" type="number" min="0" max="12" value="2"/></div>
        <div><label>帽 hat</label><input id="hat" type="number" min="0" max="12" value="2"/></div>
      </div>

      <div class="line"></div>

      <div class="row">
        <div>
          <label>每個 slot 最多顯示幾個 Custom</label>
          <input id="customMax" type="number" min="0" max="6" value="2"/>
          <div class="muted">其餘用 Google Shopping 補滿。</div>
        </div>
        <div>
          <label>Fallback（補不滿再用較寬 query 搜一次）</label>
          <div class="inlineCheck">
            <input id="fallback" type="checkbox" checked />
            <span class="muted">建議開啟，避免某些 slot 掉到 2～3。</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="ghost" id="btnReloadRules" type="button">重新讀取</button>
        <button class="primary" id="btnSaveRules" type="button">儲存規則</button>
      </div>

      <div class="muted" id="debugRules"></div>
    </section>

    <!-- ===== Custom Products ===== -->
    <section id="panelCustom" style="display:none;">
      <div class="split">
        <!-- Left -->
        <div class="panel">
          <div class="panelHead">
            <div>
              <h2>商品列表</h2>
              <div class="hint">提示：點「狀態」可直接切換上架/下架；點「編輯」會把資料帶到右側。</div>
            </div>
            <div class="actions" style="margin:0">
              <button class="ghost" id="btnRefresh" type="button">重新載入</button>
              <button class="ghost" id="btnNew" type="button">新增商品</button>
            </div>
          </div>

          <div class="row3">
            <div>
              <label>搜尋（title）</label>
              <input id="q" placeholder="例如：羽絨 外套 / hoodie"/>
            </div>
            <div>
              <label>狀態</label>
              <select id="is_active">
                <option value="">全部</option>
                <option value="true">上架</option>
                <option value="false">下架</option>
              </select>
            </div>
            <div>
              <label>tag（包含）</label>
              <input id="tag" placeholder="例如：item_top / male / kids"/>
            </div>
          </div>

          <div class="actions">
            <button class="primary" id="btnSearch" type="button">搜尋</button>
            <button class="ghost" id="btnClearFilter" type="button">清除篩選</button>
            <span class="muted" id="pageHint"></span>
          </div>

          <div class="line"></div>

          <div class="listWrap">
            <div class="listHeader">
              <div>圖</div>
              <div>標題 / tags</div>
              <div>priority</div>
              <div>狀態</div>
              <div style="text-align:right">操作</div>
            </div>
            <div id="list"></div>
          </div>

          <div class="actions">
            <button class="ghost" id="btnPrev" type="button">上一頁</button>
            <button class="ghost" id="btnNext" type="button">下一頁</button>
            <span class="muted" id="debugList"></span>
          </div>

          <!-- Import -->
          <div class="importBox">
            <h3>匯入（Import）</h3>
            <div class="small">
              支援兩種：
              <br/>1) JSON array（每筆含 title/image_url/product_url，其他欄位可選）
              <br/>2) CSV（第一列為欄位名；欄位可含：title,image_url,product_url,merchant,priority_boost,tags,badge_text,discount_type,discount_code,tracking_params,is_active）
              <br/>tags 可用 <span class="kbd">item_top, male, adult</span> 逗號分隔；tracking_params 可留白或填 JSON。
            </div>
            <div class="importGrid" style="margin-top:8px">
              <textarea id="importText" placeholder='貼上 JSON array 或 CSV 內容'></textarea>
              <div class="actions" style="margin:0">
                <input id="importFile" type="file" accept=".json,.csv,text/plain" />
                <button class="primary" id="btnImport" type="button">開始匯入</button>
              </div>
              <div class="muted" id="importDebug"></div>
            </div>
          </div>
        </div>

        <!-- Right -->
        <div class="formPanel">
          <div class="formTop">
            <h2>編輯 / 新增</h2>
            <span class="formBadge" id="formMode">新增中</span>
          </div>

          <div class="help">
            <div><b>必填：</b>title、image_url、product_url</div>
            <div style="margin-top:6px">
              <b>tags 建議至少放：</b>
              <span class="kbd">item_top / item_outerwear / item_bottom / item_shoes / item_bag / item_hat</span>
              +（可選）<span class="kbd">adult / kids</span>、<span class="kbd">male / female / neutral</span>、<span class="kbd">scene_formal</span> 之類 styleTag。
            </div>
            <div style="margin-top:6px">
              <b>is_active：</b>勾選=上架（前台可被選到）；不勾=下架（保留資料但不出現）。
            </div>
          </div>

          <input type="hidden" id="edit_id"/>

          <label>title *</label>
          <input id="f_title" placeholder="商品名稱"/>

          <label>image_url *</label>
          <input id="f_image_url" placeholder="https://...jpg"/>

          <label>product_url *</label>
          <input id="f_product_url" placeholder="https://..."/>

          <div class="row">
            <div>
              <label>merchant（可空）</label>
              <input id="f_merchant" placeholder="momo / shopee / yourbrand"/>
              <div class="muted">純顯示/辨識用（不影響搜尋規則）。</div>
            </div>
            <div>
              <label>priority_boost（建議填）</label>
              <input id="f_priority_boost" type="number" value="0"/>
              <div class="muted">越大越容易被挑中（同 slot / 同 tags 下）。</div>
            </div>
          </div>

          <label>tags（用逗號分隔）</label>
          <input id="f_tags" placeholder="item_top, adult, male, scene_formal"/>

          <div class="row">
            <div>
              <label>badge_text（可空）</label>
              <input id="f_badge_text" placeholder="本站推薦 / 熱銷"/>
              <div class="muted">前台卡片上顯示的小標籤。</div>
            </div>
            <div>
              <label>discount_type（可空）</label>
              <select id="f_discount_type">
                <option value="none">none</option>
                <option value="code">code</option>
                <option value="sale">sale</option>
              </select>
              <div class="muted">code=有折扣碼，sale=純促銷標記。</div>
            </div>
          </div>

          <label>discount_code（可空）</label>
          <input id="f_discount_code" placeholder="例：NEW88"/>

          <label>tracking_params（JSON，可空）</label>
          <textarea id="f_tracking_params" placeholder='{"utm_source":"site","utm_medium":"ref"}'></textarea>
          <div class="muted">可空白。用來自動把 UTM 參數加到 product_url（追蹤成效用）。</div>

          <div class="inlineCheck">
            <input id="f_is_active" type="checkbox" checked />
            <span class="muted"><b>is_active（上架）</b>：勾選=上架；不勾=下架</span>
          </div>

          <div class="actions">
            <button class="primary" id="btnSaveItem" type="button">儲存</button>
            <button class="ghost" id="btnClear" type="button">清空</button>
            <button class="danger" id="btnDeactivate" type="button">下架（is_active=false）</button>
          </div>

          <div class="muted" id="debugForm"></div>

          <div class="dangerZone">
            <div class="muted">
              目前「下架」是軟刪除（保留資料，前台不顯示）。如要真刪除（hard delete），建議另外做一個更危險的按鈕並加二次確認。
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
  // ========= Auth token =========
  const AUTH_KEY="os_supabase_access_token_v1";
  const el = (id)=>document.getElementById(id);
  const setStatus = (t)=> el("status").textContent = t;
  const token = ()=> localStorage.getItem(AUTH_KEY);

  // ========= API helper (shows raw text if not JSON) =========
  async function api(path, opts={}){
    const t = token();
    if(!t) throw new Error("找不到 token：請先到 /body-test.html 登入後，再回來 /admin");

    const headers = Object.assign({}, opts.headers||{}, { "Authorization": "Bearer " + t });
    const res = await fetch(path, Object.assign({}, opts, { headers }));
    const text = await res.text();
    let json = {};
    try { json = text ? JSON.parse(text) : {}; } catch { json = { raw: text }; }

    if(!res.ok){
      const msg = json?.error ? json.error : ("HTTP " + res.status);
      const e = new Error(`HTTP ${res.status}\n${msg}`);
      e.payload = json;
      throw e;
    }
    return json;
  }

  // ========= Tabs =========
  function showTab(which){
    el("tabRules").classList.toggle("active", which==="rules");
    el("tabCustom").classList.toggle("active", which==="custom");
    el("panelRules").style.display = which==="rules" ? "" : "none";
    el("panelCustom").style.display = which==="custom" ? "" : "none";
  }
  el("tabRules").addEventListener("click", ()=>showTab("rules"));
  el("tabCustom").addEventListener("click", async ()=>{
    showTab("custom");
    PAGE.offset = 0;
    await listReload();
  });

  // ========= Rules =========
  function readRulesForm(){
    return {
      perSlot: {
        top: Number(el("top").value||0),
        bottom: Number(el("bottom").value||0),
        shoes: Number(el("shoes").value||0),
        outer: Number(el("outer").value||0),
        bag: Number(el("bag").value||0),
        hat: Number(el("hat").value||0),
      },
      customMax: Number(el("customMax").value||0),
      fallback: !!el("fallback").checked
    };
  }
  function applyRules(r){
    const per = (r && r.perSlot) || {};
    if (per.top!=null) el("top").value = per.top;
    if (per.bottom!=null) el("bottom").value = per.bottom;
    if (per.shoes!=null) el("shoes").value = per.shoes;
    if (per.outer!=null) el("outer").value = per.outer;
    if (per.bag!=null) el("bag").value = per.bag;
    if (per.hat!=null) el("hat").value = per.hat;
    if (r && r.customMax!=null) el("customMax").value = r.customMax;
    if (r && typeof r.fallback==="boolean") el("fallback").checked = r.fallback;
  }
  async function rulesReload(){
    try{
      setStatus("讀取規則中…");
      el("debugRules").textContent = "";
      const j = await api("/api/admin?op=get_rules");
      applyRules(j.rules || null);
      setStatus("規則已載入 ✅（updated_at: " + (j.updated_at||"—") + "）");
    }catch(e){
      setStatus("規則讀取失敗：" + e.message);
      el("debugRules").textContent = JSON.stringify(e.payload||{}, null, 2);
    }
  }
  async function rulesSave(){
    try{
      setStatus("儲存規則中…");
      el("debugRules").textContent = "";
      const j = await api("/api/admin?op=save_rules", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ rules: readRulesForm() })
      });
      setStatus("規則已儲存 ✅（updated_at: " + (j.saved?.updated_at||"—") + "）");
      el("debugRules").textContent = "";
    }catch(e){
      setStatus("規則儲存失敗：" + e.message);
      el("debugRules").textContent = JSON.stringify(e.payload||{}, null, 2);
    }
  }
  el("btnReloadRules").addEventListener("click", rulesReload);
  el("btnSaveRules").addEventListener("click", rulesSave);

  // ========= Custom Products =========
  let PAGE = { limit: 30, offset: 0, count: 0 };

  function tagsToArray(s){
    return String(s||"").split(",").map(x=>x.trim()).filter(Boolean);
  }
  function jsonParseSafe(s){
    const t = String(s||"").trim();
    if(!t) return {};        // ✅ 可以空白
    try { return JSON.parse(t); } catch { return {}; }
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function setFormMode(text){
    el("formMode").textContent = text;
  }

  function fillForm(item){
    el("edit_id").value = item?.id || "";
    el("f_title").value = item?.title || "";
    el("f_image_url").value = item?.image_url || "";
    el("f_product_url").value = item?.product_url || "";
    el("f_merchant").value = item?.merchant || "";
    el("f_priority_boost").value = item?.priority_boost ?? 0;
    el("f_tags").value = Array.isArray(item?.tags) ? item.tags.join(", ") : "";
    el("f_badge_text").value = item?.badge_text || "";
    el("f_discount_type").value = item?.discount_type || "none";
    el("f_discount_code").value = item?.discount_code || "";
    el("f_tracking_params").value = JSON.stringify(item?.tracking_params || {}, null, 2);
    el("f_is_active").checked = !!item?.is_active;

    if(item?.id){
      setFormMode("編輯中");
      el("debugForm").textContent = "編輯中 ID: " + item.id;
    }else{
      setFormMode("新增中");
      el("debugForm").textContent = "新增中";
    }
  }

  function clearForm(){
    fillForm({ is_active:true, priority_boost:0, discount_type:"none", tracking_params:{} });
    setTimeout(()=> el("f_title")?.focus(), 0);
  }

  function readForm(){
    return {
      title: el("f_title").value?.trim(),
      image_url: el("f_image_url").value?.trim(),
      product_url: el("f_product_url").value?.trim(),
      merchant: el("f_merchant").value?.trim() || null,
      priority_boost: Number(el("f_priority_boost").value||0),
      tags: tagsToArray(el("f_tags").value),
      badge_text: (el("f_badge_text").value || "").trim() || null,
      discount_type: el("f_discount_type").value,
      discount_code: (el("f_discount_code").value || "").trim() || null,
      tracking_params: jsonParseSafe(el("f_tracking_params").value),
      is_active: !!el("f_is_active").checked
    };
  }

  function buildListParams(){
    const params = new URLSearchParams();
    params.set("limit", String(PAGE.limit));
    params.set("offset", String(PAGE.offset));

    const q = el("q").value.trim();
    const is_active = el("is_active").value; // "true"/"false"/""
    const tag = el("tag").value.trim();

    if(q) params.set("q", q);
    if(is_active) params.set("is_active", is_active);
    if(tag) params.set("tag", tag);

    return params;
  }

  function renderRow(it){
    const tagsHtml = (it.tags||[]).slice(0, 8).map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join(" ");
    const moreTags = (it.tags||[]).length > 8 ? `<span class="pill">+${(it.tags||[]).length-8}</span>` : "";

    const row = document.createElement("div");
    row.className = "listRow";
    row.innerHTML = `
      <div><img class="img" src="${escapeHtml(it.image_url||"")}" alt=""/></div>

      <div>
        <div class="title">${escapeHtml(it.title||"")}</div>
        <div class="sub">${tagsHtml} ${moreTags}</div>
        <div class="sub">
          <a href="${escapeHtml(it.product_url||"#")}" target="_blank" rel="noreferrer">商品連結</a>
          <span class="mono">${it.merchant ? "· " + escapeHtml(it.merchant) : ""}</span>
        </div>
      </div>

      <div class="cellMeta"><span class="pill">${Number(it.priority_boost||0)}</span></div>

      <div class="cellRight">
        <button class="pillBtn ${it.is_active ? "on" : "off"}" data-toggle="${it.id}">
          ${it.is_active ? "上架" : "下架"}
        </button>
      </div>

      <div class="cellActions">
        <button class="ghost" data-edit="${it.id}">編輯</button>
        <button class="ghost" data-copy="${it.id}">複製</button>
      </div>
    `;

    row.querySelector("[data-edit]").addEventListener("click", ()=> fillForm(it));
    row.querySelector("[data-copy]").addEventListener("click", ()=>{
      // copy = 新增一筆（不帶 id），方便快速建立相似商品
      const clone = Object.assign({}, it);
      delete clone.id;
      fillForm(clone);
      setFormMode("新增（由複製）");
      el("debugForm").textContent = "已複製到表單（請修改後儲存）";
      setTimeout(()=> el("f_title")?.focus(), 0);
    });
    row.querySelector("[data-toggle]").addEventListener("click", ()=> toggleActive(it));

    return row;
  }

  async function listReload(){
    try{
      setStatus("載入商品列表中…");
      el("debugList").textContent = "";
      el("pageHint").textContent = "";

      const j = await api("/api/admin?action=custom_products.list&" + buildListParams().toString());
      const items = j.items || [];
      PAGE.count = j.count ?? 0;

      const list = el("list");
      list.innerHTML = "";
      items.forEach(it => list.appendChild(renderRow(it)));

      const pageNo = Math.floor(PAGE.offset / PAGE.limit) + 1;
      const pageMax = Math.max(1, Math.ceil((PAGE.count||0) / PAGE.limit));
      el("pageHint").textContent = `本頁 ${items.length} 筆｜共 ${PAGE.count} 筆｜第 ${pageNo}/${pageMax} 頁`;

      // Prev/Next disable
      el("btnPrev").disabled = PAGE.offset <= 0;
      el("btnNext").disabled = (PAGE.offset + PAGE.limit) >= PAGE.count;

      setStatus("列表已載入 ✅");
    }catch(e){
      setStatus("列表載入失敗：" + e.message);
      el("debugList").textContent = JSON.stringify(e.payload||{}, null, 2);
    }
  }

  async function toggleActive(it){
    try{
      setStatus("更新狀態中…");
      const j = await api("/api/admin?action=custom_products.update", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ id: it.id, patch: { is_active: !it.is_active } })
      });

      // 更新右側表單（如果剛好在編輯同一筆）
      if(el("edit_id").value === String(it.id)) fillForm(j.item || it);

      await listReload();
      setStatus("已更新 ✅");
    }catch(e){
      setStatus("更新失敗：" + e.message);
      el("debugForm").textContent = JSON.stringify(e.payload||{}, null, 2);
    }
  }

  async function saveItem(){
    try{
      setStatus("儲存中…");
      el("debugForm").textContent = "";

      const id = el("edit_id").value;
      const payload = readForm();

      // 必填先擋（你之前遇到「看起來都要填」其實是後端/DB 欄位限制造成，先讓前端更明確）
      if(!payload.title) throw new Error("請填 title（必填）");
      if(!payload.image_url) throw new Error("請填 image_url（必填）");
      if(!payload.product_url) throw new Error("請填 product_url（必填）");

      let j;
      if(id){
        j = await api("/api/admin?action=custom_products.update", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ id, patch: payload })
        });
      }else{
        j = await api("/api/admin?action=custom_products.create", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ item: payload })
        });
        el("edit_id").value = (j.item?.id || "");
      }

      fillForm(j.item || payload);
      await listReload();
      setStatus("儲存成功 ✅");
    }catch(e){
      setStatus("儲存失敗：" + e.message);
      el("debugForm").textContent = JSON.stringify(e.payload||{}, null, 2);
    }
  }

  function clearFilters(){
    el("q").value = "";
    el("is_active").value = "";
    el("tag").value = "";
  }

  async function deactivate(){
    const id = el("edit_id").value;
    if(!id){
      el("debugForm").textContent = "尚未選擇商品（請先從列表按「編輯」）";
      return;
    }
    try{
      setStatus("下架中…");
      const j = await api("/api/admin?action=custom_products.update", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ id, patch: { is_active:false } })
      });

      fillForm(j.item || Object.assign({}, readForm(), { id, is_active:false }));
      await listReload();
      setStatus("已下架 ✅");
    }catch(e){
      setStatus("下架失敗：" + e.message);
      el("debugForm").textContent = JSON.stringify(e.payload||{}, null, 2);
    }
  }

  // ========= Import =========
  function parseCSV(text){
    // 簡易 CSV：支援逗號、雙引號，換行
    const rows = [];
    let i=0, field="", row=[], inQuotes=false;
    const pushField=()=>{ row.push(field); field=""; };
    const pushRow=()=>{ rows.push(row); row=[]; };

    while(i<text.length){
      const c=text[i];
      if(inQuotes){
        if(c === '"'){
          if(text[i+1] === '"'){ field+='"'; i+=2; continue; }
          inQuotes=false; i++; continue;
        }
        field+=c; i++; continue;
      }else{
        if(c === '"'){ inQuotes=true; i++; continue; }
        if(c === ","){ pushField(); i++; continue; }
        if(c === "\n"){ pushField(); pushRow(); i++; continue; }
        if(c === "\r"){ i++; continue; }
        field+=c; i++; continue;
      }
    }
    pushField(); pushRow();
    return rows.filter(r => r.some(x => String(x||"").trim() !== ""));
  }

  function normalizeImportItem(obj){
    // 對齊後端 normalizeItem 期望的 key
    const tags = Array.isArray(obj.tags) ? obj.tags : (typeof obj.tags === "string" ? obj.tags : "");
    const tracking_params = obj.tracking_params;

    return {
      title: obj.title ?? "",
      image_url: obj.image_url ?? "",
      product_url: obj.product_url ?? "",
      merchant: obj.merchant ?? null,
      priority_boost: Number(obj.priority_boost ?? 0),
      tags: tags,
      badge_text: obj.badge_text ?? null,
      discount_type: obj.discount_type ?? "none",
      discount_code: obj.discount_code ?? null,
      tracking_params: tracking_params ?? {},
      is_active: ("is_active" in obj) ? (String(obj.is_active).toLowerCase() !== "false") : true
    };
  }

  async function runImport(){
    try{
      const text = el("importText").value.trim();
      if(!text) throw new Error("請貼上 JSON 或 CSV 內容");

      setStatus("匯入中…");
      el("importDebug").textContent = "";

      let items = [];

      // Try JSON first
      if(text.startsWith("[") || text.startsWith("{")){
        let parsed;
        try { parsed = JSON.parse(text); } catch { parsed = null; }
        if(Array.isArray(parsed)){
          items = parsed.map(normalizeImportItem);
        } else if (parsed && typeof parsed === "object" && Array.isArray(parsed.items)){
          items = parsed.items.map(normalizeImportItem);
        } else {
          throw new Error("JSON 格式不正確：請貼 JSON array，或 {items:[...]}");
        }
      }else{
        // CSV
        const rows = parseCSV(text);
        if(rows.length < 2) throw new Error("CSV 至少需要標題列 + 1 筆資料");
        const header = rows[0].map(h => String(h||"").trim());
        const body = rows.slice(1);

        items = body.map(r=>{
          const obj = {};
          header.forEach((h, idx)=> obj[h] = r[idx]);
          // tags：可用逗號字串
          // tracking_params：若填 JSON 字串，後端會 parse
          return normalizeImportItem(obj);
        });
      }

      // basic validate
      const bad = items.findIndex(x => !String(x.title||"").trim() || !String(x.image_url||"").trim() || !String(x.product_url||"").trim());
      if(bad >= 0) throw new Error(`第 ${bad+1} 筆缺少必填（title/image_url/product_url）`);

      const j = await api("/api/admin?action=custom_products.import", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ items })
      });

      el("importDebug").textContent = `匯入成功 ✅ 共 ${j.count || (j.inserted||[]).length} 筆`;
      setStatus("匯入完成 ✅");
      await listReload();
    }catch(e){
      setStatus("匯入失敗：" + e.message);
      el("importDebug").textContent = JSON.stringify(e.payload||{}, null, 2) || String(e.message||e);
    }
  }

  async function handleImportFile(file){
    if(!file) return;
    const text = await file.text();
    el("importText").value = text;
  }

  // ========= Buttons =========
  el("btnSearch").addEventListener("click", ()=>{ PAGE.offset=0; listReload(); });
  el("btnRefresh").addEventListener("click", ()=> listReload());
  el("btnClearFilter").addEventListener("click", ()=>{ clearFilters(); PAGE.offset=0; listReload(); });

  el("btnNew").addEventListener("click", clearForm);
  el("btnPrev").addEventListener("click", ()=>{ PAGE.offset = Math.max(0, PAGE.offset - PAGE.limit); listReload(); });
  el("btnNext").addEventListener("click", ()=>{ if(PAGE.offset + PAGE.limit < PAGE.count){ PAGE.offset += PAGE.limit; listReload(); } });

  el("btnSaveItem").addEventListener("click", saveItem);
  el("btnClear").addEventListener("click", clearForm);
  el("btnDeactivate").addEventListener("click", deactivate);

  // Enter to search
  ["q","tag"].forEach(id=>{
    el(id).addEventListener("keydown", (ev)=>{
      if(ev.key === "Enter"){ ev.preventDefault(); PAGE.offset=0; listReload(); }
    });
  });
  el("is_active").addEventListener("change", ()=>{ PAGE.offset=0; listReload(); });

  // Import events
  el("btnImport").addEventListener("click", runImport);
  el("importFile").addEventListener("change", (ev)=> handleImportFile(ev.target.files?.[0]));

  // ========= Boot =========
  (async ()=>{
    try{
      await rulesReload();
      clearForm();
      setStatus("初始化完成 ✅（切換到 Custom Products 開始管理）");
    }catch(e){
      setStatus(String(e.message || e));
    }
  })();
</script>
</body>
</html>
