<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>Body Test · Outfit + Image + Products</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f5f5f7;
    --card:#ffffff;
    --text:#111;
    --muted:#6b7280;
    --border:#e5e7eb;
    --shadow:0 14px 36px rgba(0,0,0,.08);
    --radius:18px;
    --accent:#111;
    --ok:#0a7;
    --err:#c33;
  }
  *{box-sizing:border-box;}
  body{
    margin:0; padding:0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #ffecec 0, #f5f5f7 45%, #f5f5f7 100%);
    color:var(--text);
  }
  .page{max-width:1180px;margin:0 auto;padding:22px 16px 36px;}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;}
  .brand{display:flex;align-items:center;gap:10px;}
  .brand-dot{width:28px;height:28px;border-radius:999px;background:linear-gradient(135deg,#111,#444);box-shadow:0 10px 18px rgba(0,0,0,.22);}
  .brand h1{font-size:20px;margin:0;letter-spacing:.02em;}
  .sub{font-size:12px;color:var(--muted);margin-top:4px;}

  .layout{display:grid;grid-template-columns:420px minmax(0,1fr);gap:16px;align-items:stretch;}
  @media(max-width:960px){.layout{grid-template-columns:1fr;}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;}
  .card-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;}
  .title{font-size:16px;font-weight:800;margin:0;}
  .pill{font-size:11px;padding:5px 10px;border-radius:999px;background:#f3f4f6;color:#666;white-space:nowrap;}

  .authbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}
  .authbar .who{font-size:12px;color:var(--muted);}
  .btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-size:13px;cursor:pointer;}
  .btn.primary{background:#111;color:#fff;border-color:#111;}
  .btn:disabled{opacity:.55;cursor:not-allowed;}

  .field{margin-bottom:12px;}
  label{display:block;font-size:12px;font-weight:700;margin-bottom:6px;}
  input,select{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:#fafafa;outline:none;font-size:14px;}
  input:focus,select:focus{background:#fff;border-color:#c7c7d4;}

  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  @media(max-width:520px){.grid2{grid-template-columns:1fr;}}

  .optlist{margin-top:8px;border:1px solid var(--border);border-radius:14px;overflow:hidden;background:#fafafa;}
  .optrow{display:flex;align-items:center;justify-content:space-between;padding:12px;border-top:1px solid var(--border);}
  .optrow:first-child{border-top:none;}
  .optname{font-size:13px;font-weight:800;}
  .optdesc{font-size:12px;color:var(--muted);margin-top:2px;}
  .optleft{display:flex;flex-direction:column;gap:2px;}
  .toggle{width:42px;height:24px;border-radius:999px;background:#e5e7eb;position:relative;cursor:pointer;flex:0 0 auto;}
  .toggle::after{content:"";width:18px;height:18px;border-radius:999px;background:#fff;position:absolute;top:3px;left:3px;box-shadow:0 6px 12px rgba(0,0,0,.12);transition:all .15s ease;}
  input[type="checkbox"]{display:none;}
  input[type="checkbox"]:checked + .toggle{background:#111;}
  input[type="checkbox"]:checked + .toggle::after{left:21px;}

  .actionrow{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px;}
  .status{font-size:12px;color:var(--muted);line-height:1.35;min-height:18px;}
  .status.ok{color:var(--ok);}
  .status.err{color:var(--err);}

  .resultGrid{display:grid;grid-template-rows:auto auto auto;gap:14px;}
  .imageWrap{border-radius:var(--radius);border:1px solid var(--border);background:#f3f4f6;height:440px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
  .imageWrap img{width:100%;height:100%;object-fit:contain;display:block;}
  .placeholder{color:var(--muted);font-size:13px;text-align:center;padding:12px;}

  .sectionLabel{font-size:12px;font-weight:900;color:#555;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
  .debugToggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);user-select:none;}

  .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;}
  .pitem{border:1px solid var(--border);border-radius:14px;background:#fff;padding:10px;display:flex;gap:10px;}
  .pthumb{width:64px;height:64px;border-radius:12px;border:1px solid var(--border);background:#fafafa;overflow:hidden;flex:0 0 auto;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;}
  .pthumb img{width:100%;height:100%;object-fit:cover;}
  .pmeta{min-width:0;display:flex;flex-direction:column;gap:4px;}
  .ptitle{font-size:13px;font-weight:900;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .psub{font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:6px;}
  .plink{font-size:12px;color:#1a73e8;text-decoration:none;}
  .plink:hover{text-decoration:underline;}
  .badge{font-size:11px;padding:2px 8px;border-radius:999px;background:#f1f2f6;color:#555;}

  pre{margin:0;background:#0f1115;color:#d6e0ff;padding:12px;border-radius:14px;font-size:12px;overflow:auto;border:1px solid #222;}
</style>
</head>

<body>
<div class="page">

  <header>
    <div>
      <div class="brand">
        <div class="brand-dot"></div>
        <div>
          <h1>Outfit Studio · Body Test</h1>
          <div class="sub">流程：Spec（扣點）→ Image → Products。右上可開 Debug。</div>
        </div>
      </div>
    </div>

    <div class="authbar">
      <span id="who" class="who">未登入</span>
      <span id="credit" class="pill">點數：—</span>
      <button id="loginBtn" class="btn primary" onclick="loginGoogle()">Google 登入</button>
      <button id="logoutBtn" class="btn" style="display:none" onclick="logout()">登出</button>
    </div>
  </header>

  <main class="layout">

    <!-- Left -->
    <section class="card">
      <div class="card-head">
        <div class="title">穿搭條件</div>
        <div class="pill">扣 1 點 / 次</div>
      </div>

      <div class="grid2">
        <div class="field">
          <label>性別</label>
          <select id="gender">
            <option value="female">女性</option>
            <option value="male">男性</option>
            <option value="neutral">中性</option>
          </select>
        </div>

        <div class="field">
          <label>年齡</label>
          <input id="age" type="number" value="25" min="10" max="80" />
        </div>

        <div class="field">
          <label>身高 (cm)</label>
          <input id="height" type="number" value="165" min="120" max="210" />
        </div>

        <div class="field">
          <label>體重 (kg)</label>
          <input id="weight" type="number" value="55" min="30" max="200" />
        </div>
      </div>

      <div class="field">
        <label>風格</label>
        <select id="style">
          <option value="casual">休閒</option>
          <option value="minimal">極簡</option>
          <option value="street">街頭</option>
          <option value="sporty">運動</option>
          <option value="smart">Smart Casual</option>
        </select>
      </div>

      <div class="field">
        <label>風格變體（品牌 / 名人）</label>
        <select id="styleVariant">
          <option value="">（不使用變體）</option>
          <optgroup label="品牌 Brand">
            <option value="brand-uniqlo">UNIQLO</option>
            <option value="brand-muji">MUJI</option>
            <option value="brand-cos">COS</option>
            <option value="brand-nike-tech">Nike Tech</option>
            <option value="brand-ader-error">Ader Error</option>
          </optgroup>
          <optgroup label="名人 Celeb（只參考穿搭氛圍）">
            <option value="celeb-iu-casual">IU casual</option>
            <option value="celeb-jennie-minimal">Jennie minimal</option>
            <option value="celeb-gd-street">G-Dragon street</option>
            <option value="celeb-lisa-sporty">Lisa sporty</option>
          </optgroup>
        </select>
      </div>

      <div class="field">
        <label>溫度 (°C)</label>
        <input id="temp" type="number" value="22" min="-5" max="40" />
      </div>

      <div class="optlist">
        <div class="optrow">
          <div class="optleft">
            <div class="optname">包包</div>
            <div class="optdesc">需要 bag 才會出現在 Spec + 商品</div>
          </div>
          <label style="margin:0;">
            <input id="withBag" type="checkbox" />
            <span class="toggle" aria-hidden="true"></span>
          </label>
        </div>

        <div class="optrow">
          <div class="optleft">
            <div class="optname">帽子</div>
            <div class="optdesc">需要 hat 才會出現在 Spec + 商品</div>
          </div>
          <label style="margin:0;">
            <input id="withHat" type="checkbox" />
            <span class="toggle" aria-hidden="true"></span>
          </label>
        </div>

        <div class="optrow">
          <div class="optleft">
            <div class="optname">外套</div>
            <div class="optdesc">勾選或溫度 ≤ 20°C 時會生成 outer</div>
          </div>
          <label style="margin:0;">
            <input id="withCoat" type="checkbox" />
            <span class="toggle" aria-hidden="true"></span>
          </label>
        </div>
      </div>

      <div class="actionrow">
        <button id="btn" class="btn primary" style="width:100%; border-radius:14px;" onclick="generate()">
          產生穿搭圖 & 搜尋商品
        </button>
      </div>

      <div id="status" class="status">提示：請先登入。點數不足時會自動禁止產生。</div>
    </section>

    <!-- Right -->
    <section class="card">
      <div class="card-head">
        <div class="title">AI 穿搭示意圖 & 類似商品</div>
        <div class="debugToggle">
          <input id="debugToggle" type="checkbox" onchange="toggleDebug(this)" />
          <span>Debug</span>
        </div>
      </div>

      <div class="resultGrid">
        <!-- Image -->
        <div>
          <div class="sectionLabel"><span class="pill">AI 穿搭示意圖</span></div>
          <div id="imageWrap" class="imageWrap">
            <div class="placeholder">尚未產生示意圖</div>
          </div>
        </div>

        <!-- Products -->
        <div>
          <div class="sectionLabel"><span class="pill">類似商品（Google Shopping）</span></div>
          <div id="products" class="products">
            <div class="placeholder">尚未產生商品</div>
          </div>
        </div>

        <!-- Debug -->
        <div id="debugPanel" style="display:none;">
          <div class="sectionLabel"><span class="pill">Outfit Spec（Debug）</span></div>
          <pre id="json">—</pre>
        </div>
      </div>
    </section>

  </main>
</div>

<script>

  <script>
  const AUTH_KEY = "os_supabase_access_token_v1";

  function parseHashTokens() {
    // Supabase implicit flow: #access_token=...&refresh_token=...&expires_in=...
    const hash = window.location.hash || "";
    if (!hash.startsWith("#")) return null;

    const params = new URLSearchParams(hash.slice(1));
    const access_token = params.get("access_token");
    const refresh_token = params.get("refresh_token");
    const expires_in = params.get("expires_in");

    if (!access_token) return null;

    return {
      access_token,
      refresh_token,
      expires_in: expires_in ? Number(expires_in) : null,
      received_at: Date.now()
    };
  }

  function saveAccessToken(accessToken) {
    localStorage.setItem(AUTH_KEY, accessToken);
  }

  function getAccessToken() {
    return localStorage.getItem(AUTH_KEY);
  }

  function clearAccessToken() {
    localStorage.removeItem(AUTH_KEY);
  }

  async function fetchMeAndUpdateUI() {
    const token = getAccessToken();
    const elStatus = document.getElementById("login-status");
    const elCredits = document.getElementById("credits");

    if (!token) {
      if (elStatus) elStatus.textContent = "未登入";
      if (elCredits) elCredits.textContent = "—";
      return;
    }

    try {
      const r = await fetch("/api/me", {
        headers: { Authorization: "Bearer " + token }
      });
      const j = await r.json();

      if (!r.ok || !j.ok) {
        // token 失效
        clearAccessToken();
        if (elStatus) elStatus.textContent = "登入狀態異常（請重新登入）";
        if (elCredits) elCredits.textContent = "—";
        return;
      }

      if (elStatus) elStatus.textContent = j.user?.email ? `已登入：${j.user.email}` : "已登入";
      if (elCredits) elCredits.textContent = String(j.credits_left ?? 0);
    } catch (e) {
      console.error("me failed:", e);
      if (elStatus) elStatus.textContent = "登入狀態異常（請重新登入）";
      if (elCredits) elCredits.textContent = "—";
    }
  }

  // ====== page init ======
  (function initAuth() {
    // 1) 如果網址 hash 帶 token，存起來並清掉 hash
    const tokens = parseHashTokens();
    if (tokens?.access_token) {
      saveAccessToken(tokens.access_token);

      // 清除 hash，避免每次重整都重跑
      history.replaceState(null, "", window.location.pathname + window.location.search);
    }

    // 2) 更新 UI（登入狀態 / 點數）
    fetchMeAndUpdateUI();
  })();
</script>

/** 你 Supabase 專案 URL（若更換請改這行） */
const SUPABASE_URL = "https://auiwcsolpvufxxyhnvaf.supabase.co";

/** ===== Auth token helpers ===== */
function getSupabaseSessionFromLocalStorage() {
  const key = Object.keys(localStorage).find(k => k.startsWith("sb-") && k.endsWith("-auth-token"));
  if (!key) return null;
  try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
}
function getToken() {
  const t = localStorage.getItem("access_token");
  if (t) return t;
  const s = getSupabaseSessionFromLocalStorage();
  return s?.access_token || null;
}
function setToken(t){ if (t) localStorage.setItem("access_token", t); }
function clearToken(){ localStorage.removeItem("access_token"); }
function consumeHashTokenIfAny(){
  const hash = location.hash || "";
  if (!hash.includes("access_token=")) return;
  const params = new URLSearchParams(hash.replace(/^#/, ""));
  const accessToken = params.get("access_token");
  if (accessToken) setToken(accessToken);
  history.replaceState(null, "", location.pathname + location.search);
}
function loginGoogle(){
  const redirectTo = location.origin + location.pathname;
  const url = `${SUPABASE_URL}/auth/v1/authorize?provider=google&redirect_to=${encodeURIComponent(redirectTo)}`;
  location.href = url;
}
function logout(){
  clearToken();
  const sbKey = Object.keys(localStorage).find(k => k.startsWith("sb-") && k.endsWith("-auth-token"));
  if (sbKey) localStorage.removeItem(sbKey);
  location.reload();
}
function toggleDebug(el){
  document.getElementById("debugPanel").style.display = el.checked ? "block" : "none";
}

/** ===== Credits / me ===== */
let CURRENT_CREDITS = null;

function setCreditsUI(v){
  CURRENT_CREDITS = v;
  const credit = document.getElementById("credit");
  credit.textContent = `點數：${v ?? "—"}`;

  const btn = document.getElementById("btn");
  if (typeof v === "number" && v <= 0){
    btn.disabled = true;
    const status = document.getElementById("status");
    status.className = "status err";
    status.textContent = "點數不足：請補點後再試。";
  }else{
    btn.disabled = false;
  }
}

async function refreshMe(){
  const token = getToken();
  const who = document.getElementById("who");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  if (!token){
    who.textContent = "未登入";
    setCreditsUI(null);
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    return;
  }

  try{
    const r = await fetch("/api/me", { headers: { "Authorization": "Bearer " + token } });
    const data = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(data?.error || "me api failed");

    who.textContent = data?.email ? `已登入：${data.email}` : "已登入";
    setCreditsUI(data.credits_left ?? null);

    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
  }catch(e){
    who.textContent = "登入狀態異常（請重新登入）";
    setCreditsUI(null);
    document.getElementById("status").className = "status err";
    document.getElementById("status").textContent = "登入 token 失效或 /api/me 失敗，請按 Google 登入重試。";
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
  }
}

/** ===== Render helpers ===== */
function renderImagePlaceholder(msg){
  const wrap = document.getElementById("imageWrap");
  wrap.innerHTML = `<div class="placeholder">${msg || "尚未產生示意圖"}</div>`;
}
function renderImageBase64(base64, mime){
  const wrap = document.getElementById("imageWrap");
  const img = document.createElement("img");
  img.alt = "Outfit preview";
  img.src = `data:${mime || "image/png"};base64,` + base64;
  wrap.innerHTML = "";
  wrap.appendChild(img);
}

function slotLabel(slot){
  const m = { top:"上衣", bottom:"下身", shoes:"鞋子", outer:"外套", bag:"包包", hat:"帽子" };
  return m[slot] || slot;
}
function escapeHtml(str){
  return String(str ?? "").replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function renderProductsFromSerp(resultsBySlot){
  const box = document.getElementById("products");
  box.innerHTML = "";

  const slots = Object.keys(resultsBySlot || {});
  if (slots.length === 0){
    box.innerHTML = `<div class="placeholder">沒有取得商品結果</div>`;
    return;
  }

  const order = ["top","bottom","shoes","outer","bag","hat"];
  const sorted = order.filter(s => slots.includes(s)).concat(slots.filter(s => !order.includes(s)));

  for (const slot of sorted){
    const list = resultsBySlot[slot] || [];
    for (const p of list){
      const el = document.createElement("div");
      el.className = "pitem";
      const thumb = p.thumbnail ? `<img src="${p.thumbnail}" alt="thumb">` : `—`;
      el.innerHTML = `
        <div class="pthumb">${thumb}</div>
        <div class="pmeta">
          <div class="psub">
            <span class="badge">${slotLabel(slot)}</span>
            ${p.source ? `<span>${escapeHtml(p.source)}</span>` : ``}
            ${p.price ? `<span>· ${escapeHtml(p.price)}</span>` : ``}
          </div>
          <div class="ptitle">${escapeHtml(p.title)}</div>
          ${
            p.link
              ? `<a class="plink" href="${p.link}" target="_blank" rel="noopener noreferrer">前往查看商品</a>`
              : `<span class="psub">無連結</span>`
          }
        </div>
      `;
      box.appendChild(el);
    }
  }
}

/** ===== Main flow ===== */
async function generate(){
  const status = document.getElementById("status");
  const btn = document.getElementById("btn");
  const jsonEl = document.getElementById("json");
  const token = getToken();

  if (!token){
    status.className = "status err";
    status.textContent = "未登入：請先按右上角 Google 登入。";
    return;
  }
  if (typeof CURRENT_CREDITS === "number" && CURRENT_CREDITS <= 0){
    status.className = "status err";
    status.textContent = "點數不足：請補點後再試。";
    return;
  }

  const payload = {
    gender: document.getElementById("gender").value,
    age: Number(document.getElementById("age").value),
    height: Number(document.getElementById("height").value),
    weight: Number(document.getElementById("weight").value),
    style: document.getElementById("style").value,
    styleVariant: document.getElementById("styleVariant").value || "",
    temp: Number(document.getElementById("temp").value),
    withBag: document.getElementById("withBag").checked,
    withHat: document.getElementById("withHat").checked,
    withCoat: document.getElementById("withCoat").checked
  };

  btn.disabled = true;
  status.className = "status";
  status.textContent = "Step 1/3：產生 Outfit Spec（會扣 1 點）...";
  renderImagePlaceholder("準備產生示意圖…");
  document.getElementById("products").innerHTML = `<div class="placeholder">搜尋中…</div>`;

  try{
    // 1) Spec (扣點)
    const specResp = await fetch("/api/generate-outfit-spec", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const specData = await specResp.json().catch(()=> ({}));
    jsonEl.textContent = JSON.stringify(specData, null, 2);

    if (!specResp.ok){
      status.className = "status err";
      status.textContent = `Spec API 失敗：${specData.error || specResp.status}`;
      btn.disabled = false;
      return;
    }

    // 更新點數
    if (specData.credits_left !== undefined) setCreditsUI(specData.credits_left);

    status.className = "status ok";
    status.textContent = `Step 1/3 完成：已扣 1 點。剩餘點數：${specData.credits_left ?? "—"}；Step 2/3：產生穿搭圖...`;

    // 2) Image（用同樣 payload 或你想要的字段）
    const imgResp = await fetch("/api/generate-image", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const imgData = await imgResp.json().catch(()=> ({}));
    if (!imgResp.ok){
      status.className = "status err";
      status.textContent = `Image API 失敗：${imgData.error || imgResp.status}`;
      renderImagePlaceholder("圖片產生失敗（請看 Debug / logs）");
      btn.disabled = false;
      return;
    }

    if (!imgData.image){
      status.className = "status err";
      status.textContent = `Image API 無回傳 image`;
      renderImagePlaceholder("圖片產生失敗（無 image）");
      btn.disabled = false;
      return;
    }

    renderImageBase64(imgData.image, imgData.mime);

    status.className = "status ok";
    status.textContent = `Step 2/3 完成：已產生穿搭圖；Step 3/3：搜尋商品...`;

    // 3) Products（依 spec items 搜尋）
    const items = Array.isArray(specData.items) ? specData.items : [];
    const prodResp = await fetch("/api/search-products-from-spec", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ items, gl:"tw", hl:"zh-tw", maxPerSlot: 3 })
    });

    const prodData = await prodResp.json().catch(()=> ({}));
    if (!prodResp.ok){
      status.className = "status err";
      status.textContent = `商品搜尋失敗：${prodData.error || prodResp.status}`;
      document.getElementById("products").innerHTML = `<div class="placeholder">商品搜尋失敗</div>`;
      btn.disabled = false;
      return;
    }

    renderProductsFromSerp(prodData.results || {});
    status.className = "status ok";
    status.textContent = `完成 ✅（Spec + 圖片 + 商品）剩餘點數：${specData.credits_left ?? "—"}`;

  }catch(e){
    console.error(e);
    status.className = "status err";
    status.textContent = "發生錯誤：" + (e.message || "Unknown error");
  }finally{
    // 若點數被扣到 0，setCreditsUI 會把按鈕 disable
    if (!(typeof CURRENT_CREDITS === "number" && CURRENT_CREDITS <= 0)){
      btn.disabled = false;
    }
  }
}

/** boot */
consumeHashTokenIfAny();
refreshMe();
</script>
</body>
</html>
