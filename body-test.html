<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Outfit Studio Â· Body Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#fff;
      --text:#1b1b1f;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#111827;
      --accent:#ff6b6b;
      --ok:#16a34a;
      --warn:#ef4444;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;

      /* Mobile safe area */
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #ffecec 0, var(--bg) 45%, var(--bg) 100%);
    }

    /* ---------- Loading / Skeleton ---------- */
    .skel {
      position: relative;
      overflow: hidden;
      background: #f3f4f6;
      border-radius: 14px;
      border: 1px solid #eef0f3;
    }
    .skel::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-120%);
      animation: skelmove 1.15s infinite;
    }
    @keyframes skelmove { 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }

    .form-disabled { pointer-events:none; opacity:.6; }

    .img-skel-wrap{
      width:100%;
      height:100%;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:flex-start;
    }
    .img-skel-line{ height:14px; border-radius:999px }
    .img-skel-block{ height:100%; min-height:220px; border-radius:18px; flex: 1 1 auto; }

    .products-skel{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .products-skel .row{
      display:grid;
      grid-template-columns:60px 1fr;
      gap:10px;
    }
    .products-skel .thumb{ width:60px; height:60px; border-radius:12px }
    .products-skel .t1{ height:14px; border-radius:999px; width:75% }
    .products-skel .t2{ height:12px; border-radius:999px; width:45%; margin-top:8px }

    .page{max-width:1280px;margin:0 auto;padding:20px 14px 40px}

    header{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;padding:10px 10px 16px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .dot{
      width:28px;height:28px;border-radius:999px;
      background: linear-gradient(135deg, #111827, #111827);
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      flex:0 0 auto;
    }
    .title{font-size:20px;font-weight:800;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .top-right{display:flex;align-items:flex-start;gap:12px}
    .auth-box{
      text-align:right;font-size:13px;color:var(--muted);
      line-height:1.6;margin-top:2px;min-width:260px;
    }
    .auth-box b{color:var(--text)}
    .btn{
      border:none;cursor:pointer;border-radius:999px;
      padding:10px 14px;font-weight:700;background:var(--brand);color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.18);
      transition:transform .1s ease, opacity .1s ease;white-space:nowrap;
    }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:700}

    .layout{
      display:grid;
      grid-template-columns: minmax(320px, 0.9fr) minmax(0, 1.6fr);
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .auth-box{min-width:auto}
    }

    .card{
      background:var(--card);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,.04);
      padding:16px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      background:#f3f4f6;border:1px solid #eef0f3;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}

    /* âœ… è¡¨å–®è¦–è¦ºåˆ†æ®µ */
    .section-block{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(135deg,#fff,#fafafa);
      margin-bottom:12px;
    }
    .section-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:10px;
    }
    .section-head .stitle{
      font-weight:900;
      font-size:14px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#fff;
      color:var(--muted);
      white-space:nowrap;
    }

    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    @media (max-width: 560px){
      .form-grid{grid-template-columns:1fr}
    }
    label{
      display:block;font-size:12px;font-weight:700;
      margin:0 0 6px 0;color:#111827;
    }
    input, select{
      width:100%;padding:10px 10px;border-radius:12px;
      border:1px solid var(--line);background:#fafafa;outline:none;font-size:14px;
    }
    input:focus, select:focus{
      background:#fff;border-color:#ff9a9a;
      box-shadow:0 0 0 3px rgba(255,107,107,.18);
    }

    /* Slider UI */
    .slider-group{
      padding:10px;border-radius:14px;border:1px solid var(--line);background:#fafafa;
    }
    .slider-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .slider-head .label{font-size:12px;font-weight:800;color:#111827}
    .value-chip{
      display:inline-flex;align-items:baseline;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eef0f3;
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .value-chip b{color:#111827;font-weight:900}
    input[type="range"]{
      width:100%;
      padding:0;
      border:none;
      background:transparent;
      accent-color:#111827;
      height:26px;
    }
    .range-sub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    /* âœ… é¢¨æ ¼å¡ç‰‡åŒ– */
    .style-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:560px){
      .style-grid{grid-template-columns:1fr 1fr}
    }
    .style-card{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:76px;
    }
    .style-card:active{transform:translateY(1px)}
    .style-card .name{font-weight:900;font-size:14px;color:#111827}
    .style-card .desc{font-size:12px;color:var(--muted);line-height:1.4}
    .style-card.selected{
      border-color:#111827;
      box-shadow:0 10px 20px rgba(17,24,39,.12);
    }
    .style-card .chip{
      align-self:flex-start;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#f9fafb;
      color:#111827;
      font-weight:800;
    }

    .toggle-list{
      margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;
    }
    .toggle-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;border-top:1px solid var(--line);
    }
    .toggle-item:first-child{border-top:none}
    .toggle-item .left{display:flex;flex-direction:column;gap:2px}
    .toggle-item .name{font-weight:800;font-size:14px}
    .toggle-item .desc{font-size:12px;color:var(--muted)}
    .switch{
      width:44px;height:24px;border-radius:999px;background:#e5e7eb;
      position:relative;cursor:pointer;flex:0 0 auto;
    }
    .switch::after{
      content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px;
      background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.18);transition:transform .15s ease;
    }
    .switch.on{background:#111827}
    .switch.on::after{transform:translateX(20px)}

    .primary-wide{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      background:#111827;
      color:#fff;
      border:none;
      cursor:pointer;
    }
    .primary-wide:disabled{opacity:.55;cursor:default}

    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .hint.error{color:var(--warn);font-weight:800}

    .right-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .right-head h3{margin:0;font-size:18px;font-weight:900}
    .debug-toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none;cursor:pointer}

    .preview-wrap{
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(125deg,#fff7f7,#f9fbff);
      padding:12px;
    }

    /* âœ… Image aspect: 9:16 */
    .preview-inner{
      width:100%;
      max-width:450px;
      aspect-ratio: 9 / 16;
      height:auto;
      margin:0 auto;
      border-radius:16px;
      background:#fff;
      border:1px solid #f0f0f5;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;position:relative;
    }
    img#outfit-image{
      width:100%;
      height:100%;
      object-fit:contain;
      display:none;
      cursor: zoom-in;
    }
    .placeholder{text-align:center;color:var(--muted);font-size:14px;padding:20px}

    .section-title{margin:14px 0 8px;display:flex;gap:8px;align-items:center}
    .section-title .pill{font-weight:800}

    .products{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;background:#fff;
      min-height:160px;
    }

    /* âœ… products grouped */
    .slot-group{
      border:1px solid #f1f2f4;
      background:#fafafa;
      border-radius:16px;
      padding:10px;
      margin-bottom:12px;
    }
    .slot-group:last-child{margin-bottom:0}
    .slot-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .slot-title{
      font-weight:900;
      color:#111827;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .slot-count{
      font-size:12px;
      color:var(--muted);
      border:1px solid #eef0f3;
      background:#fff;
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    .product-item{
      display:grid;grid-template-columns:60px 1fr;gap:10px;padding:10px;border-radius:14px;
      background:#fff;border:1px solid #f1f2f4;margin-bottom:10px;
    }
    .product-item:last-child{margin-bottom:0}
    .thumb{
      width:60px;height:60px;border-radius:12px;background:#fff;border:1px solid #eee;
      display:flex;align-items:center;justify-content:center;overflow:hidden;color:var(--muted);font-size:12px;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pname{font-weight:900;font-size:14px;margin:0 0 4px}
    .pmeta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .plink{font-size:12px;color:#ff6b6b;text-decoration:none;font-weight:900}
    .plink:hover{text-decoration:underline}

    /* âœ… ç”Ÿæˆå‹•ç•«ç´°ç¯€ï¼šç‹€æ…‹ + é€²åº¦æ¢ + shimmer */
    .statusbar{margin-top:10px;font-size:12px;color:var(--muted)}
    .statusbar .ok{color:var(--ok);font-weight:900}
    .statusbar .bad{color:var(--warn);font-weight:900}

    .progress{
      margin-top:8px;
      height:8px;
      border-radius:999px;
      background:#eef0f3;
      overflow:hidden;
      border:1px solid #e9ecf1;
    }
    .progress > div{
      height:100%;
      width:0%;
      background:#111827;
      transition:width .25s ease;
    }
    .dots{
      display:inline-flex;
      gap:3px;
      vertical-align:middle;
      margin-left:6px;
    }
    .dot{
      width:5px;height:5px;border-radius:999px;background:var(--muted);
      opacity:.3;
      animation:blink 1s infinite;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{
      0%,100%{opacity:.25;transform:translateY(0)}
      50%{opacity:.9;transform:translateY(-1px)}
    }
    .shimmer{
      position:relative;
      overflow:hidden;
      border-radius:16px;
    }
    .shimmer::after{
      content:"";
      position:absolute;inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-120%);
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      0%{transform:translateX(-120%)}
      100%{transform:translateX(120%)}
    }

    .debug{
      margin-top:12px;display:none;
      border:1px dashed #d1d5db;background:#fff;border-radius:14px;
      padding:10px;font-size:12px;color:#111827;
      max-height:280px;overflow:auto;white-space:pre-wrap;
    }
    .debug.on{display:block}

    /* âœ… Outfit summary */
    .outfit-summary {
      margin-top: 14px;
      background: #fafafa;
      border: 1px solid #e5e7eb;
    }
    .summary-head {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .summary-icon { font-size: 18px; }
    .summary-title { color: #111827; }
    .summary-text {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    /* âœ… Action / retry row */
    .action-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .mini-btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .mini-btn:disabled{opacity:.55; cursor:default}
    .mini-btn.primary{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .mini-btn.danger{
      background:#fff;
      color:#ef4444;
      border-color:#fecaca;
    }
    .mini-hint{
      font-size:12px;
      color:var(--muted);
    }

    /* âœ… preview toolbar */
    .preview-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .toolbar-left{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .toolbar-right{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    /* ---------- Desktop: left panel sticky + compact spacing ---------- */
    @media (min-width: 1024px) {
      .layout { overflow: visible; }
      .left-panel {
        position: sticky;
        top: 18px;
        align-self: flex-start;
        max-height: calc(100vh - 24px);
        overflow-y: auto;
        padding-right: 6px;
      }
      .left-panel.card { padding: 14px; }
      .left-panel .row { margin-bottom: 8px; }
      .left-panel .form-grid { gap: 8px 10px; }
      .left-panel label { margin-bottom: 4px; font-size: 12px; }
      .left-panel input, .left-panel select { padding: 8px 10px; }
      .left-panel .toggle-list { margin-top: 8px; }
      .left-panel .toggle-item { padding: 10px 10px; }

      .left-panel .sticky-generate {
        position: sticky;
        bottom: 0;
        padding-top: 10px;
        background: linear-gradient(to top, #fff 60%, rgba(255,255,255,0));
        z-index: 5;
      }

      .preview-inner { max-height: 70vh; }
    }

    /* ---------- Mobile thumb-friendly tweaks + fixed action button ---------- */
    @media (max-width: 640px){
      .page{ padding:14px 12px calc(96px + var(--safe-b)); }
      header{
        padding:10px 6px 10px;
        align-items:flex-start;
      }
      .dot{ width:24px; height:24px; }
      .title{ font-size:18px; line-height:1.2; }
      .subtitle{
        font-size:12px;
        line-height:1.35;
        margin-top:6px;
        max-width: 260px;
      }
      .auth-box{
        min-width:auto;
        font-size:12px;
        line-height:1.35;
      }
      .btn{ padding:9px 12px; font-size:13px; }

      .card{ padding:14px; border-radius:16px; }
      .toggle-item{ padding:12px 10px; }
      .style-card{ min-height:72px; padding:12px; }
      .products{ padding:10px; }
      .product-item{ padding:10px; }

      /* âœ… fixed bottom button */
      .mobile-actionbar{
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: calc(14px + var(--safe-b));
        z-index: 999;
        pointer-events:none;
      }
      .mobile-actionbar .primary-wide{
        width:100%;
        height:54px;
        font-size:16px;
        border-radius:16px;
        box-shadow:0 18px 38px rgba(0,0,0,.18);
        pointer-events:auto;
      }
      .left-panel .sticky-generate{ display:none; }
    }

    /* ---------- Utilities ---------- */
    .anchor { scroll-margin-top: 12px; }

    /* ---------- Fullscreen image modal ---------- */
    .img-modal{
      display:none;
      position:fixed;
      inset:0;
      z-index: 2000;
    }
    .img-modal .backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(4px);
    }
    .img-modal .sheet{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .img-modal .content{
      width:min(92vw, 560px);
      max-height: 92vh;
      border-radius: 18px;
      background:#0b0b0f;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .img-modal .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      color:#fff;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .img-modal .topbar .left{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      font-size:13px;
    }
    .img-modal .topbar .right{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .img-modal .xbtn, .img-modal .dlbtn{
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding: 8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .img-modal .xbtn:active, .img-modal .dlbtn:active{ transform: translateY(1px); }
    .img-modal .viewer{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 12px;
      background:#0b0b0f;
      flex:1 1 auto;
      min-height: 0;
    }
    .img-modal img{
      width:100%;
      height: 100%;
      max-height: 78vh;
      object-fit: contain;
      border-radius: 12px;
      background:#0b0b0f;
    }

    /* ---------- History (Favorites + Recent) ---------- */
    .history-wrap{
      margin-top: 14px;
      border:1px solid var(--line);
      border-radius: 18px;
      background: #fff;
      padding: 12px;
    }
    .history-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .history-head .h-title{
      font-weight: 900;
      font-size: 14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .history-head .h-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      color:#111827;
    }
    .tab.active{
      background:#111827;
      border-color:#111827;
      color:#fff;
    }
    .history-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .h-item{
      display:grid;
      grid-template-columns: 54px 1fr;
      gap:10px;
      padding:10px;
      border-radius: 16px;
      border:1px solid #f1f2f4;
      background:#fafafa;
    }
    .h-thumb{
      width:54px;height:54px;border-radius: 12px;
      overflow:hidden;
      border:1px solid #eee;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
    }
    .h-thumb img{ width:100%; height:100%; object-fit: cover; }
    .h-main{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .h-title{
      font-weight: 900;
      font-size: 13px;
      color:#111827;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .h-meta{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .h-btns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .h-btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .h-btn.danger{
      border-color:#fecaca;
      color:#ef4444;
    }
    .h-empty{
      padding: 12px;
      border:1px dashed #d1d5db;
      border-radius: 14px;
      color: var(--muted);
      font-size: 12px;
      background:#fff;
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Outfit Studio Â· Body Test</div>
          <div class="subtitle">æµç¨‹ï¼šSpecï¼ˆæ‰£é»ï¼‰â†’ Image â†’ Productsã€‚å³ä¸Šå¯é–‹ Debugã€‚</div>
        </div>
      </div>

      <div class="top-right">
        <div class="auth-box">
          <div id="login-status">æœªç™»å…¥</div>
          <div>é»æ•¸ï¼š<b><span id="credits">â€”</span></b></div>
          <div id="auth-hint" style="font-size:12px;color:var(--muted)"></div>
        </div>
        <button id="login-btn" class="btn">Google ç™»å…¥</button>
        <button id="logout-btn" class="btn secondary" style="display:none;">ç™»å‡º</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT -->
      <section class="card left-panel" id="left-panel">
        <div class="row">
          <h3 style="margin:0">ç©¿æ­æ¢ä»¶</h3>
          <span class="pill">æ‰£ 1 é» / æ¬¡</span>
        </div>

        <!-- åˆ†æ®µ 1ï¼šåŸºæœ¬è³‡æ–™ -->
        <div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘  åŸºæœ¬è³‡æ–™ <span class="tag">æ‹–æ‹‰æ›´å¿«</span></div>
          </div>

          <div class="form-grid">
            <div>
              <label>æ€§åˆ¥</label>
              <select id="gender">
                <option value="female">å¥³æ€§</option>
                <option value="male">ç”·æ€§</option>
                <option value="neutral">ä¸­æ€§</option>
              </select>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">å¹´é½¡</div>
                <div class="value-chip"><b id="age-val">25</b> æ­²</div>
              </div>
              <input id="age" type="range" min="13" max="70" step="1" value="25" aria-label="å¹´é½¡" />
              <div class="range-sub"><span>13</span><span>70</span></div>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">èº«é«˜</div>
                <div class="value-chip"><b id="height-val">165</b> cm</div>
              </div>
              <input id="height" type="range" min="140" max="200" step="1" value="165" aria-label="èº«é«˜" />
              <div class="range-sub"><span>140</span><span>200</span></div>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">é«”é‡</div>
                <div class="value-chip"><b id="weight-val">55</b> kg</div>
              </div>
              <input id="weight" type="range" min="35" max="120" step="1" value="55" aria-label="é«”é‡" />
              <div class="range-sub"><span>35</span><span>120</span></div>
            </div>

            <div class="slider-group" style="grid-column:1/-1">
              <div class="slider-head">
                <div class="label">æº«åº¦</div>
                <div class="value-chip"><b id="temp-val">22</b> Â°C</div>
              </div>
              <input id="temp" type="range" min="0" max="35" step="1" value="22" aria-label="æº«åº¦" />
              <div class="range-sub"><span>0</span><span>35</span></div>
            </div>
          </div>
        </div>

        <!-- åˆ†æ®µ 2ï¼šé¢¨æ ¼ -->
        <div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘¡ é¢¨æ ¼é¸æ“‡ <span class="tag">é»ä¸€ä¸‹å°±å¥½</span></div>
          </div>

          <div class="style-grid" id="style-grid">
            <div class="style-card selected" data-style="casual">
              <div class="chip">Casual</div>
              <div class="name">ä¼‘é–’</div>
              <div class="desc">èˆ’æœã€æ—¥å¸¸ã€å¥½æ­é…</div>
            </div>
            <div class="style-card" data-style="minimal">
              <div class="chip">Minimal</div>
              <div class="name">æ¥µç°¡</div>
              <div class="desc">ä¹¾æ·¨ä¿è½ã€ä½å½©åº¦</div>
            </div>
            <div class="style-card" data-style="street">
              <div class="chip">Street</div>
              <div class="name">è¡—é ­</div>
              <div class="desc">å±¤æ¬¡ã€æ¯”ä¾‹ã€å€‹æ€§</div>
            </div>
            <div class="style-card" data-style="sporty">
              <div class="chip">Sporty</div>
              <div class="name">é‹å‹•</div>
              <div class="desc">æ©Ÿèƒ½ã€è¼•é¬†ã€å¥½æ´»å‹•</div>
            </div>
            <div class="style-card" data-style="smart" style="grid-column:1/-1">
              <div class="chip">Smart</div>
              <div class="name">Smart Casual</div>
              <div class="desc">æ­£å¼ä¸€é»ä½†ä¸æ‹˜è¬¹</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>é¢¨æ ¼è®Šé«”ï¼ˆå“ç‰Œ / åäººï¼‰</label>
            <select id="styleVariant">
              <option value="">ï¼ˆä¸ä½¿ç”¨è®Šé«”ï¼‰</option>
              <optgroup label="å“ç‰Œ">
                <option value="brand-uniqlo">UNIQLOï¼ˆæ—¥ç³»åŸºæœ¬ï¼‰</option>
                <option value="brand-muji">MUJIï¼ˆç”Ÿæ´»æ¥µç°¡ï¼‰</option>
                <option value="brand-cos">COSï¼ˆçµæ§‹æ¥µç°¡ï¼‰</option>
                <option value="brand-nike-tech">Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰</option>
                <option value="brand-ader-error">Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰</option>
              </optgroup>
              <optgroup label="åäººï¼ˆé¢¨æ ¼éˆæ„Ÿï¼Œä¸æ¨¡ä»¿è‡‰ï¼‰">
                <option value="celeb-iu-casual">IUï¼ˆéŸ“ç³»æ¸…æ–°ï¼‰</option>
                <option value="celeb-jennie-minimal">Jennieï¼ˆæ¥µç°¡è¾£ï¼‰</option>
                <option value="celeb-gd-street">G-Dragonï¼ˆè¡—é ­å±¤æ¬¡ï¼‰</option>
                <option value="celeb-lisa-sporty">Lisaï¼ˆèˆè€…é‹å‹•ï¼‰</option>
              </optgroup>
            </select>
          </div>

          <input type="hidden" id="style" value="casual" />
        </div>

        <!-- åˆ†æ®µ 3ï¼šé…ä»¶ -->
        <div class="section-block" style="margin-bottom:0">
          <div class="section-head">
            <div class="stitle">â‘¢ é…ä»¶ <span class="tag">é¸å¡«</span></div>
          </div>

          <div class="toggle-list" style="margin-top:0">
            <div class="toggle-item">
              <div class="left">
                <div class="name">åŒ…åŒ…</div>
                <div class="desc">éœ€è¦ bag æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
              </div>
              <div class="switch" id="sw-bag" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¸½å­</div>
                <div class="desc">éœ€è¦ hat æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
              </div>
              <div class="switch" id="sw-hat" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¤–å¥—</div>
                <div class="desc">å‹¾é¸æˆ–æº«åº¦ â‰¤ 20Â°C æ™‚æœƒç”Ÿæˆ outer</div>
              </div>
              <div class="switch" id="sw-coat" role="switch" aria-checked="false"></div>
            </div>
          </div>
        </div>

        <!-- Desktop sticky generate area -->
        <div class="sticky-generate">
          <button id="go-btn" class="primary-wide">ç”¢ç”Ÿç©¿æ­åœ–</button>
        </div>

        <div class="hint" id="form-hint">æç¤ºï¼šéœ€å…ˆç™»å…¥ï¼ˆGoogleï¼‰æ‰èƒ½å‘¼å«æ‰£é»çš„ Spec APIã€‚</div>
        <div class="hint error" id="error-hint" style="display:none;"></div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="right-head">
          <h3>AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“</h3>
          <div class="debug-toggle" id="debug-toggle">
            <div class="switch" id="sw-debug" aria-checked="false"></div>
            <div>Debug</div>
          </div>
        </div>

        <div class="section-title">
          <span class="pill">AI ç©¿æ­ç¤ºæ„åœ–</span>
        </div>

        <div class="preview-wrap anchor" id="anchor-preview">
          <div class="preview-inner" id="preview-box">
            <div id="img-skeleton" style="display:none;width:100%;height:100%;">
              <div class="img-skel-wrap">
                <div class="skel img-skel-line" style="width:68%"></div>
                <div class="skel img-skel-line" style="width:52%"></div>
                <div class="skel img-skel-block"></div>
              </div>
            </div>

            <img id="outfit-image" alt="Outfit preview" />
            <div class="placeholder" id="img-placeholder">å°šæœªç”¢ç”Ÿç¤ºæ„åœ–</div>
          </div>

          <!-- toolbar: fullscreen + favorite -->
          <div class="preview-toolbar">
            <div class="toolbar-left">
              <button class="mini-btn" id="fullscreen-btn">ğŸ” å…¨è¢å¹•é è¦½</button>
            </div>
            <div class="toolbar-right">
              <button class="mini-btn" id="favorite-btn" disabled>â™¡ æ”¶è—é€™å¥—</button>
            </div>
          </div>
          <div class="mini-hint" id="fav-hint" style="margin-top:8px;"></div>

          <div class="statusbar" id="statusbar">
            ç‹€æ…‹ï¼š<span id="status-text">ç­‰å¾…æ“ä½œ</span>
            <span id="status-dots" style="display:none">
              <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
            </span>
            <div class="progress"><div id="progress-bar"></div></div>

            <!-- Retry controls -->
            <div class="action-row" id="retry-row" style="display:none;">
              <button class="mini-btn primary" id="retry-btn">é‡è©¦ç›®å‰æ­¥é©Ÿ</button>
              <button class="mini-btn danger" id="restart-btn">å¾é ­é‡è·‘</button>
              <div class="mini-hint" id="retry-hint"></div>
            </div>
          </div>
        </div>

        <!-- AI Outfit Summary -->
        <div class="outfit-summary card" id="outfit-summary" style="display:none;">
          <div class="summary-head">
            <span class="summary-icon">ğŸ‘”</span>
            <span class="summary-title">AI ç©¿æ­å»ºè­°</span>
          </div>
          <div class="summary-text" id="summary-text"></div>
        </div>

        <div class="section-title anchor" id="anchor-products">
          <span class="pill">é¡ä¼¼å•†å“ï¼ˆGoogle Shoppingï¼‰</span>
        </div>
        <div class="products" id="products">
          <div class="placeholder" style="padding:16px;">å°šæœªç”¢ç”Ÿå•†å“</div>
        </div>

        <!-- History -->
        <div class="history-wrap" id="history-wrap">
          <div class="history-head">
            <div class="h-title">ğŸ—‚ï¸ çµæœç®¡ç†</div>
            <div class="h-actions">
              <button class="h-btn danger" id="clear-fav">æ¸…ç©ºæ”¶è—</button>
              <button class="h-btn danger" id="clear-recent">æ¸…ç©ºæœ€è¿‘</button>
            </div>
          </div>

          <div class="tabs">
            <button class="tab active" id="tab-recent">æœ€è¿‘ 10 å¥—</button>
            <button class="tab" id="tab-fav">å·²æ”¶è—</button>
          </div>

          <div class="history-list" id="history-list"></div>
        </div>

        <pre class="debug" id="debug-box"></pre>
      </section>
    </main>
  </div>

  <!-- Mobile fixed action bar -->
  <div class="mobile-actionbar" id="mobile-actionbar" style="display:none;">
    <button id="go-btn-mobile" class="primary-wide">ç”¢ç”Ÿç©¿æ­åœ–</button>
  </div>

  <!-- Fullscreen image modal -->
  <div class="img-modal" id="img-modal" aria-hidden="true">
    <div class="backdrop" id="img-modal-backdrop"></div>
    <div class="sheet">
      <div class="content">
        <div class="topbar">
          <div class="left">ğŸ–¼ï¸ Outfit Preview</div>
          <div class="right">
            <a class="dlbtn" id="img-download" href="#" download>â¬‡ï¸ ä¸‹è¼‰</a>
            <button class="xbtn" id="img-modal-close">âœ•</button>
          </div>
        </div>
        <div class="viewer">
          <img id="img-modal-img" alt="Fullscreen preview" />
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase JS SDK (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * Helpers
     ***********************/
    function isMobile() {
      return window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
    }
    function scrollToEl(id, behavior="smooth", block="start") {
      const el = document.getElementById(id);
      if (!el) return;
      el.scrollIntoView({ behavior, block });
    }

    function setFormDisabled(disabled) {
      const form = document.getElementById("left-panel");
      if (!form) return;
      form.classList.toggle("form-disabled", disabled);
    }

    /***********************
     * Step text
     ***********************/
    const GENERATE_STEPS = {
      idle: { btn: "ç”¢ç”Ÿç©¿æ­åœ–", text: "ç­‰å¾…æ“ä½œ" },
      spec: { btn: "åˆ†æä¸­â€¦", text: "åˆ†æä½ çš„èº«å½¢èˆ‡é¢¨æ ¼â€¦" },
      image: { btn: "è¨­è¨ˆä¸­â€¦", text: "è¨­è¨ˆæ•´é«”ç©¿æ­çµ„åˆâ€¦" },
      products: { btn: "æ‰¾å•†å“ä¸­â€¦", text: "æœå°‹å¯è³¼è²·å•†å“â€¦" },
      done: { btn: "å†ç”Ÿæˆä¸€å¥—", text: "å®Œæˆ âœ…" },
      failed: { btn: "å†è©¦ä¸€æ¬¡", text: "å¤±æ•— âŒ" },
    };

    function setGenerateStep(step) {
      const cfg = GENERATE_STEPS[step] || GENERATE_STEPS.idle;

      const btn1 = document.getElementById("go-btn");
      const btn2 = document.getElementById("go-btn-mobile");
      if (btn1) btn1.textContent = cfg.btn;
      if (btn2) btn2.textContent = cfg.btn;

      const statusTextEl = document.getElementById("status-text");
      if (statusTextEl) statusTextEl.textContent = cfg.text;
    }

    /***********************
     * 0) CONFIG
     ***********************/
    const SUPABASE_PROJECT_REF = "auiwcsolpvufxxyhnvaf";
    const SUPABASE_URL = `https://${SUPABASE_PROJECT_REF}.supabase.co`;
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1aXdjc29scHZ1Znh4eWhudmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MzUwMDEsImV4cCI6MjA4MDUxMTAwMX0.KeD8JXdHs5Iu7-wf0F0GpUPp-_y5X5ha6mwBcR5eYDA";
    const REDIRECT_TO = "https://simon-one-ochre.vercel.app/body-test.html";

    /***********************
     * 0.5) Slider bindings
     ***********************/
    function bindRange(rangeId, valueId) {
      const r = document.getElementById(rangeId);
      const v = document.getElementById(valueId);
      const paint = () => { v.textContent = String(r.value); };
      r.addEventListener("input", paint);
      paint();
    }

    /***********************
     * 0.6) Style cards
     ***********************/
    function bindStyleCards() {
      const grid = document.getElementById("style-grid");
      const hidden = document.getElementById("style");
      const cards = Array.from(grid.querySelectorAll(".style-card"));

      const select = (style) => {
        hidden.value = style;
        cards.forEach(c => c.classList.toggle("selected", c.dataset.style === style));
      };

      cards.forEach(c => {
        c.addEventListener("click", () => select(c.dataset.style));
      });

      select(hidden.value || "casual");
    }

    /***********************
     * 1) AUTH (Supabase JS)
     ***********************/
    const AUTH_KEY = "os_supabase_access_token_v1";
    function saveAccessToken(t){ localStorage.setItem(AUTH_KEY, t); }
    function getAccessToken(){ return localStorage.getItem(AUTH_KEY); }
    function clearAccessToken(){ localStorage.removeItem(AUTH_KEY); }

    const osSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: "pkce"
      }
    });

    async function apiMe() {
      const token = getAccessToken();
      if (!token) return { ok:false, error:"no token" };
      const r = await fetch("/api/me", { headers: { Authorization: "Bearer " + token } });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) return { ok:false, error:j?.error || "me failed", detail:j?.detail };
      return j;
    }

    function renderOutfitSummary(summary) {
      const box = document.getElementById("outfit-summary");
      const text = document.getElementById("summary-text");
      if (!summary) { box.style.display = "none"; return; }
      text.textContent = summary;
      box.style.display = "block";
    }

    function setAuthUI({ loggedIn, email, credits, hint }) {
      const st = document.getElementById("login-status");
      const cr = document.getElementById("credits");
      const hintEl = document.getElementById("auth-hint");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");

      if (loggedIn) {
        st.textContent = email ? `å·²ç™»å…¥ï¼š${email}` : "å·²ç™»å…¥";
        cr.textContent = String(credits ?? 0);
        hintEl.textContent = hint || "";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-flex";
      } else {
        st.textContent = hint || "æœªç™»å…¥";
        cr.textContent = "â€”";
        hintEl.textContent = "";
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
      }
    }

    async function refreshAuthUI() {
      const token = getAccessToken();
      if (!token) { setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥" }); return; }

      const me = await apiMe();
      if (!me.ok) { setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" }); return; }

      setAuthUI({ loggedIn:true, email: me.user?.email, credits: me.credits_left, hint:"" });
    }

    async function ensureTokenFromSession() {
      const { data, error } = await osSupabase.auth.getSession();
      if (error) return { ok:false, error: error.message };

      const session = data?.session;
      if (!session?.access_token) {
        clearAccessToken();
        return { ok:false, error:"no session" };
      }

      saveAccessToken(session.access_token);

      if (location.hash || location.search) {
        history.replaceState(null, "", location.pathname);
      }

      return { ok:true, session };
    }

    async function loginGoogle() {
      if (SUPABASE_ANON_KEY.startsWith("PASTE_")) {
        alert("è«‹å…ˆåœ¨ body-test.html å¡«å…¥ SUPABASE_ANON_KEYï¼ˆSupabase â†’ Settings â†’ API â†’ anon public keyï¼‰");
        return;
      }

      const { error } = await osSupabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: REDIRECT_TO }
      });

      if (error) {
        console.error(error);
        setAuthUI({ loggedIn:false, hint:"ç™»å…¥å•Ÿå‹•å¤±æ•—ï¼š" + error.message });
      }
    }

    async function logout() {
      try { await osSupabase.auth.signOut(); } catch {}
      clearAccessToken();

      try {
        const keys = Object.keys(localStorage);
        for (const k of keys) {
          if (k.startsWith("sb-") || k.includes("supabase") || k.includes("auth")) localStorage.removeItem(k);
        }
        const skeys = Object.keys(sessionStorage);
        for (const k of skeys) {
          if (k.startsWith("sb-") || k.includes("supabase") || k.includes("auth")) sessionStorage.removeItem(k);
        }
      } catch {}

      setAuthUI({ loggedIn:false, hint:"å·²ç™»å‡º" });
      window.location.href = "/body-test.html";
    }

    /***********************
     * 2) UI switches
     ***********************/
    function bindSwitch(id, initial=false) {
      const el = document.getElementById(id);
      let on = initial;
      const paint = () => {
        el.classList.toggle("on", on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      };
      paint();
      el.addEventListener("click", () => { on = !on; paint(); });
      return () => on;
    }

    const getBag = bindSwitch("sw-bag", false);
    const getHat = bindSwitch("sw-hat", false);
    const getCoat = bindSwitch("sw-coat", false);
    const getDebug = bindSwitch("sw-debug", false);

    document.getElementById("debug-toggle").addEventListener("click", (e) => {
      if (e.target.id !== "sw-debug") document.getElementById("sw-debug").click();
      document.getElementById("debug-box").classList.toggle("on", getDebug());
    });

    /***********************
     * 3) Render helpers + loading animation
     ***********************/
    const statusTextEl = document.getElementById("status-text");
    const statusDotsEl = document.getElementById("status-dots");
    const progressBarEl = document.getElementById("progress-bar");
    const previewBox = document.getElementById("preview-box");

    function setStatus(text, ok=null, loading=false) {
      statusTextEl.textContent = text;
      statusTextEl.className = ok === true ? "ok" : ok === false ? "bad" : "";
      statusDotsEl.style.display = loading ? "inline" : "none";
    }

    function setProgress(pct) {
      const v = Math.max(0, Math.min(100, Number(pct || 0)));
      progressBarEl.style.width = v + "%";
    }

    function setLoadingUI(on) {
      const products = document.getElementById("products");
      if (on) {
        previewBox.classList.add("shimmer");
        products.classList.add("shimmer");
      } else {
        previewBox.classList.remove("shimmer");
        products.classList.remove("shimmer");
      }
    }

    function showError(msg) {
      const el = document.getElementById("error-hint");
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearError() {
      const el = document.getElementById("error-hint");
      el.style.display = "none";
      el.textContent = "";
    }

    function setImageBase64(base64, mime="image/png") {
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      img.src = `data:${mime};base64,${base64}`;
      img.style.display = "block";
      ph.style.display = "none";
    }

    function clearImage() {
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      img.src = "";
      img.style.display = "none";
      ph.style.display = "block";
    }

    function showImageSkeleton(on){
      const sk = document.getElementById("img-skeleton");
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      if (!sk) return;

      if (on) {
        sk.style.display = "block";
        img.style.display = "none";
        ph.style.display = "none";
      } else {
        sk.style.display = "none";
      }
    }

    function renderProductsSkeleton(rows = 4) {
      const root = document.getElementById("products");
      root.innerHTML = `
        <div class="products-skel">
          ${Array.from({length: rows}).map(()=>`
            <div class="row">
              <div class="skel thumb"></div>
              <div>
                <div class="skel t1"></div>
                <div class="skel t2"></div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setDebug(obj) {
      const box = document.getElementById("debug-box");
      box.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      box.classList.toggle("on", getDebug());
    }

    /***********************
     * C) Products grouped by slot
     ***********************/
    const SLOT_ORDER = ["top","bottom","shoes","outer","bag","hat"];
    const SLOT_LABEL_ZH = {
      top: "ä¸Šè¡£",
      bottom: "ä¸‹èº«",
      shoes: "é‹å­",
      outer: "å¤–å¥—",
      bag: "åŒ…åŒ…",
      hat: "å¸½å­"
    };

    function groupProductsBySlot(list) {
      const groups = {};
      for (const s of SLOT_ORDER) groups[s] = [];
      (list || []).forEach(p => {
        const slot = (p.slot || "").toLowerCase();
        if (!groups[slot]) groups[slot] = [];
        groups[slot].push(p);
      });
      return groups;
    }

    function renderProductsGrouped(list) {
      const root = document.getElementById("products");
      root.innerHTML = "";

      if (!Array.isArray(list) || list.length === 0) {
        root.innerHTML = `<div class="placeholder" style="padding:16px;">æ²’æœ‰æ‰¾åˆ°å•†å“ï¼ˆæˆ– API å°šæœªå›å‚³ï¼‰</div>`;
        return;
      }

      const groups = groupProductsBySlot(list);

      for (const slot of SLOT_ORDER) {
        const items = groups[slot] || [];
        if (items.length === 0) continue;

        const wrap = document.createElement("div");
        wrap.className = "slot-group";

        wrap.innerHTML = `
          <div class="slot-head">
            <div class="slot-title">ğŸ§© ${escapeHtml(SLOT_LABEL_ZH[slot] || slot)}</div>
            <div class="slot-count">${items.length} å€‹</div>
          </div>
        `;

        items.forEach(p => {
          const div = document.createElement("div");
          div.className = "product-item";
          const thumb = p.thumbnail ? `<img src="${p.thumbnail}" alt="">` : `ç¤ºæ„`;
          const price = p.price || p.extracted_price || "";
          const link = p.product_link || p.link || p.url || "#";

          div.innerHTML = `
            <div class="thumb">${thumb}</div>
            <div>
              <div class="pname">${escapeHtml(p.title || p.name || "å•†å“")}</div>
              <div class="pmeta">
                ${price ? `<span>åƒ¹æ ¼ï¼š${escapeHtml(String(price))}</span>` : ""}
                ${p.source ? `<span>ä¾†æºï¼š${escapeHtml(String(p.source))}</span>` : ""}
              </div>
              <a class="plink" href="${link}" target="_blank" rel="noopener noreferrer">å‰å¾€æŸ¥çœ‹</a>
            </div>
          `;
          wrap.appendChild(div);
        });

        root.appendChild(wrap);
      }
    }

    /***********************
     * 4) API helper
     ***********************/
    async function postJson(url, body, withAuth=true) {
      const headers = { "Content-Type": "application/json" };
      if (withAuth) {
        const token = getAccessToken();
        if (!token) throw new Error("æœªç™»å…¥ï¼ˆæ²’æœ‰ Bearer tokenï¼‰");
        headers["Authorization"] = "Bearer " + token;
      }

      const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });

      const text = await r.text();
      let j = null;
      try { j = JSON.parse(text); } catch { j = { raw: text }; }

      if (!r.ok) {
        const msg = j?.error
          ? `${j.error}${j.detail ? " / " + (typeof j.detail === "string" ? j.detail : JSON.stringify(j.detail)) : ""}`
          : `HTTP ${r.status} / ${text.slice(0, 500)}`;
        throw new Error(`${url} å¤±æ•—ï¼š${msg}`);
      }
      return j;
    }

    /***********************
     * A) Step retry state machine
     ***********************/
    const flowState = {
      lastStep: "idle",
      payload: null,
      spec: null,
      imgResp: null,
      products: null
    };

    function showRetryUI(show, step="", hint="") {
      const row = document.getElementById("retry-row");
      const ht = document.getElementById("retry-hint");
      if (!row || !ht) return;
      if (!show) {
        row.style.display = "none";
        ht.textContent = "";
        return;
      }
      row.style.display = "flex";
      ht.textContent = hint ? hint : (step ? `å¯é‡è©¦ï¼š${step}` : "");
    }

    async function runStepSpec(payload, me) {
      setGenerateStep("spec");
      setStatus("Step 1/3ï¼šç”¢ç”Ÿ Outfit Specï¼ˆæ‰£é»ï¼‰", null, true);
      setProgress(20);

      const spec = await postJson("/api/generate-outfit-spec", payload, true);
      flowState.spec = spec;
      flowState.lastStep = "spec";
      setDebug({ step:"spec", spec });

      renderOutfitSummary(spec.summary);

      if (typeof spec.credits_left !== "undefined") {
        setAuthUI({ loggedIn:true, email: me.user?.email, credits: spec.credits_left });
      } else {
        await refreshAuthUI();
      }
      return spec;
    }

    async function runStepImage(payload, spec) {
      setGenerateStep("image");
      setStatus("Step 2/3ï¼šç”¢ç”Ÿç©¿æ­ç¤ºæ„åœ–", null, true);
      setProgress(55);

      const imgResp = await postJson("/api/generate-image", {
        ...payload,
        outfitSpec: spec,
        aspectRatio: "9:16",
        imageSize: "1K"
      }, true);

      if (!imgResp.image) throw new Error("Image API æ²’å›å‚³ image");
      flowState.imgResp = imgResp;
      flowState.lastStep = "image";
      setDebug({ step:"image", imgResp, spec });

      setImageBase64(imgResp.image, imgResp.mime || "image/png");
      showImageSkeleton(false);
      return imgResp;
    }

    async function runStepProducts(payload, spec) {
      setGenerateStep("products");
      setStatus("Step 3/3ï¼šæœå°‹é¡ä¼¼å•†å“", null, true);
      setProgress(80);

      const prodResp = await postJson("/api/search-products", {
        items: spec.items || [],
        locale: "tw",
        gender: payload.gender
      }, true);

      const list = prodResp.products || prodResp.items || prodResp.shopping_results || [];
      flowState.products = list;
      flowState.lastStep = "products";
      setDebug({ step:"products", prodResp, spec });

      renderProductsGrouped(list);
      return list;
    }

    async function retryCurrentStep() {
      showRetryUI(false);
      clearError();

      const ensured = await ensureTokenFromSession();
      if (!ensured.ok) throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");

      const me = await apiMe();
      if (!me.ok) throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");

      const payload = flowState.payload;
      if (!payload) throw new Error("æ²’æœ‰å¯é‡è©¦çš„ payloadï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");

      if (flowState.lastStep === "spec") {
        if (!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        showImageSkeleton(true);
        await runStepImage(payload, flowState.spec);
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        setGenerateStep("done");
        setProgress(100);
        setStatus("å®Œæˆ âœ…", true, false);
        scrollToEl("anchor-products", "smooth", "start");
        return;
      }

      if (flowState.lastStep === "image") {
        if (!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        setGenerateStep("done");
        setProgress(100);
        setStatus("å®Œæˆ âœ…", true, false);
        scrollToEl("anchor-products", "smooth", "start");
        return;
      }

      await generateAll(true);
    }

    /***********************
     * B) Auto scroll behavior
     ***********************/
    function autoScrollOnStart() {
      // mobile & desktop: scroll right panel preview into view
      scrollToEl("anchor-preview", "smooth", "start");
    }
    function autoScrollOnDone() {
      scrollToEl("anchor-products", "smooth", "start");
    }

    /***********************
     * D) Fullscreen image modal
     ***********************/
    function currentOutfitImageDataUrl(){
      const img = document.getElementById("outfit-image");
      const src = img?.getAttribute("src") || "";
      return (src && src.startsWith("data:")) ? src : "";
    }

    function openImageModal(dataUrl) {
      const modal = document.getElementById("img-modal");
      const modalImg = document.getElementById("img-modal-img");
      const download = document.getElementById("img-download");
      if (!modal || !modalImg || !download) return;

      modalImg.src = dataUrl;
      download.href = dataUrl;

      const ext = dataUrl.includes("image/jpeg") ? "jpg" : "png";
      download.setAttribute("download", `outfit-${Date.now()}.${ext}`);

      modal.style.display = "block";
      modal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }

    function closeImageModal(){
      const modal = document.getElementById("img-modal");
      const modalImg = document.getElementById("img-modal-img");
      if (!modal) return;
      modal.style.display = "none";
      modal.setAttribute("aria-hidden","true");
      if (modalImg) modalImg.src = "";
      document.body.style.overflow = "";
    }

    function bindImageModal() {
      const modal = document.getElementById("img-modal");
      const closeBtn = document.getElementById("img-modal-close");
      const backdrop = document.getElementById("img-modal-backdrop");
      const img = document.getElementById("outfit-image");
      const previewBtn = document.getElementById("fullscreen-btn");
      const favHint = document.getElementById("fav-hint");

      if (!modal || !closeBtn || !backdrop) {
        console.warn("[bindImageModal] modal elements missing");
        return;
      }

      // prevent double binding by cloning nodes
      function replaceWithClone(el) {
        if (!el) return null;
        const clone = el.cloneNode(true);
        el.parentNode.replaceChild(clone, el);
        return clone;
      }

      const newCloseBtn = replaceWithClone(closeBtn);
      const newBackdrop = replaceWithClone(backdrop);
      const newPreviewBtn = replaceWithClone(previewBtn);
      const newImg = replaceWithClone(img);

      function getDataUrlOrWarn() {
        const dataUrl = currentOutfitImageDataUrl();
        if (!dataUrl) {
          if (favHint) favHint.textContent = "å°šæœªæœ‰å¯é è¦½çš„åœ–ç‰‡ï¼ˆè«‹å…ˆç”Ÿæˆï¼‰";
          return "";
        }
        return dataUrl;
      }

      newCloseBtn.addEventListener("click", closeImageModal);
      newBackdrop.addEventListener("click", closeImageModal);

      document.addEventListener("keydown", (e) => {
        if (modal.style.display === "block" && e.key === "Escape") closeImageModal();
      });

      if (newImg) {
        newImg.style.cursor = "zoom-in";
        newImg.addEventListener("click", () => {
          const dataUrl = getDataUrlOrWarn();
          if (!dataUrl) return;
          openImageModal(dataUrl);
        });
      }

      if (newPreviewBtn) {
        newPreviewBtn.addEventListener("click", () => {
          const dataUrl = getDataUrlOrWarn();
          if (!dataUrl) return;
          openImageModal(dataUrl);
        });
      }

      console.log("[bindImageModal] bound âœ…");
    }

    /***********************
     * E) Favorites + Recent (Top 10)
     ***********************/
    const STORAGE_RECENT = "os_recent_looks_v1";
    const STORAGE_FAV = "os_fav_looks_v1";

    function nowTs(){ return Date.now(); }

    function loadJson(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        return JSON.parse(raw);
      }catch{ return fallback; }
    }
    function saveJson(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }

    function loadRecent(){ return loadJson(STORAGE_RECENT, []); }
    function saveRecent(arr){ saveJson(STORAGE_RECENT, arr); }

    function loadFav(){ return loadJson(STORAGE_FAV, []); }
    function saveFav(arr){ saveJson(STORAGE_FAV, arr); }

    function makeLookKey(payload) {
      const core = {
        gender: payload.gender,
        age: payload.age,
        height: payload.height,
        weight: payload.weight,
        style: payload.style,
        styleVariant: payload.styleVariant,
        temp: payload.temp,
        withBag: payload.withBag,
        withHat: payload.withHat,
        withCoat: payload.withCoat
      };
      return btoa(unescape(encodeURIComponent(JSON.stringify(core)))).slice(0, 32);
    }

    function makeLookIdUnique() {
      if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
      return `look_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function formatLookTitle(payload){
      const style = payload.style || "casual";
      const g = payload.gender === "male" ? "ç”·" : payload.gender === "female" ? "å¥³" : "ä¸­æ€§";
      const t = (payload.temp ?? "") + "Â°C";
      const v = payload.styleVariant ? ` Â· ${payload.styleVariant}` : "";
      return `${g} Â· ${style}${v} Â· ${t}`;
    }

    function buildLookSnapshot({ payload, spec, products, imgDataUrl, summary }) {
      return {
        id: makeLookIdUnique(),
        key: makeLookKey(payload),
        created_at: nowTs(),
        title: formatLookTitle(payload),
        payload,
        summary: summary || "",
        image: imgDataUrl || "",
        products: Array.isArray(products) ? products : []
      };
    }

    function upsertRecent(look){
      const arr = loadRecent();
      const idx = arr.findIndex(x => x.key && look.key && x.key === look.key);
      if (idx >= 0) arr.splice(idx, 1);
      arr.unshift(look);
      saveRecent(arr.slice(0, 10));
    }

    function isFavorited(lookId){
      const fav = loadFav();
      return fav.some(x => x.id === lookId);
    }

    function toggleFavorite(look){
      const fav = loadFav();
      const idx = fav.findIndex(x => x.id === look.id);
      if (idx >= 0) {
        fav.splice(idx, 1);
        saveFav(fav);
        return false;
      }
      fav.unshift(look);
      saveFav(fav);
      return true;
    }

    function resetFavoriteUI() {
      const btn = document.getElementById("favorite-btn");
      const hint = document.getElementById("fav-hint");
      if (!btn) return;
      btn.textContent = "â™¡ æ”¶è—é€™å¥—";
      btn.dataset.lookId = "";
      btn.disabled = true;
      if (hint) hint.textContent = "";
    }

    function syncFavoriteButton(lookId) {
      const btn = document.getElementById("favorite-btn");
      const hint = document.getElementById("fav-hint");
      if (!btn) return;

      if (!lookId) {
        btn.textContent = "â™¡ æ”¶è—é€™å¥—";
        if (hint) hint.textContent = "å…ˆç”Ÿæˆæˆ–è¼‰å…¥ä¸€å¥—";
        return;
      }

      const fav = isFavorited(lookId);
      btn.textContent = fav ? "â™¥ å·²æ”¶è—" : "â™¡ æ”¶è—é€™å¥—";
      if (hint) hint.textContent = "";
    }

    function enableFavoriteUI(lookId) {
      const btn = document.getElementById("favorite-btn");
      if (!btn) return;
      btn.dataset.lookId = lookId || "";
      btn.disabled = !lookId;
      syncFavoriteButton(lookId);
    }

    function renderHistory(activeTab){
      const tabRecent = document.getElementById("tab-recent");
      const tabFav = document.getElementById("tab-fav");
      const listEl = document.getElementById("history-list");
      if (!tabRecent || !tabFav || !listEl) return;

      const tab = activeTab || (tabFav.classList.contains("active") ? "fav" : "recent");
      tabRecent.classList.toggle("active", tab === "recent");
      tabFav.classList.toggle("active", tab === "fav");

      const data = tab === "fav" ? loadFav() : loadRecent();
      listEl.innerHTML = "";

      if (!data || data.length === 0) {
        listEl.innerHTML = `<div class="h-empty">${tab === "fav" ? "å°šæœªæ”¶è—ä»»ä½•çµæœ" : "å°šç„¡æœ€è¿‘çµæœï¼ˆç”Ÿæˆå¾Œæœƒå‡ºç¾ï¼‰"}</div>`;
        return;
      }

      data.forEach(look => {
        const row = document.createElement("div");
        row.className = "h-item";
        const img = look.image ? `<img src="${look.image}" alt="">` : "";
        row.innerHTML = `
          <div class="h-thumb">${img || "â€”"}</div>
          <div class="h-main">
            <div class="h-title">${escapeHtml(look.title || "Outfit")}</div>
            <div class="h-meta">
              <span>${new Date(look.created_at || Date.now()).toLocaleString()}</span>
              ${look.products?.length ? `<span>å•†å“ï¼š${look.products.length}</span>` : `<span>å•†å“ï¼šâ€”</span>`}
            </div>
            <div class="h-btns">
              <button class="h-btn" data-act="load" data-id="${look.id}">è¼‰å…¥</button>
              <button class="h-btn" data-act="preview" data-id="${look.id}">é è¦½</button>
              <button class="h-btn danger" data-act="remove" data-id="${look.id}">${tab === "fav" ? "ç§»é™¤æ”¶è—" : "åˆªé™¤"}</button>
            </div>
          </div>
        `;
        listEl.appendChild(row);
      });
    }

    function getLookById(id){
      const fav = loadFav();
      const recent = loadRecent();
      return fav.find(x => x.id === id) || recent.find(x => x.id === id) || null;
    }

    function loadLookIntoUI(look){
      if (!look) return;

      // Left panel values
      const payload = look.payload || {};
      document.getElementById("gender").value = payload.gender || "female";
      if (payload.age != null) document.getElementById("age").value = payload.age;
      if (payload.height != null) document.getElementById("height").value = payload.height;
      if (payload.weight != null) document.getElementById("weight").value = payload.weight;
      if (payload.temp != null) document.getElementById("temp").value = payload.temp;
      document.getElementById("styleVariant").value = payload.styleVariant || "";

      // re-paint slider text
      document.getElementById("age-val").textContent = document.getElementById("age").value;
      document.getElementById("height-val").textContent = document.getElementById("height").value;
      document.getElementById("weight-val").textContent = document.getElementById("weight").value;
      document.getElementById("temp-val").textContent = document.getElementById("temp").value;

      // style cards
      const hidden = document.getElementById("style");
      hidden.value = payload.style || "casual";
      const cards = Array.from(document.querySelectorAll(".style-card"));
      cards.forEach(c => c.classList.toggle("selected", c.dataset.style === hidden.value));

      // toggles - set switches visually
      setSwitchState("sw-bag", !!payload.withBag);
      setSwitchState("sw-hat", !!payload.withHat);
      setSwitchState("sw-coat", !!payload.withCoat);

      // right panel
      if (look.image) {
        const img = document.getElementById("outfit-image");
        const ph = document.getElementById("img-placeholder");
        img.src = look.image;
        img.style.display = "block";
        ph.style.display = "none";
        showImageSkeleton(false);
      } else {
        clearImage();
      }

      renderOutfitSummary(look.summary || "");

      if (Array.isArray(look.products)) {
        renderProductsGrouped(look.products);
      } else {
        renderProductsGrouped([]);
      }

      // set as current look for favorite
      enableFavoriteUI(look.id);
      scrollToEl("anchor-preview", "smooth", "start");
    }

    function setSwitchState(id, on){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle("on", on);
      el.setAttribute("aria-checked", on ? "true" : "false");
      // also update the bound getter by storing on element dataset
      el.dataset._force = on ? "1" : "0";
    }

    /***********************
     * IMPORTANT: bindSwitch upgraded to respect force state
     ***********************/
    function bindSwitchUpgraded(id, initial=false) {
      const el = document.getElementById(id);
      let on = initial;

      const readForced = () => {
        if (!el) return null;
        if (el.dataset._force === "1") return true;
        if (el.dataset._force === "0") return false;
        return null;
      };

      const paint = () => {
        const forced = readForced();
        if (forced !== null) on = forced;
        el.classList.toggle("on", on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      };

      paint();
      el.addEventListener("click", () => {
        // clear force and toggle
        el.dataset._force = "";
        on = !on;
        paint();
      });
      return () => {
        const forced = readForced();
        if (forced !== null) return forced;
        return on;
      };
    }

    /***********************
     * Rebind switches using upgraded
     ***********************/
    // replace old getters
    const getBag2 = () => false; // placeholder to avoid reference error

    /***********************
     * 5) Main flow
     ***********************/
    async function generateAll(forceRestart=false) {
      showRetryUI(false);
      clearError();
      setLoadingUI(true);
      setFormDisabled(true);

      try {
        setGenerateStep("spec");
        setProgress(0);
        setStatus("é–‹å§‹", null, true);

        resetFavoriteUI(); // âœ… reset favorite each run
        autoScrollOnStart();

        // Reset visuals
        clearImage();
        showImageSkeleton(true);
        renderProductsSkeleton(4);
        renderOutfitSummary(null);

        // Auth checks
        const ensured = await ensureTokenFromSession();
        if (!ensured.ok) {
          setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥ï¼ˆè«‹æŒ‰ Google ç™»å…¥ï¼‰" });
          throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");
        }

        const me = await apiMe();
        if (!me.ok) {
          setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" });
          throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");
        }

        // Build payload
        const payload = {
          gender: document.getElementById("gender").value,
          age: Number(document.getElementById("age").value),
          height: Number(document.getElementById("height").value),
          weight: Number(document.getElementById("weight").value),
          style: document.getElementById("style").value,
          styleVariant: document.getElementById("styleVariant").value || "",
          temp: Number(document.getElementById("temp").value),
          withBag: !!getBag(),
          withHat: !!getHat(),
          withCoat: !!getCoat()
        };

        // Save for retry
        flowState.payload = payload;
        if (forceRestart) {
          flowState.spec = null;
          flowState.imgResp = null;
          flowState.products = null;
          flowState.lastStep = "idle";
        }

        // Step 1: Spec
        const spec = await runStepSpec(payload, me);

        // Step 2: Image
        await runStepImage(payload, spec);

        // Step 3: Products
        await runStepProducts(payload, spec);

        // Done UI
        setGenerateStep("done");
        setProgress(100);
        setStatus("å®Œæˆ âœ…", true, false);

        // Save look to recent (unique id) + enable favorite
        const imgDataUrl = currentOutfitImageDataUrl();
        const look = buildLookSnapshot({
          payload,
          spec,
          products: flowState.products,
          imgDataUrl,
          summary: spec?.summary || ""
        });
        upsertRecent(look);
        enableFavoriteUI(look.id);
        renderHistory();

        autoScrollOnDone();
      } catch (e) {
        console.error(e);
        setGenerateStep("failed");
        setStatus("å¤±æ•— âŒ", false, false);
        setProgress(0);

        const msg = String(e?.message || e);

        if (flowState.spec && !flowState.imgResp) {
          showRetryUI(true, "Image", "Spec å·²å®Œæˆï¼Œå¯é‡è©¦ç”¢ç”Ÿç¤ºæ„åœ–");
          flowState.lastStep = "spec";
        } else if (flowState.spec && flowState.imgResp) {
          showRetryUI(true, "Products", "ç¤ºæ„åœ–å·²å®Œæˆï¼Œå¯é‡è©¦æœå°‹å•†å“");
          flowState.lastStep = "image";
        } else {
          showRetryUI(true, "Restart", "å¯å¾é ­é‡è·‘ï¼ˆé‡æ–°æ‰£é»ï¼‰");
          flowState.lastStep = "idle";
        }

        showError(msg);
        throw e;
      } finally {
        setLoadingUI(false);
        setFormDisabled(false);
      }
    }

    /***********************
     * retry buttons
     ***********************/
    async function onGenerateClick() {
      showRetryUI(false);
      try { await generateAll(false); } catch {}
    }

    /***********************
     * loading UI
     ***********************/
    function setLoadingUI(on) {
      const products = document.getElementById("products");
      if (on) {
        previewBox.classList.add("shimmer");
        products.classList.add("shimmer");
      } else {
        previewBox.classList.remove("shimmer");
        products.classList.remove("shimmer");
      }
    }

    /***********************
     * switches - set actual getters to upgraded ones
     ***********************/
    function initSwitches(){
      window.getBag = bindSwitchUpgraded("sw-bag", false);
      window.getHat = bindSwitchUpgraded("sw-hat", false);
      window.getCoat = bindSwitchUpgraded("sw-coat", false);
      window.getDebug = bindSwitchUpgraded("sw-debug", false);
    }

    /***********************
     * INIT
     ***********************/
    (async function init() {
      bindRange("age", "age-val");
      bindRange("height", "height-val");
      bindRange("weight", "weight-val");
      bindRange("temp", "temp-val");
      bindStyleCards();

      initSwitches();

      document.getElementById("login-btn").addEventListener("click", loginGoogle);
      document.getElementById("logout-btn").addEventListener("click", logout);

      // Mobile actionbar toggle
      const mobileBar = document.getElementById("mobile-actionbar");
      if (mobileBar) mobileBar.style.display = isMobile() ? "block" : "none";
      window.addEventListener("resize", () => {
        if (mobileBar) mobileBar.style.display = isMobile() ? "block" : "none";
      });

      // Retry buttons
      document.getElementById("retry-btn").addEventListener("click", async () => {
        const btn = document.getElementById("retry-btn");
        btn.disabled = true;
        try {
          setLoadingUI(true);
          await retryCurrentStep();
        } catch (e) {
          console.error(e);
          showError(String(e?.message || e));
        } finally {
          setLoadingUI(false);
          btn.disabled = false;
        }
      });

      document.getElementById("restart-btn").addEventListener("click", async () => {
        const btn = document.getElementById("restart-btn");
        btn.disabled = true;
        try {
          setLoadingUI(true);
          await generateAll(true);
        } catch (e) {
          console.error(e);
          showError(String(e?.message || e));
        } finally {
          setLoadingUI(false);
          btn.disabled = false;
        }
      });

      // Generate buttons
      const goBtnDesktop = document.getElementById("go-btn");
      const goBtnMobile = document.getElementById("go-btn-mobile");

      if (goBtnDesktop) goBtnDesktop.addEventListener("click", async () => {
        goBtnDesktop.disabled = true;
        if (goBtnMobile) goBtnMobile.disabled = true;
        try { await onGenerateClick(); }
        finally {
          goBtnDesktop.disabled = false;
          if (goBtnMobile) goBtnMobile.disabled = false;
        }
      });

      if (goBtnMobile) goBtnMobile.addEventListener("click", async () => {
        goBtnMobile.disabled = true;
        if (goBtnDesktop) goBtnDesktop.disabled = true;
        try { await onGenerateClick(); }
        finally {
          goBtnMobile.disabled = false;
          if (goBtnDesktop) goBtnDesktop.disabled = false;
        }
      });

      // Favorite button
      document.getElementById("favorite-btn").addEventListener("click", () => {
        const btn = document.getElementById("favorite-btn");
        const id = btn.dataset.lookId || "";
        const fh = document.getElementById("fav-hint");

        if (!id) {
          if (fh) fh.textContent = "å…ˆç”Ÿæˆæˆ–è¼‰å…¥ä¸€å¥—";
          return;
        }

        const recent = loadRecent();
        let look = recent.find(x => x.id === id);

        if (!look) {
          const fav = loadFav();
          look = fav.find(x => x.id === id);
        }

        if (!look) {
          look = {
            id,
            key: makeLookKey(flowState.payload || {}),
            created_at: nowTs(),
            title: formatLookTitle(flowState.payload || {}),
            payload: flowState.payload || {},
            summary: document.getElementById("summary-text")?.textContent || "",
            image: currentOutfitImageDataUrl(),
            products: flowState.products || []
          };
        }

        const becameFav = toggleFavorite(look);
        if (fh) fh.textContent = becameFav ? "å·²åŠ å…¥æ”¶è—" : "å·²å–æ¶ˆæ”¶è—";

        syncFavoriteButton(id);
        renderHistory();
      });

      // Tabs
      document.getElementById("tab-recent").addEventListener("click", () => renderHistory("recent"));
      document.getElementById("tab-fav").addEventListener("click", () => renderHistory("fav"));

      // Clear actions
      document.getElementById("clear-fav").addEventListener("click", () => {
        saveFav([]);
        renderHistory("fav");
        const btn = document.getElementById("favorite-btn");
        const id = btn?.dataset?.lookId || "";
        if (id) syncFavoriteButton(id);
      });
      document.getElementById("clear-recent").addEventListener("click", () => {
        saveRecent([]);
        renderHistory("recent");
      });

      // History list actions (event delegation)
      document.getElementById("history-list").addEventListener("click", (e) => {
        const t = e.target;
        if (!t || !t.dataset || !t.dataset.act) return;
        const act = t.dataset.act;
        const id = t.dataset.id;
        if (!id) return;

        const tabFav = document.getElementById("tab-fav").classList.contains("active");

        if (act === "load") {
          const look = getLookById(id);
          if (!look) return;
          loadLookIntoUI(look);
          return;
        }

        if (act === "preview") {
          const look = getLookById(id);
          if (!look?.image) return;
          openImageModal(look.image);
          return;
        }

        if (act === "remove") {
          if (tabFav) {
            const fav = loadFav().filter(x => x.id !== id);
            saveFav(fav);
            renderHistory("fav");
            const btn = document.getElementById("favorite-btn");
            if (btn?.dataset?.lookId === id) syncFavoriteButton(id);
          } else {
            const recent = loadRecent().filter(x => x.id !== id);
            saveRecent(recent);
            renderHistory("recent");
          }
          return;
        }
      });

      // Debug on/off
      document.getElementById("debug-box").classList.toggle("on", getDebug());

      await ensureTokenFromSession();
      await refreshAuthUI();

      osSupabase.auth.onAuthStateChange(async (_event, session) => {
        if (session?.access_token) saveAccessToken(session.access_token);
        else clearAccessToken();
        await refreshAuthUI();
      });

      setGenerateStep("idle");
      setProgress(0);
      setStatus("ç­‰å¾…æ“ä½œ", null, false);
      setLoadingUI(false);

      resetFavoriteUI();
      renderHistory("recent");
      bindImageModal();
    })();
  </script>
</body>
</html>
