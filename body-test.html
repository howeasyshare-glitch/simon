<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI èº«ææ¸¬è©¦å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --primary: #222;
      --accent: #ff6b6b;
      --muted: #777;
      --border-radius-lg: 18px;
      --border-radius-sm: 10px;
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Noto Sans TC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffecec 0, #f5f5f7 45%, #f5f5f7 100%);
      color: var(--primary);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      margin-bottom: 20px;
    }

    .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: 700;
    }

    .logo-pill {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      box-shadow: 0 6px 15px rgba(255,107,107,0.5);
    }

    .subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 20px;
    }

    @media (max-width: 840px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #f3f3f8;
      color: var(--muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 14px;
      margin-bottom: 14px;
    }

    @media (max-width: 600px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    label {
      font-weight: 500;
    }

    .hint {
      font-size: 11px;
      color: var(--muted);
    }

    select,
    input[type="number"] {
      padding: 8px 10px;
      border-radius: var(--border-radius-sm);
      border: 1px solid #e0e0ea;
      background: #fafafa;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    select:focus,
    input[type="number"]:focus {
      border-color: #ff8a8a;
      box-shadow: 0 0 0 2px rgba(255,138,138,0.35);
      background: #ffffff;
    }

    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff6b6b, #ff9f43);
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(255,107,107,0.5);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
    }

    .primary-btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(255,107,107,0.6);
      opacity: 0.95;
    }

    .primary-btn[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .btn-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .status-text {
      font-size: 11px;
      color: var(--muted);
    }

    .status-text.loading::before {
      content: "â³ ";
    }
    .status-text.done::before {
      content: "âœ¨ ";
    }
    .status-text.error::before {
      content: "âš ï¸ ";
    }

    .image-wrapper {
      border-radius: var(--border-radius-lg);
      background: linear-gradient(125deg, #fff7f7, #f9fbff);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: 420px;
      position: relative;
    }

    .image-inner {
      flex: 1;
      border-radius: 16px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid #f0f0f5;
      aspect-ratio: 3 / 4;
      position: relative;
    }

    #body-image {
      max-width: 100%;
      max-height: 100%;
      display: block;
      object-fit: contain;
    }

    .image-placeholder {
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      padding: 12px;
    }

    .desc {
      font-size: 13px;
      color: var(--muted);
    }

    .code-block {
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #111;
      color: #eee;
      padding: 10px;
      border-radius: 10px;
      max-height: 200px;
      overflow: auto;
      white-space: pre-wrap;
    }

    footer {
      margin-top: 20px;
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="title">
        <span class="logo-pill"></span>
        <span>Body Shape Test Â· èº«æç”Ÿæˆæ¸¬è©¦é </span>
      </div>
      <div class="subtitle">
        å°ˆé–€ç”¨ä¾†æ¸¬è©¦ã€Œèº«é«˜ï¼é«”é‡ã€å° AI äººç‰©èº«æçš„å½±éŸ¿ï¼Œé¿å…æ¯æ¬¡éƒ½æ”¹æ•´å€‹ç©¿æ­ç¶²ç«™ã€‚
      </div>
    </header>

    <main class="layout">
      <!-- å·¦ï¼šè¼¸å…¥æ¢ä»¶ -->
      <section class="card">
        <div class="card-title">
          æ¸¬è©¦æ¢ä»¶
          <span class="pill">Step 1 Â· è¨­å®šèº«æ</span>
        </div>

        <form id="body-form" onsubmit="event.preventDefault(); generateBodyImage();">
          <div class="form-grid">
            <div class="form-field">
              <label for="gender">æ€§åˆ¥</label>
              <select id="gender" required>
                <option value="female">å¥³æ€§</option>
                <option value="male">ç”·æ€§</option>
                <option value="neutral">ä¸­æ€§ / ä¸æ‹˜</option>
              </select>
              <div class="hint">åªå½±éŸ¿æ–‡å­—æè¿°ï¼Œä¸æœƒé™åˆ¶è¡£æœæ¬¾å¼ã€‚</div>
            </div>

            <div class="form-field">
              <label for="height">èº«é«˜ï¼ˆcmï¼‰</label>
              <input type="number" id="height" min="140" max="210" value="165" required />
              <div class="hint">ä¾‹å¦‚ï¼š150ã€160ã€170ã€180</div>
            </div>

            <div class="form-field">
              <label for="weight">é«”é‡ï¼ˆkgï¼‰</label>
              <input type="number" id="weight" min="35" max="150" value="55" required />
              <div class="hint">å¯ä»¥åˆ»æ„æ¸¬ï¼š45 / 60 / 80 / 100</div>
            </div>

            <div class="form-field">
              <label for="style">é¢¨æ ¼</label>
              <select id="style">
                <option value="casual">ä¼‘é–’æ—¥å¸¸</option>
                <option value="minimal">æ¥µç°¡é€šå‹¤</option>
                <option value="street">è¡—é ­é¢¨</option>
                <option value="sporty">é‹å‹•é¢¨</option>
                <option value="smart">Smart Casual</option>
              </select>
              <div class="hint">åªæ˜¯çµ¦æ¨¡å‹ä¸€é»ç©¿è‘—æ–¹å‘ã€‚</div>
            </div>

            <div class="form-field">
              <label for="temp">æº«åº¦ï¼ˆÂ°Cï¼Œé¸å¡«ï¼‰</label>
              <input type="number" id="temp" value="22" />
              <div class="hint">ç›®å‰åªæœƒå¯«é€² promptï¼Œä¸å½±éŸ¿èº«æã€‚</div>
            </div>

            <div class="form-field">
              <label>èº«æåˆ†ç´šï¼ˆç”± BMI è‡ªå‹•åˆ¤æ–·ï¼‰</label>
              <div id="bmi-info" class="hint">BMIï¼š--ï¼Œèº«å‹ï¼š--</div>
            </div>
          </div>

          <div class="btn-row">
            <span id="status" class="status-text">ä¿®æ”¹èº«é«˜ï¼é«”é‡å¾Œï¼ŒæŒ‰ä¸‹ã€Œç”¢ç”Ÿèº«æç¤ºæ„åœ–ã€ã€‚</span>
            <button type="submit" id="generate-btn" class="primary-btn">
              ğŸ§ ç”¢ç”Ÿèº«æç¤ºæ„åœ–
            </button>
          </div>
        </form>
      </section>

      <!-- å³ï¼šçµæœèˆ‡å¯¦éš› prompt -->
      <section class="card">
        <div class="card-title">
          æ¸¬è©¦çµæœ
          <span class="pill">Step 2 Â· æŸ¥çœ‹èº«æè®ŠåŒ–</span>
        </div>

        <div class="image-wrapper">
          <div class="image-inner">
            <img id="body-image" src="" alt="Body shape preview" style="display:none;" />
            <div id="image-placeholder" class="image-placeholder">
              é‚„æ²’æœ‰æ¸¬è©¦çµæœã€‚<br/>
              å¯ä»¥è©¦è©¦ï¼šåŒæ¨£èº«é«˜ 165 cmï¼Œåˆ†åˆ¥è¼¸å…¥ 45 / 60 / 80 / 100 kgï¼Œæ¯”è¼ƒå·®ç•°ã€‚
            </div>
          </div>
          <div class="desc">ä¸‹æ–¹æœƒé¡¯ç¤ºå¯¦éš›é€çµ¦ AI çš„è‹±æ–‡ promptï¼ˆæ–¹ä¾¿ä½ å¾®èª¿å¥å­å¼·åº¦ï¼‰ã€‚</div>
        </div>

        <div style="margin-top:10px;">
          <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">å¯¦éš›ä½¿ç”¨çš„ Promptï¼š</div>
          <pre id="prompt-view" class="code-block"></pre>
        </div>
      </section>
    </main>

    <footer>
      Body Shape Debug Â· å°ˆé–€ç”¨ä¾†èª¿æ•´ã€Œç˜¦ï¼æ­£å¸¸ï¼å¾®èƒ–ï¼è±æ»¿ã€çš„ promptï¼Œä¸å½±éŸ¿ä¸»ç«™ç¨‹å¼ç¢¼ã€‚
    </footer>
  </div>

  <script>
    // å¼·åŒ–ç‰ˆï¼šä¾ BMI çµ¦æœ€å¼·çš„èº«ææè¿° prompt
    function getBodyShapePrompt(height, weight) {
      const h = height / 100;
      const bmi = weight / (h * h);

      if (bmi < 19) {
        return `
very slim body, clearly slender limbs, visible bone outline, small waist,
minimal body fat, lightweight figure,
do NOT draw curves, do NOT draw thick arms or legs, do NOT draw chubby proportions.
        `.trim();
      }

      if (bmi < 25) {
        return `
average realistic body, balanced proportions, medium muscle and fat,
neither skinny nor chubby, natural and healthy body shape,
do NOT draw extremely slim or extremely curvy proportions.
        `.trim();
      }

      if (bmi < 30) {
        return `
slightly chubby body, soft curves, visibly thicker arms and thighs,
rounder waistline, fuller hips, clearly not slim,
do NOT draw skinny limbs, do NOT shrink the body proportion.
        `.trim();
      }

      return `
plus-size figure, full curves, heavier and thicker limbs, larger waist and hips,
round and full body shape, definitely not slim,
do NOT draw a skinny model, do NOT reduce body width.
      `.trim();
    }

    function getBodyShapeTag(height, weight) {
      const h = height / 100;
      const bmi = weight / (h * h);
      if (!isFinite(bmi)) return { bmi: null, label: "â€”" };

      if (bmi < 19) return { bmi, label: "åç˜¦ï¼ˆSlimï¼‰" };
      if (bmi < 25) return { bmi, label: "æ­£å¸¸ï¼ˆAverageï¼‰" };
      if (bmi < 30) return { bmi, label: "å¾®èƒ–ï¼ˆSlightly chubbyï¼‰" };
      return { bmi, label: "è±æ»¿ï¼ˆPlus-sizeï¼‰" };
    }

    // é€™æ˜¯å°ˆé–€çµ¦èº«ææ¸¬è©¦ç”¨çš„ promptï¼ˆè·Ÿä¸»ç«™åˆ†é–‹ï¼‰
    function buildBodyShapeTestPrompt(gender, style, temp, height, weight) {
      const genderTextMapEn = {
        female: "a woman",
        male: "a man",
        neutral: "a person"
      };
      const styleTextMapEn = {
        casual: "casual everyday clothing",
        minimal: "minimalist clean outfit",
        street: "streetwear outfit",
        sporty: "sporty athleisure outfit",
        smart: "smart casual outfit"
      };

      const genderEn = genderTextMapEn[gender] || "a person";
      const styleEn = styleTextMapEn[style] || "casual outfit";

      const bodyShapePrompt = getBodyShapePrompt(height, weight);

      const tempPart = isNaN(temp)
        ? ""
        : `Weather around ${temp}Â°C, outfit should logically match this temperature.`;

      return `
${genderEn}, height around ${height} cm, weight around ${weight} kg.
Body shape: ${bodyShapePrompt}

Full-body view, standing pose, front angle or slight 3/4 angle.

Outfit:
- ${styleEn}
- Simple everyday clothes, similar to UNIQLO lookbook style
- Neutral light background, soft even lighting

${tempPart}

Important:
- Strictly follow the described body shape above.
- If chubby or plus-size, do NOT draw a slim or skinny model.
- Show realistic human proportions, not stylized anime.
- No visible brand logos.
      `.trim();
    }

    function updateBmiDisplay() {
      const h = parseFloat(document.getElementById("height").value);
      const w = parseFloat(document.getElementById("weight").value);
      const el = document.getElementById("bmi-info");
      if (!h || !w) {
        el.textContent = "BMIï¼š--ï¼Œèº«å‹ï¼š--";
        return;
      }
      const { bmi, label } = getBodyShapeTag(h, w);
      if (!bmi) {
        el.textContent = "BMIï¼š--ï¼Œèº«å‹ï¼š--";
        return;
      }
      el.textContent = `BMIï¼šç´„ ${bmi.toFixed(1)}ï¼Œèº«å‹æ¨ä¼°ï¼š${label}`;
    }

    document.getElementById("height").addEventListener("input", updateBmiDisplay);
    document.getElementById("weight").addEventListener("input", updateBmiDisplay);
    updateBmiDisplay();

    async function generateBodyImage() {
      const gender = document.getElementById("gender").value;
      const height = parseFloat(document.getElementById("height").value);
      const weight = parseFloat(document.getElementById("weight").value);
      const style = document.getElementById("style").value;
      const temp = parseFloat(document.getElementById("temp").value);

      const status = document.getElementById("status");
      const btn = document.getElementById("generate-btn");
      const img = document.getElementById("body-image");
      const placeholder = document.getElementById("image-placeholder");
      const promptView = document.getElementById("prompt-view");

      if (!height || !weight) {
        status.textContent = "è«‹å…ˆè¼¸å…¥èº«é«˜èˆ‡é«”é‡ã€‚";
        status.className = "status-text error";
        return;
      }

      const prompt = buildBodyShapeTestPrompt(gender, style, temp, height, weight);
      promptView.textContent = prompt;

      status.textContent = "æ­£åœ¨è«‹ AI ä¾ç…§èº«é«˜ï¼é«”é‡ç”¢ç”Ÿäººç‰©èº«æç¤ºæ„åœ–â€¦";
      status.className = "status-text loading";
      btn.disabled = true;

      try {
        // âš ï¸ é€™è£¡æ²¿ç”¨ä½ ä¸»ç«™ /api/generate-image çš„çµæ§‹
        const response = await fetch("/api/generate-image", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    gender,
    age:25,
    style,
    temp,
    height,
    weight,
    outfitPrompt:prompt
  })
});


        if (!response.ok) {
          const txt = await response.text();
          console.error("API error:", txt);
          throw new Error("API å›æ‡‰å¤±æ•—ï¼š" + response.status);
        }

        const data = await response.json();
        if (!data.image) {
          throw new Error("API æ²’æœ‰å›å‚³åœ–ç‰‡è³‡æ–™");
        }

        img.src = "data:image/png;base64," + data.image;
        img.style.display = "block";
        placeholder.style.display = "none";

        status.textContent = "å·²å®Œæˆï¼Œè«‹ç›´æ¥æ¯”è¼ƒä¸åŒé«”é‡è¼¸å…¥çš„å·®ç•°ï¼ˆå»ºè­°ä¸€æ¬¡å›ºå®šèº«é«˜ï¼Œåªæ”¹é«”é‡ï¼‰";
        status.className = "status-text done";
      } catch (err) {
        console.error(err);
        status.textContent = "ç”¢ç”Ÿåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
        status.className = "status-text error";
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
