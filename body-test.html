<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Body Test · Outfit Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f6f8;
      margin: 0;
      padding: 24px;
    }
    h1 {
      margin-top: 0;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      max-width: 520px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      font-size: 14px;
    }
    button {
      margin-top: 16px;
      padding: 10px 14px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .primary {
      background: #111;
      color: #fff;
    }
    .secondary {
      background: #eee;
    }
    .status {
      margin-top: 12px;
      font-size: 14px;
      color: #555;
    }
    pre {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      overflow-x: auto;
    }
  </style>
</head>
<body>

<h1>Body Test（身材 + 風格測試頁）</h1>

<!-- ===== 登入區 ===== -->
<div class="card">
  <h2>登入</h2>
  <button class="secondary" onclick="loginWithGoogle()">使用 Google 登入</button>
  <button class="secondary" onclick="logout()">登出</button>
  <div class="status" id="login-status">尚未登入</div>
</div>

<!-- ===== 表單區 ===== -->
<div class="card">
  <h2>穿搭條件</h2>

  <label>性別
    <select id="gender">
      <option value="female">女性</option>
      <option value="male">男性</option>
      <option value="neutral">中性</option>
    </select>
  </label>

  <label>年齡
    <input id="age" type="number" value="25" />
  </label>

  <label>身高（cm）
    <input id="height" type="number" value="165" />
  </label>

  <label>體重（kg）
    <input id="weight" type="number" value="55" />
  </label>

  <label>風格
    <select id="style">
      <option value="casual">休閒</option>
      <option value="minimal">極簡</option>
      <option value="street">街頭</option>
      <option value="sporty">運動</option>
      <option value="smart">Smart Casual</option>
    </select>
  </label>

  <label>溫度（°C）
    <input id="temp" type="number" value="22" />
  </label>

  <label>
    <input type="checkbox" id="withBag" /> 包包
  </label>
  <label>
    <input type="checkbox" id="withHat" /> 帽子
  </label>
  <label>
    <input type="checkbox" id="withCoat" /> 外套
  </label>

  <button class="primary" onclick="generateOutfit()">產生穿搭</button>
  <div class="status" id="generate-status"></div>
</div>

<!-- ===== 結果區 ===== -->
<div class="card">
  <h2>Outfit Spec 回傳</h2>
  <pre id="result">尚未產生</pre>
</div>

<script>
  /* =========================
     Supabase 設定
     ========================= */
  const SUPABASE_URL = "https://auiwcsolpvufxxyhnvaf.supabase.co";

  /* =========================
     登入 / 登出
     ========================= */
  function loginWithGoogle() {
    const redirectTo = encodeURIComponent(
      window.location.origin + window.location.pathname
    );
    const url =
      `${SUPABASE_URL}/auth/v1/authorize` +
      `?provider=google&redirect_to=${redirectTo}`;
    window.location.href = url;
  }

  function logout() {
    // 清除 localStorage 中的 supabase session
    Object.keys(localStorage)
      .filter(k => k.startsWith("sb-") && k.endsWith("-auth-token"))
      .forEach(k => localStorage.removeItem(k));
    updateLoginStatus();
  }

  /* =========================
     取得 Supabase Token（重點）
     ========================= */
  function getSupabaseToken() {
    const key = Object.keys(localStorage)
      .find(k => k.startsWith("sb-") && k.endsWith("-auth-token"));
    if (!key) return null;
    const session = JSON.parse(localStorage.getItem(key));
    return session?.access_token || null;
  }

  function updateLoginStatus() {
    const token = getSupabaseToken();
    const el = document.getElementById("login-status");
    if (token) {
      el.textContent = "已登入（token 已取得）";
    } else {
      el.textContent = "尚未登入";
    }
  }

  updateLoginStatus();

  /* =========================
     產生穿搭（帶 token）
     ========================= */
  async function generateOutfit() {
    const statusEl = document.getElementById("generate-status");
    const resultEl = document.getElementById("result");

    const token = getSupabaseToken();
    if (!token) {
      alert("請先登入再使用");
      return;
    }

    statusEl.textContent = "產生中...";
    resultEl.textContent = "";

    const payload = {
      gender: document.getElementById("gender").value,
      age: Number(document.getElementById("age").value),
      height: Number(document.getElementById("height").value),
      weight: Number(document.getElementById("weight").value),
      style: document.getElementById("style").value,
      temp: Number(document.getElementById("temp").value),
      withBag: document.getElementById("withBag").checked,
      withHat: document.getElementById("withHat").checked,
      withCoat: document.getElementById("withCoat").checked
    };

    try {
      const resp = await fetch("/api/generate-outfit-spec", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      const data = await resp.json();

      if (!resp.ok) {
        throw new Error(data.error || "API error");
      }

      resultEl.textContent = JSON.stringify(data, null, 2);
      statusEl.textContent =
        "完成！剩餘點數：" + (data.credits_left ?? "未知");

    } catch (err) {
      console.error(err);
      statusEl.textContent = "錯誤：" + err.message;
    }
  }
</script>

</body>
</html>
