
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Outfit Studio Â· Body Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#fff;
      --text:#1b1b1f;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#111827;
      --accent:#ff6b6b;
      --ok:#16a34a;
      --warn:#ef4444;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;

      /* Mobile safe area */
      --safe-b: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #ffecec 0, var(--bg) 45%, var(--bg) 100%);
    }
    a{ color:inherit }

    /* ---------- Loading / Skeleton ---------- */
    .skel {
      position: relative;
      overflow: hidden;
      background: #f3f4f6;
      border-radius: 14px;
      border: 1px solid #eef0f3;
    }
    .skel::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-120%);
      animation: skelmove 1.15s infinite;
    }
    @keyframes skelmove { 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }

    .form-disabled { pointer-events:none; opacity:.6; }

    .img-skel-wrap{
      width:100%;
      height:100%;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:flex-start;
    }
    .img-skel-line{ height:14px; border-radius:999px }
    .img-skel-block{ height:100%; min-height:220px; border-radius:18px; flex: 1 1 auto; }

    .products-skel{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .products-skel .row{
      display:grid;
      grid-template-columns:60px 1fr;
      gap:10px;
    }
    .products-skel .thumb{ width:60px; height:60px; border-radius:12px }
    .products-skel .t1{ height:14px; border-radius:999px; width:75% }
    .products-skel .t2{ height:12px; border-radius:999px; width:45%; margin-top:8px }

    .page{max-width:1280px;margin:0 auto;padding:20px 14px 40px}

    header{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;padding:10px 10px 16px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .dot{
      width:28px;height:28px;border-radius:999px;
      background: linear-gradient(135deg, #111827, #111827);
      box-shadow:0 10px 20px rgba(0,0,0,.2);
      flex:0 0 auto;
    }
    .title{font-size:20px;font-weight:800;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .top-right{display:flex;align-items:flex-start;gap:12px}
    .auth-box{
      text-align:right;font-size:13px;color:var(--muted);
      line-height:1.6;margin-top:2px;min-width:260px;
    }
    .auth-box b{color:var(--text)}
    .btn{
      border:none;cursor:pointer;border-radius:999px;
      padding:10px 14px;font-weight:700;background:var(--brand);color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.18);
      transition:transform .1s ease, opacity .1s ease;white-space:nowrap;
    }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:700}

    .layout{
      display:grid;
      grid-template-columns: minmax(320px, 0.9fr) minmax(0, 1.6fr);
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .auth-box{min-width:auto}
    }

    .card{
      background:var(--card);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,.04);
      padding:16px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      background:#f3f4f6;border:1px solid #eef0f3;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}

    /* âœ… è¡¨å–®è¦–è¦ºåˆ†æ®µ */
    .section-block{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(135deg,#fff,#fafafa);
      margin-bottom:12px;
    }
    .section-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:10px;
    }
    .section-head .stitle{
      font-weight:900;
      font-size:14px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#fff;
      color:var(--muted);
      white-space:nowrap;
    }

    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    @media (max-width: 560px){
      .form-grid{grid-template-columns:1fr}
    }
    label{
      display:block;font-size:12px;font-weight:700;
      margin:0 0 6px 0;color:#111827;
    }
    input, select{
      width:100%;padding:10px 10px;border-radius:12px;
      border:1px solid var(--line);background:#fafafa;outline:none;font-size:14px;
    }
    input:focus, select:focus{
      background:#fff;border-color:#ff9a9a;
      box-shadow:0 0 0 3px rgba(255,107,107,.18);
    }

    /* Slider UI */
    .slider-group{
      padding:10px;border-radius:14px;border:1px solid var(--line);background:#fafafa;
    }
    .slider-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .slider-head .label{font-size:12px;font-weight:800;color:#111827}
    .value-chip{
      display:inline-flex;align-items:baseline;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eef0f3;
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .value-chip b{color:#111827;font-weight:900}
    input[type="range"]{
      width:100%;
      padding:0;
      border:none;
      background:transparent;
      accent-color:#111827;
      height:26px;
    }
    .range-sub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    /* âœ… é¢¨æ ¼å¡ç‰‡åŒ– */
    .style-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:560px){
      .style-grid{grid-template-columns:1fr 1fr}
    }
    .style-card{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:76px;
    }
    .style-card:active{transform:translateY(1px)}
    .style-card .name{font-weight:900;font-size:14px;color:#111827}
    .style-card .desc{font-size:12px;color:var(--muted);line-height:1.4}
    .style-card.selected{
      border-color:#111827;
      box-shadow:0 10px 20px rgba(17,24,39,.12);
    }
    .style-card .chip{
      align-self:flex-start;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#f9fafb;
      color:#111827;
      font-weight:800;
    }

    .toggle-list{
      margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;
    }
    .toggle-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;border-top:1px solid var(--line);
    }
    .toggle-item:first-child{border-top:none}
    .toggle-item .left{display:flex;flex-direction:column;gap:2px}
    .toggle-item .name{font-weight:800;font-size:14px}
    .toggle-item .desc{font-size:12px;color:var(--muted)}
    .switch{
      width:44px;height:24px;border-radius:999px;background:#e5e7eb;
      position:relative;cursor:pointer;flex:0 0 auto;
    }
    .switch::after{
      content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px;
      background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.18);transition:transform .15s ease;
    }
    .switch.on{background:#111827}
    .switch.on::after{transform:translateX(20px)}

    .primary-wide{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      background:#111827;
      color:#fff;
      border:none;
      cursor:pointer;
    }
    .primary-wide:disabled{opacity:.55;cursor:default}

    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .hint.error{color:var(--warn);font-weight:800}

    .right-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .right-head h3{margin:0;font-size:18px;font-weight:900}
    .debug-toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none;cursor:pointer}

    .preview-wrap{
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(125deg,#fff7f7,#f9fbff);
      padding:12px;
    }

    /* âœ… Image aspect: 9:16 */
    .preview-inner{
      width:100%;
      max-width:450px;
      aspect-ratio: 9 / 16;
      height:auto;
      margin:0 auto;
      border-radius:16px;
      background:#fff;
      border:1px solid #f0f0f5;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;position:relative;
    }
    img#outfit-image{
      width:100%;
      height:100%;
      object-fit:contain;
      display:none;
      cursor: zoom-in;
    }
    .placeholder{text-align:center;color:var(--muted);font-size:14px;padding:20px}

    /* preview toolbar */
    .preview-tools{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      gap:8px;
      z-index:5;
    }
    .tool-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(229,231,235,.95);
      background:rgba(255,255,255,.92);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      color:#111827;
      backdrop-filter: blur(6px);
    }
    .tool-btn:disabled{opacity:.55; cursor:default}
    .tool-btn .icon{font-size:14px}
    .tool-btn.fav.on{
      border-color:#fecaca;
      background:rgba(255,245,245,.92);
      color:#ef4444;
    }

    .section-title{margin:14px 0 8px;display:flex;gap:8px;align-items:center}
    .section-title .pill{font-weight:800}

    .products{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;background:#fff;
      min-height:160px;
    }

    /* âœ… products grouped */
    .slot-group{
      border:1px solid #f1f2f4;
      background:#fafafa;
      border-radius:16px;
      padding:10px;
      margin-bottom:12px;
    }
    .slot-group:last-child{margin-bottom:0}
    .slot-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .slot-title{
      font-weight:900;
      color:#111827;
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .slot-count{
      font-size:12px;
      color:var(--muted);
      border:1px solid #eef0f3;
      background:#fff;
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    .product-item{
      display:grid;grid-template-columns:60px 1fr;gap:10px;padding:10px;border-radius:14px;
      background:#fff;border:1px solid #f1f2f4;margin-bottom:10px;
    }
    .product-item:last-child{margin-bottom:0}
    .thumb{
      width:60px;height:60px;border-radius:12px;background:#fff;border:1px solid #eee;
      display:flex;align-items:center;justify-content:center;overflow:hidden;color:var(--muted);font-size:12px;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pname{font-weight:900;font-size:14px;margin:0 0 4px}
    .pmeta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .plink{font-size:12px;color:#ff6b6b;text-decoration:none;font-weight:900}
    .plink:hover{text-decoration:underline}

    /* âœ… ç”Ÿæˆå‹•ç•«ç´°ç¯€ï¼šç‹€æ…‹ + é€²åº¦æ¢ + shimmer */
    .statusbar{margin-top:10px;font-size:12px;color:var(--muted)}
    .statusbar .ok{color:var(--ok);font-weight:900}
    .statusbar .bad{color:var(--warn);font-weight:900}

    .progress{
      margin-top:8px;
      height:8px;
      border-radius:999px;
      background:#eef0f3;
      overflow:hidden;
      border:1px solid #e9ecf1;
    }
    .progress > div{
      height:100%;
      width:0%;
      background:#111827;
      transition:width .25s ease;
    }
    .dots{
      display:inline-flex;
      gap:3px;
      vertical-align:middle;
      margin-left:6px;
    }
    .dot{
      width:5px;height:5px;border-radius:999px;background:var(--muted);
      opacity:.3;
      animation:blink 1s infinite;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{
      0%,100%{opacity:.25;transform:translateY(0)}
      50%{opacity:.9;transform:translateY(-1px)}
    }
    .shimmer{
      position:relative;
      overflow:hidden;
      border-radius:16px;
    }
    .shimmer::after{
      content:"";
      position:absolute;inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-120%);
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      0%{transform:translateX(-120%)}
      100%{transform:translateX(120%)}
    }

    .debug{
      margin-top:12px;display:none;
      border:1px dashed #d1d5db;background:#fff;border-radius:14px;
      padding:10px;font-size:12px;color:#111827;
      max-height:280px;overflow:auto;white-space:pre-wrap;
    }
    .debug.on{display:block}

    /* âœ… Outfit summary */
    .outfit-summary {
      margin-top: 14px;
      background: #fafafa;
      border: 1px solid #e5e7eb;
    }
    .summary-head {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .summary-icon { font-size: 18px; }
    .summary-title { color: #111827; }
    .summary-text {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    /* âœ… Retry controls */
    .action-row{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .mini-btn{
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      padding:9px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
    }
    .mini-btn:disabled{opacity:.55; cursor:default}
    .mini-btn.primary{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
    .mini-btn.danger{
      background:#fff;
      color:#ef4444;
      border-color:#fecaca;
    }
    .mini-hint{
      font-size:12px;
      color:var(--muted);
    }

    /* âœ… Collection / Recent panel */
    .collection-wrap{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:18px;
      overflow:hidden;
      background:#fff;
    }
    .tabs{
      display:flex;
      gap:0;
      border-bottom:1px solid var(--line);
      background:#fafafa;
    }
    .tab{
      flex:1;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      border:none;
      background:transparent;
      color:#6b7280;
    }
    .tab.active{
      color:#111827;
      background:#fff;
    }
    .tabpanes{ padding:10px; }
    .pane{ display:none; }
    .pane.active{ display:block; }

    .mini-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .mini-card{
      display:grid;
      grid-template-columns:68px 1fr auto;
      gap:10px;
      align-items:center;
      padding:10px;
      border:1px solid #eef0f3;
      border-radius:14px;
      background:#fafafa;
    }
    .mini-thumb{
      width:68px;
      aspect-ratio: 9/16;
      border-radius:12px;
      overflow:hidden;
      border:1px solid #eee;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#9ca3af;
      font-size:12px;
    }
    .mini-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini-info .t{
      font-weight:900;
      font-size:13px;
      margin:0 0 4px;
      color:#111827;
    }
    .mini-info .m{
      font-size:12px;
      color:#6b7280;
      line-height:1.35;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .mini-actions{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    .chip-btn{
      border:1px solid #e5e7eb;
      background:#fff;
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      color:#111827;
      white-space:nowrap;
    }
    .chip-btn.danger{ color:#ef4444; border-color:#fecaca; }
    .mini-empty{
      padding:14px;
      color:#6b7280;
      font-size:12px;
      background:#fff;
      border:1px dashed #e5e7eb;
      border-radius:14px;
    }

    /* ---------- Desktop: left panel sticky + compact spacing ---------- */
    @media (min-width: 1024px) {
      .layout { overflow: visible; }
      .left-panel {
        position: sticky;
        top: 18px;
        align-self: flex-start;
        max-height: calc(100vh - 24px);
        overflow-y: auto;
        padding-right: 6px;
      }
      .left-panel.card { padding: 14px; }
      .left-panel .row { margin-bottom: 8px; }
      .left-panel .form-grid { gap: 8px 10px; }
      .left-panel label { margin-bottom: 4px; font-size: 12px; }
      .left-panel input, .left-panel select { padding: 8px 10px; }
      .left-panel .toggle-list { margin-top: 8px; }
      .left-panel .toggle-item { padding: 10px 10px; }

      .left-panel .sticky-generate {
        position: sticky;
        bottom: 0;
        padding-top: 10px;
        background: linear-gradient(to top, #fff 60%, rgba(255,255,255,0));
        z-index: 5;
      }

      .preview-inner { max-height: 70vh; }
    }

    /* ---------- Mobile thumb-friendly tweaks + fixed action button ---------- */
    @media (max-width: 640px){
      .page{ padding:14px 12px calc(96px + var(--safe-b)); }
      header{
        padding:10px 6px 10px;
        align-items:flex-start;
      }
      .dot{ width:24px; height:24px; }
      .title{ font-size:18px; line-height:1.2; }
      .subtitle{
        font-size:12px;
        line-height:1.35;
        margin-top:6px;
        max-width: 260px;
      }
      .auth-box{
        min-width:auto;
        font-size:12px;
        line-height:1.35;
      }
      .btn{ padding:9px 12px; font-size:13px; }

      .card{ padding:14px; border-radius:16px; }
      .toggle-item{ padding:12px 10px; }
      .style-card{ min-height:72px; padding:12px; }
      .products{ padding:10px; }
      .product-item{ padding:10px; }

      /* âœ… fixed bottom button */
      .mobile-actionbar{
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: calc(14px + var(--safe-b));
        z-index: 9999;
        pointer-events:none;
      }
      .mobile-actionbar .primary-wide{
        width:100%;
        height:54px;
        font-size:16px;
        border-radius:16px;
        box-shadow:0 18px 38px rgba(0,0,0,.18);
        pointer-events:auto;
      }
      .left-panel .sticky-generate{ display:none; }
    }

    /* ---------- Utilities ---------- */
    .anchor { scroll-margin-top: 12px; }

    /* ---------- Fullscreen modal ---------- */
    .modal{
      position:fixed;
      inset:0;
      z-index: 10000;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }
    .modal.on{ display:flex; }
    .modal-card{
      width: min(520px, 100%);
      aspect-ratio: 9/16;
      background:#111827;
      border-radius: 18px;
      overflow:hidden;
      position:relative;
      box-shadow: 0 30px 70px rgba(0,0,0,.35);
    }
    .modal-card img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      background:#0b1020;
    }
    .modal-top{
      position:absolute;
      top:10px;
      left:10px;
      right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .modal-top .m-btn{
      pointer-events:auto;
      border:none;
      cursor:pointer;
      background: rgba(255,255,255,.12);
      color:#fff;
      padding:9px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:12px;
      backdrop-filter: blur(8px);
    }
    .modal-top .m-btn:active{ transform: translateY(1px); opacity:.95; }
  
    /* âœ… UX: Toast + keyword chips + quick nav */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(18px + var(--safe-b));
      z-index: 2000;
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 800;
      display:none;
      box-shadow: 0 18px 38px rgba(0,0,0,.22);
      max-width: min(92vw, 560px);
      text-align:center;
    }
    .toast.show{ display:block; animation: toastIn .18s ease-out; }
    @keyframes toastIn{ from{ opacity:0; transform:translateX(-50%) translateY(6px);} to{ opacity:1; transform:translateX(-50%) translateY(0);} }

    .quick-nav{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .qbtn{
      border:1px solid var(--line);
      background:#fff;
      color:#111827;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      line-height:1;
    }
    .qbtn:active{ transform: translateY(1px); }

    .keywords-panel{
      margin: 10px 0 12px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid #eef0f3;
      background: #fafafa;
      display:none;
    }
    .keywords-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px;
    }
    .keywords-title{
      font-weight: 900;
      font-size: 13px;
      color:#111827;
      display:flex; align-items:center; gap:8px;
    }
    .keywords-toggle{
      font-size:12px;
      color: var(--muted);
      font-weight: 800;
      cursor:pointer;
      user-select:none;
    }
    .kw-list{ display:none; }
    .kw-list.on{ display:block; }
    .kw-row{
      display:flex; flex-wrap:wrap; gap:8px;
      padding: 8px 0;
      border-top: 1px dashed #e5e7eb;
    }
    .kw-row:first-child{ border-top:none; padding-top:0; }
    .kw-tag{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#fff;
      color:#111827;
      font-weight: 800;
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .kw-slot{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }

    /* Mobile: keep toast above fixed action bar */
    @media (max-width: 640px){
      .toast{
        bottom: calc(76px + var(--safe-b)); /* above bottom button */
      }
    }

  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Outfit Studio Â· Body Test</div>
          <div class="subtitle">æµç¨‹ï¼šSpecï¼ˆæ‰£é»ï¼‰â†’ Image â†’ Productsã€‚å³ä¸Šå¯é–‹ Debugã€‚</div>
        </div>
      </div>

      <div class="top-right">
        <div class="auth-box">
          <div id="login-status">æœªç™»å…¥</div>
          <div>é»æ•¸ï¼š<b><span id="credits">â€”</span></b></div>
          <div id="auth-hint" style="font-size:12px;color:var(--muted)"></div>
        </div>
        <button id="login-btn" class="btn">Google ç™»å…¥</button>
        <button id="logout-btn" class="btn secondary" style="display:none;">ç™»å‡º</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT -->
      <section class="card left-panel" id="left-panel">
        <div class="row">
          <h3 style="margin:0">ç©¿æ­æ¢ä»¶</h3>
          <span class="pill">æ‰£ 1 é» / æ¬¡</span>
        </div>

        <!-- âœ… åˆ†æ®µ 1ï¼šåŸºæœ¬è³‡æ–™ -->
        <div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘  åŸºæœ¬è³‡æ–™ <span class="tag">æ‹–æ‹‰æ›´å¿«</span></div>
          </div>

          <div class="form-grid">
            <div>
              <label>æ€§åˆ¥</label>
              <select id="gender">
                <option value="female">å¥³æ€§</option>
                <option value="male">ç”·æ€§</option>
                <option value="neutral">ä¸­æ€§</option>
              </select>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">å¹´é½¡</div>
                <div class="value-chip"><b id="age-val">25</b> æ­²</div>
              </div>
              <input id="age" type="range" min="13" max="70" step="1" value="25" aria-label="å¹´é½¡" />
              <div class="range-sub"><span>13</span><span>70</span></div>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">èº«é«˜</div>
                <div class="value-chip"><b id="height-val">165</b> cm</div>
              </div>
              <input id="height" type="range" min="140" max="200" step="1" value="165" aria-label="èº«é«˜" />
              <div class="range-sub"><span>140</span><span>200</span></div>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">é«”é‡</div>
                <div class="value-chip"><b id="weight-val">55</b> kg</div>
              </div>
              <input id="weight" type="range" min="35" max="120" step="1" value="55" aria-label="é«”é‡" />
              <div class="range-sub"><span>35</span><span>120</span></div>
            </div>

            <div class="slider-group" style="grid-column:1/-1">
              <div class="slider-head">
                <div class="label">æº«åº¦</div>
                <div class="value-chip"><b id="temp-val">22</b> Â°C</div>
              </div>
              <input id="temp" type="range" min="0" max="35" step="1" value="22" aria-label="æº«åº¦" />
              <div class="range-sub"><span>0</span><span>35</span></div>
            </div>
          </div>
        </div>

        <!-- âœ… åˆ†æ®µ 2ï¼šé¢¨æ ¼ï¼ˆå¡ç‰‡ï¼‰ -->
        <div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘¡ é¢¨æ ¼é¸æ“‡ <span class="tag">é»ä¸€ä¸‹å°±å¥½</span></div>
          </div>

          <div class="style-grid" id="style-grid">
            <div class="style-card selected" data-style="casual">
              <div class="chip">Casual</div>
              <div class="name">ä¼‘é–’</div>
              <div class="desc">èˆ’æœã€æ—¥å¸¸ã€å¥½æ­é…</div>
            </div>
            <div class="style-card" data-style="minimal">
              <div class="chip">Minimal</div>
              <div class="name">æ¥µç°¡</div>
              <div class="desc">ä¹¾æ·¨ä¿è½ã€ä½å½©åº¦</div>
            </div>
            <div class="style-card" data-style="street">
              <div class="chip">Street</div>
              <div class="name">è¡—é ­</div>
              <div class="desc">å±¤æ¬¡ã€æ¯”ä¾‹ã€å€‹æ€§</div>
            </div>
            <div class="style-card" data-style="sporty">
              <div class="chip">Sporty</div>
              <div class="name">é‹å‹•</div>
              <div class="desc">æ©Ÿèƒ½ã€è¼•é¬†ã€å¥½æ´»å‹•</div>
            </div>
            <div class="style-card" data-style="smart" style="grid-column:1/-1">
              <div class="chip">Smart</div>
              <div class="name">Smart Casual</div>
              <div class="desc">æ­£å¼ä¸€é»ä½†ä¸æ‹˜è¬¹</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>é¢¨æ ¼è®Šé«”ï¼ˆå“ç‰Œ / åäººï¼‰</label>
            <select id="styleVariant">
              <option value="">ï¼ˆä¸ä½¿ç”¨è®Šé«”ï¼‰</option>
              <optgroup label="å“ç‰Œ">
                <option value="brand-uniqlo">UNIQLOï¼ˆæ—¥ç³»åŸºæœ¬ï¼‰</option>
                <option value="brand-muji">MUJIï¼ˆç”Ÿæ´»æ¥µç°¡ï¼‰</option>
                <option value="brand-cos">COSï¼ˆçµæ§‹æ¥µç°¡ï¼‰</option>
                <option value="brand-nike-tech">Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰</option>
                <option value="brand-ader-error">Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰</option>
              </optgroup>
              <optgroup label="åäººï¼ˆé¢¨æ ¼éˆæ„Ÿï¼Œä¸æ¨¡ä»¿è‡‰ï¼‰">
                <option value="celeb-iu-casual">IUï¼ˆéŸ“ç³»æ¸…æ–°ï¼‰</option>
                <option value="celeb-jennie-minimal">Jennieï¼ˆæ¥µç°¡è¾£ï¼‰</option>
                <option value="celeb-gd-street">G-Dragonï¼ˆè¡—é ­å±¤æ¬¡ï¼‰</option>
                <option value="celeb-lisa-sporty">Lisaï¼ˆèˆè€…é‹å‹•ï¼‰</option>
              </optgroup>
            </select>
          </div>

          <!-- hidden style value for JS -->
          <input type="hidden" id="style" value="casual" />
        </div>

        <!-- âœ… åˆ†æ®µ 3ï¼šé…ä»¶ -->
        <div class="section-block" style="margin-bottom:0">
          <div class="section-head">
            <div class="stitle">â‘¢ é…ä»¶ <span class="tag">é¸å¡«</span></div>
          </div>

          <div class="toggle-list" style="margin-top:0">
            <div class="toggle-item">
              <div class="left">
                <div class="name">åŒ…åŒ…</div>
                <div class="desc">éœ€è¦ bag æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
              </div>
              <div class="switch" id="sw-bag" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¸½å­</div>
                <div class="desc">éœ€è¦ hat æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
              </div>
              <div class="switch" id="sw-hat" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¤–å¥—</div>
                <div class="desc">å‹¾é¸æˆ–æº«åº¦ â‰¤ 20Â°C æ™‚æœƒç”Ÿæˆ outer</div>
              </div>
              <div class="switch" id="sw-coat" role="switch" aria-checked="false"></div>
            </div>
          </div>
        </div>

        <!-- Desktop sticky generate area (hidden on mobile by CSS) -->
        <div class="sticky-generate">
          <button id="go-btn" class="primary-wide">ç”¢ç”Ÿç©¿æ­åœ–</button>
        </div>

        <div class="hint" id="form-hint">æç¤ºï¼šéœ€å…ˆç™»å…¥ï¼ˆGoogleï¼‰æ‰èƒ½å‘¼å«æ‰£é»çš„ Spec APIã€‚</div>
        <div class="hint error" id="error-hint" style="display:none;"></div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="right-head">
          <h3>AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“</h3>

          <div class="quick-nav">
            <button class="qbtn" type="button" id="nav-to-preview">çœ‹ç¤ºæ„åœ–</button>
            <button class="qbtn" type="button" id="nav-to-products">çœ‹å•†å“</button>
          </div>
          <div class="debug-toggle" id="debug-toggle">
            <div class="switch" id="sw-debug" aria-checked="false"></div>
            <div>Debug</div>
          </div>
        </div>

        <div class="section-title">
          <span class="pill">AI ç©¿æ­ç¤ºæ„åœ–</span>
        </div>

        <div class="preview-wrap anchor" id="anchor-preview">
          <div class="preview-inner" id="preview-box">
            <div class="preview-tools">
              <button class="tool-btn" id="btn-fullscreen" title="å…¨è¢å¹•é è¦½" type="button">
                <span class="icon">â›¶</span> å…¨è¢å¹•
              </button>
              <button class="tool-btn fav" id="btn-fav" title="æ”¶è—/å–æ¶ˆæ”¶è—" type="button" disabled>
                <span class="icon" id="fav-icon">â™¡</span>
                <span id="fav-text">æ”¶è—</span>
              </button>
            </div>

            <div id="img-skeleton" style="display:none;width:100%;height:100%;">
              <div class="img-skel-wrap">
                <div class="skel img-skel-line" style="width:68%"></div>
                <div class="skel img-skel-line" style="width:52%"></div>
                <div class="skel img-skel-block"></div>
              </div>
            </div>

            <img id="outfit-image" alt="Outfit preview" />
            <div class="placeholder" id="img-placeholder">å°šæœªç”¢ç”Ÿç¤ºæ„åœ–</div>
          </div>

          <div class="statusbar" id="statusbar">
            ç‹€æ…‹ï¼š<span id="status-text">ç­‰å¾…æ“ä½œ</span>
            <span id="status-dots" style="display:none">
              <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
            </span>
            <div class="progress"><div id="progress-bar"></div></div>

            <!-- âœ… Retry controls -->
            <div class="action-row" id="retry-row" style="display:none;">
              <button class="mini-btn primary" id="retry-btn" type="button">é‡è©¦ç›®å‰æ­¥é©Ÿ</button>
              <button class="mini-btn danger" id="restart-btn" type="button">å¾é ­é‡è·‘</button>
              <div class="mini-hint" id="retry-hint"></div>
            </div>
          </div>
        </div>

        <!-- AI Outfit Summary -->
        <div class="outfit-summary card" id="outfit-summary" style="display:none;">
          <div class="summary-head">
            <span class="summary-icon">ğŸ‘”</span>
            <span class="summary-title">AI ç©¿æ­å»ºè­°</span>
          </div>
          <div class="summary-text" id="summary-text"></div>
        </div>

        <!-- æ”¶è— / æœ€è¿‘ 10 å¥— -->
        <div class="section-title" style="margin-top:12px;">
          <span class="pill">æ”¶è— / æœ€è¿‘ 10 å¥—</span>
        </div>
        <div class="collection-wrap" id="collection-wrap">
          <div class="tabs">
            <button class="tab active" id="tab-recents" type="button">æœ€è¿‘ 10 å¥—</button>
            <button class="tab" id="tab-favs" type="button">å·²æ”¶è—</button>
          </div>
          <div class="tabpanes">
            <div class="pane active" id="pane-recents">
              <div class="mini-list" id="recents-list"></div>
            </div>
            <div class="pane" id="pane-favs">
              <div class="mini-list" id="favs-list"></div>
            </div>
          </div>
        </div>

        <div class="section-title anchor" id="anchor-products">
          <span class="pill">é¡ä¼¼å•†å“ï¼ˆGoogle Shoppingï¼‰</span>
        </div>

        <div class="keywords-panel" id="keywords-panel">
          <div class="keywords-head">
            <div class="keywords-title">ğŸ” æœ¬æ¬¡æœå°‹é—œéµå­—</div>
            <div class="keywords-toggle" id="keywords-toggle">å±•é–‹</div>
          </div>
          <div class="kw-list" id="kw-list"></div>
        </div>

        <div class="products" id="products">
          <div class="placeholder" style="padding:16px;">å°šæœªç”¢ç”Ÿå•†å“</div>
        </div>

        <pre class="debug" id="debug-box"></pre>
      </section>
    </main>
  </div>

  <!-- âœ… Mobile fixed action bar -->
  <div class="mobile-actionbar" id="mobile-actionbar" style="display:none;">
    <button id="go-btn-mobile" class="primary-wide" type="button">ç”¢ç”Ÿç©¿æ­åœ–</button>
  </div>

  <!-- Fullscreen modal -->
  <div class="modal" id="img-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="å…¨è¢å¹•é è¦½">
      <div class="modal-top">
        <button class="m-btn" id="modal-close" type="button">é—œé–‰ âœ•</button>
        <button class="m-btn" id="modal-save" type="button">ä¸‹è¼‰åœ–ç‰‡ â¬‡ï¸</button>
      </div>
      <img id="modal-img" alt="Outfit fullscreen preview" />
    </div>
  </div>

  <!-- âœ… Supabase JS SDK (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * Helpers
     ***********************/
    function isMobile() {
      return window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
    }
    function scrollToEl(id, behavior="smooth", block="start") {
      const el = document.getElementById(id);
      if (!el) return;
      el.scrollIntoView({ behavior, block });
    }
    function setFormDisabled(disabled) {
      const form = document.getElementById("left-panel");
      if (!form) return;
      form.classList.toggle("form-disabled", disabled);
    }
    function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

    /***********************
     * Step text (3æ®µæŒ‰éˆ•æ–‡å­— + ç‹€æ…‹æ–‡å­—åŒæ­¥)
     ***********************/
    const GENERATE_STEPS = {
      idle: { btn: "ç”¢ç”Ÿç©¿æ­åœ–", text: "ç­‰å¾…æ“ä½œ" },
      spec: { btn: "åˆ†æä¸­â€¦", text: "åˆ†æä½ çš„èº«å½¢èˆ‡é¢¨æ ¼â€¦" },
      image: { btn: "è¨­è¨ˆä¸­â€¦", text: "è¨­è¨ˆæ•´é«”ç©¿æ­çµ„åˆâ€¦" },
      products: { btn: "æ‰¾å•†å“ä¸­â€¦", text: "æœå°‹å¯è³¼è²·å•†å“â€¦" },
      done: { btn: "å†ç”Ÿæˆä¸€å¥—", text: "å®Œæˆ âœ…" },
      failed: { btn: "å†è©¦ä¸€æ¬¡", text: "å¤±æ•— âŒ" },
    };
    function setGenerateStep(step) {
      const cfg = GENERATE_STEPS[step] || GENERATE_STEPS.idle;

      const btn1 = document.getElementById("go-btn");
      const btn2 = document.getElementById("go-btn-mobile");
      if (btn1) btn1.textContent = cfg.btn;
      if (btn2) btn2.textContent = cfg.btn;

      const statusTextEl = document.getElementById("status-text");
      if (statusTextEl) statusTextEl.textContent = cfg.text;
    }

    /***********************
     * 0) CONFIG
     ***********************/
    const SUPABASE_PROJECT_REF = "auiwcsolpvufxxyhnvaf";
    const SUPABASE_URL = `https://${SUPABASE_PROJECT_REF}.supabase.co`;

    const SUPABASE_ANON_KEY = "PASTE_YOUR_SUPABASE_ANON_KEY_HERE";
    const REDIRECT_TO = location.origin + "/body-test.html";

    /***********************
     * 0.5) Slider bindings
     ***********************/
    function bindRange(rangeId, valueId) {
      const r = document.getElementById(rangeId);
      const v = document.getElementById(valueId);
      const paint = () => { v.textContent = String(r.value); };
      r.addEventListener("input", paint);
      paint();
    }

    /***********************
     * 0.6) Style cards
     ***********************/
    function bindStyleCards() {
      const grid = document.getElementById("style-grid");
      const hidden = document.getElementById("style");
      const cards = Array.from(grid.querySelectorAll(".style-card"));

      const select = (style) => {
        hidden.value = style;
        cards.forEach(c => c.classList.toggle("selected", c.dataset.style === style));
      };

      cards.forEach(c => {
        c.addEventListener("click", () => select(c.dataset.style));
      });

      select(hidden.value || "casual");
    }

    /***********************
     * 1) AUTH (Supabase JS)
     ***********************/
    const AUTH_KEY = "os_supabase_access_token_v1";
    function saveAccessToken(t){ localStorage.setItem(AUTH_KEY, t); }
    function getAccessToken(){ return localStorage.getItem(AUTH_KEY); }
    function clearAccessToken(){ localStorage.removeItem(AUTH_KEY); }

    const osSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: "pkce"
      }
    });

    async function apiMe() {
      const token = getAccessToken();
      if (!token) return { ok:false, error:"no token" };
      const r = await fetch("/api/me", { headers: { Authorization: "Bearer " + token } });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) return { ok:false, error:j?.error || "me failed", detail:j?.detail };
      return j;
    }

    function renderOutfitSummary(summary) {
      const box = document.getElementById("outfit-summary");
      const text = document.getElementById("summary-text");
      if (!summary) { box.style.display = "none"; return; }
      text.textContent = summary;
      box.style.display = "block";
    }

    function setAuthUI({ loggedIn, email, credits, hint }) {
      const st = document.getElementById("login-status");
      const cr = document.getElementById("credits");
      const hintEl = document.getElementById("auth-hint");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");

      if (loggedIn) {
        st.textContent = email ? `å·²ç™»å…¥ï¼š${email}` : "å·²ç™»å…¥";
        cr.textContent = String(credits ?? 0);
        hintEl.textContent = hint || "";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-flex";
      } else {
        st.textContent = hint || "æœªç™»å…¥";
        cr.textContent = "â€”";
        hintEl.textContent = "";
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
      }
    }

    async function refreshAuthUI() {
      const token = getAccessToken();
      if (!token) { setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥" }); return; }

      const me = await apiMe();
      if (!me.ok) { setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" }); return; }

      setAuthUI({ loggedIn:true, email: me.user?.email, credits: me.credits_left, hint:"" });
    }

    async function ensureTokenFromSession() {
      const { data, error } = await osSupabase.auth.getSession();
      if (error) return { ok:false, error: error.message };

      const session = data?.session;
      if (!session?.access_token) {
        clearAccessToken();
        return { ok:false, error:"no session" };
      }

      saveAccessToken(session.access_token);

      if (location.hash || location.search) {
        history.replaceState(null, "", location.pathname);
      }

      return { ok:true, session };
    }

    async function loginGoogle() {
      if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("PASTE_")) {
        alert("è«‹å…ˆåœ¨ body-test.html å¡«å…¥ SUPABASE_ANON_KEYï¼ˆSupabase â†’ Settings â†’ API â†’ anon public keyï¼‰");
        return;
      }

      const { error } = await osSupabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: REDIRECT_TO }
      });

      if (error) {
        console.error(error);
        setAuthUI({ loggedIn:false, hint:"ç™»å…¥å•Ÿå‹•å¤±æ•—ï¼š" + error.message });
      }
    }

    async function logout() {
      try { await osSupabase.auth.signOut(); } catch {}
      clearAccessToken();

      try {
        const keys = Object.keys(localStorage);
        for (const k of keys) {
          if (k.startsWith("sb-") || k.includes("supabase") || k.includes("auth")) localStorage.removeItem(k);
        }
        const skeys = Object.keys(sessionStorage);
        for (const k of skeys) {
          if (k.startsWith("sb-") || k.includes("supabase") || k.includes("auth")) sessionStorage.removeItem(k);
        }
      } catch {}

      setAuthUI({ loggedIn:false, hint:"å·²ç™»å‡º" });
      window.location.href = "/body-test.html";
    }

    /***********************
     * 2) UI switches
     ***********************/
    function bindSwitch(id, initial=false) {
      const el = document.getElementById(id);
      let on = initial;
      const paint = () => {
        el.classList.toggle("on", on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      };
      paint();
      el.addEventListener("click", () => { on = !on; paint(); });
      return () => on;
    }

    const getBag = bindSwitch("sw-bag", false);
    const getHat = bindSwitch("sw-hat", false);
    const getCoat = bindSwitch("sw-coat", false);
    const getDebug = bindSwitch("sw-debug", false);

    document.getElementById("debug-toggle").addEventListener("click", (e) => {
      if (e.target.id !== "sw-debug") document.getElementById("sw-debug").click();
      document.getElementById("debug-box").classList.toggle("on", getDebug());
    });

    /***********************
     * 3) Render helpers + loading animation
     ***********************/
    const statusTextEl = document.getElementById("status-text");
    const statusDotsEl = document.getElementById("status-dots");
    const progressBarEl = document.getElementById("progress-bar");
    const previewBox = document.getElementById("preview-box");

    function setStatus(text, ok=null, loading=false) {
      statusTextEl.textContent = text;
      statusTextEl.className = ok === true ? "ok" : ok === false ? "bad" : "";
      statusDotsEl.style.display = loading ? "inline" : "none";
    }

    function setProgress(pct) {
      const v = Math.max(0, Math.min(100, Number(pct || 0)));
      progressBarEl.style.width = v + "%";
    }

    function setLoadingUI(on) {
      const products = document.getElementById("products");
      if (on) {
        previewBox.classList.add("shimmer");
        products.classList.add("shimmer");
      } else {
        previewBox.classList.remove("shimmer");
        products.classList.remove("shimmer");
      }
    }

    function showError(msg) {
      const el = document.getElementById("error-hint");
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearError() {
      const el = document.getElementById("error-hint");
      el.style.display = "none";
      el.textContent = "";
    }

    function setImageBase64(base64, mime="image/png") {
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      img.src = `data:${mime};base64,${base64}`;
      img.style.display = "block";
      ph.style.display = "none";
    }

    function clearImage() {
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      img.src = "";
      img.style.display = "none";
      ph.style.display = "block";
    }

    function showImageSkeleton(on){
      const sk = document.getElementById("img-skeleton");
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      if (!sk) return;

      if (on) {
        sk.style.display = "block";
        img.style.display = "none";
        ph.style.display = "none";
      } else {
        sk.style.display = "none";
      }
    }

    function renderProductsSkeleton(rows = 4) {
      const root = document.getElementById("products");
      root.innerHTML = `
        <div class="products-skel">
          ${Array.from({length: rows}).map(()=>`
            <div class="row">
              <div class="skel thumb"></div>
              <div>
                <div class="skel t1"></div>
                <div class="skel t2"></div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }


    /***********************
     * UX helpers: Toast + keyword display
     ***********************/
    let toastTimer = null;
    function showToast(msg, ms=1800){
      const t = document.getElementById("toast");
      if (!t) return;
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> t.classList.remove("show"), ms);
    }

    function buildSearchQueriesFromSpec(items, { locale="tw", gender="neutral" } = {}) {
      const priority = ["top","bottom","shoes","outer","bag","hat"];
      const sorted = [...(items||[])].sort((a,b)=> priority.indexOf(a.slot)-priority.indexOf(b.slot)).slice(0,6);

      const g = (gender === "male") ? (locale === "tw" ? "ç”·æ¬¾" : "men")
            : (gender === "female") ? (locale === "tw" ? "å¥³æ¬¾" : "women")
            : "";

      return sorted.map(it=>{
        const name = (it.display_name_zh || "").trim() || (it.generic_name || "").trim();
        if (!name) return null;
        const color = (it.color || "").trim();
        const slot = (it.slot || "").trim();
        const q = `${g ? g + " " : ""}${color ? color + " " : ""}${name}${slot ? " " + slot : ""}`.trim();
        return { slot, q };
      }).filter(Boolean);
    }

    function renderKeywordsPanel(specItems, payload){
      const panel = document.getElementById("keywords-panel");
      const list = document.getElementById("kw-list");
      const toggle = document.getElementById("keywords-toggle");
      if (!panel || !list || !toggle) return;

      const qs = buildSearchQueriesFromSpec(specItems || [], { locale:"tw", gender: payload?.gender || "neutral" });
      if (!qs.length) { panel.style.display="none"; return; }

      list.innerHTML = qs.map(({slot,q})=>{
        const label = SLOT_LABEL_ZH?.[slot] || slot;
        return `
          <div class="kw-row">
            <span class="kw-tag kw-slot">${escapeHtml(label)}</span>
            <span class="kw-tag" title="${escapeHtml(q)}">${escapeHtml(q)}</span>
          </div>
        `;
      }).join("");

      panel.style.display = "block";

      // default collapsed
      list.classList.remove("on");
      toggle.textContent = "å±•é–‹";

      toggle.onclick = () => {
        const on = list.classList.toggle("on");
        toggle.textContent = on ? "æ”¶åˆ" : "å±•é–‹";
      };
    }

    function setDebug(obj) {
      const box = document.getElementById("debug-box");
      box.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      box.classList.toggle("on", getDebug());
    }

    /***********************
     * Products grouped by slot
     ***********************/
    const SLOT_ORDER = ["top","bottom","shoes","outer","bag","hat"];
    const SLOT_LABEL_ZH = {
      top: "ä¸Šè¡£", bottom: "ä¸‹èº«", shoes: "é‹å­", outer: "å¤–å¥—", bag: "åŒ…åŒ…", hat: "å¸½å­"
    };

    function groupProductsBySlot(list) {
      const groups = {};
      for (const s of SLOT_ORDER) groups[s] = [];
      (list || []).forEach(p => {
        const slot = (p.slot || "").toLowerCase();
        if (!groups[slot]) groups[slot] = [];
        groups[slot].push(p);
      });
      return groups;
    }

    function renderProductsGrouped(list) {
      const root = document.getElementById("products");
      root.innerHTML = "";

      if (!Array.isArray(list) || list.length === 0) {
        root.innerHTML = `<div class="placeholder" style="padding:16px;">æ²’æœ‰æ‰¾åˆ°å•†å“ï¼ˆæˆ– API å°šæœªå›å‚³ï¼‰</div>`;
        return;
      }

      const groups = groupProductsBySlot(list);

      for (const slot of SLOT_ORDER) {
        const items = groups[slot] || [];
        if (items.length === 0) continue;

        const wrap = document.createElement("div");
        wrap.className = "slot-group";

        wrap.innerHTML = `
          <div class="slot-head">
            <div class="slot-title">ğŸ§© ${escapeHtml(SLOT_LABEL_ZH[slot] || slot)}</div>
            <div class="slot-count">${items.length} å€‹</div>
          </div>
        `;

        items.forEach(p => {
          const div = document.createElement("div");
          div.className = "product-item";
          const thumb = p.thumbnail ? `<img src="${p.thumbnail}" alt="">` : `ç¤ºæ„`;
          const price = p.price || p.extracted_price || "";
          const link = p.product_link || p.link || p.url || "#";

          div.innerHTML = `
            <div class="thumb">${thumb}</div>
            <div>
              <div class="pname">${escapeHtml(p.title || p.name || "å•†å“")}</div>
              <div class="pmeta">
                ${price ? `<span>åƒ¹æ ¼ï¼š${escapeHtml(String(price))}</span>` : ""}
                ${p.source ? `<span>ä¾†æºï¼š${escapeHtml(String(p.source))}</span>` : ""}
              </div>
              <a class="plink" href="${link}" target="_blank" rel="noopener noreferrer">å‰å¾€æŸ¥çœ‹</a>
            </div>
          `;
          wrap.appendChild(div);
        });

        root.appendChild(wrap);
      }
    }

    /***********************
     * 4) API helper
     ***********************/
    async function postJson(url, body, withAuth=true) {
      const headers = { "Content-Type": "application/json" };
      if (withAuth) {
        const token = getAccessToken();
        if (!token) throw new Error("æœªç™»å…¥ï¼ˆæ²’æœ‰ Bearer tokenï¼‰");
        headers["Authorization"] = "Bearer " + token;
      }

      const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });

      const text = await r.text();
      let j = null;
      try { j = JSON.parse(text); } catch { j = { raw: text }; }

      if (!r.ok) {
        const msg = j?.error
          ? `${j.error}${j.detail ? " / " + (typeof j.detail === "string" ? j.detail : JSON.stringify(j.detail)) : ""}`
          : `HTTP ${r.status} / ${text.slice(0, 500)}`;
        throw new Error(`${url} å¤±æ•—ï¼š${msg}`);
      }
      return j;
    }

    /***********************
     * A) Step retry state machine
     ***********************/
    const flowState = {
      lastStep: "idle",      // "spec" | "image" | "products"
      payload: null,
      me: null,
      spec: null,
      imgResp: null,
      products: null,
      currentOutfitId: null
    };

    function showRetryUI(show, step="", hint="") {
      const row = document.getElementById("retry-row");
      const ht = document.getElementById("retry-hint");
      if (!row || !ht) return;
      if (!show) {
        row.style.display = "none";
        ht.textContent = "";
        return;
      }
      row.style.display = "flex";
      ht.textContent = hint ? hint : (step ? `å¯é‡è©¦ï¼š${step}` : "");
    }

    async function runStepSpec(payload, me) {
      setGenerateStep("spec");
      setStatus("Step 1/3ï¼šç”¢ç”Ÿ Outfit Specï¼ˆæ‰£é»ï¼‰", null, true);
      setProgress(20);

      const spec = await postJson("/api/generate-outfit-spec", payload, true);
      flowState.spec = spec;
      flowState.lastStep = "spec";
      setDebug({ step:"spec", spec });

      renderOutfitSummary(spec.summary);
      // UX: show keywords for product search
      renderKeywordsPanel(spec.items || [], payload);

      if (typeof spec.credits_left !== "undefined") {
        setAuthUI({ loggedIn:true, email: me.user?.email, credits: spec.credits_left });
      } else {
        await refreshAuthUI();
      }
      return spec;
    }

    async function runStepImage(payload, spec) {
      setGenerateStep("image");
      setStatus("Step 2/3ï¼šç”¢ç”Ÿç©¿æ­ç¤ºæ„åœ–", null, true);
      setProgress(55);

      const imgResp = await postJson("/api/generate-image", {
        ...payload,
        outfitSpec: spec,
        aspectRatio: "9:16",
        imageSize: "1K"
      }, true);

      if (!imgResp.image) throw new Error("Image API æ²’å›å‚³ image");
      flowState.imgResp = imgResp;
      flowState.lastStep = "image";
      setDebug({ step:"image", imgResp, spec });

      setImageBase64(imgResp.image, imgResp.mime || "image/png");
      showImageSkeleton(false);
      return imgResp;
    }

    async function runStepProducts(payload, spec) {
      setGenerateStep("products");
      setStatus("Step 3/3ï¼šæœå°‹é¡ä¼¼å•†å“", null, true);
      setProgress(80);

      const prodResp = await postJson("/api/search-products", {
        items: spec.items || [],
        locale: "tw",
        gender: payload.gender
      }, true);

      const list = prodResp.products || prodResp.items || prodResp.shopping_results || [];
      flowState.products = list;
      flowState.lastStep = "products";
      setDebug({ step:"products", prodResp, spec });

      renderProductsGrouped(list);
      // UX: after products done, toast
      showToast("å•†å“å·²æ›´æ–° âœ…");
      return list;
    }

    async function retryCurrentStep() {
      showRetryUI(false);
      clearError();

      const ensured = await ensureTokenFromSession();
      if (!ensured.ok) throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");

      const me = await apiMe();
      if (!me.ok) throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");

      const payload = flowState.payload;
      if (!payload) throw new Error("æ²’æœ‰å¯é‡è©¦çš„ payloadï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");

      if (flowState.lastStep === "spec") {
        if (!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        showImageSkeleton(true);
        await runStepImage(payload, flowState.spec);
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        finalizeDoneNoThrow();
        scrollToEl("anchor-products", "smooth", "start");
        return;
      }

      if (flowState.lastStep === "image") {
        if (!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        finalizeDoneNoThrow();
        scrollToEl("anchor-products", "smooth", "start");
        return;
      }

      await generateAll(true);
    }

    /***********************
     * B) Auto scroll behavior (desktop + mobile)
     ***********************/
    function autoScrollOnStart() {
      // ç”Ÿæˆå¾Œï¼šç›´æ¥æ»‘åˆ°ç¤ºæ„åœ–ï¼ˆæ¡Œæ©Ÿ/æ‰‹æ©Ÿéƒ½è¦ï¼‰
      scrollToEl("anchor-preview", "smooth", "start");
    }
    function autoScrollOnDone() {
      // å®Œæˆå¾Œï¼šæ»‘åˆ°å•†å“ï¼ˆæ¡Œæ©Ÿ/æ‰‹æ©Ÿéƒ½è¦ï¼‰
      scrollToEl("anchor-products", "smooth", "start");
    }

    /***********************
     * Fullscreen preview
     ***********************/
    const modal = document.getElementById("img-modal");
    const modalImg = document.getElementById("modal-img");
    const modalClose = document.getElementById("modal-close");
    const modalSave = document.getElementById("modal-save");

    function openModalWithCurrentImage() {
      const img = document.getElementById("outfit-image");
      if (!img || !img.src) return;
      modalImg.src = img.src;
      modal.classList.add("on");
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }
    function closeModal() {
      modal.classList.remove("on");
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape" && modal.classList.contains("on")) closeModal(); });

    modalSave.addEventListener("click", () => {
      try{
        const src = modalImg.src;
        if (!src) return;
        const a = document.createElement("a");
        a.href = src;
        a.download = "outfit.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){ console.error(e); }
    });

    document.getElementById("btn-fullscreen").addEventListener("click", openModalWithCurrentImage);
    document.getElementById("outfit-image").addEventListener("click", openModalWithCurrentImage);

    /***********************
     * æ”¶è— / æœ€è¿‘ 10 å¥—ï¼ˆæœ¬æ©Ÿå„²å­˜ï¼‰
     * - metadata: localStorage
     * - image dataUrl: IndexedDBï¼ˆé¿å… localStorage çˆ†æ‰ï¼‰
     ***********************/
    const LS_RECENTS = "os_recents_v2";
    const LS_FAVS = "os_favs_v2";

    function safeJsonParse(str, fallback){
      try{ return JSON.parse(str); }catch{ return fallback; }
    }
    function readList(key){
      const raw = localStorage.getItem(key);
      const arr = safeJsonParse(raw, []);
      return Array.isArray(arr) ? arr : [];
    }
    function writeList(key, arr){
      try{ localStorage.setItem(key, JSON.stringify(arr)); return true; }
      catch(e){ console.warn("localStorage write failed", e); return false; }
    }

    // IndexedDB tiny wrapper
    const IDB_NAME = "os_outfits_db_v1";
    const IDB_STORE = "images";
    function openDb(){
      return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = () => {
          const db = req.result;
          if (!db.objectStoreNames.contains(IDB_STORE)) {
            db.createObjectStore(IDB_STORE, { keyPath: "id" });
          }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    }
    async function idbPutImage(id, dataUrl){
      try{
        const db = await openDb();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readwrite");
          tx.objectStore(IDB_STORE).put({ id, dataUrl });
          tx.oncomplete = () => resolve(true);
          tx.onerror = () => reject(tx.error);
        });
        db.close();
        return true;
      }catch(e){
        console.warn("idbPutImage failed", e);
        return false;
      }
    }
    async function idbGetImage(id){
      try{
        const db = await openDb();
        const dataUrl = await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readonly");
          const req = tx.objectStore(IDB_STORE).get(id);
          req.onsuccess = () => resolve(req.result?.dataUrl || null);
          req.onerror = () => reject(req.error);
        });
        db.close();
        return dataUrl;
      }catch(e){
        console.warn("idbGetImage failed", e);
        return null;
      }
    }
    async function idbDelImage(id){
      try{
        const db = await openDb();
        await new Promise((resolve, reject) => {
          const tx = db.transaction(IDB_STORE, "readwrite");
          tx.objectStore(IDB_STORE).delete(id);
          tx.oncomplete = () => resolve(true);
          tx.onerror = () => reject(tx.error);
        });
        db.close();
        return true;
      }catch(e){
        console.warn("idbDelImage failed", e);
        return false;
      }
    }

    // Outfit identity
    function stableStringify(obj){
      const seen = new WeakSet();
      const sorter = (k, v) => {
        if (v && typeof v === "object") {
          if (seen.has(v)) return;
          seen.add(v);
          if (Array.isArray(v)) return v;
          const out = {};
          Object.keys(v).sort().forEach(key => out[key] = v[key]);
          return out;
        }
        return v;
      };
      return JSON.stringify(obj, sorter);
    }
    // âœ… Safe hash helper: prefer crypto.subtle SHA-256, but fall back gracefully.
    // Some environments (older iOS Safari / certain WebViews / non-secure contexts)
    // may not expose crypto.subtle, which would otherwise break the whole flow.
    function fnv1a32Hex(str){
      let h = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        // 32-bit FNV-1a prime
        h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
      }
      return h.toString(16).padStart(8, "0");
    }

    async function sha256Hex(str){
      try {
        if (!(window.crypto && window.crypto.subtle)) {
          return fnv1a32Hex(str);
        }
        const enc = new TextEncoder().encode(str);
        const buf = await window.crypto.subtle.digest("SHA-256", enc);
        return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
      } catch {
        return fnv1a32Hex(str);
      }
    }
    async function computeOutfitId(payload, spec){
      const core = {
        payload: {
          gender: payload.gender,
          age: payload.age,
          height: payload.height,
          weight: payload.weight,
          style: payload.style,
          styleVariant: payload.styleVariant || "",
          temp: payload.temp,
          withBag: !!payload.withBag,
          withHat: !!payload.withHat,
          withCoat: !!payload.withCoat,
        },
        items: (spec?.items || []).map(i => ({
          slot: i.slot, generic_name: i.generic_name, display_name_zh: i.display_name_zh, color: i.color, style: i.style, gender: i.gender, warmth: i.warmth
        })),
        summary: spec?.summary || ""
      };
      return await sha256Hex(stableStringify(core));
    }

    function fmtTime(ts){
      try{
        const d = new Date(ts);
        const m = String(d.getMonth()+1).padStart(2,"0");
        const day = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${m}/${day} ${hh}:${mm}`;
      }catch{ return ""; }
    }

    // UI: tabs
    const tabRecents = document.getElementById("tab-recents");
    const tabFavs = document.getElementById("tab-favs");
    const paneRecents = document.getElementById("pane-recents");
    const paneFavs = document.getElementById("pane-favs");

    function setTab(which){
      const rec = which === "recents";
      tabRecents.classList.toggle("active", rec);
      tabFavs.classList.toggle("active", !rec);
      paneRecents.classList.toggle("active", rec);
      paneFavs.classList.toggle("active", !rec);
    }
    tabRecents.addEventListener("click", () => setTab("recents"));
    tabFavs.addEventListener("click", () => setTab("favs"));

    // Render lists
    async function renderMiniList(targetId, listKey){
      const root = document.getElementById(targetId);
      if (!root) return;

      const list = readList(listKey);
      root.innerHTML = "";

      if (!list.length) {
        root.innerHTML = `<div class="mini-empty">ç›®å‰æ²’æœ‰è³‡æ–™ã€‚</div>`;
        return;
      }

      for (const item of list) {
        const row = document.createElement("div");
        row.className = "mini-card";

        const thumb = document.createElement("div");
        thumb.className = "mini-thumb";
        thumb.innerHTML = "è¼‰å…¥ä¸­â€¦";

        const info = document.createElement("div");
        info.className = "mini-info";
        const title = (item.summary || "ä¸€å¥—ç©¿æ­").trim() || "ä¸€å¥—ç©¿æ­";
        const meta = `${fmtTime(item.ts)} Â· ${item.payload?.gender || ""} Â· ${item.payload?.style || ""} Â· ${item.payload?.temp ?? ""}Â°C`;
        info.innerHTML = `<div class="t">${escapeHtml(title)}</div><div class="m">${escapeHtml(meta)}</div>`;

        const actions = document.createElement("div");
        actions.className = "mini-actions";

        const btnLoad = document.createElement("button");
        btnLoad.className = "chip-btn";
        btnLoad.type = "button";
        btnLoad.textContent = "å¥—ç”¨";
        btnLoad.addEventListener("click", async () => {
          await applySavedOutfit(item.id);
        });

        const btnDel = document.createElement("button");
        btnDel.className = "chip-btn danger";
        btnDel.type = "button";
        btnDel.textContent = "åˆªé™¤";
        btnDel.addEventListener("click", async () => {
          await removeSavedOutfit(listKey, item.id);
        });

        actions.appendChild(btnLoad);
        actions.appendChild(btnDel);

        row.appendChild(thumb);
        row.appendChild(info);
        row.appendChild(actions);
        root.appendChild(row);

        // load thumb async
        const dataUrl = await idbGetImage(item.imageId || item.id);
        if (dataUrl) {
          thumb.innerHTML = `<img src="${dataUrl}" alt="">`;
        } else {
          thumb.innerHTML = "ç„¡åœ–";
        }
        // click thumb to preview
        thumb.addEventListener("click", async () => {
          const dataUrl2 = await idbGetImage(item.imageId || item.id);
          if (!dataUrl2) return;
          modalImg.src = dataUrl2;
          modal.classList.add("on");
          modal.setAttribute("aria-hidden", "false");
          document.body.style.overflow = "hidden";
        });
      }
    }

    async function refreshCollectionsUI(){
      await renderMiniList("recents-list", LS_RECENTS);
      await renderMiniList("favs-list", LS_FAVS);
    }

    // Save / Remove
    async function upsertRecent(outfit){
      // non-throw
      try{
        const list = readList(LS_RECENTS);
        const filtered = list.filter(x => x.id !== outfit.id);
        filtered.unshift(outfit);
        const trimmed = filtered.slice(0, 10);
        writeList(LS_RECENTS, trimmed);
      }catch(e){
        console.warn("upsertRecent failed", e);
      }
    }

    function isFav(id){
      const list = readList(LS_FAVS);
      return list.some(x => x.id === id);
    }

    async function setFav(outfit, on){
      // non-throw
      try{
        const list = readList(LS_FAVS);
        const exists = list.some(x => x.id === outfit.id);
        let next = list;
        if (on) {
          if (!exists) next = [outfit, ...list].slice(0, 200);
        } else {
          next = list.filter(x => x.id !== outfit.id);
        }
        writeList(LS_FAVS, next);
      }catch(e){
        console.warn("setFav failed", e);
      }
    }

    async function removeSavedOutfit(listKey, id){
      try{
        const list = readList(listKey);
        const item = list.find(x => x.id === id);
        const next = list.filter(x => x.id !== id);
        writeList(listKey, next);
        // optional: also delete image (only if not referenced elsewhere)
        // keep it simple: delete always
        const imageId = item?.imageId || id;
        await idbDelImage(imageId);
      }catch(e){
        console.warn("removeSavedOutfit failed", e);
      } finally {
        await refreshCollectionsUI();
        syncFavButtonUI();
      }
    }

    async function applySavedOutfit(id){
      // Load saved outfit into UI (preview + summary + products if present)
      const all = [...readList(LS_RECENTS), ...readList(LS_FAVS)];
      const item = all.find(x => x.id === id);
      if (!item) return;

      // Fill form payload
      try{
        const p = item.payload || {};
        const setRange = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined && v !== null) { el.value = String(v); el.dispatchEvent(new Event("input")); } };
        const sel = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined && v !== null) el.value = String(v); };

        sel("gender", p.gender || "neutral");
        setRange("age", p.age ?? 25);
        setRange("height", p.height ?? 165);
        setRange("weight", p.weight ?? 55);
        setRange("temp", p.temp ?? 22);
        sel("styleVariant", p.styleVariant || "");
        // style cards
        document.getElementById("style").value = p.style || "casual";
        // repaint style cards
        document.querySelectorAll(".style-card").forEach(c => c.classList.toggle("selected", c.dataset.style === (p.style || "casual")));

        // switches (simulate click if mismatch)
        const wantBag = !!p.withBag, wantHat = !!p.withHat, wantCoat = !!p.withCoat;
        const swBag = document.getElementById("sw-bag");
        const swHat = document.getElementById("sw-hat");
        const swCoat = document.getElementById("sw-coat");
        const isOn = (el) => el.classList.contains("on");
        if (swBag && isOn(swBag) !== wantBag) swBag.click();
        if (swHat && isOn(swHat) !== wantHat) swHat.click();
        if (swCoat && isOn(swCoat) !== wantCoat) swCoat.click();

        // Show preview + summary
        const dataUrl = await idbGetImage(item.imageId || item.id);
        if (dataUrl) {
          const img = document.getElementById("outfit-image");
          const ph = document.getElementById("img-placeholder");
          img.src = dataUrl;
          img.style.display = "block";
          ph.style.display = "none";
        }
        renderOutfitSummary(item.summary || "");

        // Products (if stored)
        const products = item.products || [];
        if (Array.isArray(products) && products.length) {
          renderProductsGrouped(products);
        } else {
          // don't override user's current products too aggressively
        }

        // Update flowState for current
        flowState.currentOutfitId = item.id;
        syncFavButtonUI();

        // scroll to preview
        scrollToEl("anchor-preview", "smooth", "start");
      }catch(e){
        console.warn("applySavedOutfit failed", e);
      }
    }

    // Fav button UI
    const favBtn = document.getElementById("btn-fav");
    const favIcon = document.getElementById("fav-icon");
    const favText = document.getElementById("fav-text");

    function syncFavButtonUI(){
      const id = flowState.currentOutfitId;
      const enabled = !!id && !!flowState.imgResp && !!flowState.spec;
      favBtn.disabled = !enabled;
      if (!enabled){
        favBtn.classList.remove("on");
        favIcon.textContent = "â™¡";
        favText.textContent = "æ”¶è—";
        return;
      }
      const on = isFav(id);
      favBtn.classList.toggle("on", on);
      favIcon.textContent = on ? "â™¥" : "â™¡";
      favText.textContent = on ? "å·²æ”¶è—" : "æ”¶è—";
    }

    favBtn.addEventListener("click", async () => {
      const id = flowState.currentOutfitId;
      if (!id) return;

      // build current outfit payload for saving
      const outfit = await buildCurrentOutfitSnapshotNoThrow();
      if (!outfit) return;

      const on = !isFav(id);
      await setFav(outfit, on);
      // Ensure UI always refreshes even if storage fails
      syncFavButtonUI();
      await refreshCollectionsUI();
    });

    async function buildCurrentOutfitSnapshotNoThrow(){
      try{
        const id = flowState.currentOutfitId;
        if (!id) return null;

        // persist image into idb (use current image dataURL)
        const img = document.getElementById("outfit-image");
        const dataUrl = img?.src || null;
        if (dataUrl && dataUrl.startsWith("data:")) {
          await idbPutImage(id, dataUrl);
        }

        return {
          id,
          ts: Date.now(),
          payload: flowState.payload,
          summary: flowState.spec?.summary || "",
          spec: flowState.spec,
          products: Array.isArray(flowState.products) ? flowState.products : [],
          imageId: id
        };
      }catch(e){
        console.warn("buildCurrentOutfitSnapshot failed", e);
        return null;
      }
    }

    /***********************
     * 5) Main flow (fix: persistence NEVER throws the flow)
     ***********************/
    function resetPerRunUI(){
      // reset error and retry
      showRetryUI(false);
      clearError();

      // reset preview UI & products
      clearImage();
      showImageSkeleton(true);
      renderProductsSkeleton(4);
      renderOutfitSummary(null);

      // reset fav for new run
      flowState.currentOutfitId = null;
      flowState.imgResp = null;
      flowState.spec = null;
      flowState.products = null;
      syncFavButtonUI();
    }

    function finalizeDoneNoThrow(){
      setGenerateStep("done");
      setProgress(100);
      setStatus("å®Œæˆ âœ…", true, false);
      showRetryUI(false);
    }

    async function generateAll(forceRestart=false) {
      showRetryUI(false);
      clearError();
      setLoadingUI(true);
      setFormDisabled(true);

      try {
        setGenerateStep("spec");
        setProgress(0);
        setStatus("é–‹å§‹", null, true);

        autoScrollOnStart();

        resetPerRunUI();

        // Auth checks
        const ensured = await ensureTokenFromSession();
        if (!ensured.ok) {
          setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥ï¼ˆè«‹æŒ‰ Google ç™»å…¥ï¼‰" });
          throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");
        }

        const me = await apiMe();
        if (!me.ok) {
          setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" });
          throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");
        }
        flowState.me = me;

        // Build payload
        const payload = {
          gender: document.getElementById("gender").value,
          age: Number(document.getElementById("age").value),
          height: Number(document.getElementById("height").value),
          weight: Number(document.getElementById("weight").value),
          style: document.getElementById("style").value,
          styleVariant: document.getElementById("styleVariant").value || "",
          temp: Number(document.getElementById("temp").value),
          withBag: !!getBag(),
          withHat: !!getHat(),
          withCoat: !!getCoat()
        };

        // Save for retry
        flowState.payload = payload;
        if (forceRestart) {
          flowState.spec = null;
          flowState.imgResp = null;
          flowState.products = null;
          flowState.lastStep = "idle";
        }

        // Step 1: Spec
        const spec = await runStepSpec(payload, me);

        // compute id early
        const outfitId = await computeOutfitId(payload, spec);
        flowState.currentOutfitId = outfitId;
        syncFavButtonUI();

        // Step 2: Image
        const imgResp = await runStepImage(payload, spec);
        syncFavButtonUI();

        // auto-scroll to preview once image exists (helps on mobile & desktop)
        scrollToEl("anchor-preview", "smooth", "start");

        // Step 3: Products
        const products = await runStepProducts(payload, spec);

        // Done
        finalizeDoneNoThrow();
        autoScrollOnDone();

        // Persist to recent (NON-THROW)
        (async () => {
          try{
            const outfit = await buildCurrentOutfitSnapshotNoThrow();
            if (!outfit) return;
            // ensure products stored
            outfit.products = Array.isArray(products) ? products : [];
            // overwrite spec/products ts to actual done time
            outfit.ts = Date.now();
            await upsertRecent(outfit);
            await refreshCollectionsUI();
            syncFavButtonUI();
          }catch(e){
            console.warn("persist recent failed (non-fatal)", e);
          }
        })();

      } catch (e) {
        console.error(e);
        setGenerateStep("failed");
        setStatus("å¤±æ•— âŒ", false, false);
        setProgress(0);

        const msg = String(e?.message || e);

        // Show retry UI:
        if (flowState.spec && !flowState.imgResp) {
          showRetryUI(true, "Image", "Spec å·²å®Œæˆï¼Œå¯é‡è©¦ç”¢ç”Ÿç¤ºæ„åœ–");
          flowState.lastStep = "spec";
        } else if (flowState.spec && flowState.imgResp) {
          showRetryUI(true, "Products", "ç¤ºæ„åœ–å·²å®Œæˆï¼Œå¯é‡è©¦æœå°‹å•†å“");
          flowState.lastStep = "image";
        } else {
          showRetryUI(true, "Restart", "å¯å¾é ­é‡è·‘ï¼ˆé‡æ–°æ‰£é»ï¼‰");
          flowState.lastStep = "idle";
        }

        showError(msg);
        throw e;
      } finally {
        setLoadingUI(false);
        setFormDisabled(false);
      }
    }

    /***********************
     * 6) INIT
     ***********************/
    (async function init() {
      // sliders
      bindRange("age", "age-val");
      bindRange("height", "height-val");
      bindRange("weight", "weight-val");
      bindRange("temp", "temp-val");
      bindStyleCards();

      // auth buttons
      document.getElementById("login-btn").addEventListener("click", loginGoogle);
      document.getElementById("logout-btn").addEventListener("click", logout);

      // Mobile actionbar toggle
      const mobileBar = document.getElementById("mobile-actionbar");
      if (mobileBar) mobileBar.style.display = isMobile() ? "block" : "none";
      window.addEventListener("resize", () => {
        if (mobileBar) mobileBar.style.display = isMobile() ? "block" : "none";
      });


      // Quick nav (desktop + mobile)
      const navPreview = document.getElementById("nav-to-preview");
      const navProducts = document.getElementById("nav-to-products");
      if (navPreview) navPreview.addEventListener("click", () => scrollToEl("anchor-preview","smooth","start"));
      if (navProducts) navProducts.addEventListener("click", () => scrollToEl("anchor-products","smooth","start"));

      // Retry buttons
      document.getElementById("retry-btn").addEventListener("click", async () => {
        const btn = document.getElementById("retry-btn");
        btn.disabled = true;
        try {
          setLoadingUI(true);
          await retryCurrentStep();
        } catch (e) {
          console.error(e);
          showError(String(e?.message || e));
        } finally {
          setLoadingUI(false);
          btn.disabled = false;
        }
      });

      document.getElementById("restart-btn").addEventListener("click", async () => {
        const btn = document.getElementById("restart-btn");
        btn.disabled = true;
        try {
          setLoadingUI(true);
          await generateAll(true);
        } catch (e) {
          console.error(e);
          showError(String(e?.message || e));
        } finally {
          setLoadingUI(false);
          btn.disabled = false;
        }
      });

      // Shared click handler for both buttons
      async function onGenerateClick() {
        showRetryUI(false);
        try {
          await generateAll(false);
        } catch (e) {
          // errors already shown
        }
      }

      const goBtnDesktop = document.getElementById("go-btn");
      const goBtnMobile = document.getElementById("go-btn-mobile");

      if (goBtnDesktop) goBtnDesktop.addEventListener("click", async () => {
        goBtnDesktop.disabled = true;
        if (goBtnMobile) goBtnMobile.disabled = true;
        try { await onGenerateClick(); }
        finally {
          goBtnDesktop.disabled = false;
          if (goBtnMobile) goBtnMobile.disabled = false;
        }
      });

      if (goBtnMobile) goBtnMobile.addEventListener("click", async () => {
        goBtnMobile.disabled = true;
        if (goBtnDesktop) goBtnDesktop.disabled = true;
        try { await onGenerateClick(); }
        finally {
          goBtnMobile.disabled = false;
          if (goBtnDesktop) goBtnDesktop.disabled = false;
        }
      });

      // Debug pane initial
      document.getElementById("debug-box").classList.toggle("on", getDebug());

      // Ensure session
      await ensureTokenFromSession();
      await refreshAuthUI();

      osSupabase.auth.onAuthStateChange(async (_event, session) => {
        if (session?.access_token) saveAccessToken(session.access_token);
        else clearAccessToken();
        await refreshAuthUI();
      });

      // collections
      await refreshCollectionsUI();

      // initial status
      setGenerateStep("idle");
      setProgress(0);
      setStatus("ç­‰å¾…æ“ä½œ", null, false);
      setLoadingUI(false);
      syncFavButtonUI();
    })();
  </script>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

</body>
</html>
