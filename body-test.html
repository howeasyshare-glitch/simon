<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Outfit Studio Â· Body Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#fff;
      --text:#1b1b1f;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#111827;
      --accent:#ff6b6b;
      --ok:#16a34a;
      --warn:#ef4444;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #ffecec 0, var(--bg) 45%, var(--bg) 100%);
    }

    /* ---------- Loading / Skeleton ---------- */
    .skel {
      position: relative;
      overflow: hidden;
      background: #f3f4f6;
      border-radius: 14px;
      border: 1px solid #eef0f3;
    }
    .skel::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-120%);
      animation: skelmove 1.15s infinite;
    }
    @keyframes skelmove { 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }

    .form-disabled {
      pointer-events: none;
      opacity: 0.6;
    }
    .img-skel-wrap{
      width:100%;
      height:100%;
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      justify-content:flex-start;
    }
    .img-skel-line{ height:14px; border-radius:999px }
    .img-skel-block{ height:100%; min-height:220px; border-radius:18px; flex: 1 1 auto; }

    .products-skel{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .products-skel .row{
      display:grid;
      grid-template-columns:60px 1fr;
      gap:10px;
      margin: 0;
    }
    .products-skel .thumb{ width:60px; height:60px; border-radius:12px }
    .products-skel .t1{ height:14px; border-radius:999px; width:75% }
    .products-skel .t2{ height:12px; border-radius:999px; width:45%; margin-top:8px }

    /* ---------- Layout ---------- */
    .page{max-width:1280px;margin:0 auto;padding:20px 14px 40px}
    header{
      display:flex;align-items:flex-start;justify-content:space-between;
      gap:12px;padding:10px 10px 16px;
    }
    .brand{display:flex;gap:10px;align-items:center}
    .dot{
      width:28px;height:28px;border-radius:999px;
      background: linear-gradient(135deg, #111827, #111827);
      box-shadow:0 10px 20px rgba(0,0,0,.2);
    }
    .title{font-size:20px;font-weight:800;letter-spacing:.02em}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}
    .top-right{display:flex;align-items:flex-start;gap:12px}
    .auth-box{
      text-align:right;font-size:13px;color:var(--muted);
      line-height:1.6;margin-top:2px;min-width:260px;
    }
    .auth-box b{color:var(--text)}
    .btn{
      border:none;cursor:pointer;border-radius:999px;
      padding:10px 14px;font-weight:700;background:var(--brand);color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.18);
      transition:transform .1s ease, opacity .1s ease;white-space:nowrap;
    }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:700}

    .layout{
      display:grid;
      grid-template-columns: minmax(320px, 0.9fr) minmax(0, 1.6fr);
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .auth-box{min-width:auto}
    }

    .card{
      background:var(--card);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,.04);
      padding:16px;
    }
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;color:var(--muted);
      background:#f3f4f6;border:1px solid #eef0f3;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}

    /* âœ… è¡¨å–®è¦–è¦ºåˆ†æ®µ */
    .section-block{
      padding:12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:linear-gradient(135deg,#fff,#fafafa);
      margin-bottom:12px;
    }
    .section-head{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;margin-bottom:10px;
    }
    .section-head .stitle{
      font-weight:900;
      font-size:14px;
      color:#111827;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#fff;
      color:var(--muted);
      white-space:nowrap;
    }

    .form-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px 12px;
    }
    @media (max-width: 560px){
      .form-grid{grid-template-columns:1fr}
    }
    label{
      display:block;font-size:12px;font-weight:700;
      margin:0 0 6px 0;color:#111827;
    }
    input, select{
      width:100%;padding:10px 10px;border-radius:12px;
      border:1px solid var(--line);background:#fafafa;outline:none;font-size:14px;
    }
    input:focus, select:focus{
      background:#fff;border-color:#ff9a9a;
      box-shadow:0 0 0 3px rgba(255,107,107,.18);
    }

    /* Slider UI */
    .slider-group{
      padding:10px;border-radius:14px;border:1px solid var(--line);background:#fafafa;
    }
    .slider-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .slider-head .label{font-size:12px;font-weight:800;color:#111827}
    .value-chip{
      display:inline-flex;align-items:baseline;gap:6px;
      padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eef0f3;
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    .value-chip b{color:#111827;font-weight:900}
    input[type="range"]{
      width:100%;padding:0;border:none;background:transparent;accent-color:#111827;height:26px;
    }
    .range-sub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    /* âœ… é¢¨æ ¼å¡ç‰‡åŒ– */
    .style-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:560px){
      .style-grid{grid-template-columns:1fr 1fr}
    }
    .style-card{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-height:76px;
    }
    .style-card:active{transform:translateY(1px)}
    .style-card .name{font-weight:900;font-size:14px;color:#111827}
    .style-card .desc{font-size:12px;color:var(--muted);line-height:1.4}
    .style-card.selected{
      border-color:#111827;
      box-shadow:0 10px 20px rgba(17,24,39,.12);
    }
    .style-card .chip{
      align-self:flex-start;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #eef0f3;
      background:#f9fafb;
      color:#111827;
      font-weight:800;
    }

    .toggle-list{
      margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;
    }
    .toggle-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;border-top:1px solid var(--line);
    }
    .toggle-item:first-child{border-top:none}
    .toggle-item .left{display:flex;flex-direction:column;gap:2px}
    .toggle-item .name{font-weight:800;font-size:14px}
    .toggle-item .desc{font-size:12px;color:var(--muted)}
    .switch{
      width:44px;height:24px;border-radius:999px;background:#e5e7eb;
      position:relative;cursor:pointer;flex:0 0 auto;
    }
    .switch::after{
      content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px;
      background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.18);transition:transform .15s ease;
    }
    .switch.on{background:#111827}
    .switch.on::after{transform:translateX(20px)}

    .primary-wide{
      width:100%;
      margin-top:12px;
      padding:14px 14px;
      border-radius:14px;
      font-size:15px;
      font-weight:900;
      background:#111827;
      color:#fff;
      border:none;
      cursor:pointer;
    }
    .primary-wide:disabled{opacity:.55;cursor:default}

    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .hint.error{color:var(--warn);font-weight:800}

    .right-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .right-head h3{margin:0;font-size:18px;font-weight:900}
    .debug-toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none;cursor:pointer}

    .preview-wrap{
      border:1px solid var(--line);
      border-radius:18px;
      background:linear-gradient(125deg,#fff7f7,#f9fbff);
      padding:12px;
    }

    /* âœ… Image aspect (ç›´å¼) */
    .preview-inner{
      width:100%;
      max-width:450px;
      aspect-ratio: 9 / 16;
      height:auto;
      margin:0 auto;
      border-radius:16px;
      background:#fff;
      border:1px solid #f0f0f5;
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;position:relative;
    }
    img#outfit-image{
      width:100%;
      height:100%;
      object-fit:contain;
      display:none;
    }
    .placeholder{text-align:center;color:var(--muted);font-size:14px;padding:20px}

    .section-title{margin:14px 0 8px;display:flex;gap:8px;align-items:center}
    .section-title .pill{font-weight:800}

    .products{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;background:#fff;
      min-height:160px;
    }
    .product-item{
      display:grid;grid-template-columns:60px 1fr;gap:10px;padding:10px;border-radius:14px;
      background:#fafafa;border:1px solid #f1f2f4;margin-bottom:10px;
    }
    .product-item:last-child{margin-bottom:0}
    .thumb{
      width:60px;height:60px;border-radius:12px;background:#fff;border:1px solid #eee;
      display:flex;align-items:center;justify-content:center;overflow:hidden;color:var(--muted);font-size:12px;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pname{font-weight:900;font-size:14px;margin:0 0 4px}
    .pmeta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .plink{font-size:12px;color:#ff6b6b;text-decoration:none;font-weight:900}
    .plink:hover{text-decoration:underline}

    /* âœ… ç”Ÿæˆå‹•ç•«ç´°ç¯€ï¼šç‹€æ…‹ + é€²åº¦æ¢ + shimmer */
    .statusbar{margin-top:10px;font-size:12px;color:var(--muted)}
    .statusbar .ok{color:var(--ok);font-weight:900}
    .statusbar .bad{color:var(--warn);font-weight:900}

    .progress{
      margin-top:8px;
      height:8px;
      border-radius:999px;
      background:#eef0f3;
      overflow:hidden;
      border:1px solid #e9ecf1;
    }
    .progress > div{
      height:100%;
      width:0%;
      background:#111827;
      transition:width .25s ease;
    }
    .dots{
      display:inline-flex;
      gap:3px;
      vertical-align:middle;
      margin-left:6px;
    }
    .dot{
      width:5px;height:5px;border-radius:999px;background:var(--muted);
      opacity:.3;
      animation:blink 1s infinite;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{
      0%,100%{opacity:.25;transform:translateY(0)}
      50%{opacity:.9;transform:translateY(-1px)}
    }
    .shimmer{
      position:relative;
      overflow:hidden;
      border-radius:16px;
    }
    .shimmer::after{
      content:"";
      position:absolute;inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-120%);
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      0%{transform:translateX(-120%)}
      100%{transform:translateX(120%)}
    }

    .debug{
      margin-top:12px;display:none;
      border:1px dashed #d1d5db;background:#fff;border-radius:14px;
      padding:10px;font-size:12px;color:#111827;
      max-height:280px;overflow:auto;white-space:pre-wrap;
    }
    .debug.on{display:block}

    /* Outfit summary */
    .outfit-summary {
      margin-top: 14px;
      background: #fafafa;
      border: 1px solid #e5e7eb;
    }
    .summary-head {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 800;
      font-size: 14px;
      margin-bottom: 6px;
    }
    .summary-icon { font-size: 18px; }
    .summary-title { color: #111827; }
    .summary-text {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    /* âœ… æ¡Œæ©Ÿï¼šå·¦æ¬„æŒ‰éˆ•å›ºå®šåœ¨æ¬„åº• + å·¦æ¬„å…§å®¹å¯æ²å‹• */
    @media (min-width: 1024px) {
      .layout { overflow: visible; }

      .left-panel{
        position: sticky;
        top: 18px;
        align-self: flex-start;
        max-height: calc(100vh - 24px);
        display:flex;
        flex-direction:column;
        overflow:hidden;            /* é‡è¦ */
        padding-right: 6px;
      }
      .left-panel.card{ padding:14px; }
      .left-panel .row{ margin-bottom:8px; }
      .left-panel .form-grid{ gap: 8px 10px; }
      .left-panel label{ margin-bottom:4px; font-size:12px; }
      .left-panel input, .left-panel select{ padding:8px 10px; }
      .left-panel .toggle-list{ margin-top:8px; }
      .left-panel .toggle-item{ padding:10px 10px; }

      .left-panel-scroll{
        overflow-y:auto;
        flex: 1 1 auto;
        padding-right: 6px;
      }

      .left-panel-footer{
        position: sticky;
        bottom: 0;
        z-index: 20;
        padding-top: 10px;
        padding-bottom: 10px;
        background: linear-gradient(to top, #fff 70%, rgba(255,255,255,0));
      }
      .left-panel-footer .primary-wide{ margin-top:0; }
    }

    /* ---------- Mobile thumb-friendly tweaks ---------- */
    @media (max-width: 640px){
      .page{ padding:14px 12px calc(96px + env(safe-area-inset-bottom)); }
      header{ padding:8px 6px 10px; }
      .card{ padding:14px; border-radius:16px; }
      .toggle-item{ padding:12px 10px; }
      .style-card{ min-height:72px; padding:12px; }
      .products{ padding:10px; }
      .product-item{ padding:10px; }

      /* âœ… æ‰‹æ©Ÿåº•éƒ¨å›ºå®šæŒ‰éˆ•ï¼ˆé¿å…è¢«å…¶ä»–å…ƒä»¶é®ä½ï¼‰ */
      .left-panel-footer{
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: calc(14px + env(safe-area-inset-bottom));
        z-index: 9999; /* é‡è¦ï¼šé¿å…è¢«å…¶ä»–å…ƒä»¶é®ä½ */
        padding: 0;
        background: transparent;
      }
      .left-panel-footer .primary-wide{
        height: 52px;
        font-size: 16px;
        border-radius: 16px;
        box-shadow: 0 18px 38px rgba(0,0,0,.18);
      }

      /* å·¦æ¬„å…§å®¹ä¸è¦è¢«å›ºå®šæŒ‰éˆ•è“‹åˆ° */
      .left-panel-scroll{
        padding-bottom: calc(88px + env(safe-area-inset-bottom));
      }
    }

    @media (max-width: 768px) {
      .card { padding: 18px 16px; }
      .section-title { margin-top: 18px; }
      .product-item { padding: 12px; gap: 12px; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>
          <div class="title">Outfit Studio Â· Body Test</div>
          <div class="subtitle">æµç¨‹ï¼šSpecï¼ˆæ‰£é»ï¼‰â†’ Image â†’ Productsã€‚å³ä¸Šå¯é–‹ Debugã€‚</div>
        </div>
      </div>

      <div class="top-right">
        <div class="auth-box">
          <div id="login-status">æœªç™»å…¥</div>
          <div>é»æ•¸ï¼š<b><span id="credits">â€”</span></b></div>
          <div id="auth-hint" style="font-size:12px;color:var(--muted)"></div>
        </div>
        <button id="login-btn" class="btn">Google ç™»å…¥</button>
        <button id="logout-btn" class="btn secondary" style="display:none;">ç™»å‡º</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT -->
      <section class="card left-panel" id="left-panel">
        <div class="left-panel-scroll">
          <div class="row">
            <h3 style="margin:0">ç©¿æ­æ¢ä»¶</h3>
            <span class="pill">æ‰£ 1 é» / æ¬¡</span>
          </div>

          <!-- âœ… åˆ†æ®µ 1ï¼šåŸºæœ¬è³‡æ–™ -->
          <div class="section-block">
            <div class="section-head">
              <div class="stitle">â‘  åŸºæœ¬è³‡æ–™ <span class="tag">æ‹–æ‹‰æ›´å¿«</span></div>
            </div>

            <div class="form-grid">
              <div>
                <label>æ€§åˆ¥</label>
                <select id="gender">
                  <option value="female">å¥³æ€§</option>
                  <option value="male">ç”·æ€§</option>
                  <option value="neutral">ä¸­æ€§</option>
                </select>
              </div>

              <div class="slider-group">
                <div class="slider-head">
                  <div class="label">å¹´é½¡</div>
                  <div class="value-chip"><b id="age-val">25</b> æ­²</div>
                </div>
                <input id="age" type="range" min="13" max="70" step="1" value="25" aria-label="å¹´é½¡" />
                <div class="range-sub"><span>13</span><span>70</span></div>
              </div>

              <div class="slider-group">
                <div class="slider-head">
                  <div class="label">èº«é«˜</div>
                  <div class="value-chip"><b id="height-val">165</b> cm</div>
                </div>
                <input id="height" type="range" min="140" max="200" step="1" value="165" aria-label="èº«é«˜" />
                <div class="range-sub"><span>140</span><span>200</span></div>
              </div>

              <div class="slider-group">
                <div class="slider-head">
                  <div class="label">é«”é‡</div>
                  <div class="value-chip"><b id="weight-val">55</b> kg</div>
                </div>
                <input id="weight" type="range" min="35" max="120" step="1" value="55" aria-label="é«”é‡" />
                <div class="range-sub"><span>35</span><span>120</span></div>
              </div>

              <div class="slider-group" style="grid-column:1/-1">
                <div class="slider-head">
                  <div class="label">æº«åº¦</div>
                  <div class="value-chip"><b id="temp-val">22</b> Â°C</div>
                </div>
                <input id="temp" type="range" min="0" max="35" step="1" value="22" aria-label="æº«åº¦" />
                <div class="range-sub"><span>0</span><span>35</span></div>
              </div>
            </div>
          </div>

          <!-- âœ… åˆ†æ®µ 2ï¼šé¢¨æ ¼ï¼ˆå¡ç‰‡ï¼‰ -->
          <div class="section-block">
            <div class="section-head">
              <div class="stitle">â‘¡ é¢¨æ ¼é¸æ“‡ <span class="tag">é»ä¸€ä¸‹å°±å¥½</span></div>
            </div>

            <div class="style-grid" id="style-grid">
              <div class="style-card selected" data-style="casual">
                <div class="chip">Casual</div>
                <div class="name">ä¼‘é–’</div>
                <div class="desc">èˆ’æœã€æ—¥å¸¸ã€å¥½æ­é…</div>
              </div>
              <div class="style-card" data-style="minimal">
                <div class="chip">Minimal</div>
                <div class="name">æ¥µç°¡</div>
                <div class="desc">ä¹¾æ·¨ä¿è½ã€ä½å½©åº¦</div>
              </div>
              <div class="style-card" data-style="street">
                <div class="chip">Street</div>
                <div class="name">è¡—é ­</div>
                <div class="desc">å±¤æ¬¡ã€æ¯”ä¾‹ã€å€‹æ€§</div>
              </div>
              <div class="style-card" data-style="sporty">
                <div class="chip">Sporty</div>
                <div class="name">é‹å‹•</div>
                <div class="desc">æ©Ÿèƒ½ã€è¼•é¬†ã€å¥½æ´»å‹•</div>
              </div>
              <div class="style-card" data-style="smart" style="grid-column:1/-1">
                <div class="chip">Smart</div>
                <div class="name">Smart Casual</div>
                <div class="desc">æ­£å¼ä¸€é»ä½†ä¸æ‹˜è¬¹</div>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>é¢¨æ ¼è®Šé«”ï¼ˆå“ç‰Œ / åäººï¼‰</label>
              <select id="styleVariant">
                <option value="">ï¼ˆä¸ä½¿ç”¨è®Šé«”ï¼‰</option>
                <optgroup label="å“ç‰Œ">
                  <option value="brand-uniqlo">UNIQLOï¼ˆæ—¥ç³»åŸºæœ¬ï¼‰</option>
                  <option value="brand-muji">MUJIï¼ˆç”Ÿæ´»æ¥µç°¡ï¼‰</option>
                  <option value="brand-cos">COSï¼ˆçµæ§‹æ¥µç°¡ï¼‰</option>
                  <option value="brand-nike-tech">Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰</option>
                  <option value="brand-ader-error">Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰</option>
                </optgroup>
                <optgroup label="åäººï¼ˆé¢¨æ ¼éˆæ„Ÿï¼Œä¸æ¨¡ä»¿è‡‰ï¼‰">
                  <option value="celeb-iu-casual">IUï¼ˆéŸ“ç³»æ¸…æ–°ï¼‰</option>
                  <option value="celeb-jennie-minimal">Jennieï¼ˆæ¥µç°¡è¾£ï¼‰</option>
                  <option value="celeb-gd-street">G-Dragonï¼ˆè¡—é ­å±¤æ¬¡ï¼‰</option>
                  <option value="celeb-lisa-sporty">Lisaï¼ˆèˆè€…é‹å‹•ï¼‰</option>
                </optgroup>
              </select>
            </div>

            <input type="hidden" id="style" value="casual" />
          </div>

          <!-- âœ… åˆ†æ®µ 3ï¼šé…ä»¶ -->
          <div class="section-block" style="margin-bottom:0">
            <div class="section-head">
              <div class="stitle">â‘¢ é…ä»¶ <span class="tag">é¸å¡«</span></div>
            </div>

            <div class="toggle-list" style="margin-top:0">
              <div class="toggle-item">
                <div class="left">
                  <div class="name">åŒ…åŒ…</div>
                  <div class="desc">éœ€è¦ bag æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
                </div>
                <div class="switch" id="sw-bag" role="switch" aria-checked="false"></div>
              </div>
              <div class="toggle-item">
                <div class="left">
                  <div class="name">å¸½å­</div>
                  <div class="desc">éœ€è¦ hat æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
                </div>
                <div class="switch" id="sw-hat" role="switch" aria-checked="false"></div>
              </div>
              <div class="toggle-item">
                <div class="left">
                  <div class="name">å¤–å¥—</div>
                  <div class="desc">å‹¾é¸æˆ–æº«åº¦ â‰¤ 20Â°C æ™‚æœƒç”Ÿæˆ outer</div>
                </div>
                <div class="switch" id="sw-coat" role="switch" aria-checked="false"></div>
              </div>
            </div>
          </div>

          <div class="hint" id="form-hint">æç¤ºï¼šéœ€å…ˆç™»å…¥ï¼ˆGoogleï¼‰æ‰èƒ½å‘¼å«æ‰£é»çš„ Spec APIã€‚</div>
          <div class="hint error" id="error-hint" style="display:none;"></div>
        </div>

        <!-- âœ… å›ºå®šåº•éƒ¨ï¼ˆæ¡Œæ©Ÿåœ¨å·¦æ¬„åº•ã€æ‰‹æ©Ÿå›ºå®šåœ¨è¢å¹•åº•ï¼‰ -->
        <div class="left-panel-footer">
          <button id="go-btn" class="primary-wide">ç”¢ç”Ÿç©¿æ­åœ–</button>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="right-head">
          <h3>AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“</h3>
          <div class="debug-toggle" id="debug-toggle">
            <div class="switch" id="sw-debug" aria-checked="false"></div>
            <div>Debug</div>
          </div>
        </div>

        <div class="section-title">
          <span class="pill">AI ç©¿æ­ç¤ºæ„åœ–</span>
        </div>

        <!-- âœ… anchorï¼šç”Ÿæˆå¾Œè‡ªå‹•æ»‘åˆ°é€™è£¡ -->
        <div class="preview-wrap" id="anchor-preview">
          <div class="preview-inner" id="preview-box">
            <div id="img-skeleton" style="display:none;width:100%;height:100%;">
              <div class="img-skel-wrap">
                <div class="skel img-skel-line" style="width:68%"></div>
                <div class="skel img-skel-line" style="width:52%"></div>
                <div class="skel img-skel-block"></div>
              </div>
            </div>

            <img id="outfit-image" alt="Outfit preview" />
            <div class="placeholder" id="img-placeholder">å°šæœªç”¢ç”Ÿç¤ºæ„åœ–</div>
          </div>

          <div class="statusbar" id="statusbar">
            ç‹€æ…‹ï¼š<span id="status-text">ç­‰å¾…æ“ä½œ</span>
            <span id="status-dots" style="display:none">
              <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
            </span>
            <div class="progress"><div id="progress-bar"></div></div>
          </div>
        </div>

        <!-- AI Outfit Summary -->
        <div class="outfit-summary card" id="outfit-summary" style="display:none;">
          <div class="summary-head">
            <span class="summary-icon">ğŸ‘”</span>
            <span class="summary-title">AI ç©¿æ­å»ºè­°</span>
          </div>
          <div class="summary-text" id="summary-text"></div>
        </div>

        <div class="section-title">
          <span class="pill">é¡ä¼¼å•†å“ï¼ˆGoogle Shoppingï¼‰</span>
        </div>

        <!-- âœ… anchorï¼šå®Œæˆå¾Œè‡ªå‹•æ»‘åˆ°å•†å“å€ -->
        <div class="products" id="products">
          <div class="placeholder" style="padding:16px;">å°šæœªç”¢ç”Ÿå•†å“</div>
        </div>

        <pre class="debug" id="debug-box"></pre>
      </section>
    </main>
  </div>

  <!-- âœ… Supabase JS SDK (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /***********************
     * Utility: scroll helpers
     ***********************/
    function isMobile() {
      return window.matchMedia && window.matchMedia("(max-width: 640px)").matches;
    }

    function scrollToEl(id, behavior="smooth", block="start") {
      const el = document.getElementById(id);
      if (!el) return;
      el.scrollIntoView({ behavior, block });
    }

    function setFormDisabled(disabled) {
      const panel = document.getElementById("left-panel");
      if (!panel) return;
      panel.classList.toggle("form-disabled", disabled);
    }

    const GENERATE_STEPS = {
      idle: { btn: "ç”¢ç”Ÿç©¿æ­åœ–", text: "ç­‰å¾…æ“ä½œ" },
      spec: { btn: "åˆ†æä¸­â€¦", text: "åˆ†æä½ çš„èº«å½¢èˆ‡é¢¨æ ¼â€¦" },
      image: { btn: "è¨­è¨ˆä¸­â€¦", text: "è¨­è¨ˆæ•´é«”ç©¿æ­çµ„åˆâ€¦" },
      products: { btn: "æœå°‹å•†å“ä¸­â€¦", text: "æœå°‹å¯è³¼è²·å•†å“â€¦" },
      done: { btn: "å†ç”Ÿæˆä¸€å¥—", text: "å®Œæˆ" },
    };

    function setGenerateStep(step) {
      const cfg = GENERATE_STEPS[step] || GENERATE_STEPS.idle;

      const btn = document.getElementById("go-btn");
      if (btn) btn.textContent = cfg.btn;

      const statusText = document.getElementById("status-text");
      if (statusText) statusText.textContent = cfg.text;
    }

    /***********************
     * 0) CONFIG (è«‹æ”¹é€™è£¡)
     ***********************/
    const SUPABASE_PROJECT_REF = "auiwcsolpvufxxyhnvaf";
    const SUPABASE_URL = `https://${SUPABASE_PROJECT_REF}.supabase.co`;

    // âœ… Supabase Dashboard â†’ Settings â†’ API â†’ anon public key
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1aXdjc29scHZ1Znh4eWhudmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MzUwMDEsImV4cCI6MjA4MDUxMTAwMX0.KeD8JXdHs5Iu7-wf0F0GpUPp-_y5X5ha6mwBcR5eYDA";

    const REDIRECT_TO = "https://simon-one-ochre.vercel.app/body-test.html";

    /***********************
     * 0.5) Slider bindings
     ***********************/
    function bindRange(rangeId, valueId) {
      const r = document.getElementById(rangeId);
      const v = document.getElementById(valueId);
      const paint = () => { v.textContent = String(r.value); };
      r.addEventListener("input", paint);
      paint();
    }

    /***********************
     * 0.6) Style cards
     ***********************/
    function bindStyleCards() {
      const grid = document.getElementById("style-grid");
      const hidden = document.getElementById("style");
      const cards = Array.from(grid.querySelectorAll(".style-card"));

      const select = (style) => {
        hidden.value = style;
        cards.forEach(c => c.classList.toggle("selected", c.dataset.style === style));
      };

      cards.forEach(c => c.addEventListener("click", () => select(c.dataset.style)));
      select(hidden.value || "casual");
    }

    /***********************
     * 1) AUTH (Supabase JS)
     ***********************/
    const AUTH_KEY = "os_supabase_access_token_v1";
    function saveAccessToken(t){ localStorage.setItem(AUTH_KEY, t); }
    function getAccessToken(){ return localStorage.getItem(AUTH_KEY); }
    function clearAccessToken(){ localStorage.removeItem(AUTH_KEY); }

    const osSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: "pkce"
      }
    });

    async function apiMe() {
      const token = getAccessToken();
      if (!token) return { ok:false, error:"no token" };
      const r = await fetch("/api/me", { headers: { Authorization: "Bearer " + token } });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) return { ok:false, error:j?.error || "me failed", detail:j?.detail };
      return j;
    }

    function renderOutfitSummary(summary) {
      const box = document.getElementById("outfit-summary");
      const text = document.getElementById("summary-text");
      if (!box || !text) return;

      if (!summary) {
        box.style.display = "none";
        text.textContent = "";
        return;
      }
      text.textContent = summary;
      box.style.display = "block";
    }

    function setAuthUI({ loggedIn, email, credits, hint }) {
      const st = document.getElementById("login-status");
      const cr = document.getElementById("credits");
      const hintEl = document.getElementById("auth-hint");
      const loginBtn = document.getElementById("login-btn");
      const logoutBtn = document.getElementById("logout-btn");

      if (loggedIn) {
        st.textContent = email ? `å·²ç™»å…¥ï¼š${email}` : "å·²ç™»å…¥";
        cr.textContent = String(credits ?? 0);
        hintEl.textContent = hint || "";
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-flex";
      } else {
        st.textContent = hint || "æœªç™»å…¥";
        cr.textContent = "â€”";
        hintEl.textContent = "";
        loginBtn.style.display = "inline-flex";
        logoutBtn.style.display = "none";
      }
    }

    async function refreshAuthUI() {
      const token = getAccessToken();
      if (!token) {
        setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥" });
        return;
      }

      const me = await apiMe();
      if (!me.ok) {
        setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" });
        return;
      }
      setAuthUI({ loggedIn:true, email: me.user?.email, credits: me.credits_left, hint:"" });
    }

    async function ensureTokenFromSession() {
      const { data, error } = await osSupabase.auth.getSession();
      if (error) return { ok:false, error: error.message };

      const session = data?.session;
      if (!session?.access_token) {
        clearAccessToken();
        return { ok:false, error:"no session" };
      }

      saveAccessToken(session.access_token);

      if (location.hash || location.search) {
        history.replaceState(null, "", location.pathname);
      }

      return { ok:true, session };
    }

    async function loginGoogle() {
      if (SUPABASE_ANON_KEY.startsWith("PASTE_")) {
        alert("è«‹å…ˆåœ¨ body-test.html å¡«å…¥ SUPABASE_ANON_KEYï¼ˆSupabase â†’ Settings â†’ API â†’ anon public keyï¼‰");
        return;
      }

      const { error } = await osSupabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: REDIRECT_TO }
      });

      if (error) {
        console.error(error);
        setAuthUI({ loggedIn:false, hint:"ç™»å…¥å•Ÿå‹•å¤±æ•—ï¼š" + error.message });
      }
    }

    async function logout() {
      try { await osSupabase.auth.signOut(); } catch {}
      clearAccessToken();

      try {
        const keys = Object.keys(localStorage);
        for (const k of keys) {
          if (k.startsWith("sb-") || k.includes("supabase") || k.includes("auth")) localStorage.removeItem(k);
        }
        const skeys = Object.keys(sessionStorage);
        for (const k of skeys) {
          if (k.startsWith("sb-") || k.includes("supabase") || k.includes("auth")) sessionStorage.removeItem(k);
        }
      } catch {}

      setAuthUI({ loggedIn:false, hint:"å·²ç™»å‡º" });
      window.location.href = "/body-test.html";
    }

    /***********************
     * 2) UI switches
     ***********************/
    function bindSwitch(id, initial=false) {
      const el = document.getElementById(id);
      let on = initial;
      const paint = () => {
        el.classList.toggle("on", on);
        el.setAttribute("aria-checked", on ? "true" : "false");
      };
      paint();
      el.addEventListener("click", () => { on = !on; paint(); });
      return () => on;
    }

    const getBag = bindSwitch("sw-bag", false);
    const getHat = bindSwitch("sw-hat", false);
    const getCoat = bindSwitch("sw-coat", false);
    const getDebug = bindSwitch("sw-debug", false);

    document.getElementById("debug-toggle").addEventListener("click", (e) => {
      if (e.target.id !== "sw-debug") document.getElementById("sw-debug").click();
      document.getElementById("debug-box").classList.toggle("on", getDebug());
    });

    /***********************
     * 3) Render helpers + loading animation
     ***********************/
    const statusTextEl = document.getElementById("status-text");
    const statusDotsEl = document.getElementById("status-dots");
    const progressBarEl = document.getElementById("progress-bar");
    const previewBox = document.getElementById("preview-box");

    function setStatus(text, ok=null, loading=false) {
      statusTextEl.textContent = text;
      statusTextEl.className = ok === true ? "ok" : ok === false ? "bad" : "";
      statusDotsEl.style.display = loading ? "inline" : "none";
    }

    function setProgress(pct) {
      const v = Math.max(0, Math.min(100, Number(pct || 0)));
      progressBarEl.style.width = v + "%";
    }

    function setLoadingUI(on) {
      const products = document.getElementById("products");
      if (on) {
        previewBox.classList.add("shimmer");
        products.classList.add("shimmer");
      } else {
        previewBox.classList.remove("shimmer");
        products.classList.remove("shimmer");
      }
    }

    function showError(msg) {
      const el = document.getElementById("error-hint");
      el.style.display = "block";
      el.textContent = msg;
    }
    function clearError() {
      const el = document.getElementById("error-hint");
      el.style.display = "none";
      el.textContent = "";
    }

    function setImageBase64(base64, mime="image/png") {
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      img.src = `data:${mime};base64,${base64}`;
      img.style.display = "block";
      ph.style.display = "none";
    }

    function clearImage() {
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      img.src = "";
      img.style.display = "none";
      ph.style.display = "block";
    }

    function showImageSkeleton(on){
      const sk = document.getElementById("img-skeleton");
      const img = document.getElementById("outfit-image");
      const ph = document.getElementById("img-placeholder");
      if (!sk) return;

      if (on) {
        sk.style.display = "block";
        img.style.display = "none";
        ph.style.display = "none";
      } else {
        sk.style.display = "none";
      }
    }

    function renderProductsSkeleton(rows = 4) {
      const root = document.getElementById("products");
      root.innerHTML = `
        <div class="products-skel">
          ${Array.from({length: rows}).map(()=>`
            <div class="row">
              <div class="skel thumb"></div>
              <div>
                <div class="skel t1"></div>
                <div class="skel t2"></div>
              </div>
            </div>
          `).join("")}
        </div>
      `;
    }

    function renderProducts(list) {
      const root = document.getElementById("products");
      root.innerHTML = "";

      if (!Array.isArray(list) || list.length === 0) {
        root.innerHTML = `<div class="placeholder" style="padding:16px;">æ²’æœ‰æ‰¾åˆ°å•†å“ï¼ˆæˆ– API å°šæœªå›å‚³ï¼‰</div>`;
        return;
      }

      list.forEach(p => {
        const div = document.createElement("div");
        div.className = "product-item";

        const thumb = p.thumbnail ? `<img src="${p.thumbnail}" alt="">` : `ç¤ºæ„`;
        const price = p.price || p.extracted_price || "";
        const link = p.product_link || p.link || p.url || "#";

        div.innerHTML = `
          <div class="thumb">${thumb}</div>
          <div>
            <div class="pname">${escapeHtml(p.title || p.name || "å•†å“")}</div>
            <div class="pmeta">
              ${price ? `<span>åƒ¹æ ¼ï¼š${escapeHtml(String(price))}</span>` : ""}
              ${p.source ? `<span>ä¾†æºï¼š${escapeHtml(String(p.source))}</span>` : ""}
              ${p.slot ? `<span>é¡åˆ¥ï¼š${escapeHtml(String(p.slot))}</span>` : ""}
            </div>
            <a class="plink" href="${link}" target="_blank" rel="noopener noreferrer">å‰å¾€æŸ¥çœ‹</a>
          </div>
        `;
        root.appendChild(div);
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setDebug(obj) {
      const box = document.getElementById("debug-box");
      box.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      box.classList.toggle("on", getDebug());
    }

    /***********************
     * 4) Main flow: Spec -> Image -> Products
     ***********************/
    async function postJson(url, body, withAuth=true) {
      const headers = { "Content-Type": "application/json" };
      if (withAuth) {
        const token = getAccessToken();
        if (!token) throw new Error("æœªç™»å…¥ï¼ˆæ²’æœ‰ Bearer tokenï¼‰");
        headers["Authorization"] = "Bearer " + token;
      }

      const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
      const text = await r.text();
      let j = null;
      try { j = JSON.parse(text); } catch { j = { raw: text }; }

      if (!r.ok) {
        const msg = j?.error
          ? `${j.error}${j.detail ? " / " + (typeof j.detail === "string" ? j.detail : JSON.stringify(j.detail)) : ""}`
          : `HTTP ${r.status} / ${text.slice(0, 500)}`;
        throw new Error(`${url} å¤±æ•—ï¼š${msg}`);
      }
      return j;
    }

    async function generateAll() {
      clearError();
      renderOutfitSummary(null);
      clearImage();
      showImageSkeleton(true);
      renderProductsSkeleton(4);

      // âœ… å…ˆæ»‘åˆ°å³é‚Šç¤ºæ„åœ–å€ï¼ˆæ¡Œæ©Ÿä¹Ÿé©ç”¨ï¼‰
      scrollToEl("anchor-preview", "smooth", "start");

      setFormDisabled(true);
      setGenerateStep("spec");
      setProgress(0);
      setLoadingUI(true);
      setStatus("é–‹å§‹", null, true);

      const ensured = await ensureTokenFromSession();
      if (!ensured.ok) {
        setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥ï¼ˆè«‹æŒ‰ Google ç™»å…¥ï¼‰" });
        throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");
      }

      const me = await apiMe();
      if (!me.ok) {
        setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" });
        throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");
      }

      const payload = {
        gender: document.getElementById("gender").value,
        age: Number(document.getElementById("age").value),
        height: Number(document.getElementById("height").value),
        weight: Number(document.getElementById("weight").value),
        style: document.getElementById("style").value,
        styleVariant: document.getElementById("styleVariant").value || "",
        temp: Number(document.getElementById("temp").value),
        withBag: !!getBag(),
        withHat: !!getHat(),
        withCoat: !!getCoat()
      };

      // 1) Spec
      setStatus("Step 1/3ï¼šç”¢ç”Ÿ Outfit Specï¼ˆæ‰£é»ï¼‰", null, true);
      setProgress(20);
      const spec = await postJson("/api/generate-outfit-spec", payload, true);
      setDebug({ step:"spec", spec });
      renderOutfitSummary(spec.summary);
      setGenerateStep("image");

      if (typeof spec.credits_left !== "undefined") {
        setAuthUI({ loggedIn:true, email: me.user?.email, credits: spec.credits_left });
      } else {
        await refreshAuthUI();
      }

      // 2) Image
      setStatus("Step 2/3ï¼šç”¢ç”Ÿç©¿æ­ç¤ºæ„åœ–", null, true);
      setProgress(55);
      const imgResp = await postJson("/api/generate-image", {
        ...payload,
        outfitSpec: spec,
        aspectRatio: "9:16",
        imageSize: "1K"
      }, true);

      if (!imgResp.image) throw new Error("Image API æ²’å›å‚³ image");
      setImageBase64(imgResp.image, imgResp.mime || "image/png");
      showImageSkeleton(false);
      setDebug({ step:"image", imgResp, spec });

      setGenerateStep("products");

      // 3) Products
      setStatus("Step 3/3ï¼šæœå°‹é¡ä¼¼å•†å“", null, true);
      setProgress(80);

      const prodResp = await postJson("/api/search-products", {
        items: spec.items || [],
        locale: "tw",
        gender: payload.gender
      }, true);

      const list = prodResp.products || prodResp.items || prodResp.shopping_results || [];
      renderProducts(list);
      setDebug({ step:"products", prodResp, spec });

      setGenerateStep("done");
      setProgress(100);
      setStatus("å®Œæˆ âœ…", true, false);

      // âœ… å®Œæˆå¾Œè‡ªå‹•æ»‘åˆ°å•†å“å€
      scrollToEl("products", "smooth", "start");
    }

    /***********************
     * 5) INIT
     ***********************/
    (async function init() {
      bindRange("age", "age-val");
      bindRange("height", "height-val");
      bindRange("weight", "weight-val");
      bindRange("temp", "temp-val");
      bindStyleCards();

      document.getElementById("login-btn").addEventListener("click", loginGoogle);
      document.getElementById("logout-btn").addEventListener("click", logout);

      const goBtn = document.getElementById("go-btn");
      goBtn.addEventListener("click", async () => {
        goBtn.disabled = true;
        try {
          await generateAll();
        } catch (e) {
          console.error(e);
          setGenerateStep("idle");
          setProgress(0);
          setStatus("å¤±æ•— âŒ", false, false);
          showError(String(e.message || e));
        } finally {
          setLoadingUI(false);
          setFormDisabled(false);
          goBtn.disabled = false;
          // è‹¥å¤±æ•—ï¼Œå›åˆ°ç¤ºæ„åœ–å€è®“ä½¿ç”¨è€…çœ‹åˆ°éŒ¯èª¤
          // ï¼ˆæˆåŠŸæƒ…æ³å·²æ»‘åˆ° productsï¼‰
          if (document.getElementById("error-hint")?.style.display === "block") {
            scrollToEl("anchor-preview", "smooth", "start");
          }
        }
      });

      document.getElementById("debug-box").classList.toggle("on", getDebug());

      await ensureTokenFromSession();
      await refreshAuthUI();

      osSupabase.auth.onAuthStateChange(async (_event, session) => {
        if (session?.access_token) saveAccessToken(session.access_token);
        else clearAccessToken();
        await refreshAuthUI();
      });

      setGenerateStep("idle");
      setProgress(0);
      setStatus("ç­‰å¾…æ“ä½œ", null, false);
      setLoadingUI(false);
      setFormDisabled(false);
    })();
  </script>
</body>
</html>
