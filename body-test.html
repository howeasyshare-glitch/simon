
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Outfit Studio Â· Body Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#fff;
      --text:#1b1b1f;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#111827;
      --accent:#ff6b6b;
      --ok:#16a34a;
      --warn:#ef4444;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --r-lg:18px;
      --r-md:14px;
      --r-sm:10px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #ffecec 0, var(--bg) 45%, var(--bg) 100%);
    }
    a{ color:inherit }
    .skel { position: relative; overflow: hidden; background: #f3f4f6; border-radius: 14px; border: 1px solid #eef0f3; }
    .skel::after{ content:""; position:absolute; inset:0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.65) 50%, rgba(255,255,255,0) 100%); transform:translateX(-120%); animation: skelmove 1.15s infinite; }
    @keyframes skelmove { 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }
    .form-disabled { pointer-events:none; opacity:.6; }
    .img-skel-wrap{ width:100%; height:100%; padding:14px; display:flex; flex-direction:column; gap:12px; justify-content:flex-start; }
    .img-skel-line{ height:14px; border-radius:999px }
    .img-skel-block{ height:100%; min-height:220px; border-radius:18px; flex: 1 1 auto; }
    .products-skel{ display:flex; flex-direction:column; gap:10px; }
    .products-skel .row{ display:grid; grid-template-columns:60px 1fr; gap:10px; }
    .products-skel .thumb{ width:60px; height:60px; border-radius:12px }
    .products-skel .t1{ height:14px; border-radius:999px; width:75% }
    .products-skel .t2{ height:12px; border-radius:999px; width:45%; margin-top:8px }
    .page{max-width:1280px;margin:0 auto;padding:16px 14px 40px}

    /* Header re-layout (1236) */
    header{ display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; padding:12px 10px 14px; }
    .brand{ display:flex; gap:10px; align-items:center; min-width:0; }
    .brand-dot{ width:28px;height:28px;border-radius:999px; background: linear-gradient(135deg, #111827, #111827); box-shadow:0 10px 20px rgba(0,0,0,.2); flex:0 0 auto; }
    .brand-text{min-width:0}
    .title{font-size:20px;font-weight:900;letter-spacing:.02em; line-height:1.15}
    .subtitle{color:var(--muted);font-size:12px;margin-top:6px; line-height:1.35; max-width: 520px}
    .top-right{ display:flex; align-items:center; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    .auth-chip{ display:flex; flex-direction:column; align-items:flex-end; gap:2px; padding:8px 10px; border-radius:14px; border:1px solid #eef0f3; background:rgba(255,255,255,.75); backdrop-filter: blur(8px); box-shadow: 0 10px 22px rgba(0,0,0,.06); max-width:min(56vw, 320px); }
    .auth-chip .line1{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:100%; text-align:right; }
    .auth-chip .line2{ font-size:12px; color:var(--muted); }
    .auth-chip b{color:var(--text)}
    .btn{ border:none;cursor:pointer;border-radius:999px; padding:10px 14px;font-weight:900;background:var(--brand);color:#fff; box-shadow:0 10px 20px rgba(0,0,0,.18); transition:transform .1s ease, opacity .1s ease;white-space:nowrap; }
    .btn:active{transform:translateY(1px);opacity:.92}
    .btn.secondary{background:#fff;color:var(--text);border:1px solid var(--line);box-shadow:none;font-weight:900}

    .layout{ display:grid; grid-template-columns: minmax(320px, 0.9fr) minmax(0, 1.6fr); gap:16px; align-items:start; }
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }

    .card{ background:var(--card); border-radius:var(--r-lg); box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.04); padding:16px; }
    .pill{ display:inline-flex;align-items:center;gap:6px; padding:6px 10px;border-radius:999px; font-size:12px;color:var(--muted); background:#f3f4f6;border:1px solid #eef0f3; }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}

    .section-block{ padding:12px; border:1px solid var(--line); border-radius:16px; background:linear-gradient(135deg,#fff,#fafafa); margin-bottom:12px; }
    .section-head{ display:flex;align-items:center;justify-content:space-between; gap:10px;margin-bottom:10px; }
    .section-head .stitle{ font-weight:900; font-size:14px; color:#111827; display:flex; align-items:center; gap:8px; }
    .tag{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #eef0f3; background:#fff; color:var(--muted); white-space:nowrap; }

    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px 12px; }
    @media (max-width: 560px){ .form-grid{grid-template-columns:1fr} }
    label{ display:block;font-size:12px;font-weight:900; margin:0 0 6px 0;color:#111827; }
    input, select{ width:100%;padding:10px 10px;border-radius:12px; border:1px solid var(--line);background:#fafafa;outline:none;font-size:14px; }
    input:focus, select:focus{ background:#fff;border-color:#ff9a9a; box-shadow:0 0 0 3px rgba(255,107,107,.18); }

    .slider-group{ padding:10px;border-radius:14px;border:1px solid var(--line);background:#fafafa; }
    .slider-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
    .slider-head .label{font-size:12px;font-weight:900;color:#111827}
    .value-chip{ display:inline-flex;align-items:baseline;gap:6px; padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eef0f3; font-size:12px;color:var(--muted);white-space:nowrap; }
    .value-chip b{color:#111827;font-weight:900}
    input[type="range"]{ width:100%; padding:0; border:none; background:transparent; accent-color:#111827; height:26px; }
    .range-sub{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-top:4px}

    .style-grid{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; }
    @media (max-width:560px){ .style-grid{grid-template-columns:1fr 1fr} }
    .style-card{ border:1px solid var(--line); background:#fff; border-radius:16px; padding:12px 12px; cursor:pointer; user-select:none; transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease; display:flex; flex-direction:column; gap:6px; min-height:76px; }
    .style-card:active{transform:translateY(1px)}
    .style-card .name{font-weight:900;font-size:14px;color:#111827}
    .style-card .desc{font-size:12px;color:var(--muted);line-height:1.4}
    .style-card.selected{ border-color:#111827; box-shadow:0 10px 20px rgba(17,24,39,.12); }
    .style-card .chip{ align-self:flex-start; font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #eef0f3; background:#f9fafb; color:#111827; font-weight:900; }

    .toggle-list{ margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden; }
    .toggle-item{ display:flex;justify-content:space-between;align-items:center; padding:12px 12px;border-top:1px solid var(--line); }
    .toggle-item:first-child{border-top:none}
    .toggle-item .left{display:flex;flex-direction:column;gap:2px}
    .toggle-item .name{font-weight:900;font-size:14px}
    .toggle-item .desc{font-size:12px;color:var(--muted)}
    .switch{ width:44px;height:24px;border-radius:999px;background:#e5e7eb; position:relative;cursor:pointer;flex:0 0 auto; }
    .switch::after{ content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:999px; background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.18);transition:transform .15s ease; }
    .switch.on{background:#111827}
    .switch.on::after{transform:translateX(20px)}

    .primary-wide{ width:100%; margin-top:12px; padding:14px 14px; border-radius:14px; font-size:15px; font-weight:900; background:#111827; color:#fff; border:none; cursor:pointer; }
    .primary-wide:disabled{opacity:.55;cursor:default}

    .hint{margin-top:10px;font-size:12px;color:var(--muted)}
    .hint.error{color:var(--warn);font-weight:900}

    .right-head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .right-head h3{margin:0;font-size:18px;font-weight:900}
    .debug-toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted);user-select:none;cursor:pointer}

    .preview-wrap{ border:1px solid var(--line); border-radius:18px; background:linear-gradient(125deg,#fff7f7,#f9fbff); padding:12px; }
    .preview-inner{ width:100%; max-width:450px; aspect-ratio: 9 / 16; height:auto; margin:0 auto; border-radius:16px; background:#fff; border:1px solid #f0f0f5; display:flex;align-items:center;justify-content:center; overflow:hidden;position:relative; }
    img#outfit-image{ width:100%; height:100%; object-fit:contain; display:none; cursor: zoom-in; }
    .placeholder{text-align:center;color:var(--muted);font-size:14px;padding:20px}

    .preview-tools{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5; }
    .tool-btn{ display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(229,231,235,.95); background:rgba(255,255,255,.92); padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:900; font-size:12px; color:#111827; backdrop-filter: blur(6px); }
    .tool-btn:disabled{opacity:.55; cursor:default}
    .tool-btn .icon{font-size:14px}
    .tool-btn.fav.on{ border-color:#fecaca; background:rgba(255,245,245,.92); color:#ef4444; }

    .section-title{margin:14px 0 8px;display:flex;gap:8px;align-items:center}
    .section-title .pill{font-weight:900}

    .products{ border:1px solid var(--line); border-radius:18px; padding:12px;background:#fff; min-height:160px; }

    .slot-group{ border:1px solid #f1f2f4; background:#fafafa; border-radius:16px; padding:10px; margin-bottom:12px; }
    .slot-group:last-child{margin-bottom:0}
    .slot-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .slot-title{ font-weight:900; color:#111827; font-size:14px; display:flex; align-items:center; gap:8px; }
    .slot-count{ font-size:12px; color:var(--muted); border:1px solid #eef0f3; background:#fff; padding:4px 8px; border-radius:999px; white-space:nowrap; }

    .product-item{ display:grid;grid-template-columns:60px 1fr;gap:10px;padding:10px;border-radius:14px; background:#fff;border:1px solid #f1f2f4;margin-bottom:10px; }
    .product-item:last-child{margin-bottom:0}
    .thumb{ width:60px;height:60px;border-radius:12px;background:#fff;border:1px solid #eee; display:flex;align-items:center;justify-content:center;overflow:hidden;color:var(--muted);font-size:12px; }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .pname{font-weight:900;font-size:14px;margin:0 0 4px}
    .pmeta{font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px}
    .plink{font-size:12px;color:#ff6b6b;text-decoration:none;font-weight:900}
    .plink:hover{text-decoration:underline}

    .statusbar{margin-top:10px;font-size:12px;color:var(--muted)}
    .statusbar .ok{color:var(--ok);font-weight:900}
    .statusbar .bad{color:var(--warn);font-weight:900}
    .progress{ margin-top:8px; height:8px; border-radius:999px; background:#eef0f3; overflow:hidden; border:1px solid #e9ecf1; }
    .progress > div{ height:100%; width:0%; background:#111827; transition:width .25s ease; }

    .dots{ display:inline-flex; gap:3px; vertical-align:middle; margin-left:6px; }
    .ldot{ width:5px;height:5px;border-radius:999px;background:var(--muted); opacity:.3; animation:blink 1s infinite; }
    .ldot:nth-child(2){animation-delay:.15s}
    .ldot:nth-child(3){animation-delay:.3s}
    @keyframes blink{ 0%,100%{opacity:.25;transform:translateY(0)} 50%{opacity:.9;transform:translateY(-1px)} }

    .shimmer{ position:relative; overflow:hidden; border-radius:16px; }
    .shimmer::after{ content:""; position:absolute;inset:0; background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.7) 50%, rgba(255,255,255,0) 100%); transform:translateX(-120%); animation:shimmer 1.2s infinite; }
    @keyframes shimmer{ 0%{transform:translateX(-120%)} 100%{transform:translateX(120%)} }

    .debug{ margin-top:12px;display:none; border:1px dashed #d1d5db;background:#fff;border-radius:14px; padding:10px;font-size:12px;color:#111827; max-height:280px;overflow:auto;white-space:pre-wrap; }
    .debug.on{display:block}

    .outfit-summary { margin-top: 14px; background: #fafafa; border: 1px solid #e5e7eb; }
    .summary-head { display: flex; align-items: center; gap: 8px; font-weight: 900; font-size: 14px; margin-bottom: 6px; }
    .summary-icon { font-size: 18px; }
    .summary-title { color: #111827; }
    .summary-text { font-size: 14px; line-height: 1.6; color: #374151; }

    .action-row{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .mini-btn{ border:1px solid var(--line); background:#fff; color:#111827; padding:9px 12px; border-radius:999px; cursor:pointer; font-weight:900; font-size:13px; }
    .mini-btn:disabled{opacity:.55; cursor:default}
    .mini-btn.primary{ background:#111827; color:#fff; border-color:#111827; }
    .mini-btn.danger{ background:#fff; color:#ef4444; border-color:#fecaca; }
    .mini-hint{ font-size:12px; color:var(--muted); }

    .collection-wrap{ margin-top:12px; border:1px solid var(--line); border-radius:18px; overflow:hidden; background:#fff; }
    .tabs{ display:flex; gap:0; border-bottom:1px solid var(--line); background:#fafafa; }
    .tab{ flex:1; padding:10px 12px; font-weight:900; font-size:13px; cursor:pointer; border:none; background:transparent; color:#6b7280; }
    .tab.active{ color:#111827; background:#fff; }
    .tabpanes{ padding:10px; }
    .pane{ display:none; }
    .pane.active{ display:block; }

    .mini-list{ display:flex; flex-direction:column; gap:10px; }
    .mini-card{ display:grid; grid-template-columns:68px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid #eef0f3; border-radius:14px; background:#fafafa; }
    .mini-thumb{ width:68px; aspect-ratio: 9/16; border-radius:12px; overflow:hidden; border:1px solid #eee; background:#fff; display:flex; align-items:center; justify-content:center; color:#9ca3af; font-size:12px; }
    .mini-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini-info .t{ font-weight:900; font-size:13px; margin:0 0 4px; color:#111827; }
    .mini-info .m{ font-size:12px; color:#6b7280; line-height:1.35; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
    .mini-actions{ display:flex; flex-direction:column; gap:6px; align-items:flex-end; }
    .chip-btn{ border:1px solid #e5e7eb; background:#fff; padding:7px 10px; border-radius:999px; cursor:pointer; font-weight:900; font-size:12px; color:#111827; white-space:nowrap; }
    .chip-btn.danger{ color:#ef4444; border-color:#fecaca; }
    .mini-empty{ padding:14px; color:#6b7280; font-size:12px; background:#fff; border:1px dashed #e5e7eb; border-radius:14px; }

    @media (min-width: 1024px) {
      .layout { overflow: visible; }
      .left-panel { position: sticky; top: 18px; align-self: flex-start; max-height: calc(100vh - 24px); overflow-y: auto; padding-right: 6px; }
      .left-panel.card { padding: 14px; }
      .left-panel .row { margin-bottom: 8px; }
      .left-panel .form-grid { gap: 8px 10px; }
      .left-panel label { margin-bottom: 4px; font-size: 12px; }
      .left-panel input, .left-panel select { padding: 8px 10px; }
      .left-panel .toggle-list { margin-top: 8px; }
      .left-panel .toggle-item { padding: 10px 10px; }
      .left-panel .sticky-generate { position: sticky; bottom: 0; padding-top: 10px; background: linear-gradient(to top, #fff 60%, rgba(255,255,255,0)); z-index: 5; }
      .preview-inner { max-height: 70vh; }
    }

    @media (max-width: 640px){
      .page{ padding:14px 12px calc(104px + var(--safe-b)); }
      header{ grid-template-columns: 1fr; gap:10px; padding:10px 6px 10px; align-items:flex-start; }
      .brand-dot{ width:24px; height:24px; }
      .title{ font-size:18px; }
      .subtitle{ display:none; }
      .top-right{ width:100%; justify-content:space-between; gap:10px; }
      .auth-chip{ flex:1 1 auto; align-items:flex-start; max-width:none; }
      .auth-chip .line1{ text-align:left; }
      .btn{ padding:9px 12px; font-size:13px; }
      .card{ padding:14px; border-radius:16px; }
      .toggle-item{ padding:12px 10px; }
      .style-card{ min-height:72px; padding:12px; }
      .products{ padding:10px; }
      .product-item{ padding:10px; }
      .mobile-actionbar{ position: fixed; left: 12px; right: 12px; bottom: calc(14px + var(--safe-b)); z-index: 9999; pointer-events:none; }
      .mobile-actionbar .primary-wide{ width:100%; height:54px; font-size:16px; border-radius:16px; box-shadow:0 18px 38px rgba(0,0,0,.18); pointer-events:auto; }
      .left-panel .sticky-generate{ display:none; }
      .anchor { scroll-margin-top: 12px; }
    }

    .anchor { scroll-margin-top: 12px; }

    .modal{ position:fixed; inset:0; z-index: 10000; background: rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; padding: 14px; }
    .modal.on{ display:flex; }
    .modal-card{ width: min(520px, 100%); aspect-ratio: 9/16; background:#111827; border-radius: 18px; overflow:hidden; position:relative; box-shadow: 0 30px 70px rgba(0,0,0,.35); }
    .modal-card img{ width:100%; height:100%; object-fit:contain; display:block; background:#0b1020; }
    .modal-top{ position:absolute; top:10px; left:10px; right:10px; display:flex; justify-content:space-between; gap:10px; pointer-events:none; }
    .modal-top .m-btn{ pointer-events:auto; border:none; cursor:pointer; background: rgba(255,255,255,.12); color:#fff; padding:9px 12px; border-radius: 999px; font-weight:900; font-size:12px; backdrop-filter: blur(8px); }
    .modal-top .m-btn:active{ transform: translateY(1px); opacity:.95; }

    .status-sub{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.4; }
    .result-meta{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid #eef0f3; background:linear-gradient(135deg,#fff,#fafafa); border-radius:16px; margin:10px 0 14px; }
    .rm-left{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:12px; color:var(--muted); line-height:1.3; }
    .rm-left b{ color:#111827; }
    .rm-dot{ opacity:.5; }
    .rm-actions{ display:flex; gap:8px; flex:0 0 auto; }
    .cta-row{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:calc(90px + var(--safe-b)); z-index:1200; background:rgba(17,24,39,.92); color:#fff; padding:10px 12px; border-radius:999px; font-size:13px; font-weight:900; box-shadow:0 18px 38px rgba(0,0,0,.22); max-width:min(92vw,520px); text-align:center; opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease; }
    .toast.on{ opacity:1; transform:translateX(-50%) translateY(-2px); }
    .newbie-tip{ margin:10px 0 6px; padding:10px 12px; border-radius:14px; border:1px solid #eef0f3; background:#fff; color:var(--muted); font-size:12px; line-height:1.5; }
    .newbie-tip b{ color:#111827; }
  
    /* === UI fixes (2026-01) === */
    /* Gender segmented: match style-card logic (bold, clean, consistent) */
    .segmented{
      display:flex;
      gap:10px;
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:8px;
    }
    .seg-btn{
      flex:1;
      border:1px solid transparent;
      background:#fafafa;
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      transition:transform .08s ease, border-color .08s ease, box-shadow .08s ease, background .08s ease;
    }
    .seg-btn:active{ transform:translateY(1px); }
    .seg-btn .seg-main{ font-weight:900; font-size:14px; color:#111827; }
    .seg-btn .seg-sub{ font-weight:800; font-size:11px; color:var(--muted); letter-spacing:.02em; }
    .seg-btn.on{
      background:#fff;
      border-color:#111827;
      box-shadow:0 10px 20px rgba(17,24,39,.12);
    }

    /* Compact sliders (reduce height) */
    .slider-group{
      padding:8px;
      border-radius:14px;
    }
    .slider-head{ margin-bottom:6px; }
    .value-chip{ padding:5px 8px; font-size:12px; }
    .range-sub{ margin-top:2px; font-size:10px; }

    /* Bigger thumb + better track (override earlier range styles) */
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      height:28px;
      background:transparent;
      border:none;
      padding:0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:6px;
      border-radius:999px;
      background:#d1d5db;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:28px;height:28px;
      border-radius:999px;
      background:#111827;
      border:4px solid #fff;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
      margin-top:-11px;
    }
    input[type="range"]::-moz-range-track{
      height:6px;border-radius:999px;background:#d1d5db;
    }
    input[type="range"]::-moz-range-thumb{
      width:28px;height:28px;border-radius:999px;
      background:#111827;border:4px solid #fff;
      box-shadow:0 10px 18px rgba(0,0,0,.18);
    }

    /* Hide admin-only helper text under accessories */
    .toggle-item .desc{ display:none !important; }

  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-dot" aria-hidden="true"></div>
        <div class="brand-text">
          <div class="title">Outfit Studio Â· Body Test</div>
          <div class="subtitle">AI æœƒä¾æ¢ä»¶ç”¢ç”Ÿï¼šç¤ºæ„åœ– â†’ é¡ä¼¼å•†å“ï¼ˆå³ä¸Šå¯é–‹ Debugï¼‰</div>
        </div>
      </div>

      <div class="top-right">
        <div class="auth-chip" aria-label="ç™»å…¥èˆ‡é»æ•¸">
          <div class="line1" id="login-status">æœªç™»å…¥</div>
          <div class="line2">é»æ•¸ï¼š<b><span id="credits">â€”</span></b> <span id="auth-hint" style="margin-left:6px;"></span></div>
        </div>
        <button id="login-btn" class="btn">Google ç™»å…¥</button>
        <button id="logout-btn" class="btn secondary" style="display:none;">ç™»å‡º</button>
      </div>
    </header>

    <main class="layout">
      <section class="card left-panel" id="left-panel">
        <div class="row">
          <h3 style="margin:0">ç©¿æ­æ¢ä»¶</h3>
          <span class="pill">æ‰£ 1 é» / æ¬¡</span>
        </div>

        <div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘  åŸºæœ¬è³‡æ–™ <span class="tag">æ‹–æ‹‰æ›´å¿«</span></div>
          </div>

          <div class="form-grid">
            <div>
              <label>æ€§åˆ¥</label>
              <input type="hidden" id="gender" value="female" />
              <div class="segmented" id="gender-seg" role="radiogroup" aria-label="æ€§åˆ¥">
                <button type="button" class="seg-btn on" data-value="female" role="radio" aria-checked="true">
                  <span class="seg-main">å¥³æ€§</span><span class="seg-sub">Female</span>
                </button>
                <button type="button" class="seg-btn" data-value="male" role="radio" aria-checked="false">
                  <span class="seg-main">ç”·æ€§</span><span class="seg-sub">Male</span>
                </button>
                <button type="button" class="seg-btn" data-value="neutral" role="radio" aria-checked="false">
                  <span class="seg-main">ä¸­æ€§</span><span class="seg-sub">Neutral</span>
                </button>
              </div>
            </div>
</div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">å¹´é½¡</div>
                <div class="value-chip"><b id="age-val">25</b> æ­²</div>
              </div>
              <input id="age" type="range" min="13" max="70" step="1" value="25" aria-label="å¹´é½¡" />
              <div class="range-sub"><span>13</span><span>70</span></div>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">èº«é«˜</div>
                <div class="value-chip"><b id="height-val">165</b> cm</div>
              </div>
              <input id="height" type="range" min="140" max="200" step="1" value="165" aria-label="èº«é«˜" />
              <div class="range-sub"><span>140</span><span>200</span></div>
            </div>

            <div class="slider-group">
              <div class="slider-head">
                <div class="label">é«”é‡</div>
                <div class="value-chip"><b id="weight-val">55</b> kg</div>
              </div>
              <input id="weight" type="range" min="35" max="120" step="1" value="55" aria-label="é«”é‡" />
              <div class="range-sub"><span>35</span><span>120</span></div>
            </div>

            <div class="slider-group" style="grid-column:1/-1">
              <div class="slider-head">
                <div class="label">æº«åº¦</div>
                <div class="value-chip"><b id="temp-val">22</b> Â°C</div>
              </div>
              <input id="temp" type="range" min="0" max="35" step="1" value="22" aria-label="æº«åº¦" />
              <div class="range-sub"><span>0</span><span>35</span></div>
            </div>

            <div class="cta-row" style="grid-column:1/-1">
              <button class="mini-btn" id="cta-products" style="display:none;">çœ‹å•†å“ â†“</button>
              <div class="mini-hint" id="cta-hint" style="display:none;">å•†å“åœ¨ä¸‹æ–¹</div>
            </div>
          </div>
        </div>

        <div class="section-block">
          <div class="section-head">
            <div class="stitle">â‘¡ é¢¨æ ¼é¸æ“‡ <span class="tag">é»ä¸€ä¸‹å°±å¥½</span></div>
          </div>

          <div class="style-grid" id="style-grid">
            <div class="style-card selected" data-style="casual">
<div class="name">ä¼‘é–’ <span class="en">Casual</span></div>
              <div class="desc">èˆ’æœã€æ—¥å¸¸ã€å¥½æ­é…</div>
            </div>
            <div class="style-card" data-style="minimal">
<div class="name">æ¥µç°¡ <span class="en">Minimal</span></div>
              <div class="desc">ä¹¾æ·¨ä¿è½ã€ä½å½©åº¦</div>
            </div>
            <div class="style-card" data-style="street">
<div class="name">è¡—é ­ <span class="en">Street</span></div>
              <div class="desc">å±¤æ¬¡ã€æ¯”ä¾‹ã€å€‹æ€§</div>
            </div>
            <div class="style-card" data-style="sporty">
<div class="name">é‹å‹• <span class="en">Sporty</span></div>
              <div class="desc">æ©Ÿèƒ½ã€è¼•é¬†ã€å¥½æ´»å‹•</div>
            </div>
            <div class="style-card" data-style="smart" style="grid-column:1/-1">
<div class="name">Smart Casual <span class="en">Smart</span></div>
              <div class="desc">æ­£å¼ä¸€é»ä½†ä¸æ‹˜è¬¹</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>é¢¨æ ¼è®Šé«”ï¼ˆå“ç‰Œ / åäººï¼‰</label>
            <select id="styleVariant">
              <option value="">ï¼ˆä¸ä½¿ç”¨è®Šé«”ï¼‰</option>
              <optgroup label="å“ç‰Œ">
                <option value="brand-uniqlo">UNIQLOï¼ˆæ—¥ç³»åŸºæœ¬ï¼‰</option>
                <option value="brand-muji">MUJIï¼ˆç”Ÿæ´»æ¥µç°¡ï¼‰</option>
                <option value="brand-cos">COSï¼ˆçµæ§‹æ¥µç°¡ï¼‰</option>
                <option value="brand-nike-tech">Nike Techï¼ˆæ©Ÿèƒ½é‹å‹•ï¼‰</option>
                <option value="brand-ader-error">Ader Errorï¼ˆéŸ“ç³»è¡—é ­ï¼‰</option>
              </optgroup>
              <optgroup label="åäººï¼ˆé¢¨æ ¼éˆæ„Ÿï¼Œä¸æ¨¡ä»¿è‡‰ï¼‰">
                <option value="celeb-iu-casual">IUï¼ˆéŸ“ç³»æ¸…æ–°ï¼‰</option>
                <option value="celeb-jennie-minimal">Jennieï¼ˆæ¥µç°¡è¾£ï¼‰</option>
                <option value="celeb-gd-street">G-Dragonï¼ˆè¡—é ­å±¤æ¬¡ï¼‰</option>
                <option value="celeb-lisa-sporty">Lisaï¼ˆèˆè€…é‹å‹•ï¼‰</option>
              </optgroup>
            </select>
          </div>

          <input type="hidden" id="style" value="casual" />
        </div>

        <div class="section-block" style="margin-bottom:0">
          <div class="section-head">
            <div class="stitle">â‘¢ é…ä»¶ <span class="tag">é¸å¡«</span></div>
          </div>

          <div class="toggle-list" style="margin-top:0">
            <div class="toggle-item">
              <div class="left">
                <div class="name">åŒ…åŒ…</div>
                <div class="desc">éœ€è¦ bag æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
              </div>
              <div class="switch" id="sw-bag" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¸½å­</div>
                <div class="desc">éœ€è¦ hat æ‰æœƒå‡ºç¾åœ¨ Spec + å•†å“</div>
              </div>
              <div class="switch" id="sw-hat" role="switch" aria-checked="false"></div>
            </div>
            <div class="toggle-item">
              <div class="left">
                <div class="name">å¤–å¥—</div>
                <div class="desc">å‹¾é¸æˆ–æº«åº¦ â‰¤ 20Â°C æ™‚æœƒç”Ÿæˆ outer</div>
              </div>
              <div class="switch" id="sw-coat" role="switch" aria-checked="false"></div>
            </div>
          </div>
        </div>

        <div class="newbie-tip" id="newbie-tip" style="display:none;">é¦–æ¬¡ä½¿ç”¨ï¼šæŒ‰ä¸‹ <b>ã€Œç”¢ç”Ÿç©¿æ­åœ–ã€</b> å¾Œæœƒè‡ªå‹•è·³åˆ°å³å´çµæœï¼ˆç¤ºæ„åœ– â†’ å•†å“ï¼‰ã€‚</div>

        <div class="sticky-generate">
          <button id="go-btn" class="primary-wide">ç”¢ç”Ÿç©¿æ­åœ–</button>
        </div>

        <div class="hint" id="form-hint">æç¤ºï¼šéœ€å…ˆç™»å…¥ï¼ˆGoogleï¼‰æ‰èƒ½å‘¼å«æ‰£é»çš„ Spec APIã€‚</div>
        <div class="hint error" id="error-hint" style="display:none;"></div>
      </section>

      <section class="card">
        <div class="right-head">
          <h3>AI ç©¿æ­ç¤ºæ„åœ– & é¡ä¼¼å•†å“</h3>
          <div class="debug-toggle" id="debug-toggle">
            <div class="switch" id="sw-debug" aria-checked="false"></div>
            <div>Debug</div>
          </div>
        </div>

        <div class="result-meta" id="result-meta" style="display:none;">
          <div class="rm-left">
            <span id="result-time">â€”</span><span class="rm-dot">â€¢</span>
            <span id="result-summaryline">â€”</span>
          </div>
          <div class="rm-actions">
            <button class="mini-btn" id="copy-spec-btn" disabled>ä¸€éµè¤‡è£½ Outfit Spec</button>
            <button class="mini-btn" id="share-btn" disabled>åˆ†äº«</button>
          </div>
        </div>

        <div class="section-title">
          <span class="pill">ç¤ºæ„åœ–ï¼ˆå¯å…¨è¢å¹•ï¼‰</span>
        </div>

        <div class="preview-wrap anchor" id="anchor-preview">
          <div class="preview-inner" id="preview-box">
            <div class="preview-tools">
              <button class="tool-btn" id="btn-fullscreen" title="å…¨è¢å¹•é è¦½" type="button">
                <span class="icon">â›¶</span> å…¨è¢å¹•
              </button>
              <button class="tool-btn fav" id="btn-fav" title="æ”¶è—/å–æ¶ˆæ”¶è—" type="button" disabled>
                <span class="icon" id="fav-icon">â™¡</span>
                <span id="fav-text">æ”¶è—</span>
              </button>
            </div>

            <div id="img-skeleton" style="display:none;width:100%;height:100%;">
              <div class="img-skel-wrap">
                <div class="skel img-skel-line" style="width:68%"></div>
                <div class="skel img-skel-line" style="width:52%"></div>
                <div class="skel img-skel-block"></div>
              </div>
            </div>

            <img id="outfit-image" alt="Outfit preview" />
            <div class="placeholder" id="img-placeholder">å°šæœªç”¢ç”Ÿç¤ºæ„åœ–</div>
          </div>

          <div class="anchor" id="anchor-status"></div>

          <div class="statusbar" id="statusbar">
            ç‹€æ…‹ï¼š<span id="status-text">ç­‰å¾…æ“ä½œ</span>
            <div class="status-sub" id="status-sub">æŒ‰ä¸‹å·¦å´æŒ‰éˆ•é–‹å§‹ã€‚</div>
            <span id="status-dots" style="display:none">
              <span class="dots"><span class="ldot"></span><span class="ldot"></span><span class="ldot"></span></span>
            </span>
            <div class="progress"><div id="progress-bar"></div></div>

            <div class="action-row" id="retry-row" style="display:none;">
              <button class="mini-btn primary" id="retry-btn" type="button">é‡è©¦ç›®å‰æ­¥é©Ÿ</button>
              <button class="mini-btn danger" id="restart-btn" type="button">å¾é ­é‡è·‘</button>
              <div class="mini-hint" id="retry-hint"></div>
            </div>
          </div>
        </div>

        <div class="outfit-summary card" id="outfit-summary" style="display:none;">
          <div class="summary-head">
            <span class="summary-icon">ğŸ‘”</span>
            <span class="summary-title">AI ç©¿æ­å»ºè­°</span>
          </div>
          <div class="summary-text" id="summary-text"></div>
        </div>

        <div class="section-title" style="margin-top:12px;">
          <span class="pill">æ”¶è— / æœ€è¿‘ 10 å¥—</span>
        </div>
        <div class="collection-wrap" id="collection-wrap">
          <div class="tabs">
            <button class="tab active" id="tab-recents" type="button">æœ€è¿‘ 10 å¥—</button>
            <button class="tab" id="tab-favs" type="button">å·²æ”¶è—</button>
          </div>
          <div class="tabpanes">
            <div class="pane active" id="pane-recents">
              <div class="mini-list" id="recents-list"></div>
            </div>
            <div class="pane" id="pane-favs">
              <div class="mini-list" id="favs-list"></div>
            </div>
          </div>
        </div>

        <div class="section-title anchor" id="anchor-products">
          <span class="pill">é¡ä¼¼å•†å“ï¼ˆGoogle Shoppingï¼‰</span>
        </div>
        <div class="products" id="products">
          <div class="placeholder" style="padding:16px;">å°šæœªç”¢ç”Ÿå•†å“</div>
        </div>

        <pre class="debug" id="debug-box"></pre>
      </section>
    </main>
  </div>

  <div class="mobile-actionbar" id="mobile-actionbar" style="display:none;">
    <button id="go-btn-mobile" class="primary-wide" type="button">ç”¢ç”Ÿç©¿æ­åœ–</button>
  </div>

  <div class="modal" id="img-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="å…¨è¢å¹•é è¦½">
      <div class="modal-top">
        <button class="m-btn" id="modal-close" type="button">é—œé–‰ âœ•</button>
        <button class="m-btn" id="modal-save" type="button">ä¸‹è¼‰åœ–ç‰‡ â¬‡ï¸</button>
      </div>
      <img id="modal-img" alt="Outfit fullscreen preview" />
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    function isMobile(){ return window.matchMedia && window.matchMedia("(max-width: 640px)").matches; }

    function scrollToElWithOffset(id, offsetPx = 0, behavior="smooth"){
      const el = document.getElementById(id);
      if (!el) return;
      const y = el.getBoundingClientRect().top + window.scrollY - (offsetPx || 0);
      window.scrollTo({ top: Math.max(0, y), behavior });
    }

    function haptic(ms = 12){
      try{ if (navigator.vibrate) navigator.vibrate(ms); }catch{}
    }

    let toastTimer=null;
    function showToast(text, ms=2000){
      const t=document.getElementById("toast");
      if(!t) return;
      t.textContent=text||"";
      t.style.display="block";
      void t.offsetWidth;
      t.classList.add("on");
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>{ t.classList.remove("on"); setTimeout(()=>{ t.style.display="none"; },220); }, ms);
    }

    function formatNowTS(){
      const d=new Date();
      const pad=(n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function payloadSummaryLine(p){
      if(!p) return "â€”";
      const style=(p.style||"").toUpperCase();
      const g=p.gender==="female"?"å¥³":p.gender==="male"?"ç”·":"ä¸­æ€§";
      const extras=[p.withBag?"åŒ…":"",p.withHat?"å¸½":"",(p.withCoat|| (Number(p.temp)<=20))?"å¤–å¥—":""].filter(Boolean).join("ã€");
      return `${g} Â· ${p.age}æ­² Â· ${p.height}cm/${p.weight}kg Â· ${p.temp}Â°C Â· ${style}${p.styleVariant? " Â· "+p.styleVariant:""}${extras? " Â· "+extras:""}`;
    }

    function setResultMeta(payload){
      const bar=document.getElementById("result-meta");
      const timeEl=document.getElementById("result-time");
      const sumEl=document.getElementById("result-summaryline");
      if(!bar||!timeEl||!sumEl) return;
      bar.style.display="flex";
      timeEl.innerHTML=`<b>${formatNowTS()}</b>`;
      sumEl.textContent=payloadSummaryLine(payload);
    }

    function safeJson(obj){ try{ return JSON.stringify(obj,null,2);}catch{ return ""; } }
    function copyText(text){
      const s=String(text||"");
      if(!s) return false;
      if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(s).catch(()=>{}); return true; }
      const ta=document.createElement("textarea");
      ta.value=s; ta.style.position="fixed"; ta.style.left="-9999px";
      document.body.appendChild(ta); ta.select();
      try{ document.execCommand("copy"); }catch{}
      document.body.removeChild(ta);
      return true;
    }

    function b64urlEncode(str){
      const b64=btoa(unescape(encodeURIComponent(str)));
      return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");
    }
    function b64urlDecode(str){
      const s=String(str||"").replace(/-/g,"+").replace(/_/g,"/");
      const pad=s.length%4? "=".repeat(4-(s.length%4)):"";
      return decodeURIComponent(escape(atob(s+pad)));
    }

    function makeShareHash({payload,spec}){
      const data={v:1,payload:payload||null,spec:spec?{summary:spec.summary||"",items:spec.items||[]}:null};
      return "#share="+b64urlEncode(JSON.stringify(data));
    }
    function parseShareFromLocation(){
      const h=location.hash||"";
      const m=h.match(/#share=([^&]+)/);
      if(!m) return null;
      try{ const obj=JSON.parse(b64urlDecode(m[1])); if(!obj||!obj.payload) return null; return obj; }catch{ return null; }
    }

    function applyPayloadToForm(payload){
      if(!payload) return;
      const setSel=(id,v)=>{ const el=document.getElementById(id); if(el && v!==undefined && v!==null) el.value=String(v); };
                  setSel("gender", payload.gender);
      try{ const seg=document.getElementById("gender-seg"); if(seg){ seg.querySelectorAll(".seg-btn").forEach(b=>{ const on=b.dataset.value===String(payload.gender||""); b.classList.toggle("on", on); b.setAttribute("aria-checked", on?"true":"false"); }); } }catch{}
      try{ const gsel=document.getElementById("gender"); if(gsel) gsel.dispatchEvent(new Event("change")); }catch{}
      const setRange=(id,valId,v)=>{
        const el=document.getElementById(id);
        const lab=document.getElementById(valId);
        if(!el || v===undefined || v===null) return;
        el.value=String(v);
        if(lab) lab.textContent=String(v);
      };
      setRange("age","age-val",payload.age);
      setRange("height","height-val",payload.height);
      setRange("weight","weight-val",payload.weight);
      setRange("temp","temp-val",payload.temp);

      const styleHidden=document.getElementById("style");
      if(styleHidden && payload.style) styleHidden.value=payload.style;
      const cards=Array.from(document.querySelectorAll("#style-grid .style-card"));
      cards.forEach(c=>c.classList.toggle("selected", c.dataset.style===payload.style));

      setSel("styleVariant", payload.styleVariant||"");
      const setSwitch=(id,on)=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.classList.toggle("on", !!on);
        el.setAttribute("aria-checked", !!on? "true":"false");
      };
      setSwitch("sw-bag", !!payload.withBag);
      setSwitch("sw-hat", !!payload.withHat);
      setSwitch("sw-coat", !!payload.withCoat);
    }

    function userFriendlyError(e, step, hasImage){
      const raw=String(e?.message||e||"");
      if(raw.includes("æœªç™»å…¥")||raw.includes("no session")||raw.includes("Missing bearer token")||raw.includes("Invalid token")){
        return { title:"ç™»å…¥ç‹€æ…‹å·²å¤±æ•ˆ", desc:"è«‹å…ˆç™»å…¥å¾Œå†è©¦ä¸€æ¬¡ã€‚", next:"æŒ‰å³ä¸Šã€ŒGoogle ç™»å…¥ã€â†’ å†é»ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€ã€‚" };
      }
      if(raw.includes("/api/search-products")||raw.includes("search-products")){
        return { title:"å•†å“æœå°‹æš«æ™‚ä¸ç©©", desc: hasImage? "ç¤ºæ„åœ–å·²ä¿ç•™ï¼Œä½ å¯ä»¥ç¨å¾Œå†è©¦æœå°‹å•†å“ã€‚":"è«‹ç¨å¾Œå†è©¦ä¸€æ¬¡ã€‚", next: hasImage? "æŒ‰ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€å³å¯é‡æ–°æ‰¾å•†å“ã€‚":"æŒ‰ã€Œå¾é ­é‡è·‘ã€å†è©¦ã€‚" };
      }
      if(raw.includes("/api/generate-image")||raw.includes("generate-image")){
        return { title:"ç¤ºæ„åœ–ç”Ÿæˆæš«æ™‚å¤±æ•—", desc:"é€šå¸¸æ˜¯æ¨¡å‹æˆ–ç¶²è·¯æ³¢å‹•ï¼Œç¨å¾Œå¯å†è©¦ã€‚", next:"æŒ‰ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€å³å¯ã€‚" };
      }
      if(raw.includes("/api/generate-outfit-spec")||raw.includes("generate-outfit-spec")){
        return { title:"åˆ†ææ¢ä»¶æš«æ™‚å¤±æ•—", desc:"è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–å…ˆæª¢æŸ¥ç™»å…¥èˆ‡é»æ•¸ã€‚", next:"æŒ‰ã€Œå¾é ­é‡è·‘ã€å†è©¦ä¸€æ¬¡ã€‚" };
      }
      return { title:"æš«æ™‚å¤±æ•—", desc:"å¯èƒ½æ˜¯ç¶²è·¯æˆ–æœå‹™æ³¢å‹•ï¼Œç¨å¾Œå†è©¦å³å¯ã€‚", next:"æŒ‰ã€Œé‡è©¦ç›®å‰æ­¥é©Ÿã€æˆ–ç¨å¾Œå†è©¦ã€‚" };
    }

    function setFormDisabled(disabled){
      const form=document.getElementById("left-panel");
      if(!form) return;
      form.classList.toggle("form-disabled", disabled);
    }

    const GENERATE_STEPS={
      idle:{ btn:"ç”¢ç”Ÿç©¿æ­åœ–", text:"æº–å‚™å°±ç·’", sub:"æŒ‰ä¸‹å¾Œæœƒè‡ªå‹•è·³åˆ°ç¤ºæ„åœ–èˆ‡å•†å“å€ã€‚", eta:"" },
      spec:{ btn:"åˆ†æèº«å½¢â€¦", text:"åˆ†æèº«å½¢èˆ‡éœ€æ±‚", sub:"ç‚ºäº†æŒ‘å‡ºæ›´åˆèº«ã€ç¬¦åˆé¢¨æ ¼çš„ç‰ˆå‹èˆ‡é…è‰²ã€‚", eta:"é€šå¸¸ 10â€“20 ç§’" },
      image:{ btn:"çµ„åˆç©¿æ­â€¦", text:"çµ„è¡£æœèˆ‡æ¯”ä¾‹", sub:"æŠŠå–®å“çµ„æˆå®Œæ•´ç©¿æ­ï¼Œä¸¦ç”Ÿæˆç¤ºæ„åœ–ã€‚", eta:"é€šå¸¸ 10â€“20 ç§’" },
      products:{ btn:"æ‰¾å•†å“â€¦", text:"æ‰¾å¯è²·å•†å“", sub:"ç”¨ç©¿æ­å–®å“å»æœå°‹ç›¸ä¼¼å•†å“ï¼Œæ–¹ä¾¿ç›´æ¥è³¼è²·ã€‚", eta:"é€šå¸¸ 5â€“15 ç§’" },
      done:{ btn:"å†ç”Ÿæˆä¸€å¥—", text:"å®Œæˆ âœ…", sub:"ä½ å¯ä»¥æ”¶è—ã€åˆ†äº«ï¼Œæˆ–å†è©¦ä¸€å¥—ä¸åŒé¢¨æ ¼ã€‚", eta:"" },
      failed:{ btn:"å†è©¦ä¸€æ¬¡", text:"æš«æ™‚å¤±æ•—", sub:"åˆ¥æ“”å¿ƒï¼Œçµæœå·²ç›¡é‡ä¿ç•™ï¼Œä½ å¯ä»¥é‡è©¦ã€‚", eta:"" }
    };

    function setGenerateStep(step){
      const cfg=GENERATE_STEPS[step]||GENERATE_STEPS.idle;
      const btn1=document.getElementById("go-btn");
      const btn2=document.getElementById("go-btn-mobile");
      if(btn1) btn1.textContent=cfg.btn;
      if(btn2) btn2.textContent=cfg.btn;

      const statusTextEl=document.getElementById("status-text");
      if(statusTextEl) statusTextEl.textContent=cfg.text;

      const statusSubEl=document.getElementById("status-sub");
      if(statusSubEl){
        const extra=cfg.eta? `ï¼ˆ${cfg.eta}ï¼‰`:"";
        statusSubEl.textContent=(cfg.sub||"") + (cfg.sub? " ":"") + extra;
      }
    }

    const SUPABASE_PROJECT_REF="auiwcsolpvufxxyhnvaf";
    const SUPABASE_URL=`https://${SUPABASE_PROJECT_REF}.supabase.co`;
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1aXdjc29scHZ1Znh4eWhudmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MzUwMDEsImV4cCI6MjA4MDUxMTAwMX0.KeD8JXdHs5Iu7-wf0F0GpUPp-_y5X5ha6mwBcR5eYDA";
    const REDIRECT_TO=location.origin+"/body-test.html";

    function bindRange(rangeId, valueId){
      const r=document.getElementById(rangeId);
      const v=document.getElementById(valueId);
      const paint=()=>{ v.textContent=String(r.value); };
      r.addEventListener("input", paint);
      paint();
    }

    function bindStyleCards(){
      const grid=document.getElementById("style-grid");
      const hidden=document.getElementById("style");
      const cards=Array.from(grid.querySelectorAll(".style-card"));
      const select=(style)=>{
        hidden.value=style;
        cards.forEach(c=>c.classList.toggle("selected", c.dataset.style===style));
      };
      cards.forEach(c=>c.addEventListener("click", ()=>select(c.dataset.style)));
      select(hidden.value||"casual");
    }

    const AUTH_KEY="os_supabase_access_token_v1";
    function saveAccessToken(t){ localStorage.setItem(AUTH_KEY,t); }
    function getAccessToken(){ return localStorage.getItem(AUTH_KEY); }
    function clearAccessToken(){ localStorage.removeItem(AUTH_KEY); }

    const osSupabase=supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, flowType:"pkce" }
    });

    async function apiMe(){
      const token=getAccessToken();
      if(!token) return { ok:false, error:"no token" };
      const r=await fetch("/api/me", { headers:{ Authorization:"Bearer "+token } });
      const j=await r.json().catch(()=>({}));
      if(!r.ok) return { ok:false, error:j?.error||"me failed", detail:j?.detail };
      return j;
    }

    function renderOutfitSummary(summary){
      const box=document.getElementById("outfit-summary");
      const text=document.getElementById("summary-text");
      if(!summary){ box.style.display="none"; return; }
      text.textContent=summary;
      box.style.display="block";
    }

    function setAuthUI({loggedIn,email,credits,hint}){
      const st=document.getElementById("login-status");
      const cr=document.getElementById("credits");
      const hintEl=document.getElementById("auth-hint");
      const loginBtn=document.getElementById("login-btn");
      const logoutBtn=document.getElementById("logout-btn");
      if(loggedIn){
        st.textContent=email? `å·²ç™»å…¥ï¼š${email}`:"å·²ç™»å…¥";
        cr.textContent=String(credits ?? 0);
        hintEl.textContent=hint||"";
        loginBtn.style.display="none";
        logoutBtn.style.display="inline-flex";
      } else {
        st.textContent=hint||"æœªç™»å…¥";
        cr.textContent="â€”";
        hintEl.textContent="";
        loginBtn.style.display="inline-flex";
        logoutBtn.style.display="none";
      }
    }

    async function refreshAuthUI(){
      const token=getAccessToken();
      if(!token){ setAuthUI({loggedIn:false, hint:"æœªç™»å…¥"}); return; }
      const me=await apiMe();
      if(!me.ok){ setAuthUI({loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰"}); return; }
      setAuthUI({loggedIn:true, email:me.user?.email, credits:me.credits_left, hint:""});
    }

    async function ensureTokenFromSession(){
      const {data, error}=await osSupabase.auth.getSession();
      if(error) return { ok:false, error:error.message };
      const session=data?.session;
      if(!session?.access_token){ clearAccessToken(); return { ok:false, error:"no session" }; }
      saveAccessToken(session.access_token);
      if(location.hash||location.search) history.replaceState(null,"",location.pathname);
      return { ok:true, session };
    }

    async function loginGoogle(){
      if(!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY.startsWith("PASTE_")){
        alert("è«‹å…ˆåœ¨ body-test.html å¡«å…¥ SUPABASE_ANON_KEYï¼ˆSupabase â†’ Settings â†’ API â†’ anon public keyï¼‰");
        return;
      }
      const {error}=await osSupabase.auth.signInWithOAuth({ provider:"google", options:{ redirectTo: REDIRECT_TO } });
      if(error){ console.error(error); setAuthUI({loggedIn:false, hint:"ç™»å…¥å•Ÿå‹•å¤±æ•—ï¼š"+error.message}); }
    }

    async function logout(){
      try{ await osSupabase.auth.signOut(); }catch{}
      clearAccessToken();
      try{
        const keys=Object.keys(localStorage);
        for(const k of keys){ if(k.startsWith("sb-")||k.includes("supabase")||k.includes("auth")) localStorage.removeItem(k); }
        const skeys=Object.keys(sessionStorage);
        for(const k of skeys){ if(k.startsWith("sb-")||k.includes("supabase")||k.includes("auth")) sessionStorage.removeItem(k); }
      }catch{}
      setAuthUI({loggedIn:false, hint:"å·²ç™»å‡º"});
      window.location.href="/body-test.html";
    }

    function bindSwitch(id, initial=false){
      const el=document.getElementById(id);
      let on=initial;
      const paint=()=>{ el.classList.toggle("on",on); el.setAttribute("aria-checked", on?"true":"false"); };
      paint();
      el.addEventListener("click", ()=>{ on=!on; paint(); });
      return ()=>on;
    }

    const getBag=bindSwitch("sw-bag", false);
    const getHat=bindSwitch("sw-hat", false);
    const getCoat=bindSwitch("sw-coat", false);
    const getDebug=bindSwitch("sw-debug", false);

    document.getElementById("debug-toggle").addEventListener("click", (e)=>{
      if(e.target.id!=="sw-debug") document.getElementById("sw-debug").click();
      document.getElementById("debug-box").classList.toggle("on", getDebug());
    });

    const statusTextEl=document.getElementById("status-text");
    const statusDotsEl=document.getElementById("status-dots");
    const progressBarEl=document.getElementById("progress-bar");
    const previewBox=document.getElementById("preview-box");

    function setStatus(_ignored, ok=null, loading=false){
      statusTextEl.className = ok===true ? "ok" : ok===false ? "bad" : "";
      statusDotsEl.style.display = loading ? "inline" : "none";
    }
    function setProgress(pct){ const v=Math.max(0,Math.min(100,Number(pct||0))); progressBarEl.style.width=v+"%"; }
    function setLoadingUI(on){
      const products=document.getElementById("products");
      if(on){ previewBox.classList.add("shimmer"); products.classList.add("shimmer"); }
      else{ previewBox.classList.remove("shimmer"); products.classList.remove("shimmer"); }
    }

    function showError(msg){ const el=document.getElementById("error-hint"); el.style.display="block"; el.textContent=msg; }
    function clearError(){ const el=document.getElementById("error-hint"); el.style.display="none"; el.textContent=""; }

    function setImageBase64(base64, mime="image/png"){
      const img=document.getElementById("outfit-image");
      const ph=document.getElementById("img-placeholder");
      img.src=`data:${mime};base64,${base64}`;
      img.style.display="block";
      ph.style.display="none";
    }
    function clearImage(){
      const img=document.getElementById("outfit-image");
      const ph=document.getElementById("img-placeholder");
      img.src="";
      img.style.display="none";
      ph.style.display="block";
    }
    function showImageSkeleton(on){
      const sk=document.getElementById("img-skeleton");
      const img=document.getElementById("outfit-image");
      const ph=document.getElementById("img-placeholder");
      if(!sk) return;
      if(on){ sk.style.display="block"; img.style.display="none"; ph.style.display="none"; }
      else { sk.style.display="none"; }
    }

    function renderProductsSkeleton(rows=4){
      const root=document.getElementById("products");
      root.innerHTML = `<div class="products-skel">` + Array.from({length:rows}).map(()=>`
          <div class="row">
            <div class="skel thumb"></div>
            <div><div class="skel t1"></div><div class="skel t2"></div></div>
          </div>`).join("") + `</div>`;
    }

    function escapeHtml(str){
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function setDebug(obj){
      const box=document.getElementById("debug-box");
      box.textContent = typeof obj==="string" ? obj : JSON.stringify(obj,null,2);
      box.classList.toggle("on", getDebug());
    }

    const SLOT_ORDER=["top","bottom","shoes","outer","bag","hat"];
    const SLOT_LABEL_ZH={ top:"ä¸Šè¡£", bottom:"ä¸‹èº«", shoes:"é‹å­", outer:"å¤–å¥—", bag:"åŒ…åŒ…", hat:"å¸½å­" };

    function groupProductsBySlot(list){
      const groups={}; for(const s of SLOT_ORDER) groups[s]=[];
      (list||[]).forEach(p=>{ const slot=(p.slot||"").toLowerCase(); (groups[slot] ||= []).push(p); });
      return groups;
    }

    function renderProductsGrouped(list){
      const root=document.getElementById("products");
      root.innerHTML="";
      if(!Array.isArray(list) || list.length===0){
        root.innerHTML=`<div class="placeholder" style="padding:16px;">æ²’æœ‰æ‰¾åˆ°å•†å“ï¼ˆæˆ– API å°šæœªå›å‚³ï¼‰</div>`;
        return;
      }
      const groups=groupProductsBySlot(list);
      for(const slot of SLOT_ORDER){
        const items=groups[slot]||[];
        if(items.length===0) continue;
        const wrap=document.createElement("div");
        wrap.className="slot-group";
        wrap.innerHTML=`<div class="slot-head"><div class="slot-title">ğŸ§© ${escapeHtml(SLOT_LABEL_ZH[slot]||slot)}</div><div class="slot-count">${items.length} å€‹</div></div>`;
        items.forEach(p=>{
          const div=document.createElement("div");
          div.className="product-item";
          const thumb=p.thumbnail? `<img src="${p.thumbnail}" alt="">`:"ç¤ºæ„";
          const price=p.price||p.extracted_price||"";
          const link=p.product_link||p.link||p.url||"#";
          div.innerHTML=`<div class="thumb">${thumb}</div><div><div class="pname">${escapeHtml(p.title||p.name||"å•†å“")}</div><div class="pmeta">${price? `<span>åƒ¹æ ¼ï¼š${escapeHtml(String(price))}</span>`:""}${p.source? `<span>ä¾†æºï¼š${escapeHtml(String(p.source))}</span>`:""}</div><a class="plink" href="${link}" target="_blank" rel="noopener noreferrer">å‰å¾€æŸ¥çœ‹</a></div>`;
          wrap.appendChild(div);
        });
        root.appendChild(wrap);
      }
    }

    async function postJson(url, body, withAuth=true){
      const headers={ "Content-Type":"application/json" };
      if(withAuth){
        const token=getAccessToken();
        if(!token) throw new Error("æœªç™»å…¥ï¼ˆæ²’æœ‰ Bearer tokenï¼‰");
        headers["Authorization"]="Bearer "+token;
      }
      const r=await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
      const text=await r.text();
      let j=null;
      try{ j=JSON.parse(text); }catch{ j={ raw:text }; }
      if(!r.ok){
        const msg=j?.error ? `${j.error}${j.detail? " / "+(typeof j.detail==="string"? j.detail: JSON.stringify(j.detail)):""}` : `HTTP ${r.status} / ${text.slice(0,500)}`;
        throw new Error(`${url} å¤±æ•—ï¼š${msg}`);
      }
      return j;
    }

    const flowState={ lastStep:"idle", payload:null, me:null, spec:null, imgResp:null, products:null, currentOutfitId:null };

    function updateResultActions(){
      const copyBtn=document.getElementById("copy-spec-btn");
      const shareBtn=document.getElementById("share-btn");
      const ctaBtn=document.getElementById("cta-products");
      if(copyBtn) copyBtn.disabled=!flowState.spec;
      if(shareBtn) shareBtn.disabled=!(flowState.payload && (flowState.spec || flowState.payload));
      if(ctaBtn) ctaBtn.style.display=(Array.isArray(flowState.products) && flowState.products.length) ? "inline-flex":"none";
      const ctaHint=document.getElementById("cta-hint");
      if(ctaHint) ctaHint.style.display=(ctaBtn && ctaBtn.style.display!=="none") ? "block":"none";
    }

    function showRetryUI(show, step="", hint=""){
      const row=document.getElementById("retry-row");
      const ht=document.getElementById("retry-hint");
      if(!row||!ht) return;
      if(!show){ row.style.display="none"; ht.textContent=""; return; }
      row.style.display="flex";
      ht.textContent=hint ? hint : (step? `å¯é‡è©¦ï¼š${step}`:"");
    }

    async function runStepSpec(payload, me){
      setGenerateStep("spec"); setStatus("", null, true); setProgress(20);
      const spec=await postJson("/api/generate-outfit-spec", payload, true);
      flowState.spec=spec; flowState.lastStep="spec"; updateResultActions(); haptic(12);
      setDebug({ step:"spec", spec });
      renderOutfitSummary(spec.summary);
      if(typeof spec.credits_left!=="undefined"){ setAuthUI({ loggedIn:true, email: me.user?.email, credits: spec.credits_left }); }
      else { await refreshAuthUI(); }
      return spec;
    }

    async function runStepImage(payload, spec){
      setGenerateStep("image"); setStatus("", null, true); setProgress(55);
      const imgResp=await postJson("/api/generate-image", { ...payload, outfitSpec: spec, aspectRatio:"9:16", imageSize:"1K" }, true);
      if(!imgResp.image) throw new Error("Image API æ²’å›å‚³ image");
      flowState.imgResp=imgResp; flowState.lastStep="image"; haptic(12);
      setDebug({ step:"image", imgResp, spec });
      setImageBase64(imgResp.image, imgResp.mime||"image/png");
      showImageSkeleton(false);
      return imgResp;
    }

    async function runStepProducts(payload, spec){
      setGenerateStep("products"); setStatus("", null, true); setProgress(80);
      const prodResp=await postJson("/api/search-products", { items: spec.items||[], locale:"tw", gender: payload.gender }, true);
      const list=prodResp.products || prodResp.items || prodResp.shopping_results || [];
      flowState.products=list; flowState.lastStep="products"; updateResultActions(); haptic(14);
      setDebug({ step:"products", prodResp, spec });
      renderProductsGrouped(list);
      return list;
    }

    async function retryCurrentStep(){
      showRetryUI(false); clearError();
      const ensured=await ensureTokenFromSession();
      if(!ensured.ok) throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨");
      const me=await apiMe();
      if(!me.ok) throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰");
      const payload=flowState.payload;
      if(!payload) throw new Error("æ²’æœ‰å¯é‡è©¦çš„ payloadï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
      if(flowState.lastStep==="spec"){
        if(!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        showImageSkeleton(true);
        await runStepImage(payload, flowState.spec);
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        finalizeDoneNoThrow();
        scrollToElWithOffset("anchor-products", 12, "smooth");
        return;
      }
      if(flowState.lastStep==="image"){
        if(!flowState.spec) throw new Error("spec ä¸å­˜åœ¨ï¼ˆè«‹å¾é ­é‡è·‘ï¼‰");
        renderProductsSkeleton(4);
        await runStepProducts(payload, flowState.spec);
        finalizeDoneNoThrow();
        scrollToElWithOffset("anchor-products", 12, "smooth");
        return;
      }
      await generateAll(true);
    }

    // Auto scroll fix (1238): scroll to anchor-status (status text area)
    function autoScrollOnStart(){ scrollToElWithOffset("anchor-status", isMobile()? 16:12, "smooth"); haptic(10); }
    function autoScrollOnDone(){ scrollToElWithOffset("anchor-products", 12, "smooth"); showToast("å¾€ä¸‹çœ‹å•†å“ â†“", 2000); haptic(18); }

    const modal=document.getElementById("img-modal");
    const modalImg=document.getElementById("modal-img");
    const modalClose=document.getElementById("modal-close");
    const modalSave=document.getElementById("modal-save");
    function openModalWithCurrentImage(){
      const img=document.getElementById("outfit-image");
      if(!img || !img.src) return;
      modalImg.src=img.src;
      modal.classList.add("on");
      modal.setAttribute("aria-hidden","false");
      document.body.style.overflow="hidden";
    }
    function closeModal(){
      modal.classList.remove("on");
      modal.setAttribute("aria-hidden","true");
      document.body.style.overflow="";
    }
    modalClose.addEventListener("click", closeModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && modal.classList.contains("on")) closeModal(); });

    modalSave.addEventListener("click", ()=>{
      try{
        const src=modalImg.src;
        if(!src) return;
        const a=document.createElement("a");
        a.href=src; a.download="outfit.png";
        document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ console.error(e); }
    });

    document.getElementById("btn-fullscreen").addEventListener("click", openModalWithCurrentImage);
    document.getElementById("outfit-image").addEventListener("click", openModalWithCurrentImage);

    // Collections code omitted here for brevity in this export? (Kept in your original file.)
    // NOTE: In your actual project, keep the full "æ”¶è—/æœ€è¿‘10å¥—" JS segment from your current body-test,
    // or merge it back if you need it. This HTML focuses on 1236/1238 + downloadability.

    function resetPerRunUI(){
      showRetryUI(false);
      clearError();
      clearImage();
      showImageSkeleton(true);
      renderProductsSkeleton(4);
      renderOutfitSummary(null);
      flowState.currentOutfitId=null;
      flowState.imgResp=null;
      flowState.spec=null;
      flowState.products=null;
    }

    function finalizeDoneNoThrow(){
      setGenerateStep("done");
      setProgress(100);
      setStatus("", true, false);
      showRetryUI(false);
    }

    async function generateAll(forceRestart=false){
      showRetryUI(false); clearError();
      setLoadingUI(true); setFormDisabled(true);
      try{
        setGenerateStep("spec"); setProgress(0); setStatus("", null, true);
        autoScrollOnStart();
        resetPerRunUI();

        const ensured=await ensureTokenFromSession();
        if(!ensured.ok){ setAuthUI({ loggedIn:false, hint:"æœªç™»å…¥ï¼ˆè«‹æŒ‰ Google ç™»å…¥ï¼‰" }); throw new Error("æœªç™»å…¥æˆ– session ä¸å­˜åœ¨"); }

        const me=await apiMe();
        if(!me.ok){ setAuthUI({ loggedIn:false, hint:"ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰" }); throw new Error("ç™»å…¥ç‹€æ…‹ç•°å¸¸ï¼ˆ/api/me å¤±æ•—ï¼‰"); }
        flowState.me=me;

        const payload={
          gender: document.getElementById("gender").value,
          age: Number(document.getElementById("age").value),
          height: Number(document.getElementById("height").value),
          weight: Number(document.getElementById("weight").value),
          style: document.getElementById("style").value,
          styleVariant: document.getElementById("styleVariant").value || "",
          temp: Number(document.getElementById("temp").value),
          withBag: !!getBag(),
          withHat: !!getHat(),
          withCoat: !!getCoat()
        };
        flowState.payload=payload;
        setResultMeta(payload);
        updateResultActions();

        if(forceRestart){ flowState.spec=null; flowState.imgResp=null; flowState.products=null; flowState.lastStep="idle"; }

        const spec=await runStepSpec(payload, me);
        const imgResp=await runStepImage(payload, spec);
        scrollToElWithOffset("anchor-preview", 12, "smooth");
        const products=await runStepProducts(payload, spec);

        finalizeDoneNoThrow();
        autoScrollOnDone();
      }catch(e){
        console.error(e);
        setGenerateStep("failed");
        setStatus("", false, false);
        setProgress(0);
        const raw=String(e?.message||e||"");
        setDebug({ error: raw, step: flowState.lastStep, state: flowState });
        const friendly=userFriendlyError(e, flowState.lastStep, !!flowState.imgResp);
        showError(`${friendly.title}ï¼š${friendly.desc}ï¼ˆä¸‹ä¸€æ­¥ï¼š${friendly.next}ï¼‰`);
        showRetryUI(true, flowState.lastStep, friendly.next);
      } finally {
        setLoadingUI(false);
        setFormDisabled(false);
      }
    }

    (async function init(){
      bindRange("age","age-val");
      bindRange("height","height-val");
      bindRange("weight","weight-val");
      bindRange("temp","temp-val");
      bindStyleCards();
      initGenderSegmented();
      initGenderSegmented();

      document.getElementById("login-btn").addEventListener("click", loginGoogle);
      document.getElementById("logout-btn").addEventListener("click", logout);

      const mobileBar=document.getElementById("mobile-actionbar");
      if(mobileBar) mobileBar.style.display=isMobile()? "block":"none";
      window.addEventListener("resize", ()=>{ if(mobileBar) mobileBar.style.display=isMobile()? "block":"none"; });

      const ctaBtn=document.getElementById("cta-products");
      if(ctaBtn) ctaBtn.addEventListener("click", ()=>{ scrollToElWithOffset("anchor-products",12,"smooth"); haptic(8); });

      const copyBtn=document.getElementById("copy-spec-btn");
      if(copyBtn) copyBtn.addEventListener("click", ()=>{ if(!flowState.spec) return; copyText(safeJson(flowState.spec)); showToast("å·²è¤‡è£½ Outfit Spec",1600); haptic(10); });

      const shareBtn=document.getElementById("share-btn");
      if(shareBtn) shareBtn.addEventListener("click", ()=>{ const hash=makeShareHash({ payload: flowState.payload, spec: flowState.spec }); const url=location.origin+location.pathname+hash; copyText(url); showToast("åˆ†äº«é€£çµå·²è¤‡è£½",1800); haptic(12); });

      document.getElementById("retry-btn").addEventListener("click", async ()=>{
        const btn=document.getElementById("retry-btn");
        btn.disabled=true;
        try{ setLoadingUI(true); await retryCurrentStep(); }
        catch(e){ console.error(e); showError(String(e?.message||e)); }
        finally{ setLoadingUI(false); btn.disabled=false; }
      });

      document.getElementById("restart-btn").addEventListener("click", async ()=>{
        const btn=document.getElementById("restart-btn");
        btn.disabled=true;
        try{ setLoadingUI(true); await generateAll(true); }
        catch(e){ console.error(e); showError(String(e?.message||e)); }
        finally{ setLoadingUI(false); btn.disabled=false; }
      });

      async function onGenerateClick(){ showRetryUI(false); try{ await generateAll(false); }catch{} }

      const goBtnDesktop=document.getElementById("go-btn");
      const goBtnMobile=document.getElementById("go-btn-mobile");
      if(goBtnDesktop) goBtnDesktop.addEventListener("click", async ()=>{
        goBtnDesktop.disabled=true; if(goBtnMobile) goBtnMobile.disabled=true;
        try{ await onGenerateClick(); } finally { goBtnDesktop.disabled=false; if(goBtnMobile) goBtnMobile.disabled=false; }
      });
      if(goBtnMobile) goBtnMobile.addEventListener("click", async ()=>{
        goBtnMobile.disabled=true; if(goBtnDesktop) goBtnDesktop.disabled=true;
        try{ await onGenerateClick(); } finally { goBtnMobile.disabled=false; if(goBtnDesktop) goBtnDesktop.disabled=false; }
      });

      document.getElementById("debug-box").classList.toggle("on", getDebug());

      await ensureTokenFromSession();
      await refreshAuthUI();

      osSupabase.auth.onAuthStateChange(async (_event, session)=>{ if(session?.access_token) saveAccessToken(session.access_token); else clearAccessToken(); await refreshAuthUI(); });

      const shared=parseShareFromLocation();
      if(shared && shared.payload){
        applyPayloadToForm(shared.payload);
        flowState.payload=shared.payload;
        setResultMeta(shared.payload);
        if(shared.spec){
          flowState.spec={ ...shared.spec, items: shared.spec.items||[], summary: shared.spec.summary||"" };
          renderOutfitSummary(flowState.spec.summary);
        }
        updateResultActions();
        showToast("å·²è¼‰å…¥åˆ†äº«æ¢ä»¶", 1600);
      }

      setGenerateStep("idle");
      setProgress(0);
      setStatus("", null, false);
      setLoadingUI(false);
    })();
  </script>

  <div class="toast" id="toast" style="display:none;">å¾€ä¸‹çœ‹å•†å“ â†“</div>
</body>
</html>
